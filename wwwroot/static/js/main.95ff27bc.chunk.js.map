{"version":3,"sources":["constants.ts","element/typeChecks.ts","math.ts","points.ts","element/bounds.ts","renderer/renderElement.ts","random.ts","element/mutateElement.ts","element/sizeHelpers.ts","groups.ts","element/newElement.ts","element/handlerRectangles.ts","element/collision.ts","element/resizeTest.ts","element/resizeElements.ts","element/dragElements.ts","keys.ts","element/textWysiwyg.tsx","element/textElement.ts","element/showSelectedShapeActions.ts","element/index.ts","i18n.ts","scene/scrollbars.ts","scene/selection.ts","scene/scroll.ts","scene/comparisons.ts","scene/zoom.ts","scene/globalScene.ts","utils.ts","components/TopErrorBoundary.tsx","components/LoadingMessage.tsx","components/InitializeApp.tsx","is-mobile.tsx","appState.ts","colors.ts","clients.ts","element/linearElementEditor.ts","renderer/renderScene.ts","renderer/roundRect.ts","scene/export.ts","charts.ts","clipboard.ts","data/restore.ts","data/blob.ts","data/json.ts","data/localStorage.ts","data/urlStorage.ts","data/index.ts","components/Portal.tsx","shapes.tsx","history.ts","components/Popover.tsx","components/ContextMenu.tsx","actions/manager.tsx","components/ToolButton.tsx","components/icons.tsx","actions/register.ts","actions/actionDeleteSelected.tsx","zindex.ts","actions/actionZindex.tsx","components/ButtonSelect.tsx","actions/actionSelectAll.ts","actions/actionDuplicateSelection.tsx","components/ColorPicker.tsx","actions/actionProperties.tsx","actions/actionCanvas.tsx","actions/actionFinalize.tsx","components/ProjectName.tsx","actions/actionExport.tsx","actions/actionStyles.ts","components/HelpIcon.tsx","actions/actionMenu.tsx","actions/actionGroup.ts","components/Avatar.tsx","gesture.ts","actions/actionNavigate.tsx","actions/actionAddToLibrary.ts","actions/actionHistory.tsx","components/Island.tsx","components/Stack.tsx","components/FixedSideContainer.tsx","components/UserList.tsx","components/LockIcon.tsx","components/Modal.tsx","components/Dialog.tsx","components/ExportDialog.tsx","components/LanguageList.tsx","components/HintViewer.tsx","components/Actions.tsx","components/Section.tsx","components/RoomDialog.tsx","components/MobileMenu.tsx","components/ErrorDialog.tsx","components/ShortcutsDialog.tsx","components/GitHubCorner.tsx","components/Tooltip.tsx","components/LibraryUnit.tsx","components/LayerUI.tsx","components/App.tsx","time_constants.ts","serviceWorker.tsx","index.tsx","locales lazy /^/.//.*$/ groupOptions: {} namespace object"],"names":["SHIFT_LOCKING_ANGLE","Math","PI","CURSOR_TYPE","POINTER_BUTTON","SCENE","EVENT","ENV","BROADCAST","CLASSES","FONT_FAMILY","1","2","3","CANVAS_ONLY_ACTIONS","isTextElement","element","type","isLinearElement","distanceBetweenPointAndSegment","x","y","x1","y1","x2","y2","C","D","lenSquare","xx","yy","param","dx","dy","hypot","rotate","angle","cos","sin","adjustXYWithRotation","sides","deltaX1","deltaY1","deltaX2","deltaY2","e","w","n","s","distance2d","xd","yd","isPathALoop","points","length","firstPoint","lastPoint","onSegment","p","q","r","max","min","orientation","val","doIntersect","p1","q1","p2","q2","o1","o2","o3","o4","getGridPoint","gridSize","round","getSizeFromPoints","xs","map","point","ys","width","height","rescalePoints","dimension","nextDimensionSize","prevPoints","prevDimValues","prevMaxDimension","prevMinDimension","prevDimensionSize","dimensionScaleFactor","nextMinDimension","Infinity","scaledPoints","prevPoint","value","currentDimension","scaledValue","translation","scaledPoint","getElementAbsoluteCoords","getLinearElementAbsoluteCoords","getDiamondPoints","topX","floor","rightX","rightY","getCurvePathOps","shape","set","sets","ops","getMinMaxXYFromCurvePathOps","transformXY","currentP","minX","minY","maxX","maxY","reduce","limits","op","data","p3","p0","equation","t","idx","pow","getShapeForElement","getElementBounds","cx","cy","getLinearElementRotatedBounds","x11","y11","x12","y12","x22","y22","x21","y21","h","ww","hh","getCommonBounds","elements","forEach","getResizedElementAbsoluteCoords","nextWidth","nextHeight","curve","rough","generator","generateRoughOptions","getElementPointsCoords","DASHARRAY_DASHED","DASHARRAY_DOTTED","drawElementOnCanvas","rc","context","globalAlpha","opacity","draw","Error","rtl","isRTL","text","shouldTemporarilyAttach","canvas","isConnected","document","body","appendChild","setAttribute","font","getFontString","fillStyle","strokeColor","textAlign","lines","replace","split","lineHeight","verticalOffset","baseline","horizontalOffset","i","fillText","remove","elementWithCanvasCache","WeakMap","shapeCache","get","invalidateShapeForElement","delete","options","seed","strokeLineDash","strokeStyle","undefined","disableMultiStroke","strokeWidth","fillWeight","hachureGap","roughness","stroke","fill","backgroundColor","curveFitting","generateElementShape","rectangle","topY","bottomX","bottomY","leftX","leftY","polygon","ellipse","x3","y3","x4","y4","prevOp","distance","nx","ny","arrowLength","total","px","py","minSize","getArrowPoints","push","line","generateElementWithCanvas","sceneState","zoom","prevElementWithCanvas","shouldRegenerateBecauseZoom","canvasZoom","shouldCacheIgnoreZoom","elementWithCanvas","createElement","getContext","canvasOffsetX","canvasOffsetY","window","devicePixelRatio","CANVAS_PADDING","translate","scale","generateElementCanvas","renderElement","renderOptimizations","scrollX","scrollY","fillRect","drawImage","drawElementFromCanvas","shiftX","shiftY","random","Random","Date","now","randomInteger","next","randomId","nanoid","mutateElement","updates","didChange","key","nextPoints","didChangePoints","nextPoint","version","versionNonce","globalSceneState","informMutation","newElementWith","isInvisiblySmallElement","getPerfectElementSize","elementType","absWidth","abs","absHeight","lockedAngle","atan","tan","sign","getNormalizedDimensions","ret","selectGroup","groupId","appState","elementsInGroup","filter","groupIds","includes","selectedGroupIds","editingGroupId","selectedElementIds","Object","fromEntries","id","getSelectedGroupIds","entries","isSelected","selectGroupsForSelectedElements","nextAppState","selectedElements","getSelectedElements","selectedElement","indexOfEditingGroup","indexOf","slice","isElementInGroup","getElementsInGroup","addToGroup","prevGroupIds","newGroupId","positionOfEditingGroupId","positionToInsert","splice","_newElementBase","rest","isDeleted","newElement","opts","getTextElementPositionOffsets","metrics","verticalAlign","newTextElement","measureText","offsets","fontSize","fontFamily","getAdjustedDimensions","nextText","nextBaseline","prevMetrics","nextX1","nextY1","nextX2","nextY2","Number","isFinite","deepCopyElement","depth","prototype","toString","call","tmp","constructor","create","getPrototypeOf","hasOwnProperty","Array","isArray","k","arr","duplicateElement","groupIdMapForOperation","overrides","copy","mapper","endIndex","getNewGroupIdsForDuplication","has","assign","handleSizes","mouse","pen","touch","OMIT_SIDES_FOR_MULTIPLE_ELEMENTS","rotation","OMIT_SIDES_FOR_TEXT_ELEMENT","OMIT_SIDES_FOR_LINE_SLASH","nw","se","OMIT_SIDES_FOR_LINE_BACKSLASH","ne","sw","generateHandler","handlerRectanglesFromCoords","pointerType","omitSides","size","handlerWidth","handlerHeight","handlerMarginX","handlerMarginY","dashedLineMargin","centeringOffset","handlers","minimumSizeForEightHandlers","handlerRectangles","isElementDraggableFromInside","dragFromInside","hitTest","lineThreshold","tx","ty","a","b","ex","ey","rx","ry","qx","qy","relX","relY","some","subshape","hitTestCurveInside","hitTestRoughShape","console","warn","drawable","operation","vertices","extreme","MAX_SAFE_INTEGER","count","current","isPointInPolygon","pointsOnBezierCurves","mx","my","sqrt","pointInBezierEquation","isInHandlerRect","handler","getElementWithResizeHandler","scenePointerX","scenePointerY","result","resizeHandle","rotationHandler","keys","resizeTest","getResizeHandlerFromCoords","find","RESIZE_CURSORS","getCursorForResizingElement","resizingElement","shouldSwapCursors","cursor","index","rotateResizeCursor","rotateSingleElement","pointerX","pointerY","isRotateWithDiscreteAngle","atan2","resizeSingleTwoPointElement","resizeArrowDirection","pointOrigin","pointEnd","rescalePointsInElement","measureFontSizeFromWH","nextFontSize","getSidesForResizeHandle","isResizeFromCenter","test","resizeSingleTextElement","rotatedX","rotatedY","nextFont","nextElementX","nextElementY","resizeSingleElement","sidesWithSameLength","scaleX","scaleY","rescaledPoints","finalX1","finalY1","finalX2","finalY2","flipDiffX","flipDiffY","side","needsRotation","getFlipAdjustment","resizeMultipleElements","getNextXY","origX1","origY1","origX2","origY2","prev","origCoords","finalCoords","dragNewElement","draggingElement","originX","originY","isResizeWithSidesSameLength","isResizeCenterPoint","newX","newY","isDarwin","navigator","platform","KEYS","isArrowKey","keyCode","getResizeCenterPointKey","event","altKey","which","getResizeWithSidesSameLengthKey","shiftKey","getRotateWithDiscreteAngleKey","normalizeText","getTransform","degree","redrawTextBoundingBox","showSelectedShapeActions","Boolean","editingElement","getElementMap","acc","getDrawingVersion","el","getNonDeletedElements","isNonDeletedElement","languages","lng","label","concat","sort","left","right","lang","percentages","currentLanguage","currentLanguageData","fallbackLanguage","setLanguage","async","language","newLng","documentElement","dir","languageDetector","cacheUserLanguage","getLanguage","findPartsForData","parts","part","path","replacement","fallbackLanguageData","LanguageDetector","init","languageUtils","formatLanguageCode","isWhitelisted","checkWhitelist","isOverScrollBars","scrollBars","isOverHorizontal","isOverVertical","horizontal","vertical","scrollBar","isOverEither","isSomeElementSelected","normalizeScroll","pos","calculateScrollCenter","cords","viewportX1","viewportY1","sceneCoordsToViewportCoords","sceneX","sceneY","viewportX2","viewportY2","isOutsideViewPort","from","minDistance","closestElement","getClosestElementBounds","viewportCoordsToSceneCoords","clientX","clientY","centerX","centerY","hasBackground","hasStroke","hasText","getElementAtPosition","hitElement","getZoomOrigin","getNormalizedZoom","normalizedZoom","parseFloat","toFixed","callbacks","Set","nonDeletedElements","elementsMap","getElementsIncludingDeleted","this","getElements","getElement","getNonDeletedElement","replaceAllElements","nextElements","callback","addCallback","cb","add","SVG_NS","mockDateTime","getDateTime","date","year","getFullYear","month","getMonth","padStart","day","getDate","hr","getHours","getMinutes","capitalizeString","str","charAt","toUpperCase","isWritableElement","target","HTMLElement","dataset","HTMLBRElement","HTMLTextAreaElement","HTMLInputElement","getFontFamilyString","style","position","whiteSpace","innerText","join","offsetWidth","offsetHeight","span","display","overflow","offsetTop","removeChild","debounce","fn","timeout","lastArgs","handle","args","clearTimeout","setTimeout","flush","resetCursor","setCursorForShape","isFullScreen","fullscreenElement","nodeName","getShortcutKey","shortcut","isMac","zoomOrigin","getGlobalCSSVariable","name","getComputedStyle","getPropertyValue","RE_RTL_CHECK","RegExp","tupleToCoors","xyTuple","TopErrorBoundary","React","Component","state","hasError","sentryEventId","localStorage","render","errorSplash","props","children","componentDidCatch","error","errorInfo","_localStorage","JSON","parse","Sentry","scope","setExtras","eventId","setState","stringify","selectTextArea","activeElement","preventDefault","select","templateStrFn","default","encodeURIComponent","open","className","onClick","location","reload","clear","role","aria-label","aria-hidden","createGithubIssue","rows","onPointerDown","readOnly","LoadingMessage","InitializeApp","isLoading","detect","setLanguageFirstTime","createContext","IsMobileProvider","query","useRef","matchMedia","matches","addListener","removeListener","isMobile","setMobile","useState","useEffect","Provider","useIsMobile","useContext","getDefaultAppState","errorMessage","multiElement","editingLinearElement","elementLocked","exportBackground","shouldAddWatermark","currentItemStrokeColor","oc","black","currentItemBackgroundColor","currentItemFillStyle","currentItemStrokeWidth","currentItemStrokeStyle","currentItemRoughness","currentItemOpacity","currentItemFontSize","currentItemFontFamily","currentItemTextAlign","viewBackgroundColor","white","cursorX","cursorY","cursorButton","scrolledOutside","username","isCollaborating","isResizing","isRotating","selectionElement","openMenu","lastPointerDownWith","previousSelectedElementIds","collaborators","Map","showShortcutsDialog","zenModeEnabled","innerWidth","innerHeight","isLibraryOpen","clearAppStateForLocalStorage","exportedState","cleanAppStateForExport","shades","red","pink","grape","violet","indigo","blue","cyan","teal","green","lime","yellow","orange","canvasBackground","gray","elementBackground","elementStroke","getClientColors","clientId","sum","charCodeAt","backgrounds","colors","strokes","background","LinearElementEditor","elementId","activePointIndex","draggingElementPointIndex","lastUncommittedPoint","normalizePoints","lastX","lastY","clickedPointIndex","getPointIndexUnderCursor","deltaX","deltaY","targetPoint","movePoint","history","didAddPoint","createPointAt","resumeRecording","newPoint","pointHandles","getPointsGlobalCoordinates","POINT_HANDLE_SIZE","offsetX","offsetY","_idx","pointIndex","targetPosition","nextCoords","prevCoords","nextCenterX","nextCenterY","prevCenterX","prevCenterY","rotated","strokeRectWithRotation","strokeRect","strokeCircle","beginPath","arc","renderScene","renderScrollbars","renderSelection","renderGrid","atLeastOneVisibleElement","normalizedCanvasWidth","normalizedCanvasHeight","clearRect","zoomTranslationX","zoomTranslationY","origStrokeStyle","moveTo","lineTo","strokeGrid","ceil","visibleElements","isVisibleElement","lineWidth","setLineDash","renderLinearPointHandles","selections","selectionColors","isSelectedViaGroup","remoteSelectedElementIds","socketId","elementX1","elementY1","elementX2","elementY2","addSelectionForGroupId","groupElements","elementWidth","elementHeight","initialLineDash","getLineDash","lineDashOffset","dashedLinePadding","dashWidth","spaceWidth","locallySelectedElements","remotePointerViewportCoords","remotePointerUsernames","isOutOfBounds","remotePointerButton","closePath","paddingHorizontal","paddingVertical","measure","measureHeight","actualBoundingBoxDescent","actualBoundingBoxAscent","viewportWidth","viewportHeight","elementsMinX","elementsMinY","elementsMaxX","elementsMaxY","viewportWidthWithZoom","viewportHeightWithZoom","viewportWidthDiff","viewportHeightDiff","safeArea","top","parseInt","bottom","viewportMinX","viewportMinY","viewportMaxX","viewportMaxY","sceneMinX","sceneMinY","sceneMaxX","sceneMaxY","SCROLLBAR_MARGIN","getScrollBars","radius","quadraticCurveTo","roundRect","SCROLLBAR_WIDTH","renderSceneToSvg","rsvg","svgRoot","node","group","ownerDocument","createElementNS","direction","textAnchor","textContent","renderElementToSvg","exportToCanvas","exportPadding","createCanvas","tempCanvas","sceneElements","getWatermarkElement","exportToSvg","innerHTML","rect","svg","tryParseNumber","match","exec","isNumericColumn","columnIndex","every","tryParseCells","cells","numCols","hasHeader","values","spreadsheet","yAxisLabel","labels","valueColumnIndex","labelColumnIndex","row","renderSpreadsheet","range","minYLabel","toLocaleString","maxYLabel","bars","barHeight","xLabels","labelX","BAR_HEIGHT","CLIPBOARD","PREFER_APP_CLIPBOARD","probablySupportsClipboardReadText","clipboard","probablySupportsClipboardWriteText","probablySupportsClipboardBlob","HTMLCanvasElement","getClipboardContent","clipboardData","getData","trim","readText","numColsFirstLine","transposedResults","nextCells","col","nextCellRow","transposeCells","tryParseSpreadsheet","clipboardElements","getAppClipboard","copyTextToSystemClipboard","copied","writeText","copyTextViaExecCommand","getAttribute","textarea","border","padding","margin","yPosition","pageYOffset","scrollTop","success","setSelectionRange","execCommand","migrateElementWithProperties","extra","base","migrateElement","fontPx","_fontFamily","fontFamilyName","fontFamilyString","getFontFamilyByName","restore","savedElements","savedState","migratedElement","log","scrollToContent","loadFromBlob","contents","blob","Blob","Promise","resolve","reader","FileReader","readAsText","onloadend","readyState","DONE","defaultAppState","updateAppState","serializeAsJSON","source","origin","saveAsJSON","fileHandle","serialized","fileSave","fileName","description","extensions","_LATEST_LIBRARY_ITEMS","loadLibrary","getItem","items","saveLibrary","prevLibraryItems","serializedItems","setItem","axios","require","byteToHex","byte","getCollaborationLinkData","link","URL","hash","generateCollaborationLink","Uint8Array","crypto","getRandomValues","generateRandomID","subtle","generateKey","exportKey","generateEncryptionKey","pathname","getImportedKey","usage","importKey","alg","ext","key_ops","kty","encryptAESGEM","importedKey","iv","createIV","encrypt","exportCanvas","alert","tempSvg","outerHTML","svgroot","copyCanvasToClipboardAsSvg","toBlob","reject","write","ClipboardItem","copyCanvasToClipboardAsPng","json","encoded","TextEncoder","encode","encrypted","exportedKey","response","fetch","process","method","url","href","urlString","prompt","exportToBackend","loadScene","privateKey","lastHttpStatus","status","substr","lastSuccessfulPut","restoreFromUrl","ok","buffer","arrayBuffer","decrypted","decrypt","string","TextDecoder","decode","importFromBackend","restoreFromLocalStorage","commitToHistory","Portal","app","socket","socketInitialized","roomID","roomKey","on","emit","restoreUserName","broadcastScene","INIT","clients","setCollaborators","close","isOpen","volatile","SHAPES","icon","viewBox","d","strokeLinecap","shapesShortcutKeys","flat","clearAppStatePropertiesForHistory","SceneHistory","elementCache","recording","stateHistory","redoStack","lastEntry","generateEntry","dehydrateHistoryEntry","lastCommittedPoint","hydrateHistoryEntry","dehydratedExcalidrawElement","versions","getSnapshotForTest","dehydratedHistoryEntry","shouldCreateEntry","nextEntry","pushEntry","newEntryDehydrated","newEntry","clearRedoStack","redoOnce","entryToRestore","pop","undoOnce","currentEntry","setCurrentState","record","Popover","onCloseRequest","fitInViewport","popoverRef","useLayoutEffect","getBoundingClientRect","contains","unstable_batchedUpdates","addEventListener","removeEventListener","ref","ContextMenu","onContextMenu","option","ContextMenuOption","action","contextMenuNode","getContextMenuNode","div","handleClose","unmountComponentAtNode","params","of","ActionManager","updater","getAppState","actions","renderAction","PanelComponent","updateData","formState","perform","registerAction","registerAll","handleKeyDown","keyPriority","keyTest","executeAction","getContextMenuItems","actionFilter","contextItemPredicate","contextMenuOrder","contextItemLabel","ToolButton","forwardRef","innerRef","useImperativeHandle","sizeCn","hidden","selected","visible","title","keyBindingLabel","showAriaLabel","aria-keyshortcuts","data-testid","onChange","checked","defaultProps","ACTIVE_ELEMENT_COLOR","createIcon","mirror","focusable","save","saveAs","load","trash","palette","exportFile","zoomIn","zoomOut","done","menu","undo","redo","resetZoom","bringForward","sendBackward","bringToFront","sendToBack","strokeLinejoin","users","start","stop","back","marginLeft","clone","shield","register","handleGroupEditingState","siblingElements","actionDeleteSelected","deleteSelectedElements","swap","indexA","indexB","moveOneLeft","indicesToMove","isSorted","moveOneRight","reversedIndicesToMove","moveAllLeft","leftMostElements","reverse","moveAllRight","rightMostElements","moveElements","func","_elements","selectedIndices","deletedIndicesCache","len","getElementIndices","ButtonSelect","code","selectedPoint","groupIdMap","isValidColor","color","Option","keyBindings","Picker","onClose","showInput","firstItem","activeItem","gallery","colorInput","focus","aria-modal","onKeyDown","nextIndex","toLowerCase","nativeEvent","stopImmediatePropagation","_color","currentTarget","onFocus","ColorInput","innerValue","setInnerValue","inputRef","changeColor","useCallback","inputValue","getColor","spellCheck","onBlur","ColorPicker","isActive","setActive","pickerButton","Suspense","fallback","changedColor","changeProperty","getFormValue","defaultValue","attributes","getCommonAttributeOfSelectedElements","KEY_CODES","step","onWheel","stopPropagation","_","confirm","actionFinalize","commonBounds","currentZoom","zoomX","zoomY","newZoom","calculateZoom","newElements","blur","multiPointElement","linePoints","ProjectName","handleFocus","selection","getSelection","createRange","selectNodeContents","removeAllRanges","addRange","selectNode","handleBlur","removeSelection","isComposing","makeEditable","editable","contentEditable","suppressContentEditableWarning","data-type","catch","loadedElements","loadedAppState","fileOpen","mimeTypes","loadFromJSON","then","message","copiedStyles","pastedElement","ICON","xmlns","HelpIcon","requestFullscreen","exitFullscreen","selectedGroupId","elementIdsInGroup","updatedElements","lastElementInGroup","lastGroupElementIndex","lastIndexOf","elementsAfterGroup","updatedElementsInOrder","updatedElement","nextGroupIds","removeFromSelectedGroups","Avatar","getCenter","collaborator","shortName","names","substring","firstName","lastName","getClientInitials","pointer","pointers","allCoords","coords","getDistance","array","item","writeData","prevElements","prevElementMap","nextElementMap","nextElement","prevElement","syncHistory","testUndo","shift","Island","gap","align","justifyContent","alignItems","justifyItems","FixedSideContainer","UserList","mobile","compClassName","ICONS","CHECKED","UNCHECKED","LockIcon","Modal","modalRoot","useBodyRoot","createPortal","aria-labelledby","labelledBy","maxWidth","maxHeight","overflowY","Dialog","islandRef","focusableElements","queryFocusableElements","currentIndex","findIndex","querySelectorAll","scales","defaultScale","ExportModal","actionManager","onExportToPng","onExportToSvg","onExportToClipboard","onExportToBackend","someElementIsSelected","setScale","exportSelected","setExportSelected","previewRef","exportedElements","previewNode","ExportDialog","modalIsShown","setModalIsShown","triggerButton","LanguageList","i18n","floating","Fragment","HintViewer","hint","multiMode","targetElement","getHints","SelectedShapeActions","targetElements","getTargetElement","isEditing","LIBRARY_ICON","ShapesSwitcher","setAppState","ZoomActions","marginInlineStart","Section","heading","header","RoomModal","activeRoomLink","onUsernameChange","onRoomCreate","onRoomDestroy","onPressingEnter","roomLinkInput","htmlFor","onKeyPress","RoomDialog","collaboratorCount","setActiveRoomLink","MobileMenu","exportButton","onLockToggle","marginBottom","marginRight","client","ErrorDialog","Columns","flexDirection","flexWrap","Column","ShortcutIsland","caption","Shortcut","borderTop","flex","minWidth","shortcuts","ShortcutKey","isOr","wordBreak","borderRadius","minHeight","boxSizing","Footer","marginTop","paddingTop","rel","ShortcutsDialog","GitHubCorner","memo","transformOrigin","Tooltip","PLUS_ICON","LibraryUnit","pendingElements","onRemoveFromLibrary","elementsToRender","child","tagName","isHovered","setIsHovered","adder","onMouseEnter","onMouseLeave","draggable","onDragStart","dataTransfer","setData","LibraryMenuItems","library","onAddToLibrary","onInsertShape","numCells","numRows","addedPendingElements","j","shouldAddPendingElements","bind","LibraryMenu","onClickOutside","listener","Element","useOnClickOutside","libraryItems","setLibraryItems","loadingState","setIsLoading","loadingTimerRef","race","removeFromLibrary","nextItems","indexToRemove","addToLibrary","toggleZenMode","renderExportDialog","createExporter","closeLibrary","deselectItems","shouldRenderSelectedShapeActions","libraryMenu","zIndex","renderFixedSideContainer","getNecessaryObj","prevAppState","withBatchedUpdates","didTapTwice","tappedTwiceTimer","isHoldingSpace","isPanning","isDraggingScrollBar","currentScrollBars","touchTimeout","touchMoving","lastPointerUp","gesture","lastCenter","initialDistance","initialScale","App","super","portal","lastBroadcastedOrReceivedSceneVersion","broadcastedElementVersions","removeSceneCallback","unmounted","syncActionResult","actionResult","saveDebounced","onUnload","destroySocketClient","disableEvent","onFontLoaded","onSceneUpdated","initializeScene","URLSearchParams","search","jsonMatch","scene","isCollaborationScene","shouldForceLoadScene","replaceState","initializeSocketClient","showLoadingState","onResize","onHashChange","beforeUnload","timestamp","room","returnValue","queueBroadcastAllElements","throttle","UPDATE","onCut","copyAll","onCopy","copyToAppClipboard","copyToClipboardAsPng","copyToClipboardAsSvg","onTapStart","resetTapTwice","touches","handleCanvasDoubleClick","onTapEnd","pasteFromClipboard","elementUnderCursor","elementFromPoint","addElementsFromPasteOrLibrary","addTextFromPaste","selectShapeTool","elementsCenterX","elementsCenterY","obj","removePointer","pointerId","openPortal","pushState","closePortal","toggleLock","prevState","toggleGridMode","roomMatch","initialize","initializationTimer","updateScene","decryptedData","remoteElements","payload","localElementMap","socketIOClient","encryptedData","decodedData","decryptAESGEM","socketID","pointerCoords","button","user","off","broadcastMouseLocation","_broadcastSocketData","sceneType","syncAll","syncableElements","syncableElement","updateCurrentCursorPosition","HTMLSelectElement","findShapeByKey","update","startTextEditing","ctrlKey","metaKey","onKeyUp","onGestureStart","onGestureChange","onGestureEnd","setElements","insertAtParentCenter","existingTextElement","getTextElementAtPosition","parentCenterPosition","getTextWysiwygSnappedToCenterPosition","elementCenterX","elementCenterY","handleTextWysiwyg","isExistingElement","getSelectedGroupIdForElement","handleCanvasPointerMove","savePointer","center","scaleFactor","resetShouldCacheIgnoreZoomDebounced","isOverScrollBar","handlePointerMove","buttons","elementWithResizeHandler","handleTouchMove","handleCanvasPointerDown","persist","maybeOpenContextMenuAfterPointerDownOnTouchDevices","maybeCleanupAfterMissingPointerUp","handleCanvasPanUsingWheelOrSpaceDrag","updateGestureOnPointerDown","pointerDownState","initialPointerDownState","handleDraggingScrollBar","clearSelectionIfNotUsingSelection","handleSelectionOnPointerDown","handleTextOnPointerDown","handleLinearElementOnPointerDown","createGenericElementOnPointerDown","onPointerMove","onPointerMoveFromPointerDownHandler","onPointerUp","onPointerUpFromPointerDownHandler","POINTER_MOVE","POINTER_UP","eventListeners","onMove","onUp","openContextMenu","nextPastePrevented","isLinux","preventNextPaste","PASTE","enableNextPaste","teardown","BLUR","passive","resize","offset","getResizeOffsetXY","arrowDirection","getResizeArrowDirection","handlePointerDown","hit","maybeClearSelectionWhenHittingElement","wasAddedToSelection","gridX","gridY","handleCanvasRef","WHEEL","handleWheel","TOUCH_START","TOUCH_END","handleCanvasOnDrop","libraryShapes","file","files","endsWith","handleCanvasContextMenu","MAX_STEP","delta","isNaN","saveToLocalStorage","isCloudConnected","activeDocIndex","saveActiveDoc","createRedoAction","SaveToURL","statCodeString","codeLeadingDigit","appStateJSON","elementsJSON","reqData","lastSaved","toISOString","headers","restoreFromURL","fetchDocs","serverURL","cloudDocs","listDocs","dateLastSaved","activateCloud","urlParams","docToLoad","loadDoc","isRefresh","newurl","protocol","host","activeDocName","reloadDoc","saveNewDoc","l","canvasDOMWidth","canvasDOMHeight","canvasScale","canvasWidth","canvasHeight","saveUsernameToLocalStorage","onDoubleClick","onPointerCancel","onTouchMove","onDrop","collabForceLoadFlag","previousRoom","defineProperties","configurable","addEventListeners","componentWillUnmount","removeEventListeners","COPY","CUT","KEYDOWN","MOUSE_MOVE","KEYUP","RESIZE","UNLOAD","DRAG_OVER","DROP","HASHCHANGE","GESTURE_START","GESTURE_CHANGE","GESTURE_END","BEFORE_UNLOAD","fonts","componentDidUpdate","prevProps","prevWidth","prevHeight","currentWidth","currentHeight","pointerViewportCoords","pointerUsernames","sockets","restoreUsernameFromLocalStorage","resetSelection","updateElement","_element","updateTextElement","onSubmit","onCancel","getViewportCoords","updateWysiwygStyle","viewportX","viewportY","transform","tabIndex","wrap","backfaceVisibility","outline","oninput","onkeydown","handleSubmit","stopEvent","cleanup","isDestroyed","onblur","rebindBlur","unbindUpdate","closest","textWysiwyg","originInGrid","scrollbars","lastCoords","hasBeenDuplicated","drag","hasOccurred","getDragOffsetXY","resizeX","resizeY","setResizeHandle","normalizeResizeHandle","resizeElements","newResizeHandle","handlePointDragging","dragX","dragY","dragSelectedElements","elementsToAppend","duplicatedElement","originDragX","originDragY","simplify","elementsWithinSelection","selectionX1","selectionY1","selectionX2","selectionY2","getElementsWithinSelection","childEvent","handlePointerUp","_prevState","elementClickedInside","getElementContainingPosition","isLocalhost","hostname","registerValidSW","swUrl","config","serviceWorker","registration","onupdatefound","installingWorker","installing","onstatechange","controller","onUpdate","onSuccess","checkValidServiceWorker","contentType","ready","unregister","userAgent","SentryEnvHostnameMap","onlineEnv","REACT_APP_DISABLE_SENTRY","ExcalidrawApp","dimensions","setDimensions","dsn","environment","release","ignoreErrors","integrations","SentryIntegrations","levels","beforeSend","request","__EXCALIDRAW_SHA__","rootElement","getElementById","ReactDOM","info","registerServiceWorker","waitingServiceWorker","waiting","STATE_CHANGE","postMessage","launchQueue","setConsumer","launchParams","getFile","webpackAsyncContext","req","__webpack_require__","o","ids","all","module","exports"],"mappings":"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MAAMlsD,OACtB,OAEF,MAAMq+B,EAAas5B,EAAazL,MAAM,GAChC7uB,QAAagB,EAAWu5B,UAC9Bz6B,GAAaE,M,i4NC3InB,IAAI57B,EAAM,CACT,cAAe,CACd,IACA,EACA,IAED,UAAW,CACV,GACA,EACA,GAED,eAAgB,CACf,GACA,EACA,GAED,UAAW,CACV,GACA,EACA,GAED,eAAgB,CACf,GACA,EACA,GAED,UAAW,CACV,GACA,EACA,GAED,eAAgB,CACf,GACA,EACA,GAED,UAAW,CACV,GACA,EACA,GAED,eAAgB,CACf,GACA,EACA,GAED,UAAW,CACV,GACA,EACA,GAED,eAAgB,CACf,GACA,EACA,GAED,OAAQ,CACP,GACA,GAED,YAAa,CACZ,GACA,GAED,UAAW,CACV,GACA,EACA,GAED,eAAgB,CACf,GACA,EACA,GAED,UAAW,CACV,GACA,EACA,GAED,eAAgB,CACf,GACA,EACA,GAED,UAAW,CACV,GACA,EACA,GAED,eAAgB,CACf,GACA,EACA,GAED,UAAW,CACV,GACA,EACA,GAED,eAAgB,CACf,GACA,EACA,GAED,UAAW,CACV,GACA,EACA,GAED,eAAgB,CACf,GACA,EACA,GAED,UAAW,CACV,GACA,EACA,IAED,eAAgB,CACf,GACA,EACA,IAED,UAAW,CACV,GACA,EACA,IAED,eAAgB,CACf,GACA,EACA,IAED,UAAW,CACV,GACA,EACA,IAED,eAAgB,CACf,GACA,EACA,IAED,UAAW,CACV,GACA,EACA,IAED,eAAgB,CACf,GACA,EACA,IAED,UAAW,CACV,GACA,EACA,IAED,eAAgB,CACf,GACA,EACA,IAED,UAAW,CACV,GACA,EACA,IAED,eAAgB,CACf,GACA,EACA,IAED,UAAW,CACV,GACA,EACA,IAED,eAAgB,CACf,GACA,EACA,IAED,UAAW,CACV,GACA,EACA,IAED,eAAgB,CACf,GACA,EACA,IAED,UAAW,CACV,GACA,EACA,IAED,eAAgB,CACf,GACA,EACA,IAED,gBAAiB,CAChB,GACA,GAED,qBAAsB,CACrB,GACA,GAED,UAAW,CACV,GACA,EACA,IAED,eAAgB,CACf,GACA,EACA,IAED,UAAW,CACV,GACA,EACA,IAED,eAAgB,CACf,GACA,EACA,IAED,UAAW,CACV,GACA,EACA,IAED,eAAgB,CACf,GACA,EACA,IAED,UAAW,CACV,GACA,EACA,IAED,eAAgB,CACf,GACA,EACA,IAED,UAAW,CACV,GACA,EACA,IAED,eAAgB,CACf,GACA,EACA,IAED,UAAW,CACV,GACA,EACA,IAED,eAAgB,CACf,GACA,EACA,IAED,UAAW,CACV,GACA,EACA,IAED,eAAgB,CACf,GACA,EACA,IAED,UAAW,CACV,GACA,EACA,IAED,eAAgB,CACf,GACA,EACA,KAGF,SAASo2D,EAAoBC,GAC5B,IAAIC,EAAoBC,EAAEv2D,EAAKq2D,GAC9B,OAAOv6B,QAAQC,UAAUgW,MAAK,WAC7B,IAAIj0C,EAAI,IAAIyH,MAAM,uBAAyB8wD,EAAM,KAEjD,MADAv4D,EAAE2uC,KAAO,mBACH3uC,KAIR,IAAI04D,EAAMx2D,EAAIq2D,GAAMhoD,EAAKmoD,EAAI,GAC7B,OAAO16B,QAAQ26B,IAAID,EAAIxnD,MAAM,GAAGhP,IAAIs2D,EAAoBx4D,IAAIi0C,MAAK,WAChE,OAAOukB,EAAoBrzD,EAAEoL,EAAImoD,EAAI,OAGvCJ,EAAoBv/C,KAAO,WAC1B,OAAO1I,OAAO0I,KAAK7W,IAEpBo2D,EAAoB/nD,GAAK,GACzBqoD,EAAOC,QAAUP,G","file":"static/js/main.95ff27bc.chunk.js","sourcesContent":["import { FontFamily } from \"./element/types\";\n\nexport const DRAGGING_THRESHOLD = 10; // 10px\nexport const LINE_CONFIRM_THRESHOLD = 10; // 10px\nexport const ELEMENT_SHIFT_TRANSLATE_AMOUNT = 5;\nexport const ELEMENT_TRANSLATE_AMOUNT = 1;\nexport const TEXT_TO_CENTER_SNAP_THRESHOLD = 30;\nexport const SHIFT_LOCKING_ANGLE = Math.PI / 12;\nexport const CURSOR_TYPE = {\n  TEXT: \"text\",\n  CROSSHAIR: \"crosshair\",\n  GRABBING: \"grabbing\",\n  POINTER: \"pointer\",\n};\nexport const POINTER_BUTTON = {\n  MAIN: 0,\n  WHEEL: 1,\n  SECONDARY: 2,\n  TOUCH: -1,\n};\n\nexport enum SCENE {\n  INIT = \"SCENE_INIT\",\n  UPDATE = \"SCENE_UPDATE\",\n}\n\nexport enum EVENT {\n  COPY = \"copy\",\n  PASTE = \"paste\",\n  CUT = \"cut\",\n  KEYDOWN = \"keydown\",\n  KEYUP = \"keyup\",\n  MOUSE_MOVE = \"mousemove\",\n  RESIZE = \"resize\",\n  UNLOAD = \"unload\",\n  BLUR = \"blur\",\n  DRAG_OVER = \"dragover\",\n  DROP = \"drop\",\n  GESTURE_END = \"gestureend\",\n  BEFORE_UNLOAD = \"beforeunload\",\n  GESTURE_START = \"gesturestart\",\n  GESTURE_CHANGE = \"gesturechange\",\n  POINTER_MOVE = \"pointermove\",\n  POINTER_UP = \"pointerup\",\n  STATE_CHANGE = \"statechange\",\n  WHEEL = \"wheel\",\n  TOUCH_START = \"touchstart\",\n  TOUCH_END = \"touchend\",\n  HASHCHANGE = \"hashchange\",\n}\n\nexport const ENV = {\n  TEST: \"test\",\n  DEVELOPMENT: \"development\",\n};\n\nexport const BROADCAST = {\n  SERVER_VOLATILE: \"server-volatile-broadcast\",\n  SERVER: \"server-broadcast\",\n};\n\nexport const CLASSES = {\n  SHAPE_ACTIONS_MENU: \"App-menu__left\",\n};\n\n// 1-based in case we ever do `if(element.fontFamily)`\nexport const FONT_FAMILY = {\n  1: \"Virgil\",\n  2: \"Helvetica\",\n  3: \"Cascadia\",\n} as const;\n\nexport const DEFAULT_FONT_SIZE = 20;\nexport const DEFAULT_FONT_FAMILY: FontFamily = 1;\nexport const DEFAULT_TEXT_ALIGN = \"left\";\nexport const DEFAULT_VERTICAL_ALIGN = \"top\";\n\nexport const CANVAS_ONLY_ACTIONS = [\"selectAll\"];\n\nexport const GRID_SIZE = 20; // TODO make it configurable?\n\nexport const LOCAL_STORAGE_KEY_COLLAB_FORCE_FLAG = \"collabLinkForceLoadFlag\";\n","import {\n  ExcalidrawElement,\n  ExcalidrawTextElement,\n  ExcalidrawLinearElement,\n} from \"./types\";\n\nexport const isTextElement = (\n  element: ExcalidrawElement | null,\n): element is ExcalidrawTextElement => {\n  return element != null && element.type === \"text\";\n};\n\nexport const isLinearElement = (\n  element?: ExcalidrawElement | null,\n): element is ExcalidrawLinearElement => {\n  return (\n    element != null &&\n    (element.type === \"arrow\" ||\n      element.type === \"line\" ||\n      element.type === \"draw\")\n  );\n};\n\nexport const isExcalidrawElement = (element: any): boolean => {\n  return (\n    element?.type === \"text\" ||\n    element?.type === \"diamond\" ||\n    element?.type === \"rectangle\" ||\n    element?.type === \"ellipse\" ||\n    element?.type === \"arrow\" ||\n    element?.type === \"draw\" ||\n    element?.type === \"line\"\n  );\n};\n","import { Point } from \"./types\";\nimport { LINE_CONFIRM_THRESHOLD } from \"./constants\";\nimport { ExcalidrawLinearElement } from \"./element/types\";\n\n// https://stackoverflow.com/a/6853926/232122\nexport const distanceBetweenPointAndSegment = (\n  x: number,\n  y: number,\n  x1: number,\n  y1: number,\n  x2: number,\n  y2: number,\n) => {\n  const A = x - x1;\n  const B = y - y1;\n  const C = x2 - x1;\n  const D = y2 - y1;\n\n  const dot = A * C + B * D;\n  const lenSquare = C * C + D * D;\n  let param = -1;\n  if (lenSquare !== 0) {\n    // in case of 0 length line\n    param = dot / lenSquare;\n  }\n\n  let xx, yy;\n  if (param < 0) {\n    xx = x1;\n    yy = y1;\n  } else if (param > 1) {\n    xx = x2;\n    yy = y2;\n  } else {\n    xx = x1 + param * C;\n    yy = y1 + param * D;\n  }\n\n  const dx = x - xx;\n  const dy = y - yy;\n  return Math.hypot(dx, dy);\n};\n\nexport const rotate = (\n  x1: number,\n  y1: number,\n  x2: number,\n  y2: number,\n  angle: number,\n): [number, number] =>\n  // =()cos()sin+\n  // =()sin+()cos+.\n  // https://math.stackexchange.com/questions/2204520/how-do-i-rotate-a-line-segment-in-a-specific-point-on-the-line\n  [\n    (x1 - x2) * Math.cos(angle) - (y1 - y2) * Math.sin(angle) + x2,\n    (x1 - x2) * Math.sin(angle) + (y1 - y2) * Math.cos(angle) + y2,\n  ];\n\nexport const adjustXYWithRotation = (\n  sides: {\n    n?: boolean;\n    e?: boolean;\n    s?: boolean;\n    w?: boolean;\n  },\n  x: number,\n  y: number,\n  angle: number,\n  deltaX1: number,\n  deltaY1: number,\n  deltaX2: number,\n  deltaY2: number,\n): [number, number] => {\n  const cos = Math.cos(angle);\n  const sin = Math.sin(angle);\n  if (sides.e && sides.w) {\n    x += deltaX1 + deltaX2;\n  } else if (sides.e) {\n    x += deltaX1 * (1 + cos);\n    y += deltaX1 * sin;\n    x += deltaX2 * (1 - cos);\n    y += deltaX2 * -sin;\n  } else if (sides.w) {\n    x += deltaX1 * (1 - cos);\n    y += deltaX1 * -sin;\n    x += deltaX2 * (1 + cos);\n    y += deltaX2 * sin;\n  }\n\n  if (sides.n && sides.s) {\n    y += deltaY1 + deltaY2;\n  } else if (sides.n) {\n    x += deltaY1 * sin;\n    y += deltaY1 * (1 - cos);\n    x += deltaY2 * -sin;\n    y += deltaY2 * (1 + cos);\n  } else if (sides.s) {\n    x += deltaY1 * -sin;\n    y += deltaY1 * (1 + cos);\n    x += deltaY2 * sin;\n    y += deltaY2 * (1 - cos);\n  }\n  return [x, y];\n};\n\nexport const getFlipAdjustment = (\n  side: \"n\" | \"s\" | \"w\" | \"e\" | \"nw\" | \"ne\" | \"sw\" | \"se\",\n  nextWidth: number,\n  nextHeight: number,\n  nextX1: number,\n  nextY1: number,\n  nextX2: number,\n  nextY2: number,\n  finalX1: number,\n  finalY1: number,\n  finalX2: number,\n  finalY2: number,\n  needsRotation: boolean,\n  angle: number,\n): [number, number] => {\n  const cos = Math.cos(angle);\n  const sin = Math.sin(angle);\n  let flipDiffX = 0;\n  let flipDiffY = 0;\n  if (nextWidth < 0) {\n    if (side === \"e\" || side === \"ne\" || side === \"se\") {\n      if (needsRotation) {\n        flipDiffX += (finalX2 - nextX1) * cos;\n        flipDiffY += (finalX2 - nextX1) * sin;\n      } else {\n        flipDiffX += finalX2 - nextX1;\n      }\n    }\n    if (side === \"w\" || side === \"nw\" || side === \"sw\") {\n      if (needsRotation) {\n        flipDiffX += (finalX1 - nextX2) * cos;\n        flipDiffY += (finalX1 - nextX2) * sin;\n      } else {\n        flipDiffX += finalX1 - nextX2;\n      }\n    }\n  }\n  if (nextHeight < 0) {\n    if (side === \"s\" || side === \"se\" || side === \"sw\") {\n      if (needsRotation) {\n        flipDiffY += (finalY2 - nextY1) * cos;\n        flipDiffX += (finalY2 - nextY1) * -sin;\n      } else {\n        flipDiffY += finalY2 - nextY1;\n      }\n    }\n    if (side === \"n\" || side === \"ne\" || side === \"nw\") {\n      if (needsRotation) {\n        flipDiffY += (finalY1 - nextY2) * cos;\n        flipDiffX += (finalY1 - nextY2) * -sin;\n      } else {\n        flipDiffY += finalY1 - nextY2;\n      }\n    }\n  }\n  return [flipDiffX, flipDiffY];\n};\n\nexport const getPointOnAPath = (point: Point, path: Point[]) => {\n  const [px, py] = point;\n  const [start, ...other] = path;\n  let [lastX, lastY] = start;\n  let kLine: number = 0;\n  let idx: number = 0;\n\n  // if any item in the array is true, it means that a point is\n  // on some segment of a line based path\n  const retVal = other.some(([x2, y2], i) => {\n    // we always take a line when dealing with line segments\n    const x1 = lastX;\n    const y1 = lastY;\n\n    lastX = x2;\n    lastY = y2;\n\n    // if a point is not within the domain of the line segment\n    // it is not on the line segment\n    if (px < x1 || px > x2) {\n      return false;\n    }\n\n    // check if all points lie on the same line\n    // y1 = kx1 + b, y2 = kx2 + b\n    // y2 - y1 = k(x2 - x2) -> k = (y2 - y1) / (x2 - x1)\n\n    // coefficient for the line (p0, p1)\n    const kL = (y2 - y1) / (x2 - x1);\n\n    // coefficient for the line segment (p0, point)\n    const kP1 = (py - y1) / (px - x1);\n\n    // coefficient for the line segment (point, p1)\n    const kP2 = (py - y2) / (px - x2);\n\n    // because we are basing both lines from the same starting point\n    // the only option for collinearity is having same coefficients\n\n    // using it for floating point comparisons\n    const epsilon = 0.3;\n\n    // if coefficient is more than an arbitrary epsilon,\n    // these lines are nor collinear\n    if (Math.abs(kP1 - kL) > epsilon && Math.abs(kP2 - kL) > epsilon) {\n      return false;\n    }\n\n    // store the coefficient because we are goint to need it\n    kLine = kL;\n    idx = i;\n\n    return true;\n  });\n\n  // Return a coordinate that is always on the line segment\n  if (retVal === true) {\n    return { x: point[0], y: kLine * point[0], segment: idx };\n  }\n\n  return null;\n};\n\nexport const distance2d = (x1: number, y1: number, x2: number, y2: number) => {\n  const xd = x2 - x1;\n  const yd = y2 - y1;\n  return Math.hypot(xd, yd);\n};\n\n// Checks if the first and last point are close enough\n// to be considered a loop\nexport const isPathALoop = (\n  points: ExcalidrawLinearElement[\"points\"],\n): boolean => {\n  if (points.length >= 3) {\n    const [firstPoint, lastPoint] = [points[0], points[points.length - 1]];\n    return (\n      distance2d(firstPoint[0], firstPoint[1], lastPoint[0], lastPoint[1]) <=\n      LINE_CONFIRM_THRESHOLD\n    );\n  }\n  return false;\n};\n\n// Draw a line from the point to the right till infiinty\n// Check how many lines of the polygon does this infinite line intersects with\n// If the number of intersections is odd, point is in the polygon\nexport const isPointInPolygon = (\n  points: Point[],\n  x: number,\n  y: number,\n): boolean => {\n  const vertices = points.length;\n\n  // There must be at least 3 vertices in polygon\n  if (vertices < 3) {\n    return false;\n  }\n  const extreme: Point = [Number.MAX_SAFE_INTEGER, y];\n  const p: Point = [x, y];\n  let count = 0;\n  for (let i = 0; i < vertices; i++) {\n    const current = points[i];\n    const next = points[(i + 1) % vertices];\n    if (doIntersect(current, next, p, extreme)) {\n      if (orientation(current, p, next) === 0) {\n        return onSegment(current, p, next);\n      }\n      count++;\n    }\n  }\n  // true if count is off\n  return count % 2 === 1;\n};\n\n// Check if q lies on the line segment pr\nconst onSegment = (p: Point, q: Point, r: Point) => {\n  return (\n    q[0] <= Math.max(p[0], r[0]) &&\n    q[0] >= Math.min(p[0], r[0]) &&\n    q[1] <= Math.max(p[1], r[1]) &&\n    q[1] >= Math.min(p[1], r[1])\n  );\n};\n\n// For the ordered points p, q, r, return\n// 0 if p, q, r are collinear\n// 1 if Clockwise\n// 2 if counterclickwise\nconst orientation = (p: Point, q: Point, r: Point) => {\n  const val = (q[1] - p[1]) * (r[0] - q[0]) - (q[0] - p[0]) * (r[1] - q[1]);\n  if (val === 0) {\n    return 0;\n  }\n  return val > 0 ? 1 : 2;\n};\n\n// Check is p1q1 intersects with p2q2\nconst doIntersect = (p1: Point, q1: Point, p2: Point, q2: Point) => {\n  const o1 = orientation(p1, q1, p2);\n  const o2 = orientation(p1, q1, q2);\n  const o3 = orientation(p2, q2, p1);\n  const o4 = orientation(p2, q2, q1);\n\n  if (o1 !== o2 && o3 !== o4) {\n    return true;\n  }\n\n  // p1, q1 and p2 are colinear and p2 lies on segment p1q1\n  if (o1 === 0 && onSegment(p1, p2, q1)) {\n    return true;\n  }\n\n  // p1, q1 and p2 are colinear and q2 lies on segment p1q1\n  if (o2 === 0 && onSegment(p1, q2, q1)) {\n    return true;\n  }\n\n  // p2, q2 and p1 are colinear and p1 lies on segment p2q2\n  if (o3 === 0 && onSegment(p2, p1, q2)) {\n    return true;\n  }\n\n  // p2, q2 and q1 are colinear and q1 lies on segment p2q2\n  if (o4 === 0 && onSegment(p2, q1, q2)) {\n    return true;\n  }\n\n  return false;\n};\n\nexport const getGridPoint = (\n  x: number,\n  y: number,\n  gridSize: number | null,\n): [number, number] => {\n  if (gridSize) {\n    return [\n      Math.round(x / gridSize) * gridSize,\n      Math.round(y / gridSize) * gridSize,\n    ];\n  }\n  return [x, y];\n};\n","import { Point } from \"./types\";\n\nexport const getSizeFromPoints = (points: readonly Point[]) => {\n  const xs = points.map((point) => point[0]);\n  const ys = points.map((point) => point[1]);\n  return {\n    width: Math.max(...xs) - Math.min(...xs),\n    height: Math.max(...ys) - Math.min(...ys),\n  };\n};\nexport const rescalePoints = (\n  dimension: 0 | 1,\n  nextDimensionSize: number,\n  prevPoints: readonly Point[],\n): Point[] => {\n  const prevDimValues = prevPoints.map((point) => point[dimension]);\n  const prevMaxDimension = Math.max(...prevDimValues);\n  const prevMinDimension = Math.min(...prevDimValues);\n  const prevDimensionSize = prevMaxDimension - prevMinDimension;\n\n  const dimensionScaleFactor =\n    prevDimensionSize === 0 ? 1 : nextDimensionSize / prevDimensionSize;\n\n  let nextMinDimension = Infinity;\n\n  const scaledPoints = prevPoints.map(\n    (prevPoint) =>\n      prevPoint.map((value, currentDimension) => {\n        if (currentDimension !== dimension) {\n          return value;\n        }\n        const scaledValue = value * dimensionScaleFactor;\n        nextMinDimension = Math.min(scaledValue, nextMinDimension);\n        return scaledValue;\n      }) as [number, number],\n  );\n\n  if (scaledPoints.length === 2) {\n    // we don't tranlate two-point lines\n    return scaledPoints;\n  }\n\n  const translation = prevMinDimension - nextMinDimension;\n\n  const nextPoints = scaledPoints.map(\n    (scaledPoint) =>\n      scaledPoint.map((value, currentDimension) => {\n        return currentDimension === dimension ? value + translation : value;\n      }) as [number, number],\n  );\n\n  return nextPoints;\n};\n","import { ExcalidrawElement, ExcalidrawLinearElement } from \"./types\";\nimport { distance2d, rotate } from \"../math\";\nimport rough from \"roughjs/bin/rough\";\nimport { Drawable, Op } from \"roughjs/bin/core\";\nimport { Point } from \"../types\";\nimport {\n  getShapeForElement,\n  generateRoughOptions,\n} from \"../renderer/renderElement\";\nimport { isLinearElement } from \"./typeChecks\";\nimport { rescalePoints } from \"../points\";\n\n// If the element is created from right to left, the width is going to be negative\n// This set of functions retrieves the absolute position of the 4 points.\nexport const getElementAbsoluteCoords = (\n  element: ExcalidrawElement,\n): [number, number, number, number] => {\n  if (isLinearElement(element)) {\n    return getLinearElementAbsoluteCoords(element);\n  }\n  return [\n    element.x,\n    element.y,\n    element.x + element.width,\n    element.y + element.height,\n  ];\n};\n\nexport const getDiamondPoints = (element: ExcalidrawElement) => {\n  // Here we add +1 to avoid these numbers to be 0\n  // otherwise rough.js will throw an error complaining about it\n  const topX = Math.floor(element.width / 2) + 1;\n  const topY = 0;\n  const rightX = element.width;\n  const rightY = Math.floor(element.height / 2) + 1;\n  const bottomX = topX;\n  const bottomY = element.height;\n  const leftX = topY;\n  const leftY = rightY;\n\n  return [topX, topY, rightX, rightY, bottomX, bottomY, leftX, leftY];\n};\n\nexport const getCurvePathOps = (shape: Drawable): Op[] => {\n  for (const set of shape.sets) {\n    if (set.type === \"path\") {\n      return set.ops;\n    }\n  }\n  return shape.sets[0].ops;\n};\n\nconst getMinMaxXYFromCurvePathOps = (\n  ops: Op[],\n  transformXY?: (x: number, y: number) => [number, number],\n): [number, number, number, number] => {\n  let currentP: Point = [0, 0];\n  const { minX, minY, maxX, maxY } = ops.reduce(\n    (limits, { op, data }) => {\n      // There are only four operation types:\n      // move, bcurveTo, lineTo, and curveTo\n      if (op === \"move\") {\n        // change starting point\n        currentP = (data as unknown) as Point;\n        // move operation does not draw anything; so, it always\n        // returns false\n      } else if (op === \"bcurveTo\") {\n        // create points from bezier curve\n        // bezier curve stores data as a flattened array of three positions\n        // [x1, y1, x2, y2, x3, y3]\n        const p1 = [data[0], data[1]] as Point;\n        const p2 = [data[2], data[3]] as Point;\n        const p3 = [data[4], data[5]] as Point;\n\n        const p0 = currentP;\n        currentP = p3;\n\n        const equation = (t: number, idx: number) =>\n          Math.pow(1 - t, 3) * p3[idx] +\n          3 * t * Math.pow(1 - t, 2) * p2[idx] +\n          3 * Math.pow(t, 2) * (1 - t) * p1[idx] +\n          p0[idx] * Math.pow(t, 3);\n\n        let t = 0;\n        while (t <= 1.0) {\n          let x = equation(t, 0);\n          let y = equation(t, 1);\n          if (transformXY) {\n            [x, y] = transformXY(x, y);\n          }\n\n          limits.minY = Math.min(limits.minY, y);\n          limits.minX = Math.min(limits.minX, x);\n\n          limits.maxX = Math.max(limits.maxX, x);\n          limits.maxY = Math.max(limits.maxY, y);\n\n          t += 0.1;\n        }\n      } else if (op === \"lineTo\") {\n        // TODO: Implement this\n      } else if (op === \"qcurveTo\") {\n        // TODO: Implement this\n      }\n      return limits;\n    },\n    { minX: Infinity, minY: Infinity, maxX: -Infinity, maxY: -Infinity },\n  );\n\n  return [minX, minY, maxX, maxY];\n};\n\nconst getLinearElementAbsoluteCoords = (\n  element: ExcalidrawLinearElement,\n): [number, number, number, number] => {\n  if (element.points.length < 2 || !getShapeForElement(element)) {\n    // XXX this is just a poor estimate and not very useful\n    const { minX, minY, maxX, maxY } = element.points.reduce(\n      (limits, [x, y]) => {\n        limits.minY = Math.min(limits.minY, y);\n        limits.minX = Math.min(limits.minX, x);\n\n        limits.maxX = Math.max(limits.maxX, x);\n        limits.maxY = Math.max(limits.maxY, y);\n\n        return limits;\n      },\n      { minX: Infinity, minY: Infinity, maxX: -Infinity, maxY: -Infinity },\n    );\n    return [\n      minX + element.x,\n      minY + element.y,\n      maxX + element.x,\n      maxY + element.y,\n    ];\n  }\n\n  const shape = getShapeForElement(element) as Drawable[];\n\n  // first element is always the curve\n  const ops = getCurvePathOps(shape[0]);\n\n  const [minX, minY, maxX, maxY] = getMinMaxXYFromCurvePathOps(ops);\n\n  return [\n    minX + element.x,\n    minY + element.y,\n    maxX + element.x,\n    maxY + element.y,\n  ];\n};\n\nexport const getArrowPoints = (\n  element: ExcalidrawLinearElement,\n  shape: Drawable[],\n) => {\n  const ops = getCurvePathOps(shape[0]);\n\n  const data = ops[ops.length - 1].data;\n  const p3 = [data[4], data[5]] as Point;\n  const p2 = [data[2], data[3]] as Point;\n  const p1 = [data[0], data[1]] as Point;\n\n  // we need to find p0 of the bezier curve\n  // it is typically the last point of the previous\n  // curve; it can also be the position of moveTo operation\n  const prevOp = ops[ops.length - 2];\n  let p0: Point = [0, 0];\n  if (prevOp.op === \"move\") {\n    p0 = (prevOp.data as unknown) as Point;\n  } else if (prevOp.op === \"bcurveTo\") {\n    p0 = [prevOp.data[4], prevOp.data[5]];\n  }\n\n  // B(t) = p0 * (1-t)^3 + 3p1 * t * (1-t)^2 + 3p2 * t^2 * (1-t) + p3 * t^3\n  const equation = (t: number, idx: number) =>\n    Math.pow(1 - t, 3) * p3[idx] +\n    3 * t * Math.pow(1 - t, 2) * p2[idx] +\n    3 * Math.pow(t, 2) * (1 - t) * p1[idx] +\n    p0[idx] * Math.pow(t, 3);\n\n  // we know the last point of the arrow\n  const [x2, y2] = p3;\n\n  // by using cubic bezier equation (B(t)) and the given parameters,\n  // we calculate a point that is closer to the last point\n  // The value 0.3 is chosen arbitrarily and it works best for all\n  // the tested cases\n  const [x1, y1] = [equation(0.3, 0), equation(0.3, 1)];\n\n  // find the normalized direction vector based on the\n  // previously calculated points\n  const distance = Math.hypot(x2 - x1, y2 - y1);\n  const nx = (x2 - x1) / distance;\n  const ny = (y2 - y1) / distance;\n\n  const size = 30; // pixels\n  const arrowLength = element.points.reduce((total, [cx, cy], idx, points) => {\n    const [px, py] = idx > 0 ? points[idx - 1] : [0, 0];\n    return total + Math.hypot(cx - px, cy - py);\n  }, 0);\n\n  // Scale down the arrow until we hit a certain size so that it doesn't look weird\n  // This value is selected by minizing a minmum size with the whole length of the arrow\n  // intead of last segment of the arrow\n  const minSize = Math.min(size, arrowLength / 2);\n  const xs = x2 - nx * minSize;\n  const ys = y2 - ny * minSize;\n\n  const angle = 20; // degrees\n  const [x3, y3] = rotate(xs, ys, x2, y2, (-angle * Math.PI) / 180);\n  const [x4, y4] = rotate(xs, ys, x2, y2, (angle * Math.PI) / 180);\n\n  return [x2, y2, x3, y3, x4, y4];\n};\n\nconst getLinearElementRotatedBounds = (\n  element: ExcalidrawLinearElement,\n  cx: number,\n  cy: number,\n): [number, number, number, number] => {\n  if (element.points.length < 2 || !getShapeForElement(element)) {\n    // XXX this is just a poor estimate and not very useful\n    const { minX, minY, maxX, maxY } = element.points.reduce(\n      (limits, [x, y]) => {\n        [x, y] = rotate(element.x + x, element.y + y, cx, cy, element.angle);\n        limits.minY = Math.min(limits.minY, y);\n        limits.minX = Math.min(limits.minX, x);\n        limits.maxX = Math.max(limits.maxX, x);\n        limits.maxY = Math.max(limits.maxY, y);\n        return limits;\n      },\n      { minX: Infinity, minY: Infinity, maxX: -Infinity, maxY: -Infinity },\n    );\n    return [minX, minY, maxX, maxY];\n  }\n\n  const shape = getShapeForElement(element) as Drawable[];\n\n  // first element is always the curve\n  const ops = getCurvePathOps(shape[0]);\n\n  const transformXY = (x: number, y: number) =>\n    rotate(element.x + x, element.y + y, cx, cy, element.angle);\n  return getMinMaxXYFromCurvePathOps(ops, transformXY);\n};\n\nexport const getElementBounds = (\n  element: ExcalidrawElement,\n): [number, number, number, number] => {\n  const [x1, y1, x2, y2] = getElementAbsoluteCoords(element);\n  const cx = (x1 + x2) / 2;\n  const cy = (y1 + y2) / 2;\n  if (isLinearElement(element)) {\n    return getLinearElementRotatedBounds(element, cx, cy);\n  }\n  if (element.type === \"diamond\") {\n    const [x11, y11] = rotate(cx, y1, cx, cy, element.angle);\n    const [x12, y12] = rotate(cx, y2, cx, cy, element.angle);\n    const [x22, y22] = rotate(x1, cy, cx, cy, element.angle);\n    const [x21, y21] = rotate(x2, cy, cx, cy, element.angle);\n    const minX = Math.min(x11, x12, x22, x21);\n    const minY = Math.min(y11, y12, y22, y21);\n    const maxX = Math.max(x11, x12, x22, x21);\n    const maxY = Math.max(y11, y12, y22, y21);\n    return [minX, minY, maxX, maxY];\n  }\n  if (element.type === \"ellipse\") {\n    const w = (x2 - x1) / 2;\n    const h = (y2 - y1) / 2;\n    const cos = Math.cos(element.angle);\n    const sin = Math.sin(element.angle);\n    const ww = Math.hypot(w * cos, h * sin);\n    const hh = Math.hypot(h * cos, w * sin);\n    return [cx - ww, cy - hh, cx + ww, cy + hh];\n  }\n  const [x11, y11] = rotate(x1, y1, cx, cy, element.angle);\n  const [x12, y12] = rotate(x1, y2, cx, cy, element.angle);\n  const [x22, y22] = rotate(x2, y2, cx, cy, element.angle);\n  const [x21, y21] = rotate(x2, y1, cx, cy, element.angle);\n  const minX = Math.min(x11, x12, x22, x21);\n  const minY = Math.min(y11, y12, y22, y21);\n  const maxX = Math.max(x11, x12, x22, x21);\n  const maxY = Math.max(y11, y12, y22, y21);\n  return [minX, minY, maxX, maxY];\n};\n\nexport const getCommonBounds = (\n  elements: readonly ExcalidrawElement[],\n): [number, number, number, number] => {\n  if (!elements.length) {\n    return [0, 0, 0, 0];\n  }\n\n  let minX = Infinity;\n  let maxX = -Infinity;\n  let minY = Infinity;\n  let maxY = -Infinity;\n\n  elements.forEach((element) => {\n    const [x1, y1, x2, y2] = getElementBounds(element);\n    minX = Math.min(minX, x1);\n    minY = Math.min(minY, y1);\n    maxX = Math.max(maxX, x2);\n    maxY = Math.max(maxY, y2);\n  });\n\n  return [minX, minY, maxX, maxY];\n};\n\nexport const getResizedElementAbsoluteCoords = (\n  element: ExcalidrawElement,\n  nextWidth: number,\n  nextHeight: number,\n): [number, number, number, number] => {\n  if (!isLinearElement(element)) {\n    return [\n      element.x,\n      element.y,\n      element.x + nextWidth,\n      element.y + nextHeight,\n    ];\n  }\n\n  const points = rescalePoints(\n    0,\n    nextWidth,\n    rescalePoints(1, nextHeight, element.points),\n  );\n\n  const gen = rough.generator();\n  const curve = gen.curve(\n    points as [number, number][],\n    generateRoughOptions(element),\n  );\n  const ops = getCurvePathOps(curve);\n  const [minX, minY, maxX, maxY] = getMinMaxXYFromCurvePathOps(ops);\n  return [\n    minX + element.x,\n    minY + element.y,\n    maxX + element.x,\n    maxY + element.y,\n  ];\n};\n\nexport const getElementPointsCoords = (\n  element: ExcalidrawLinearElement,\n  points: readonly (readonly [number, number])[],\n): [number, number, number, number] => {\n  // This might be computationally heavey\n  const gen = rough.generator();\n  const curve = gen.curve(\n    points as [number, number][],\n    generateRoughOptions(element),\n  );\n  const ops = getCurvePathOps(curve);\n  const [minX, minY, maxX, maxY] = getMinMaxXYFromCurvePathOps(ops);\n  return [\n    minX + element.x,\n    minY + element.y,\n    maxX + element.x,\n    maxY + element.y,\n  ];\n};\n\nexport const getClosestElementBounds = (\n  elements: readonly ExcalidrawElement[],\n  from: { x: number; y: number },\n): [number, number, number, number] => {\n  if (!elements.length) {\n    return [0, 0, 0, 0];\n  }\n\n  let minDistance = Infinity;\n  let closestElement = elements[0];\n\n  elements.forEach((element) => {\n    const [x1, y1, x2, y2] = getElementBounds(element);\n    const distance = distance2d((x1 + x2) / 2, (y1 + y2) / 2, from.x, from.y);\n\n    if (distance < minDistance) {\n      minDistance = distance;\n      closestElement = element;\n    }\n  });\n\n  return getElementBounds(closestElement);\n};\n","import {\n  ExcalidrawElement,\n  ExcalidrawTextElement,\n  NonDeletedExcalidrawElement,\n} from \"../element/types\";\nimport { isTextElement, isLinearElement } from \"../element/typeChecks\";\nimport {\n  getDiamondPoints,\n  getArrowPoints,\n  getElementAbsoluteCoords,\n} from \"../element/bounds\";\nimport { RoughCanvas } from \"roughjs/bin/canvas\";\nimport { Drawable, Options } from \"roughjs/bin/core\";\nimport { RoughSVG } from \"roughjs/bin/svg\";\nimport { RoughGenerator } from \"roughjs/bin/generator\";\nimport { SceneState } from \"../scene/types\";\nimport {\n  SVG_NS,\n  distance,\n  getFontString,\n  getFontFamilyString,\n  isRTL,\n} from \"../utils\";\nimport { isPathALoop } from \"../math\";\nimport rough from \"roughjs/bin/rough\";\n\nconst CANVAS_PADDING = 20;\n\nconst DASHARRAY_DASHED = [12, 8];\nconst DASHARRAY_DOTTED = [3, 6];\n\nexport interface ExcalidrawElementWithCanvas {\n  element: ExcalidrawElement | ExcalidrawTextElement;\n  canvas: HTMLCanvasElement;\n  canvasZoom: number;\n  canvasOffsetX: number;\n  canvasOffsetY: number;\n}\n\nconst generateElementCanvas = (\n  element: NonDeletedExcalidrawElement,\n  zoom: number,\n): ExcalidrawElementWithCanvas => {\n  const canvas = document.createElement(\"canvas\");\n  const context = canvas.getContext(\"2d\")!;\n\n  let canvasOffsetX = 0;\n  let canvasOffsetY = 0;\n\n  if (isLinearElement(element)) {\n    const [x1, y1, x2, y2] = getElementAbsoluteCoords(element);\n    canvas.width =\n      distance(x1, x2) * window.devicePixelRatio * zoom + CANVAS_PADDING * 2;\n    canvas.height =\n      distance(y1, y2) * window.devicePixelRatio * zoom + CANVAS_PADDING * 2;\n\n    canvasOffsetX =\n      element.x > x1\n        ? Math.floor(distance(element.x, x1)) * window.devicePixelRatio\n        : 0;\n    canvasOffsetY =\n      element.y > y1\n        ? Math.floor(distance(element.y, y1)) * window.devicePixelRatio\n        : 0;\n    context.translate(canvasOffsetX * zoom, canvasOffsetY * zoom);\n  } else {\n    canvas.width =\n      element.width * window.devicePixelRatio * zoom + CANVAS_PADDING * 2;\n    canvas.height =\n      element.height * window.devicePixelRatio * zoom + CANVAS_PADDING * 2;\n  }\n\n  context.translate(CANVAS_PADDING, CANVAS_PADDING);\n  context.scale(window.devicePixelRatio * zoom, window.devicePixelRatio * zoom);\n\n  const rc = rough.canvas(canvas);\n  drawElementOnCanvas(element, rc, context);\n  context.translate(-CANVAS_PADDING, -CANVAS_PADDING);\n  context.scale(\n    1 / (window.devicePixelRatio * zoom),\n    1 / (window.devicePixelRatio * zoom),\n  );\n  return { element, canvas, canvasZoom: zoom, canvasOffsetX, canvasOffsetY };\n};\n\nconst drawElementOnCanvas = (\n  element: NonDeletedExcalidrawElement,\n  rc: RoughCanvas,\n  context: CanvasRenderingContext2D,\n) => {\n  context.globalAlpha = element.opacity / 100;\n  switch (element.type) {\n    case \"rectangle\":\n    case \"diamond\":\n    case \"ellipse\": {\n      rc.draw(getShapeForElement(element) as Drawable);\n      break;\n    }\n    case \"arrow\":\n    case \"draw\":\n    case \"line\": {\n      (getShapeForElement(element) as Drawable[]).forEach((shape) => {\n        rc.draw(shape);\n      });\n      break;\n    }\n    default: {\n      if (isTextElement(element)) {\n        const rtl = isRTL(element.text);\n        const shouldTemporarilyAttach = rtl && !context.canvas.isConnected;\n        if (shouldTemporarilyAttach) {\n          // to correctly render RTL text mixed with LTR, we have to append it\n          //  to the DOM\n          document.body.appendChild(context.canvas);\n        }\n        context.canvas.setAttribute(\"dir\", rtl ? \"rtl\" : \"ltr\");\n        const font = context.font;\n        context.font = getFontString(element);\n        const fillStyle = context.fillStyle;\n        context.fillStyle = element.strokeColor;\n        const textAlign = context.textAlign;\n        context.textAlign = element.textAlign as CanvasTextAlign;\n\n        // Canvas does not support multiline text by default\n        const lines = element.text.replace(/\\r\\n?/g, \"\\n\").split(\"\\n\");\n        const lineHeight = element.height / lines.length;\n        const verticalOffset = element.height - element.baseline;\n        const horizontalOffset =\n          element.textAlign === \"center\"\n            ? element.width / 2\n            : element.textAlign === \"right\"\n            ? element.width\n            : 0;\n        for (let i = 0; i < lines.length; i++) {\n          context.fillText(\n            lines[i],\n            horizontalOffset,\n            (i + 1) * lineHeight - verticalOffset,\n          );\n        }\n        context.fillStyle = fillStyle;\n        context.font = font;\n        context.textAlign = textAlign;\n        if (shouldTemporarilyAttach) {\n          context.canvas.remove();\n        }\n      } else {\n        throw new Error(`Unimplemented type ${element.type}`);\n      }\n    }\n  }\n  context.globalAlpha = 1;\n};\n\nconst elementWithCanvasCache = new WeakMap<\n  ExcalidrawElement,\n  ExcalidrawElementWithCanvas\n>();\n\nconst shapeCache = new WeakMap<\n  ExcalidrawElement,\n  Drawable | Drawable[] | null\n>();\n\nexport const getShapeForElement = (element: ExcalidrawElement) =>\n  shapeCache.get(element);\n\nexport const invalidateShapeForElement = (element: ExcalidrawElement) =>\n  shapeCache.delete(element);\n\nexport const generateRoughOptions = (element: ExcalidrawElement): Options => {\n  const options: Options = {\n    seed: element.seed,\n    strokeLineDash:\n      element.strokeStyle === \"dashed\"\n        ? DASHARRAY_DASHED\n        : element.strokeStyle === \"dotted\"\n        ? DASHARRAY_DOTTED\n        : undefined,\n    // for non-solid strokes, disable multiStroke because it tends to make\n    //  dashes/dots overlay each other\n    disableMultiStroke: element.strokeStyle !== \"solid\",\n    // for non-solid strokes, increase the width a bit to make it visually\n    //  similar to solid strokes, because we're also disabling multiStroke\n    strokeWidth:\n      element.strokeStyle !== \"solid\"\n        ? element.strokeWidth + 0.5\n        : element.strokeWidth,\n    // when increasing strokeWidth, we must explicitly set fillWeight and\n    //  hachureGap because if not specified, roughjs uses strokeWidth to\n    //  calculate them (and we don't want the fills to be modified)\n    fillWeight: element.strokeWidth / 2,\n    hachureGap: element.strokeWidth * 4,\n    roughness: element.roughness,\n    stroke: element.strokeColor,\n  };\n\n  switch (element.type) {\n    case \"rectangle\":\n    case \"diamond\":\n    case \"ellipse\": {\n      options.fillStyle = element.fillStyle;\n      options.fill =\n        element.backgroundColor === \"transparent\"\n          ? undefined\n          : element.backgroundColor;\n      if (element.type === \"ellipse\") {\n        options.curveFitting = 1;\n      }\n      return options;\n    }\n    case \"line\":\n    case \"draw\": {\n      // If shape is a line and is a closed shape,\n      // fill the shape if a color is set.\n      if (isPathALoop(element.points)) {\n        options.fillStyle = element.fillStyle;\n        options.fill =\n          element.backgroundColor === \"transparent\"\n            ? undefined\n            : element.backgroundColor;\n      }\n      return options;\n    }\n    case \"arrow\":\n      return options;\n    default: {\n      throw new Error(`Unimplemented type ${element.type}`);\n    }\n  }\n};\n\nconst generateElementShape = (\n  element: NonDeletedExcalidrawElement,\n  generator: RoughGenerator,\n) => {\n  let shape = shapeCache.get(element) || null;\n  if (!shape) {\n    elementWithCanvasCache.delete(element);\n\n    switch (element.type) {\n      case \"rectangle\":\n        shape = generator.rectangle(\n          0,\n          0,\n          element.width,\n          element.height,\n          generateRoughOptions(element),\n        );\n\n        break;\n      case \"diamond\": {\n        const [\n          topX,\n          topY,\n          rightX,\n          rightY,\n          bottomX,\n          bottomY,\n          leftX,\n          leftY,\n        ] = getDiamondPoints(element);\n        shape = generator.polygon(\n          [\n            [topX, topY],\n            [rightX, rightY],\n            [bottomX, bottomY],\n            [leftX, leftY],\n          ],\n          generateRoughOptions(element),\n        );\n        break;\n      }\n      case \"ellipse\":\n        shape = generator.ellipse(\n          element.width / 2,\n          element.height / 2,\n          element.width,\n          element.height,\n          generateRoughOptions(element),\n        );\n        break;\n      case \"line\":\n      case \"draw\":\n      case \"arrow\": {\n        const options = generateRoughOptions(element);\n\n        // points array can be empty in the beginning, so it is important to add\n        // initial position to it\n        const points = element.points.length ? element.points : [[0, 0]];\n\n        // curve is always the first element\n        // this simplifies finding the curve for an element\n        shape = [generator.curve(points as [number, number][], options)];\n\n        // add lines only in arrow\n        if (element.type === \"arrow\") {\n          const [x2, y2, x3, y3, x4, y4] = getArrowPoints(element, shape);\n          // for dotted arrows caps, reduce gap to make it more legible\n          if (element.strokeStyle === \"dotted\") {\n            options.strokeLineDash = [3, 4];\n            // for solid/dashed, keep solid arrow cap\n          } else {\n            delete options.strokeLineDash;\n          }\n          shape.push(\n            ...[\n              generator.line(x3, y3, x2, y2, options),\n              generator.line(x4, y4, x2, y2, options),\n            ],\n          );\n        }\n        break;\n      }\n      case \"text\": {\n        // just to ensure we don't regenerate element.canvas on rerenders\n        shape = [];\n        break;\n      }\n    }\n    shapeCache.set(element, shape);\n  }\n};\n\nconst generateElementWithCanvas = (\n  element: NonDeletedExcalidrawElement,\n  sceneState?: SceneState,\n) => {\n  const zoom = sceneState ? sceneState.zoom : 1;\n  const prevElementWithCanvas = elementWithCanvasCache.get(element);\n  const shouldRegenerateBecauseZoom =\n    prevElementWithCanvas &&\n    prevElementWithCanvas.canvasZoom !== zoom &&\n    !sceneState?.shouldCacheIgnoreZoom;\n  if (!prevElementWithCanvas || shouldRegenerateBecauseZoom) {\n    const elementWithCanvas = generateElementCanvas(element, zoom);\n    elementWithCanvasCache.set(element, elementWithCanvas);\n    return elementWithCanvas;\n  }\n  return prevElementWithCanvas;\n};\n\nconst drawElementFromCanvas = (\n  elementWithCanvas: ExcalidrawElementWithCanvas,\n  rc: RoughCanvas,\n  context: CanvasRenderingContext2D,\n  sceneState: SceneState,\n) => {\n  const element = elementWithCanvas.element;\n  const [x1, y1, x2, y2] = getElementAbsoluteCoords(element);\n  const cx = ((x1 + x2) / 2 + sceneState.scrollX) * window.devicePixelRatio;\n  const cy = ((y1 + y2) / 2 + sceneState.scrollY) * window.devicePixelRatio;\n  context.scale(1 / window.devicePixelRatio, 1 / window.devicePixelRatio);\n  context.translate(cx, cy);\n  context.rotate(element.angle);\n  context.drawImage(\n    elementWithCanvas.canvas!,\n    (-(x2 - x1) / 2) * window.devicePixelRatio -\n      CANVAS_PADDING / elementWithCanvas.canvasZoom,\n    (-(y2 - y1) / 2) * window.devicePixelRatio -\n      CANVAS_PADDING / elementWithCanvas.canvasZoom,\n    elementWithCanvas.canvas!.width / elementWithCanvas.canvasZoom,\n    elementWithCanvas.canvas!.height / elementWithCanvas.canvasZoom,\n  );\n  context.rotate(-element.angle);\n  context.translate(-cx, -cy);\n  context.scale(window.devicePixelRatio, window.devicePixelRatio);\n\n  // Clear the nested element we appended to the DOM\n};\n\nexport const renderElement = (\n  element: NonDeletedExcalidrawElement,\n  rc: RoughCanvas,\n  context: CanvasRenderingContext2D,\n  renderOptimizations: boolean,\n  sceneState: SceneState,\n) => {\n  const generator = rc.generator;\n  switch (element.type) {\n    case \"selection\": {\n      context.translate(\n        element.x + sceneState.scrollX,\n        element.y + sceneState.scrollY,\n      );\n      const fillStyle = context.fillStyle;\n      context.fillStyle = \"rgba(0, 0, 255, 0.10)\";\n      context.fillRect(0, 0, element.width, element.height);\n      context.fillStyle = fillStyle;\n      context.translate(\n        -element.x - sceneState.scrollX,\n        -element.y - sceneState.scrollY,\n      );\n      break;\n    }\n    case \"rectangle\":\n    case \"diamond\":\n    case \"ellipse\":\n    case \"line\":\n    case \"draw\":\n    case \"arrow\":\n    case \"text\": {\n      generateElementShape(element, generator);\n      if (renderOptimizations) {\n        const elementWithCanvas = generateElementWithCanvas(\n          element,\n          sceneState,\n        );\n        drawElementFromCanvas(elementWithCanvas, rc, context, sceneState);\n      } else {\n        const [x1, y1, x2, y2] = getElementAbsoluteCoords(element);\n        const cx = (x1 + x2) / 2 + sceneState.scrollX;\n        const cy = (y1 + y2) / 2 + sceneState.scrollY;\n        const shiftX = (x2 - x1) / 2 - (element.x - x1);\n        const shiftY = (y2 - y1) / 2 - (element.y - y1);\n        context.translate(cx, cy);\n        context.rotate(element.angle);\n        context.translate(-shiftX, -shiftY);\n        drawElementOnCanvas(element, rc, context);\n        context.translate(shiftX, shiftY);\n        context.rotate(-element.angle);\n        context.translate(-cx, -cy);\n      }\n      break;\n    }\n    default: {\n      // @ts-ignore\n      throw new Error(`Unimplemented type ${element.type}`);\n    }\n  }\n};\n\nexport const renderElementToSvg = (\n  element: NonDeletedExcalidrawElement,\n  rsvg: RoughSVG,\n  svgRoot: SVGElement,\n  offsetX?: number,\n  offsetY?: number,\n) => {\n  const [x1, y1, x2, y2] = getElementAbsoluteCoords(element);\n  const cx = (x2 - x1) / 2 - (element.x - x1);\n  const cy = (y2 - y1) / 2 - (element.y - y1);\n  const degree = (180 * element.angle) / Math.PI;\n  const generator = rsvg.generator;\n  switch (element.type) {\n    case \"selection\": {\n      // Since this is used only during editing experience, which is canvas based,\n      // this should not happen\n      throw new Error(\"Selection rendering is not supported for SVG\");\n    }\n    case \"rectangle\":\n    case \"diamond\":\n    case \"ellipse\": {\n      generateElementShape(element, generator);\n      const node = rsvg.draw(getShapeForElement(element) as Drawable);\n      const opacity = element.opacity / 100;\n      if (opacity !== 1) {\n        node.setAttribute(\"stroke-opacity\", `${opacity}`);\n        node.setAttribute(\"fill-opacity\", `${opacity}`);\n      }\n      node.setAttribute(\n        \"transform\",\n        `translate(${offsetX || 0} ${\n          offsetY || 0\n        }) rotate(${degree} ${cx} ${cy})`,\n      );\n      svgRoot.appendChild(node);\n      break;\n    }\n    case \"line\":\n    case \"draw\":\n    case \"arrow\": {\n      generateElementShape(element, generator);\n      const group = svgRoot.ownerDocument!.createElementNS(SVG_NS, \"g\");\n      const opacity = element.opacity / 100;\n      (getShapeForElement(element) as Drawable[]).forEach((shape) => {\n        const node = rsvg.draw(shape);\n        if (opacity !== 1) {\n          node.setAttribute(\"stroke-opacity\", `${opacity}`);\n          node.setAttribute(\"fill-opacity\", `${opacity}`);\n        }\n        node.setAttribute(\n          \"transform\",\n          `translate(${offsetX || 0} ${\n            offsetY || 0\n          }) rotate(${degree} ${cx} ${cy})`,\n        );\n        if (\n          (element.type === \"line\" || element.type === \"draw\") &&\n          isPathALoop(element.points) &&\n          element.backgroundColor !== \"transparent\"\n        ) {\n          node.setAttribute(\"fill-rule\", \"evenodd\");\n        }\n        group.appendChild(node);\n      });\n      svgRoot.appendChild(group);\n      break;\n    }\n    default: {\n      if (isTextElement(element)) {\n        const opacity = element.opacity / 100;\n        const node = svgRoot.ownerDocument!.createElementNS(SVG_NS, \"g\");\n        if (opacity !== 1) {\n          node.setAttribute(\"stroke-opacity\", `${opacity}`);\n          node.setAttribute(\"fill-opacity\", `${opacity}`);\n        }\n        node.setAttribute(\n          \"transform\",\n          `translate(${offsetX || 0} ${\n            offsetY || 0\n          }) rotate(${degree} ${cx} ${cy})`,\n        );\n        const lines = element.text.replace(/\\r\\n?/g, \"\\n\").split(\"\\n\");\n        const lineHeight = element.height / lines.length;\n        const verticalOffset = element.height - element.baseline;\n        const horizontalOffset =\n          element.textAlign === \"center\"\n            ? element.width / 2\n            : element.textAlign === \"right\"\n            ? element.width\n            : 0;\n        const direction = isRTL(element.text) ? \"rtl\" : \"ltr\";\n        const textAnchor =\n          element.textAlign === \"center\"\n            ? \"middle\"\n            : element.textAlign === \"right\" || direction === \"rtl\"\n            ? \"end\"\n            : \"start\";\n        for (let i = 0; i < lines.length; i++) {\n          const text = svgRoot.ownerDocument!.createElementNS(SVG_NS, \"text\");\n          text.textContent = lines[i];\n          text.setAttribute(\"x\", `${horizontalOffset}`);\n          text.setAttribute(\"y\", `${(i + 1) * lineHeight - verticalOffset}`);\n          text.setAttribute(\"font-family\", getFontFamilyString(element));\n          text.setAttribute(\"font-size\", `${element.fontSize}px`);\n          text.setAttribute(\"fill\", element.strokeColor);\n          text.setAttribute(\"text-anchor\", textAnchor);\n          text.setAttribute(\"style\", \"white-space: pre;\");\n          text.setAttribute(\"direction\", direction);\n          node.appendChild(text);\n        }\n        svgRoot.appendChild(node);\n      } else {\n        // @ts-ignore\n        throw new Error(`Unimplemented type ${element.type}`);\n      }\n    }\n  }\n};\n","import { Random } from \"roughjs/bin/math\";\nimport nanoid from \"nanoid\";\n\nlet random = new Random(Date.now());\nlet testIdBase = 0;\n\nexport const randomInteger = () => Math.floor(random.next() * 2 ** 31);\n\nexport const reseed = (seed: number) => {\n  random = new Random(seed);\n  testIdBase = 0;\n};\n\nexport const randomId = () =>\n  process.env.NODE_ENV === \"test\" ? `id${testIdBase++}` : nanoid();\n","import { ExcalidrawElement } from \"./types\";\nimport { invalidateShapeForElement } from \"../renderer/renderElement\";\nimport { globalSceneState } from \"../scene\";\nimport { getSizeFromPoints } from \"../points\";\nimport { randomInteger } from \"../random\";\nimport { Point } from \"../types\";\n\ntype ElementUpdate<TElement extends ExcalidrawElement> = Omit<\n  Partial<TElement>,\n  \"id\" | \"seed\" | \"version\" | \"versionNonce\"\n>;\n\n// This function tracks updates of text elements for the purposes for collaboration.\n// The version is used to compare updates when more than one user is working in\n// the same drawing. Note: this will trigger the component to update. Make sure you\n// are calling it either from a React event handler or within unstable_batchedUpdates().\nexport const mutateElement = <TElement extends Mutable<ExcalidrawElement>>(\n  element: TElement,\n  updates: ElementUpdate<TElement>,\n) => {\n  let didChange = false;\n\n  // casting to any because can't use `in` operator\n  // (see https://github.com/microsoft/TypeScript/issues/21732)\n  const { points } = updates as any;\n\n  if (typeof points !== \"undefined\") {\n    updates = { ...getSizeFromPoints(points), ...updates };\n  }\n\n  for (const key in updates) {\n    const value = (updates as any)[key];\n    if (typeof value !== \"undefined\") {\n      if (\n        (element as any)[key] === value &&\n        // if object, always update in case its deep prop was mutated\n        (typeof value !== \"object\" || value === null || key === \"groupIds\")\n      ) {\n        continue;\n      }\n\n      if (key === \"points\") {\n        const prevPoints = (element as any)[key];\n        const nextPoints = value;\n        if (prevPoints.length === nextPoints.length) {\n          let didChangePoints = false;\n          let i = prevPoints.length;\n          while (--i) {\n            const prevPoint: Point = prevPoints[i];\n            const nextPoint: Point = nextPoints[i];\n            if (\n              prevPoint[0] !== nextPoint[0] ||\n              prevPoint[1] !== nextPoint[1]\n            ) {\n              didChangePoints = true;\n              break;\n            }\n          }\n          if (!didChangePoints) {\n            continue;\n          }\n        }\n      }\n\n      (element as any)[key] = value;\n      didChange = true;\n    }\n  }\n\n  if (!didChange) {\n    return;\n  }\n\n  if (\n    typeof updates.height !== \"undefined\" ||\n    typeof updates.width !== \"undefined\" ||\n    typeof points !== \"undefined\"\n  ) {\n    invalidateShapeForElement(element);\n  }\n\n  element.version++;\n  element.versionNonce = randomInteger();\n\n  globalSceneState.informMutation();\n};\n\nexport const newElementWith = <TElement extends ExcalidrawElement>(\n  element: TElement,\n  updates: ElementUpdate<TElement>,\n): TElement => ({\n  ...element,\n  ...updates,\n  version: element.version + 1,\n  versionNonce: randomInteger(),\n});\n","import { ExcalidrawElement } from \"./types\";\nimport { mutateElement } from \"./mutateElement\";\nimport { isLinearElement } from \"./typeChecks\";\nimport { SHIFT_LOCKING_ANGLE } from \"../constants\";\n\nexport const isInvisiblySmallElement = (\n  element: ExcalidrawElement,\n): boolean => {\n  if (isLinearElement(element)) {\n    return element.points.length < 2;\n  }\n  return element.width === 0 && element.height === 0;\n};\n\n/**\n * Makes a perfect shape or diagonal/horizontal/vertical line\n */\nexport const getPerfectElementSize = (\n  elementType: string,\n  width: number,\n  height: number,\n): { width: number; height: number } => {\n  const absWidth = Math.abs(width);\n  const absHeight = Math.abs(height);\n\n  if (\n    elementType === \"line\" ||\n    elementType === \"arrow\" ||\n    elementType === \"draw\"\n  ) {\n    const lockedAngle =\n      Math.round(Math.atan(absHeight / absWidth) / SHIFT_LOCKING_ANGLE) *\n      SHIFT_LOCKING_ANGLE;\n    if (lockedAngle === 0) {\n      height = 0;\n    } else if (lockedAngle === Math.PI / 2) {\n      width = 0;\n    } else {\n      height =\n        Math.round(absWidth * Math.tan(lockedAngle)) * Math.sign(height) ||\n        height;\n    }\n  } else if (elementType !== \"selection\") {\n    height = absWidth * Math.sign(height);\n  }\n  return { width, height };\n};\n\nexport const resizePerfectLineForNWHandler = (\n  element: ExcalidrawElement,\n  x: number,\n  y: number,\n) => {\n  const anchorX = element.x + element.width;\n  const anchorY = element.y + element.height;\n  const distanceToAnchorX = x - anchorX;\n  const distanceToAnchorY = y - anchorY;\n  if (Math.abs(distanceToAnchorX) < Math.abs(distanceToAnchorY) / 2) {\n    mutateElement(element, {\n      x: anchorX,\n      width: 0,\n      y,\n      height: -distanceToAnchorY,\n    });\n  } else if (Math.abs(distanceToAnchorY) < Math.abs(element.width) / 2) {\n    mutateElement(element, {\n      y: anchorY,\n      height: 0,\n    });\n  } else {\n    const nextHeight =\n      Math.sign(distanceToAnchorY) *\n      Math.sign(distanceToAnchorX) *\n      element.width;\n    mutateElement(element, {\n      x,\n      y: anchorY - nextHeight,\n      width: -distanceToAnchorX,\n      height: nextHeight,\n    });\n  }\n};\n\nexport const getNormalizedDimensions = (\n  element: Pick<ExcalidrawElement, \"width\" | \"height\" | \"x\" | \"y\">,\n): {\n  width: ExcalidrawElement[\"width\"];\n  height: ExcalidrawElement[\"height\"];\n  x: ExcalidrawElement[\"x\"];\n  y: ExcalidrawElement[\"y\"];\n} => {\n  const ret = {\n    width: element.width,\n    height: element.height,\n    x: element.x,\n    y: element.y,\n  };\n\n  if (element.width < 0) {\n    const nextWidth = Math.abs(element.width);\n    ret.width = nextWidth;\n    ret.x = element.x - nextWidth;\n  }\n\n  if (element.height < 0) {\n    const nextHeight = Math.abs(element.height);\n    ret.height = nextHeight;\n    ret.y = element.y - nextHeight;\n  }\n\n  return ret;\n};\n","import { GroupId, ExcalidrawElement, NonDeleted } from \"./element/types\";\nimport { AppState } from \"./types\";\nimport { getSelectedElements } from \"./scene\";\n\nexport function selectGroup(\n  groupId: GroupId,\n  appState: AppState,\n  elements: readonly NonDeleted<ExcalidrawElement>[],\n): AppState {\n  const elementsInGroup = elements.filter((element) =>\n    element.groupIds.includes(groupId),\n  );\n\n  if (elementsInGroup.length < 2) {\n    if (\n      appState.selectedGroupIds[groupId] ||\n      appState.editingGroupId === groupId\n    ) {\n      return {\n        ...appState,\n        selectedGroupIds: { ...appState.selectedGroupIds, [groupId]: false },\n        editingGroupId: null,\n      };\n    }\n    return appState;\n  }\n\n  return {\n    ...appState,\n    selectedGroupIds: { ...appState.selectedGroupIds, [groupId]: true },\n    selectedElementIds: {\n      ...appState.selectedElementIds,\n      ...Object.fromEntries(\n        elementsInGroup.map((element) => [element.id, true]),\n      ),\n    },\n  };\n}\n\n/**\n * If the element's group is selected, don't render an individual\n * selection border around it.\n */\nexport function isSelectedViaGroup(\n  appState: AppState,\n  element: ExcalidrawElement,\n) {\n  return !!element.groupIds\n    .filter((groupId) => groupId !== appState.editingGroupId)\n    .find((groupId) => appState.selectedGroupIds[groupId]);\n}\n\nexport function getSelectedGroupIds(appState: AppState): GroupId[] {\n  return Object.entries(appState.selectedGroupIds)\n    .filter(([groupId, isSelected]) => isSelected)\n    .map(([groupId, isSelected]) => groupId);\n}\n\n/**\n * When you select an element, you often want to actually select the whole group it's in, unless\n * you're currently editing that group.\n */\nexport function selectGroupsForSelectedElements(\n  appState: AppState,\n  elements: readonly NonDeleted<ExcalidrawElement>[],\n): AppState {\n  let nextAppState = { ...appState };\n\n  const selectedElements = getSelectedElements(elements, appState);\n\n  for (const selectedElement of selectedElements) {\n    let groupIds = selectedElement.groupIds;\n    if (appState.editingGroupId) {\n      // handle the case where a group is nested within a group\n      const indexOfEditingGroup = groupIds.indexOf(appState.editingGroupId);\n      if (indexOfEditingGroup > -1) {\n        groupIds = groupIds.slice(0, indexOfEditingGroup);\n      }\n    }\n    if (groupIds.length > 0) {\n      const groupId = groupIds[groupIds.length - 1];\n      nextAppState = selectGroup(groupId, nextAppState, elements);\n    }\n  }\n\n  return nextAppState;\n}\n\nexport function isElementInGroup(element: ExcalidrawElement, groupId: string) {\n  return element.groupIds.includes(groupId);\n}\n\nexport function getElementsInGroup(\n  elements: readonly ExcalidrawElement[],\n  groupId: string,\n) {\n  return elements.filter((element) => isElementInGroup(element, groupId));\n}\n\nexport function getSelectedGroupIdForElement(\n  element: ExcalidrawElement,\n  selectedGroupIds: { [groupId: string]: boolean },\n) {\n  return element.groupIds.find((groupId) => selectedGroupIds[groupId]);\n}\n\nexport function getNewGroupIdsForDuplication(\n  groupIds: ExcalidrawElement[\"groupIds\"],\n  editingGroupId: AppState[\"editingGroupId\"],\n  mapper: (groupId: GroupId) => GroupId,\n) {\n  const copy = [...groupIds];\n  const positionOfEditingGroupId = editingGroupId\n    ? groupIds.indexOf(editingGroupId)\n    : -1;\n  const endIndex =\n    positionOfEditingGroupId > -1 ? positionOfEditingGroupId : groupIds.length;\n  for (let i = 0; i < endIndex; i++) {\n    copy[i] = mapper(copy[i]);\n  }\n\n  return copy;\n}\n\nexport function addToGroup(\n  prevGroupIds: ExcalidrawElement[\"groupIds\"],\n  newGroupId: GroupId,\n  editingGroupId: AppState[\"editingGroupId\"],\n) {\n  // insert before the editingGroupId, or push to the end.\n  const groupIds = [...prevGroupIds];\n  const positionOfEditingGroupId = editingGroupId\n    ? groupIds.indexOf(editingGroupId)\n    : -1;\n  const positionToInsert =\n    positionOfEditingGroupId > -1 ? positionOfEditingGroupId : groupIds.length;\n  groupIds.splice(positionToInsert, 0, newGroupId);\n  return groupIds;\n}\n\nexport function removeFromSelectedGroups(\n  groupIds: ExcalidrawElement[\"groupIds\"],\n  selectedGroupIds: { [groupId: string]: boolean },\n) {\n  return groupIds.filter((groupId) => !selectedGroupIds[groupId]);\n}\n","import {\n  ExcalidrawElement,\n  ExcalidrawTextElement,\n  ExcalidrawLinearElement,\n  ExcalidrawGenericElement,\n  NonDeleted,\n  TextAlign,\n  FontFamily,\n  GroupId,\n  VerticalAlign,\n} from \"../element/types\";\nimport { measureText, getFontString } from \"../utils\";\nimport { randomInteger, randomId } from \"../random\";\nimport { newElementWith } from \"./mutateElement\";\nimport { getNewGroupIdsForDuplication } from \"../groups\";\nimport { AppState } from \"../types\";\nimport { getElementAbsoluteCoords } from \".\";\nimport { adjustXYWithRotation } from \"../math\";\nimport { getResizedElementAbsoluteCoords } from \"./bounds\";\n\ntype ElementConstructorOpts = MarkOptional<\n  Omit<ExcalidrawGenericElement, \"id\" | \"type\" | \"isDeleted\">,\n  | \"width\"\n  | \"height\"\n  | \"angle\"\n  | \"groupIds\"\n  | \"seed\"\n  | \"version\"\n  | \"versionNonce\"\n>;\n\nconst _newElementBase = <T extends ExcalidrawElement>(\n  type: T[\"type\"],\n  {\n    x,\n    y,\n    strokeColor,\n    backgroundColor,\n    fillStyle,\n    strokeWidth,\n    strokeStyle,\n    roughness,\n    opacity,\n    width = 0,\n    height = 0,\n    angle = 0,\n    groupIds = [],\n    ...rest\n  }: ElementConstructorOpts & Omit<Partial<ExcalidrawGenericElement>, \"type\">,\n) => ({\n  id: rest.id || randomId(),\n  type,\n  x,\n  y,\n  width,\n  height,\n  angle,\n  strokeColor,\n  backgroundColor,\n  fillStyle,\n  strokeWidth,\n  strokeStyle,\n  roughness,\n  opacity,\n  groupIds,\n  seed: rest.seed ?? randomInteger(),\n  version: rest.version || 1,\n  versionNonce: rest.versionNonce ?? 0,\n  isDeleted: false as false,\n});\n\nexport const newElement = (\n  opts: {\n    type: ExcalidrawGenericElement[\"type\"];\n  } & ElementConstructorOpts,\n): NonDeleted<ExcalidrawGenericElement> =>\n  _newElementBase<ExcalidrawGenericElement>(opts.type, opts);\n\n/** computes element x/y offset based on textAlign/verticalAlign */\nfunction getTextElementPositionOffsets(\n  opts: {\n    textAlign: ExcalidrawTextElement[\"textAlign\"];\n    verticalAlign: ExcalidrawTextElement[\"verticalAlign\"];\n  },\n  metrics: {\n    width: number;\n    height: number;\n  },\n) {\n  return {\n    x:\n      opts.textAlign === \"center\"\n        ? metrics.width / 2\n        : opts.textAlign === \"right\"\n        ? metrics.width\n        : 0,\n    y: opts.verticalAlign === \"middle\" ? metrics.height / 2 : 0,\n  };\n}\n\nexport const newTextElement = (\n  opts: {\n    text: string;\n    fontSize: number;\n    fontFamily: FontFamily;\n    textAlign: TextAlign;\n    verticalAlign: VerticalAlign;\n  } & ElementConstructorOpts,\n): NonDeleted<ExcalidrawTextElement> => {\n  const metrics = measureText(opts.text, getFontString(opts));\n  const offsets = getTextElementPositionOffsets(opts, metrics);\n  const textElement = newElementWith(\n    {\n      ..._newElementBase<ExcalidrawTextElement>(\"text\", opts),\n      text: opts.text,\n      fontSize: opts.fontSize,\n      fontFamily: opts.fontFamily,\n      textAlign: opts.textAlign,\n      verticalAlign: opts.verticalAlign,\n      x: opts.x - offsets.x,\n      y: opts.y - offsets.y,\n      width: metrics.width,\n      height: metrics.height,\n      baseline: metrics.baseline,\n    },\n    {},\n  );\n\n  return textElement;\n};\n\nconst getAdjustedDimensions = (\n  element: ExcalidrawTextElement,\n  nextText: string,\n): {\n  x: number;\n  y: number;\n  width: number;\n  height: number;\n  baseline: number;\n} => {\n  const {\n    width: nextWidth,\n    height: nextHeight,\n    baseline: nextBaseline,\n  } = measureText(nextText, getFontString(element));\n\n  const { textAlign, verticalAlign } = element;\n\n  let x, y;\n\n  if (textAlign === \"center\" && verticalAlign === \"middle\") {\n    const prevMetrics = measureText(element.text, getFontString(element));\n    const offsets = getTextElementPositionOffsets(element, {\n      width: nextWidth - prevMetrics.width,\n      height: nextHeight - prevMetrics.height,\n    });\n\n    x = element.x - offsets.x;\n    y = element.y - offsets.y;\n  } else {\n    const [x1, y1, x2, y2] = getElementAbsoluteCoords(element);\n\n    const [nextX1, nextY1, nextX2, nextY2] = getResizedElementAbsoluteCoords(\n      element,\n      nextWidth,\n      nextHeight,\n    );\n    const deltaX1 = (x1 - nextX1) / 2;\n    const deltaY1 = (y1 - nextY1) / 2;\n    const deltaX2 = (x2 - nextX2) / 2;\n    const deltaY2 = (y2 - nextY2) / 2;\n\n    [x, y] = adjustXYWithRotation(\n      {\n        s: true,\n        e: textAlign === \"center\" || textAlign === \"left\",\n        w: textAlign === \"center\" || textAlign === \"right\",\n      },\n      element.x,\n      element.y,\n      element.angle,\n      deltaX1,\n      deltaY1,\n      deltaX2,\n      deltaY2,\n    );\n  }\n\n  return {\n    width: nextWidth,\n    height: nextHeight,\n    x: Number.isFinite(x) ? x : element.x,\n    y: Number.isFinite(y) ? y : element.y,\n    baseline: nextBaseline,\n  };\n};\n\nexport const updateTextElement = (\n  element: ExcalidrawTextElement,\n  { text, isDeleted }: { text: string; isDeleted?: boolean },\n): ExcalidrawTextElement => {\n  return newElementWith(element, {\n    text,\n    isDeleted: isDeleted ?? element.isDeleted,\n    ...getAdjustedDimensions(element, text),\n  });\n};\n\nexport const newLinearElement = (\n  opts: {\n    type: ExcalidrawLinearElement[\"type\"];\n    lastCommittedPoint?: ExcalidrawLinearElement[\"lastCommittedPoint\"];\n  } & ElementConstructorOpts,\n): NonDeleted<ExcalidrawLinearElement> => {\n  return {\n    ..._newElementBase<ExcalidrawLinearElement>(opts.type, opts),\n    points: [],\n    lastCommittedPoint: opts.lastCommittedPoint || null,\n  };\n};\n\n// Simplified deep clone for the purpose of cloning ExcalidrawElement only\n//  (doesn't clone Date, RegExp, Map, Set, Typed arrays etc.)\n//\n// Adapted from https://github.com/lukeed/klona\nexport const deepCopyElement = (val: any, depth: number = 0) => {\n  if (val == null || typeof val !== \"object\") {\n    return val;\n  }\n\n  if (Object.prototype.toString.call(val) === \"[object Object]\") {\n    const tmp =\n      typeof val.constructor === \"function\"\n        ? Object.create(Object.getPrototypeOf(val))\n        : {};\n    for (const key in val) {\n      if (val.hasOwnProperty(key)) {\n        // don't copy top-level shape property, which we want to regenerate\n        if (depth === 0 && (key === \"shape\" || key === \"canvas\")) {\n          continue;\n        }\n        tmp[key] = deepCopyElement(val[key], depth + 1);\n      }\n    }\n    return tmp;\n  }\n\n  if (Array.isArray(val)) {\n    let k = val.length;\n    const arr = new Array(k);\n    while (k--) {\n      arr[k] = deepCopyElement(val[k], depth + 1);\n    }\n    return arr;\n  }\n\n  return val;\n};\n\n/**\n * Duplicate an element, often used in the alt-drag operation.\n * Note that this method has gotten a bit complicated since the\n * introduction of gruoping/ungrouping elements.\n * @param editingGroupId The current group being edited. The new\n *                       element will inherit this group and its\n *                       parents.\n * @param groupIdMapForOperation A Map that maps old group IDs to\n *                               duplicated ones. If you are duplicating\n *                               multiple elements at once, share this map\n *                               amongst all of them\n * @param element Element to duplicate\n * @param overrides Any element properties to override\n */\nexport const duplicateElement = <TElement extends Mutable<ExcalidrawElement>>(\n  editingGroupId: AppState[\"editingGroupId\"],\n  groupIdMapForOperation: Map<GroupId, GroupId>,\n  element: TElement,\n  overrides?: Partial<TElement>,\n): TElement => {\n  let copy: TElement = deepCopyElement(element);\n  copy.id = randomId();\n  copy.seed = randomInteger();\n  copy.groupIds = getNewGroupIdsForDuplication(\n    copy.groupIds,\n    editingGroupId,\n    (groupId) => {\n      if (!groupIdMapForOperation.has(groupId)) {\n        groupIdMapForOperation.set(groupId, randomId());\n      }\n      return groupIdMapForOperation.get(groupId)!;\n    },\n  );\n  if (overrides) {\n    copy = Object.assign(copy, overrides);\n  }\n  return copy;\n};\n","import { ExcalidrawElement, PointerType } from \"./types\";\n\nimport { getElementAbsoluteCoords } from \"./bounds\";\nimport { rotate } from \"../math\";\n\ntype Sides = \"n\" | \"s\" | \"w\" | \"e\" | \"nw\" | \"ne\" | \"sw\" | \"se\" | \"rotation\";\n\nconst handleSizes: { [k in PointerType]: number } = {\n  mouse: 8,\n  pen: 16,\n  touch: 28,\n};\n\nconst ROTATION_HANDLER_GAP = 16;\n\nexport const OMIT_SIDES_FOR_MULTIPLE_ELEMENTS = {\n  e: true,\n  s: true,\n  n: true,\n  w: true,\n  rotation: true,\n};\n\nconst OMIT_SIDES_FOR_TEXT_ELEMENT = {\n  e: true,\n  s: true,\n  n: true,\n  w: true,\n};\n\nconst OMIT_SIDES_FOR_LINE_SLASH = {\n  e: true,\n  s: true,\n  n: true,\n  w: true,\n  nw: true,\n  se: true,\n  rotation: true,\n};\n\nconst OMIT_SIDES_FOR_LINE_BACKSLASH = {\n  e: true,\n  s: true,\n  n: true,\n  w: true,\n  ne: true,\n  sw: true,\n  rotation: true,\n};\n\nconst generateHandler = (\n  x: number,\n  y: number,\n  width: number,\n  height: number,\n  cx: number,\n  cy: number,\n  angle: number,\n): [number, number, number, number] => {\n  const [xx, yy] = rotate(x + width / 2, y + height / 2, cx, cy, angle);\n  return [xx - width / 2, yy - height / 2, width, height];\n};\n\nexport const handlerRectanglesFromCoords = (\n  [x1, y1, x2, y2]: [number, number, number, number],\n  angle: number,\n  zoom: number,\n  pointerType: PointerType = \"mouse\",\n  omitSides: { [T in Sides]?: boolean } = {},\n): Partial<{ [T in Sides]: [number, number, number, number] }> => {\n  const size = handleSizes[pointerType];\n  const handlerWidth = size / zoom;\n  const handlerHeight = size / zoom;\n\n  const handlerMarginX = size / zoom;\n  const handlerMarginY = size / zoom;\n\n  const width = x2 - x1;\n  const height = y2 - y1;\n  const cx = (x1 + x2) / 2;\n  const cy = (y1 + y2) / 2;\n\n  const dashedLineMargin = 4 / zoom;\n\n  const centeringOffset = (size - 8) / (2 * zoom);\n\n  const handlers: Partial<\n    { [T in Sides]: [number, number, number, number] }\n  > = {\n    nw: omitSides[\"nw\"]\n      ? undefined\n      : generateHandler(\n          x1 - dashedLineMargin - handlerMarginX + centeringOffset,\n          y1 - dashedLineMargin - handlerMarginY + centeringOffset,\n          handlerWidth,\n          handlerHeight,\n          cx,\n          cy,\n          angle,\n        ),\n    ne: omitSides[\"ne\"]\n      ? undefined\n      : generateHandler(\n          x2 + dashedLineMargin - centeringOffset,\n          y1 - dashedLineMargin - handlerMarginY + centeringOffset,\n          handlerWidth,\n          handlerHeight,\n          cx,\n          cy,\n          angle,\n        ),\n    sw: omitSides[\"sw\"]\n      ? undefined\n      : generateHandler(\n          x1 - dashedLineMargin - handlerMarginX + centeringOffset,\n          y2 + dashedLineMargin - centeringOffset,\n          handlerWidth,\n          handlerHeight,\n          cx,\n          cy,\n          angle,\n        ),\n    se: omitSides[\"se\"]\n      ? undefined\n      : generateHandler(\n          x2 + dashedLineMargin - centeringOffset,\n          y2 + dashedLineMargin - centeringOffset,\n          handlerWidth,\n          handlerHeight,\n          cx,\n          cy,\n          angle,\n        ),\n    rotation: omitSides[\"rotation\"]\n      ? undefined\n      : generateHandler(\n          x1 + width / 2 - handlerWidth / 2,\n          y1 -\n            dashedLineMargin -\n            handlerMarginY +\n            centeringOffset -\n            ROTATION_HANDLER_GAP / zoom,\n          handlerWidth,\n          handlerHeight,\n          cx,\n          cy,\n          angle,\n        ),\n  };\n\n  // We only want to show height handlers (all cardinal directions)  above a certain size\n  const minimumSizeForEightHandlers = (5 * size) / zoom;\n  if (Math.abs(width) > minimumSizeForEightHandlers) {\n    if (!omitSides[\"n\"]) {\n      handlers[\"n\"] = generateHandler(\n        x1 + width / 2 - handlerWidth / 2,\n        y1 - dashedLineMargin - handlerMarginY + centeringOffset,\n        handlerWidth,\n        handlerHeight,\n        cx,\n        cy,\n        angle,\n      );\n    }\n    if (!omitSides[\"s\"]) {\n      handlers[\"s\"] = generateHandler(\n        x1 + width / 2 - handlerWidth / 2,\n        y2 + dashedLineMargin - centeringOffset,\n        handlerWidth,\n        handlerHeight,\n        cx,\n        cy,\n        angle,\n      );\n    }\n  }\n  if (Math.abs(height) > minimumSizeForEightHandlers) {\n    if (!omitSides[\"w\"]) {\n      handlers[\"w\"] = generateHandler(\n        x1 - dashedLineMargin - handlerMarginX + centeringOffset,\n        y1 + height / 2 - handlerHeight / 2,\n        handlerWidth,\n        handlerHeight,\n        cx,\n        cy,\n        angle,\n      );\n    }\n    if (!omitSides[\"e\"]) {\n      handlers[\"e\"] = generateHandler(\n        x2 + dashedLineMargin - centeringOffset,\n        y1 + height / 2 - handlerHeight / 2,\n        handlerWidth,\n        handlerHeight,\n        cx,\n        cy,\n        angle,\n      );\n    }\n  }\n\n  return handlers;\n};\n\nexport const handlerRectangles = (\n  element: ExcalidrawElement,\n  zoom: number,\n  pointerType: PointerType = \"mouse\",\n) => {\n  let omitSides: { [T in Sides]?: boolean } = {};\n  if (\n    element.type === \"arrow\" ||\n    element.type === \"line\" ||\n    element.type === \"draw\"\n  ) {\n    if (element.points.length === 2) {\n      // only check the last point because starting point is always (0,0)\n      const [, p1] = element.points;\n      if (p1[0] === 0 || p1[1] === 0) {\n        omitSides = OMIT_SIDES_FOR_LINE_BACKSLASH;\n      } else if (p1[0] > 0 && p1[1] < 0) {\n        omitSides = OMIT_SIDES_FOR_LINE_SLASH;\n      } else if (p1[0] > 0 && p1[1] > 0) {\n        omitSides = OMIT_SIDES_FOR_LINE_BACKSLASH;\n      } else if (p1[0] < 0 && p1[1] > 0) {\n        omitSides = OMIT_SIDES_FOR_LINE_SLASH;\n      } else if (p1[0] < 0 && p1[1] < 0) {\n        omitSides = OMIT_SIDES_FOR_LINE_BACKSLASH;\n      }\n    }\n  } else if (element.type === \"text\") {\n    omitSides = OMIT_SIDES_FOR_TEXT_ELEMENT;\n  }\n\n  return handlerRectanglesFromCoords(\n    getElementAbsoluteCoords(element),\n    element.angle,\n    zoom,\n    pointerType,\n    omitSides,\n  );\n};\n","import {\n  distanceBetweenPointAndSegment,\n  isPathALoop,\n  rotate,\n  isPointInPolygon,\n} from \"../math\";\nimport { pointsOnBezierCurves } from \"points-on-curve\";\n\nimport { NonDeletedExcalidrawElement } from \"./types\";\n\nimport {\n  getDiamondPoints,\n  getElementAbsoluteCoords,\n  getCurvePathOps,\n} from \"./bounds\";\nimport { Point } from \"../types\";\nimport { Drawable } from \"roughjs/bin/core\";\nimport { AppState } from \"../types\";\nimport { getShapeForElement } from \"../renderer/renderElement\";\nimport { isLinearElement } from \"./typeChecks\";\n\nconst isElementDraggableFromInside = (\n  element: NonDeletedExcalidrawElement,\n  appState: AppState,\n): boolean => {\n  if (element.type === \"arrow\") {\n    return false;\n  }\n  const dragFromInside =\n    element.backgroundColor !== \"transparent\" ||\n    appState.selectedElementIds[element.id];\n  if (element.type === \"line\" || element.type === \"draw\") {\n    return dragFromInside && isPathALoop(element.points);\n  }\n  return dragFromInside;\n};\n\nexport const hitTest = (\n  element: NonDeletedExcalidrawElement,\n  appState: AppState,\n  x: number,\n  y: number,\n  zoom: number,\n): boolean => {\n  // For shapes that are composed of lines, we only enable point-selection when the distance\n  // of the click is less than x pixels of any of the lines that the shape is composed of\n  const lineThreshold = 10 / zoom;\n\n  const [x1, y1, x2, y2] = getElementAbsoluteCoords(element);\n  const cx = (x1 + x2) / 2;\n  const cy = (y1 + y2) / 2;\n  // reverse rotate the pointer\n  [x, y] = rotate(x, y, cx, cy, -element.angle);\n\n  if (element.type === \"ellipse\") {\n    // https://stackoverflow.com/a/46007540/232122\n    const px = Math.abs(x - element.x - element.width / 2);\n    const py = Math.abs(y - element.y - element.height / 2);\n\n    let tx = 0.707;\n    let ty = 0.707;\n\n    const a = Math.abs(element.width) / 2;\n    const b = Math.abs(element.height) / 2;\n\n    [0, 1, 2, 3].forEach((x) => {\n      const xx = a * tx;\n      const yy = b * ty;\n\n      const ex = ((a * a - b * b) * tx ** 3) / a;\n      const ey = ((b * b - a * a) * ty ** 3) / b;\n\n      const rx = xx - ex;\n      const ry = yy - ey;\n\n      const qx = px - ex;\n      const qy = py - ey;\n\n      const r = Math.hypot(ry, rx);\n      const q = Math.hypot(qy, qx);\n\n      tx = Math.min(1, Math.max(0, ((qx * r) / q + ex) / a));\n      ty = Math.min(1, Math.max(0, ((qy * r) / q + ey) / b));\n      const t = Math.hypot(ty, tx);\n      tx /= t;\n      ty /= t;\n    });\n\n    if (isElementDraggableFromInside(element, appState)) {\n      return (\n        a * tx - (px - lineThreshold) >= 0 && b * ty - (py - lineThreshold) >= 0\n      );\n    }\n    return Math.hypot(a * tx - px, b * ty - py) < lineThreshold;\n  } else if (element.type === \"rectangle\") {\n    if (isElementDraggableFromInside(element, appState)) {\n      return (\n        x > x1 - lineThreshold &&\n        x < x2 + lineThreshold &&\n        y > y1 - lineThreshold &&\n        y < y2 + lineThreshold\n      );\n    }\n\n    // (x1, y1) --A-- (x2, y1)\n    //    |D             |B\n    // (x1, y2) --C-- (x2, y2)\n    return (\n      distanceBetweenPointAndSegment(x, y, x1, y1, x2, y1) < lineThreshold || // A\n      distanceBetweenPointAndSegment(x, y, x2, y1, x2, y2) < lineThreshold || // B\n      distanceBetweenPointAndSegment(x, y, x2, y2, x1, y2) < lineThreshold || // C\n      distanceBetweenPointAndSegment(x, y, x1, y2, x1, y1) < lineThreshold // D\n    );\n  } else if (element.type === \"diamond\") {\n    x -= element.x;\n    y -= element.y;\n    let [\n      topX,\n      topY,\n      rightX,\n      rightY,\n      bottomX,\n      bottomY,\n      leftX,\n      leftY,\n    ] = getDiamondPoints(element);\n\n    if (isElementDraggableFromInside(element, appState)) {\n      // TODO: remove this when we normalize coordinates globally\n      if (topY > bottomY) {\n        [bottomY, topY] = [topY, bottomY];\n      }\n      if (rightX < leftX) {\n        [leftX, rightX] = [rightX, leftX];\n      }\n\n      topY -= lineThreshold;\n      bottomY += lineThreshold;\n      leftX -= lineThreshold;\n      rightX += lineThreshold;\n\n      // all deltas should be < 0. Delta > 0 indicates it's on the outside side\n      //  of the line.\n      //\n      //          (topX, topY)\n      //     D  /             \\ A\n      //      /               \\\n      //  (leftX, leftY)  (rightX, rightY)\n      //    C \\               / B\n      //      \\              /\n      //      (bottomX, bottomY)\n      //\n      // https://stackoverflow.com/a/2752753/927631\n      return (\n        // delta from line D\n        (leftX - topX) * (y - leftY) - (leftX - x) * (topY - leftY) <= 0 &&\n        // delta from line A\n        (topX - rightX) * (y - rightY) - (x - rightX) * (topY - rightY) <= 0 &&\n        // delta from line B\n        (rightX - bottomX) * (y - bottomY) -\n          (x - bottomX) * (rightY - bottomY) <=\n          0 &&\n        // delta from line C\n        (bottomX - leftX) * (y - leftY) - (x - leftX) * (bottomY - leftY) <= 0\n      );\n    }\n\n    return (\n      distanceBetweenPointAndSegment(x, y, topX, topY, rightX, rightY) <\n        lineThreshold ||\n      distanceBetweenPointAndSegment(x, y, rightX, rightY, bottomX, bottomY) <\n        lineThreshold ||\n      distanceBetweenPointAndSegment(x, y, bottomX, bottomY, leftX, leftY) <\n        lineThreshold ||\n      distanceBetweenPointAndSegment(x, y, leftX, leftY, topX, topY) <\n        lineThreshold\n    );\n  } else if (isLinearElement(element)) {\n    if (!getShapeForElement(element)) {\n      return false;\n    }\n    const shape = getShapeForElement(element) as Drawable[];\n\n    if (\n      x < x1 - lineThreshold ||\n      y < y1 - lineThreshold ||\n      x > x2 + lineThreshold ||\n      y > y2 + lineThreshold\n    ) {\n      return false;\n    }\n\n    const relX = x - element.x;\n    const relY = y - element.y;\n\n    if (isElementDraggableFromInside(element, appState)) {\n      const hit = shape.some((subshape) =>\n        hitTestCurveInside(subshape, relX, relY, lineThreshold),\n      );\n      if (hit) {\n        return true;\n      }\n    }\n\n    // hit thest all \"subshapes\" of the linear element\n    return shape.some((subshape) =>\n      hitTestRoughShape(subshape, relX, relY, lineThreshold),\n    );\n  } else if (element.type === \"text\") {\n    return x >= x1 && x <= x2 && y >= y1 && y <= y2;\n  } else if (element.type === \"selection\") {\n    console.warn(\"This should not happen, we need to investigate why it does.\");\n    return false;\n  }\n  throw new Error(`Unimplemented type ${element.type}`);\n};\n\nconst pointInBezierEquation = (\n  p0: Point,\n  p1: Point,\n  p2: Point,\n  p3: Point,\n  [mx, my]: Point,\n  lineThreshold: number,\n) => {\n  // B(t) = p0 * (1-t)^3 + 3p1 * t * (1-t)^2 + 3p2 * t^2 * (1-t) + p3 * t^3\n  const equation = (t: number, idx: number) =>\n    Math.pow(1 - t, 3) * p3[idx] +\n    3 * t * Math.pow(1 - t, 2) * p2[idx] +\n    3 * Math.pow(t, 2) * (1 - t) * p1[idx] +\n    p0[idx] * Math.pow(t, 3);\n\n  // go through t in increments of 0.01\n  let t = 0;\n  while (t <= 1.0) {\n    const tx = equation(t, 0);\n    const ty = equation(t, 1);\n\n    const diff = Math.sqrt(Math.pow(tx - mx, 2) + Math.pow(ty - my, 2));\n\n    if (diff < lineThreshold) {\n      return true;\n    }\n\n    t += 0.01;\n  }\n\n  return false;\n};\n\nconst hitTestCurveInside = (\n  drawable: Drawable,\n  x: number,\n  y: number,\n  lineThreshold: number,\n) => {\n  const ops = getCurvePathOps(drawable);\n  const points: Point[] = [];\n  for (const operation of ops) {\n    if (operation.op === \"move\") {\n      if (points.length) {\n        break;\n      }\n      points.push([operation.data[0], operation.data[1]]);\n    } else if (operation.op === \"bcurveTo\") {\n      points.push([operation.data[0], operation.data[1]]);\n      points.push([operation.data[2], operation.data[3]]);\n      points.push([operation.data[4], operation.data[5]]);\n    }\n  }\n  if (points.length >= 4) {\n    const polygonPoints = pointsOnBezierCurves(points as any, 10, 5);\n    return isPointInPolygon(polygonPoints, x, y);\n  }\n  return false;\n};\n\nconst hitTestRoughShape = (\n  drawable: Drawable,\n  x: number,\n  y: number,\n  lineThreshold: number,\n) => {\n  // read operations from first opSet\n  const ops = getCurvePathOps(drawable);\n\n  // set start position as (0,0) just in case\n  // move operation does not exist (unlikely but it is worth safekeeping it)\n  let currentP: Point = [0, 0];\n\n  return ops.some(({ op, data }, idx) => {\n    // There are only four operation types:\n    // move, bcurveTo, lineTo, and curveTo\n    if (op === \"move\") {\n      // change starting point\n      currentP = (data as unknown) as Point;\n      // move operation does not draw anything; so, it always\n      // returns false\n    } else if (op === \"bcurveTo\") {\n      // create points from bezier curve\n      // bezier curve stores data as a flattened array of three positions\n      // [x1, y1, x2, y2, x3, y3]\n      const p1 = [data[0], data[1]] as Point;\n      const p2 = [data[2], data[3]] as Point;\n      const p3 = [data[4], data[5]] as Point;\n\n      const p0 = currentP;\n      currentP = p3;\n\n      // check if points are on the curve\n      // cubic bezier curves require four parameters\n      // the first parameter is the last stored position (p0)\n      const retVal = pointInBezierEquation(\n        p0,\n        p1,\n        p2,\n        p3,\n        [x, y],\n        lineThreshold,\n      );\n\n      // set end point of bezier curve as the new starting point for\n      // upcoming operations as each operation is based on the last drawn\n      // position of the previous operation\n      return retVal;\n    } else if (op === \"lineTo\") {\n      // TODO: Implement this\n    } else if (op === \"qcurveTo\") {\n      // TODO: Implement this\n    }\n\n    return false;\n  });\n};\n","import {\n  ExcalidrawElement,\n  PointerType,\n  NonDeletedExcalidrawElement,\n} from \"./types\";\n\nimport {\n  OMIT_SIDES_FOR_MULTIPLE_ELEMENTS,\n  handlerRectanglesFromCoords,\n  handlerRectangles,\n} from \"./handlerRectangles\";\nimport { AppState } from \"../types\";\n\ntype HandlerRectanglesRet = keyof ReturnType<typeof handlerRectangles>;\n\nconst isInHandlerRect = (\n  handler: [number, number, number, number],\n  x: number,\n  y: number,\n) =>\n  x >= handler[0] &&\n  x <= handler[0] + handler[2] &&\n  y >= handler[1] &&\n  y <= handler[1] + handler[3];\n\nexport const resizeTest = (\n  element: NonDeletedExcalidrawElement,\n  appState: AppState,\n  x: number,\n  y: number,\n  zoom: number,\n  pointerType: PointerType,\n): HandlerRectanglesRet | false => {\n  if (!appState.selectedElementIds[element.id]) {\n    return false;\n  }\n\n  const { rotation: rotationHandler, ...handlers } = handlerRectangles(\n    element,\n    zoom,\n    pointerType,\n  );\n\n  if (rotationHandler && isInHandlerRect(rotationHandler, x, y)) {\n    return \"rotation\" as HandlerRectanglesRet;\n  }\n\n  const filter = Object.keys(handlers).filter((key) => {\n    const handler = handlers[key as Exclude<HandlerRectanglesRet, \"rotation\">]!;\n    if (!handler) {\n      return false;\n    }\n    return isInHandlerRect(handler, x, y);\n  });\n\n  if (filter.length > 0) {\n    return filter[0] as HandlerRectanglesRet;\n  }\n\n  return false;\n};\n\nexport const getElementWithResizeHandler = (\n  elements: readonly NonDeletedExcalidrawElement[],\n  appState: AppState,\n  scenePointerX: number,\n  scenePointerY: number,\n  zoom: number,\n  pointerType: PointerType,\n) => {\n  return elements.reduce((result, element) => {\n    if (result) {\n      return result;\n    }\n    const resizeHandle = resizeTest(\n      element,\n      appState,\n      scenePointerX,\n      scenePointerY,\n      zoom,\n      pointerType,\n    );\n    return resizeHandle ? { element, resizeHandle } : null;\n  }, null as { element: NonDeletedExcalidrawElement; resizeHandle: HandlerRectanglesRet } | null);\n};\n\nexport const getResizeHandlerFromCoords = (\n  [x1, y1, x2, y2]: readonly [number, number, number, number],\n  scenePointerX: number,\n  scenePointerY: number,\n  zoom: number,\n  pointerType: PointerType,\n) => {\n  const handlers = handlerRectanglesFromCoords(\n    [x1, y1, x2, y2],\n    0,\n    zoom,\n    pointerType,\n    OMIT_SIDES_FOR_MULTIPLE_ELEMENTS,\n  );\n\n  const found = Object.keys(handlers).find((key) => {\n    const handler = handlers[key as Exclude<HandlerRectanglesRet, \"rotation\">]!;\n    return handler && isInHandlerRect(handler, scenePointerX, scenePointerY);\n  });\n  return (found || false) as HandlerRectanglesRet;\n};\n\nconst RESIZE_CURSORS = [\"ns\", \"nesw\", \"ew\", \"nwse\"];\nconst rotateResizeCursor = (cursor: string, angle: number) => {\n  const index = RESIZE_CURSORS.indexOf(cursor);\n  if (index >= 0) {\n    const a = Math.round(angle / (Math.PI / 4));\n    cursor = RESIZE_CURSORS[(index + a) % RESIZE_CURSORS.length];\n  }\n  return cursor;\n};\n\n/*\n * Returns bi-directional cursor for the element being resized\n */\nexport const getCursorForResizingElement = (resizingElement: {\n  element?: ExcalidrawElement;\n  resizeHandle: ReturnType<typeof resizeTest>;\n}): string => {\n  const { element, resizeHandle } = resizingElement;\n  const shouldSwapCursors =\n    element && Math.sign(element.height) * Math.sign(element.width) === -1;\n  let cursor = null;\n\n  switch (resizeHandle) {\n    case \"n\":\n    case \"s\":\n      cursor = \"ns\";\n      break;\n    case \"w\":\n    case \"e\":\n      cursor = \"ew\";\n      break;\n    case \"nw\":\n    case \"se\":\n      if (shouldSwapCursors) {\n        cursor = \"nesw\";\n      } else {\n        cursor = \"nwse\";\n      }\n      break;\n    case \"ne\":\n    case \"sw\":\n      if (shouldSwapCursors) {\n        cursor = \"nwse\";\n      } else {\n        cursor = \"nesw\";\n      }\n      break;\n    case \"rotation\":\n      return \"grab\";\n  }\n\n  if (cursor && element) {\n    cursor = rotateResizeCursor(cursor, element.angle);\n  }\n\n  return cursor ? `${cursor}-resize` : \"\";\n};\n\nexport const normalizeResizeHandle = (\n  element: ExcalidrawElement,\n  resizeHandle: HandlerRectanglesRet,\n): HandlerRectanglesRet => {\n  if (element.width >= 0 && element.height >= 0) {\n    return resizeHandle;\n  }\n\n  if (element.width < 0 && element.height < 0) {\n    switch (resizeHandle) {\n      case \"nw\":\n        return \"se\";\n      case \"ne\":\n        return \"sw\";\n      case \"se\":\n        return \"nw\";\n      case \"sw\":\n        return \"ne\";\n    }\n  } else if (element.width < 0) {\n    switch (resizeHandle) {\n      case \"nw\":\n        return \"ne\";\n      case \"ne\":\n        return \"nw\";\n      case \"se\":\n        return \"sw\";\n      case \"sw\":\n        return \"se\";\n      case \"e\":\n        return \"w\";\n      case \"w\":\n        return \"e\";\n    }\n  } else {\n    switch (resizeHandle) {\n      case \"nw\":\n        return \"sw\";\n      case \"ne\":\n        return \"se\";\n      case \"se\":\n        return \"ne\";\n      case \"sw\":\n        return \"nw\";\n      case \"n\":\n        return \"s\";\n      case \"s\":\n        return \"n\";\n    }\n  }\n\n  return resizeHandle;\n};\n","import { SHIFT_LOCKING_ANGLE } from \"../constants\";\nimport { rescalePoints } from \"../points\";\n\nimport { rotate, adjustXYWithRotation, getFlipAdjustment } from \"../math\";\nimport {\n  ExcalidrawLinearElement,\n  ExcalidrawTextElement,\n  NonDeletedExcalidrawElement,\n  NonDeleted,\n} from \"./types\";\nimport {\n  getElementAbsoluteCoords,\n  getCommonBounds,\n  getResizedElementAbsoluteCoords,\n} from \"./bounds\";\nimport { isLinearElement } from \"./typeChecks\";\nimport { mutateElement } from \"./mutateElement\";\nimport { getPerfectElementSize } from \"./sizeHelpers\";\nimport {\n  resizeTest,\n  getCursorForResizingElement,\n  normalizeResizeHandle,\n} from \"./resizeTest\";\nimport { measureText, getFontString } from \"../utils\";\n\ntype ResizeTestType = ReturnType<typeof resizeTest>;\n\nexport const resizeElements = (\n  resizeHandle: ResizeTestType,\n  setResizeHandle: (nextResizeHandle: ResizeTestType) => void,\n  selectedElements: NonDeletedExcalidrawElement[],\n  resizeArrowDirection: \"origin\" | \"end\",\n  isRotateWithDiscreteAngle: boolean,\n  isResizeWithSidesSameLength: boolean,\n  isResizeCenterPoint: boolean,\n  pointerX: number,\n  pointerY: number,\n) => {\n  if (selectedElements.length === 1) {\n    const [element] = selectedElements;\n    if (resizeHandle === \"rotation\") {\n      rotateSingleElement(\n        element,\n        pointerX,\n        pointerY,\n        isRotateWithDiscreteAngle,\n      );\n    } else if (\n      isLinearElement(element) &&\n      element.points.length === 2 &&\n      (resizeHandle === \"nw\" ||\n        resizeHandle === \"ne\" ||\n        resizeHandle === \"sw\" ||\n        resizeHandle === \"se\")\n    ) {\n      resizeSingleTwoPointElement(\n        element,\n        resizeArrowDirection,\n        isRotateWithDiscreteAngle,\n        pointerX,\n        pointerY,\n      );\n    } else if (\n      element.type === \"text\" &&\n      (resizeHandle === \"nw\" ||\n        resizeHandle === \"ne\" ||\n        resizeHandle === \"sw\" ||\n        resizeHandle === \"se\")\n    ) {\n      resizeSingleTextElement(\n        element,\n        resizeHandle,\n        isResizeCenterPoint,\n        pointerX,\n        pointerY,\n      );\n    } else if (resizeHandle) {\n      resizeSingleElement(\n        element,\n        resizeHandle,\n        isResizeWithSidesSameLength,\n        isResizeCenterPoint,\n        pointerX,\n        pointerY,\n      );\n      setResizeHandle(normalizeResizeHandle(element, resizeHandle));\n      if (element.width < 0) {\n        mutateElement(element, { width: -element.width });\n      }\n      if (element.height < 0) {\n        mutateElement(element, { height: -element.height });\n      }\n    }\n\n    // update cursor\n    // FIXME it is not very nice to have this here\n    document.documentElement.style.cursor = getCursorForResizingElement({\n      element,\n      resizeHandle,\n    });\n\n    return true;\n  } else if (\n    selectedElements.length > 1 &&\n    (resizeHandle === \"nw\" ||\n      resizeHandle === \"ne\" ||\n      resizeHandle === \"sw\" ||\n      resizeHandle === \"se\")\n  ) {\n    resizeMultipleElements(selectedElements, resizeHandle, pointerX, pointerY);\n    return true;\n  }\n  return false;\n};\n\nconst rotateSingleElement = (\n  element: NonDeletedExcalidrawElement,\n  pointerX: number,\n  pointerY: number,\n  isRotateWithDiscreteAngle: boolean,\n) => {\n  const [x1, y1, x2, y2] = getElementAbsoluteCoords(element);\n  const cx = (x1 + x2) / 2;\n  const cy = (y1 + y2) / 2;\n  let angle = (5 * Math.PI) / 2 + Math.atan2(pointerY - cy, pointerX - cx);\n  if (isRotateWithDiscreteAngle) {\n    angle += SHIFT_LOCKING_ANGLE / 2;\n    angle -= angle % SHIFT_LOCKING_ANGLE;\n  }\n  if (angle >= 2 * Math.PI) {\n    angle -= 2 * Math.PI;\n  }\n  mutateElement(element, { angle });\n};\n\nconst resizeSingleTwoPointElement = (\n  element: NonDeleted<ExcalidrawLinearElement>,\n  resizeArrowDirection: \"origin\" | \"end\",\n  isRotateWithDiscreteAngle: boolean,\n  pointerX: number,\n  pointerY: number,\n) => {\n  const pointOrigin = element.points[0]; // can assume always [0, 0]?\n  const pointEnd = element.points[1];\n  if (resizeArrowDirection === \"end\") {\n    if (isRotateWithDiscreteAngle) {\n      const { width, height } = getPerfectElementSize(\n        element.type,\n        pointerX - element.x,\n        pointerY - element.y,\n      );\n      mutateElement(element, {\n        points: [pointOrigin, [width, height]],\n      });\n    } else {\n      mutateElement(element, {\n        points: [\n          pointOrigin,\n          [\n            pointerX - pointOrigin[0] - element.x,\n            pointerY - pointOrigin[1] - element.y,\n          ],\n        ],\n      });\n    }\n  } else {\n    // resizeArrowDirection === \"origin\"\n    if (isRotateWithDiscreteAngle) {\n      const { width, height } = getPerfectElementSize(\n        element.type,\n        element.x + pointEnd[0] - pointOrigin[0] - pointerX,\n        element.y + pointEnd[1] - pointOrigin[1] - pointerY,\n      );\n      mutateElement(element, {\n        x: element.x + pointEnd[0] - pointOrigin[0] - width,\n        y: element.y + pointEnd[1] - pointOrigin[1] - height,\n        points: [pointOrigin, [width, height]],\n      });\n    } else {\n      mutateElement(element, {\n        x: pointerX,\n        y: pointerY,\n        points: [\n          pointOrigin,\n          [\n            pointEnd[0] - (pointerX - pointOrigin[0] - element.x),\n            pointEnd[1] - (pointerY - pointOrigin[1] - element.y),\n          ],\n        ],\n      });\n    }\n  }\n};\n\nconst rescalePointsInElement = (\n  element: NonDeletedExcalidrawElement,\n  width: number,\n  height: number,\n) =>\n  isLinearElement(element)\n    ? {\n        points: rescalePoints(\n          0,\n          width,\n          rescalePoints(1, height, element.points),\n        ),\n      }\n    : {};\n\nconst MIN_FONT_SIZE = 1;\n\nconst measureFontSizeFromWH = (\n  element: NonDeleted<ExcalidrawTextElement>,\n  nextWidth: number,\n  nextHeight: number,\n): { size: number; baseline: number } | null => {\n  // We only use width to scale font on resize\n  const nextFontSize = element.fontSize * (nextWidth / element.width);\n  if (nextFontSize < MIN_FONT_SIZE) {\n    return null;\n  }\n  const metrics = measureText(\n    element.text,\n    getFontString({ fontSize: nextFontSize, fontFamily: element.fontFamily }),\n  );\n  return {\n    size: nextFontSize,\n    baseline: metrics.baseline + (nextHeight - metrics.height),\n  };\n};\n\nconst getSidesForResizeHandle = (\n  resizeHandle: \"n\" | \"s\" | \"w\" | \"e\" | \"nw\" | \"ne\" | \"sw\" | \"se\",\n  isResizeFromCenter: boolean,\n) => {\n  return {\n    n:\n      /^(n|ne|nw)$/.test(resizeHandle) ||\n      (isResizeFromCenter && /^(s|se|sw)$/.test(resizeHandle)),\n    s:\n      /^(s|se|sw)$/.test(resizeHandle) ||\n      (isResizeFromCenter && /^(n|ne|nw)$/.test(resizeHandle)),\n    w:\n      /^(w|nw|sw)$/.test(resizeHandle) ||\n      (isResizeFromCenter && /^(e|ne|se)$/.test(resizeHandle)),\n    e:\n      /^(e|ne|se)$/.test(resizeHandle) ||\n      (isResizeFromCenter && /^(w|nw|sw)$/.test(resizeHandle)),\n  };\n};\n\nconst resizeSingleTextElement = (\n  element: NonDeleted<ExcalidrawTextElement>,\n  resizeHandle: \"nw\" | \"ne\" | \"sw\" | \"se\",\n  isResizeFromCenter: boolean,\n  pointerX: number,\n  pointerY: number,\n) => {\n  const [x1, y1, x2, y2] = getElementAbsoluteCoords(element);\n  const cx = (x1 + x2) / 2;\n  const cy = (y1 + y2) / 2;\n  // rotation pointer with reverse angle\n  const [rotatedX, rotatedY] = rotate(\n    pointerX,\n    pointerY,\n    cx,\n    cy,\n    -element.angle,\n  );\n  let scale;\n  switch (resizeHandle) {\n    case \"se\":\n      scale = Math.max(\n        (rotatedX - x1) / (x2 - x1),\n        (rotatedY - y1) / (y2 - y1),\n      );\n      break;\n    case \"nw\":\n      scale = Math.max(\n        (x2 - rotatedX) / (x2 - x1),\n        (y2 - rotatedY) / (y2 - y1),\n      );\n      break;\n    case \"ne\":\n      scale = Math.max(\n        (rotatedX - x1) / (x2 - x1),\n        (y2 - rotatedY) / (y2 - y1),\n      );\n      break;\n    case \"sw\":\n      scale = Math.max(\n        (x2 - rotatedX) / (x2 - x1),\n        (rotatedY - y1) / (y2 - y1),\n      );\n      break;\n  }\n  if (scale > 0) {\n    const nextWidth = element.width * scale;\n    const nextHeight = element.height * scale;\n    const nextFont = measureFontSizeFromWH(element, nextWidth, nextHeight);\n    if (nextFont === null) {\n      return;\n    }\n    const [nextX1, nextY1, nextX2, nextY2] = getResizedElementAbsoluteCoords(\n      element,\n      nextWidth,\n      nextHeight,\n    );\n    const deltaX1 = (x1 - nextX1) / 2;\n    const deltaY1 = (y1 - nextY1) / 2;\n    const deltaX2 = (x2 - nextX2) / 2;\n    const deltaY2 = (y2 - nextY2) / 2;\n    const [nextElementX, nextElementY] = adjustXYWithRotation(\n      getSidesForResizeHandle(resizeHandle, isResizeFromCenter),\n      element.x,\n      element.y,\n      element.angle,\n      deltaX1,\n      deltaY1,\n      deltaX2,\n      deltaY2,\n    );\n    mutateElement(element, {\n      fontSize: nextFont.size,\n      width: nextWidth,\n      height: nextHeight,\n      baseline: nextFont.baseline,\n      x: nextElementX,\n      y: nextElementY,\n    });\n  }\n};\n\nconst resizeSingleElement = (\n  element: NonDeletedExcalidrawElement,\n  resizeHandle: \"n\" | \"s\" | \"w\" | \"e\" | \"nw\" | \"ne\" | \"sw\" | \"se\",\n  sidesWithSameLength: boolean,\n  isResizeFromCenter: boolean,\n  pointerX: number,\n  pointerY: number,\n) => {\n  const [x1, y1, x2, y2] = getElementAbsoluteCoords(element);\n  const cx = (x1 + x2) / 2;\n  const cy = (y1 + y2) / 2;\n  // rotation pointer with reverse angle\n  const [rotatedX, rotatedY] = rotate(\n    pointerX,\n    pointerY,\n    cx,\n    cy,\n    -element.angle,\n  );\n  let scaleX = 1;\n  let scaleY = 1;\n  if (resizeHandle === \"e\" || resizeHandle === \"ne\" || resizeHandle === \"se\") {\n    scaleX = (rotatedX - x1) / (x2 - x1);\n  }\n  if (resizeHandle === \"s\" || resizeHandle === \"sw\" || resizeHandle === \"se\") {\n    scaleY = (rotatedY - y1) / (y2 - y1);\n  }\n  if (resizeHandle === \"w\" || resizeHandle === \"nw\" || resizeHandle === \"sw\") {\n    scaleX = (x2 - rotatedX) / (x2 - x1);\n  }\n  if (resizeHandle === \"n\" || resizeHandle === \"nw\" || resizeHandle === \"ne\") {\n    scaleY = (y2 - rotatedY) / (y2 - y1);\n  }\n  let nextWidth = element.width * scaleX;\n  let nextHeight = element.height * scaleY;\n  if (sidesWithSameLength) {\n    nextWidth = nextHeight = Math.max(nextWidth, nextHeight);\n  }\n  const [nextX1, nextY1, nextX2, nextY2] = getResizedElementAbsoluteCoords(\n    element,\n    nextWidth,\n    nextHeight,\n  );\n  const deltaX1 = (x1 - nextX1) / 2;\n  const deltaY1 = (y1 - nextY1) / 2;\n  const deltaX2 = (x2 - nextX2) / 2;\n  const deltaY2 = (y2 - nextY2) / 2;\n  const rescaledPoints = rescalePointsInElement(element, nextWidth, nextHeight);\n  const [finalX1, finalY1, finalX2, finalY2] = getResizedElementAbsoluteCoords(\n    {\n      ...element,\n      ...rescaledPoints,\n    },\n    Math.abs(nextWidth),\n    Math.abs(nextHeight),\n  );\n  const [flipDiffX, flipDiffY] = getFlipAdjustment(\n    resizeHandle,\n    nextWidth,\n    nextHeight,\n    nextX1,\n    nextY1,\n    nextX2,\n    nextY2,\n    finalX1,\n    finalY1,\n    finalX2,\n    finalY2,\n    isLinearElement(element),\n    element.angle,\n  );\n  const [nextElementX, nextElementY] = adjustXYWithRotation(\n    getSidesForResizeHandle(resizeHandle, isResizeFromCenter),\n    element.x - flipDiffX,\n    element.y - flipDiffY,\n    element.angle,\n    deltaX1,\n    deltaY1,\n    deltaX2,\n    deltaY2,\n  );\n  if (\n    nextWidth !== 0 &&\n    nextHeight !== 0 &&\n    Number.isFinite(nextElementX) &&\n    Number.isFinite(nextElementY)\n  ) {\n    mutateElement(element, {\n      width: nextWidth,\n      height: nextHeight,\n      x: nextElementX,\n      y: nextElementY,\n      ...rescaledPoints,\n    });\n  }\n};\n\nconst resizeMultipleElements = (\n  elements: readonly NonDeletedExcalidrawElement[],\n  resizeHandle: \"nw\" | \"ne\" | \"sw\" | \"se\",\n  pointerX: number,\n  pointerY: number,\n) => {\n  const [x1, y1, x2, y2] = getCommonBounds(elements);\n  let scale: number;\n  let getNextXY: (\n    element: NonDeletedExcalidrawElement,\n    origCoords: readonly [number, number, number, number],\n    finalCoords: readonly [number, number, number, number],\n  ) => { x: number; y: number };\n  switch (resizeHandle) {\n    case \"se\":\n      scale = Math.max(\n        (pointerX - x1) / (x2 - x1),\n        (pointerY - y1) / (y2 - y1),\n      );\n      getNextXY = (element, [origX1, origY1], [finalX1, finalY1]) => {\n        const x = element.x + (origX1 - x1) * (scale - 1) + origX1 - finalX1;\n        const y = element.y + (origY1 - y1) * (scale - 1) + origY1 - finalY1;\n        return { x, y };\n      };\n      break;\n    case \"nw\":\n      scale = Math.max(\n        (x2 - pointerX) / (x2 - x1),\n        (y2 - pointerY) / (y2 - y1),\n      );\n      getNextXY = (element, [, , origX2, origY2], [, , finalX2, finalY2]) => {\n        const x = element.x - (x2 - origX2) * (scale - 1) + origX2 - finalX2;\n        const y = element.y - (y2 - origY2) * (scale - 1) + origY2 - finalY2;\n        return { x, y };\n      };\n      break;\n    case \"ne\":\n      scale = Math.max(\n        (pointerX - x1) / (x2 - x1),\n        (y2 - pointerY) / (y2 - y1),\n      );\n      getNextXY = (element, [origX1, , , origY2], [finalX1, , , finalY2]) => {\n        const x = element.x + (origX1 - x1) * (scale - 1) + origX1 - finalX1;\n        const y = element.y - (y2 - origY2) * (scale - 1) + origY2 - finalY2;\n        return { x, y };\n      };\n      break;\n    case \"sw\":\n      scale = Math.max(\n        (x2 - pointerX) / (x2 - x1),\n        (pointerY - y1) / (y2 - y1),\n      );\n      getNextXY = (element, [, origY1, origX2], [, finalY1, finalX2]) => {\n        const x = element.x - (x2 - origX2) * (scale - 1) + origX2 - finalX2;\n        const y = element.y + (origY1 - y1) * (scale - 1) + origY1 - finalY1;\n        return { x, y };\n      };\n      break;\n  }\n  if (scale > 0) {\n    const updates = elements.reduce(\n      (prev, element) => {\n        if (!prev) {\n          return prev;\n        }\n        const width = element.width * scale;\n        const height = element.height * scale;\n        let font: { fontSize?: number; baseline?: number } = {};\n        if (element.type === \"text\") {\n          const nextFont = measureFontSizeFromWH(element, width, height);\n          if (nextFont === null) {\n            return null;\n          }\n          font = { fontSize: nextFont.size, baseline: nextFont.baseline };\n        }\n        const origCoords = getElementAbsoluteCoords(element);\n        const rescaledPoints = rescalePointsInElement(element, width, height);\n        const finalCoords = getResizedElementAbsoluteCoords(\n          {\n            ...element,\n            ...rescaledPoints,\n          },\n          width,\n          height,\n        );\n        const { x, y } = getNextXY(element, origCoords, finalCoords);\n        return [...prev, { width, height, x, y, ...rescaledPoints, ...font }];\n      },\n      [] as\n        | {\n            width: number;\n            height: number;\n            x: number;\n            y: number;\n            points?: (readonly [number, number])[];\n            fontSize?: number;\n            baseline?: number;\n          }[]\n        | null,\n    );\n    if (updates) {\n      elements.forEach((element, index) => {\n        mutateElement(element, updates[index]);\n      });\n    }\n  }\n};\n\nexport const getResizeOffsetXY = (\n  resizeHandle: ResizeTestType,\n  selectedElements: NonDeletedExcalidrawElement[],\n  x: number,\n  y: number,\n): [number, number] => {\n  const [x1, y1, x2, y2] =\n    selectedElements.length === 1\n      ? getElementAbsoluteCoords(selectedElements[0])\n      : getCommonBounds(selectedElements);\n  const cx = (x1 + x2) / 2;\n  const cy = (y1 + y2) / 2;\n  const angle = selectedElements.length === 1 ? selectedElements[0].angle : 0;\n  [x, y] = rotate(x, y, cx, cy, -angle);\n  switch (resizeHandle) {\n    case \"n\":\n      return rotate(x - (x1 + x2) / 2, y - y1, 0, 0, angle);\n    case \"s\":\n      return rotate(x - (x1 + x2) / 2, y - y2, 0, 0, angle);\n    case \"w\":\n      return rotate(x - x1, y - (y1 + y2) / 2, 0, 0, angle);\n    case \"e\":\n      return rotate(x - x2, y - (y1 + y2) / 2, 0, 0, angle);\n    case \"nw\":\n      return rotate(x - x1, y - y1, 0, 0, angle);\n    case \"ne\":\n      return rotate(x - x2, y - y1, 0, 0, angle);\n    case \"sw\":\n      return rotate(x - x1, y - y2, 0, 0, angle);\n    case \"se\":\n      return rotate(x - x2, y - y2, 0, 0, angle);\n    default:\n      return [0, 0];\n  }\n};\n\nexport const getResizeArrowDirection = (\n  resizeHandle: ResizeTestType,\n  element: NonDeleted<ExcalidrawLinearElement>,\n): \"origin\" | \"end\" => {\n  const [, [px, py]] = element.points;\n  const isResizeEnd =\n    (resizeHandle === \"nw\" && (px < 0 || py < 0)) ||\n    (resizeHandle === \"ne\" && px >= 0) ||\n    (resizeHandle === \"sw\" && px <= 0) ||\n    (resizeHandle === \"se\" && (px > 0 || py > 0));\n  return isResizeEnd ? \"end\" : \"origin\";\n};\n","import { NonDeletedExcalidrawElement } from \"./types\";\nimport { getCommonBounds } from \"./bounds\";\nimport { mutateElement } from \"./mutateElement\";\nimport { SHAPES } from \"../shapes\";\nimport { getPerfectElementSize } from \"./sizeHelpers\";\n\nexport const dragSelectedElements = (\n  selectedElements: NonDeletedExcalidrawElement[],\n  pointerX: number,\n  pointerY: number,\n) => {\n  const [x1, y1] = getCommonBounds(selectedElements);\n  selectedElements.forEach((element) => {\n    mutateElement(element, {\n      x: pointerX + element.x - x1,\n      y: pointerY + element.y - y1,\n    });\n  });\n};\n\nexport const getDragOffsetXY = (\n  selectedElements: NonDeletedExcalidrawElement[],\n  x: number,\n  y: number,\n): [number, number] => {\n  const [x1, y1] = getCommonBounds(selectedElements);\n  return [x - x1, y - y1];\n};\n\nexport const dragNewElement = (\n  draggingElement: NonDeletedExcalidrawElement,\n  elementType: typeof SHAPES[number][\"value\"],\n  originX: number,\n  originY: number,\n  x: number,\n  y: number,\n  width: number,\n  height: number,\n  isResizeWithSidesSameLength: boolean,\n  isResizeCenterPoint: boolean,\n) => {\n  if (isResizeWithSidesSameLength) {\n    ({ width, height } = getPerfectElementSize(\n      elementType,\n      width,\n      y < originY ? -height : height,\n    ));\n\n    if (height < 0) {\n      height = -height;\n    }\n  }\n\n  let newX = x < originX ? originX - width : originX;\n  let newY = y < originY ? originY - height : originY;\n\n  if (isResizeCenterPoint) {\n    width += width;\n    height += height;\n    newX = originX - width / 2;\n    newY = originY - height / 2;\n  }\n\n  if (width !== 0 && height !== 0) {\n    mutateElement(draggingElement, {\n      x: newX,\n      y: newY,\n      width: width,\n      height: height,\n    });\n  }\n};\n","export const isDarwin = /Mac|iPod|iPhone|iPad/.test(window.navigator.platform);\n\nexport const KEYS = {\n  ARROW_LEFT: \"ArrowLeft\",\n  ARROW_RIGHT: \"ArrowRight\",\n  ARROW_DOWN: \"ArrowDown\",\n  ARROW_UP: \"ArrowUp\",\n  ENTER: \"Enter\",\n  ESCAPE: \"Escape\",\n  DELETE: \"Delete\",\n  BACKSPACE: \"Backspace\",\n  CTRL_OR_CMD: isDarwin ? \"metaKey\" : \"ctrlKey\",\n  TAB: \"Tab\",\n  SPACE: \" \",\n  QUESTION_MARK: \"?\",\n  F_KEY_CODE: 70,\n  ALT_KEY_CODE: 18,\n  Z_KEY_CODE: 90,\n  GRID_KEY_CODE: 222,\n  G_KEY_CODE: 71,\n  C_KEY_CODE: 67,\n  V_KEY_CODE: 86,\n} as const;\n\nexport type Key = keyof typeof KEYS;\n\nexport const isArrowKey = (keyCode: string) =>\n  keyCode === KEYS.ARROW_LEFT ||\n  keyCode === KEYS.ARROW_RIGHT ||\n  keyCode === KEYS.ARROW_DOWN ||\n  keyCode === KEYS.ARROW_UP;\n\nexport const getResizeCenterPointKey = (event: MouseEvent | KeyboardEvent) =>\n  event.altKey || event.which === KEYS.ALT_KEY_CODE;\n\nexport const getResizeWithSidesSameLengthKey = (event: MouseEvent) =>\n  event.shiftKey;\n\nexport const getRotateWithDiscreteAngleKey = (event: MouseEvent) =>\n  event.shiftKey;\n","import { KEYS } from \"../keys\";\nimport { isWritableElement, getFontString } from \"../utils\";\nimport { globalSceneState } from \"../scene\";\nimport { isTextElement } from \"./typeChecks\";\nimport { CLASSES } from \"../constants\";\nimport { ExcalidrawElement } from \"./types\";\n\nconst normalizeText = (text: string) => {\n  return (\n    text\n      // replace tabs with spaces so they render and measure correctly\n      .replace(/\\t/g, \"        \")\n      // normalize newlines\n      .replace(/\\r?\\n|\\r/g, \"\\n\")\n  );\n};\n\nconst getTransform = (\n  width: number,\n  height: number,\n  angle: number,\n  zoom: number,\n) => {\n  const degree = (180 * angle) / Math.PI;\n  return `translate(${(width * (zoom - 1)) / 2}px, ${\n    (height * (zoom - 1)) / 2\n  }px) scale(${zoom}) rotate(${degree}deg)`;\n};\n\nexport const textWysiwyg = ({\n  id,\n  zoom,\n  onChange,\n  onSubmit,\n  onCancel,\n  getViewportCoords,\n}: {\n  id: ExcalidrawElement[\"id\"];\n  zoom: number;\n  onChange?: (text: string) => void;\n  onSubmit: (text: string) => void;\n  onCancel: () => void;\n  getViewportCoords: (x: number, y: number) => [number, number];\n}) => {\n  function updateWysiwygStyle() {\n    const updatedElement = globalSceneState.getElement(id);\n    if (isTextElement(updatedElement)) {\n      const [viewportX, viewportY] = getViewportCoords(\n        updatedElement.x,\n        updatedElement.y,\n      );\n      const { textAlign, angle } = updatedElement;\n\n      editable.value = updatedElement.text;\n\n      const lines = updatedElement.text.replace(/\\r\\n?/g, \"\\n\").split(\"\\n\");\n      const lineHeight = updatedElement.height / lines.length;\n\n      Object.assign(editable.style, {\n        font: getFontString(updatedElement),\n        // must be defined *after* font \\_()_/\n        lineHeight: `${lineHeight}px`,\n        width: `${updatedElement.width}px`,\n        height: `${updatedElement.height}px`,\n        left: `${viewportX}px`,\n        top: `${viewportY}px`,\n        transform: getTransform(\n          updatedElement.width,\n          updatedElement.height,\n          angle,\n          zoom,\n        ),\n        textAlign: textAlign,\n        color: updatedElement.strokeColor,\n        opacity: updatedElement.opacity / 100,\n      });\n    }\n  }\n\n  const editable = document.createElement(\"textarea\");\n\n  editable.dir = \"auto\";\n  editable.tabIndex = 0;\n  editable.dataset.type = \"wysiwyg\";\n  // prevent line wrapping on Safari\n  editable.wrap = \"off\";\n\n  Object.assign(editable.style, {\n    position: \"fixed\",\n    display: \"inline-block\",\n    minHeight: \"1em\",\n    backfaceVisibility: \"hidden\",\n    margin: 0,\n    padding: 0,\n    border: 0,\n    outline: 0,\n    resize: \"none\",\n    background: \"transparent\",\n    overflow: \"hidden\",\n    // prevent line wrapping (`whitespace: nowrap` doesn't work on FF)\n    whiteSpace: \"pre\",\n  });\n\n  updateWysiwygStyle();\n\n  if (onChange) {\n    editable.oninput = () => {\n      onChange(normalizeText(editable.value));\n    };\n  }\n\n  editable.onkeydown = (event) => {\n    if (event.key === KEYS.ESCAPE) {\n      event.preventDefault();\n      handleSubmit();\n    } else if (event.key === KEYS.ENTER && event[KEYS.CTRL_OR_CMD]) {\n      event.preventDefault();\n      if (event.isComposing || event.keyCode === 229) {\n        return;\n      }\n      handleSubmit();\n    } else if (event.key === KEYS.ENTER && !event.altKey) {\n      event.stopPropagation();\n    }\n  };\n\n  const stopEvent = (event: Event) => {\n    event.stopPropagation();\n  };\n\n  const handleSubmit = () => {\n    if (editable.value) {\n      onSubmit(normalizeText(editable.value));\n    } else {\n      onCancel();\n    }\n    cleanup();\n  };\n\n  const cleanup = () => {\n    if (isDestroyed) {\n      return;\n    }\n    isDestroyed = true;\n    // remove events to ensure they don't late-fire\n    editable.onblur = null;\n    editable.oninput = null;\n    editable.onkeydown = null;\n\n    window.removeEventListener(\"resize\", updateWysiwygStyle);\n    window.removeEventListener(\"wheel\", stopEvent, true);\n    window.removeEventListener(\"pointerdown\", onPointerDown);\n    window.removeEventListener(\"pointerup\", rebindBlur);\n    window.removeEventListener(\"blur\", handleSubmit);\n\n    unbindUpdate();\n\n    document.body.removeChild(editable);\n  };\n\n  const rebindBlur = () => {\n    window.removeEventListener(\"pointerup\", rebindBlur);\n    // deferred to guard against focus traps on various UIs that steal focus\n    //  upon pointerUp\n    setTimeout(() => {\n      editable.onblur = handleSubmit;\n      // case: clicking on the same property  no change  no update  no focus\n      editable.focus();\n    });\n  };\n\n  // prevent blur when changing properties from the menu\n  const onPointerDown = (event: MouseEvent) => {\n    if (\n      event.target instanceof HTMLElement &&\n      event.target.closest(`.${CLASSES.SHAPE_ACTIONS_MENU}`) &&\n      !isWritableElement(event.target)\n    ) {\n      editable.onblur = null;\n      window.addEventListener(\"pointerup\", rebindBlur);\n      // handle edge-case where pointerup doesn't fire e.g. due to user\n      //  alt-tabbing away\n      window.addEventListener(\"blur\", handleSubmit);\n    }\n  };\n\n  // handle updates of textElement properties of editing element\n  const unbindUpdate = globalSceneState.addCallback(() => {\n    updateWysiwygStyle();\n    editable.focus();\n  });\n\n  let isDestroyed = false;\n\n  editable.onblur = handleSubmit;\n  // reposition wysiwyg in case of window resize. Happens on mobile when\n  //  device keyboard is opened.\n  window.addEventListener(\"resize\", updateWysiwygStyle);\n  window.addEventListener(\"pointerdown\", onPointerDown);\n  window.addEventListener(\"wheel\", stopEvent, true);\n  document.body.appendChild(editable);\n  editable.focus();\n  editable.select();\n};\n","import { measureText, getFontString } from \"../utils\";\nimport { ExcalidrawTextElement } from \"./types\";\nimport { mutateElement } from \"./mutateElement\";\n\nexport const redrawTextBoundingBox = (element: ExcalidrawTextElement) => {\n  const metrics = measureText(element.text, getFontString(element));\n  mutateElement(element, {\n    width: metrics.width,\n    height: metrics.height,\n    baseline: metrics.baseline,\n  });\n};\n","import { AppState } from \"../types\";\nimport { NonDeletedExcalidrawElement } from \"./types\";\nimport { getSelectedElements } from \"../scene\";\n\nexport const showSelectedShapeActions = (\n  appState: AppState,\n  elements: readonly NonDeletedExcalidrawElement[],\n) =>\n  Boolean(\n    appState.editingElement ||\n      getSelectedElements(elements, appState).length ||\n      appState.elementType !== \"selection\",\n  );\n","import {\n  ExcalidrawElement,\n  NonDeletedExcalidrawElement,\n  NonDeleted,\n} from \"./types\";\nimport { isInvisiblySmallElement } from \"./sizeHelpers\";\n\nexport {\n  newElement,\n  newTextElement,\n  updateTextElement,\n  newLinearElement,\n  duplicateElement,\n} from \"./newElement\";\nexport {\n  getElementAbsoluteCoords,\n  getElementBounds,\n  getCommonBounds,\n  getDiamondPoints,\n  getArrowPoints,\n  getClosestElementBounds,\n} from \"./bounds\";\n\nexport {\n  OMIT_SIDES_FOR_MULTIPLE_ELEMENTS,\n  handlerRectanglesFromCoords,\n  handlerRectangles,\n} from \"./handlerRectangles\";\nexport { hitTest } from \"./collision\";\nexport {\n  resizeTest,\n  getCursorForResizingElement,\n  normalizeResizeHandle,\n  getElementWithResizeHandler,\n  getResizeHandlerFromCoords,\n} from \"./resizeTest\";\nexport {\n  resizeElements,\n  getResizeOffsetXY,\n  getResizeArrowDirection,\n} from \"./resizeElements\";\nexport {\n  dragSelectedElements,\n  getDragOffsetXY,\n  dragNewElement,\n} from \"./dragElements\";\nexport { isTextElement, isExcalidrawElement } from \"./typeChecks\";\nexport { textWysiwyg } from \"./textWysiwyg\";\nexport { redrawTextBoundingBox } from \"./textElement\";\nexport {\n  getPerfectElementSize,\n  isInvisiblySmallElement,\n  resizePerfectLineForNWHandler,\n  getNormalizedDimensions,\n} from \"./sizeHelpers\";\nexport { showSelectedShapeActions } from \"./showSelectedShapeActions\";\n\nexport const getSyncableElements = (\n  elements: readonly ExcalidrawElement[], // There are places in Excalidraw where synthetic invisibly small elements are added and removed.\n) =>\n  // It's probably best to keep those local otherwise there might be a race condition that\n  // gets the app into an invalid state. I've never seen it happen but I'm worried about it :)\n  elements.filter((el) => el.isDeleted || !isInvisiblySmallElement(el));\n\nexport const getElementMap = (elements: readonly ExcalidrawElement[]) =>\n  elements.reduce(\n    (acc: { [key: string]: ExcalidrawElement }, element: ExcalidrawElement) => {\n      acc[element.id] = element;\n      return acc;\n    },\n    {},\n  );\n\nexport const getDrawingVersion = (elements: readonly ExcalidrawElement[]) =>\n  elements.reduce((acc, el) => acc + el.version, 0);\n\nexport const getNonDeletedElements = (elements: readonly ExcalidrawElement[]) =>\n  elements.filter(\n    (element) => !element.isDeleted,\n  ) as readonly NonDeletedExcalidrawElement[];\n\nexport const isNonDeletedElement = <T extends ExcalidrawElement>(\n  element: T,\n): element is NonDeleted<T> => !element.isDeleted;\n","import LanguageDetector from \"i18next-browser-languagedetector\";\n\nimport fallbackLanguageData from \"./locales/en.json\";\nimport percentages from \"./locales/percentages.json\";\n\nconst COMPLETION_THRESHOLD_TO_EXCEED = 85;\n\ninterface Language {\n  lng: string;\n  label: string;\n  data: string;\n  rtl?: boolean;\n}\n\nconst allLanguages: Language[] = [\n  { lng: \"bg-BG\", label: \"\", data: \"bg-BG.json\" },\n  { lng: \"de-DE\", label: \"Deutsch\", data: \"de-DE.json\" },\n  { lng: \"es-ES\", label: \"Espaol\", data: \"es-ES.json\" },\n  { lng: \"ca-ES\", label: \"Catalan\", data: \"ca-ES.json\" },\n  { lng: \"el-GR\", label: \"\", data: \"el-GR.json\" },\n  { lng: \"fr-FR\", label: \"Franais\", data: \"fr-FR.json\" },\n  { lng: \"id-ID\", label: \"Bahasa Indonesia\", data: \"id-ID.json\" },\n  { lng: \"it-IT\", label: \"Italiano\", data: \"it-IT.json\" },\n  { lng: \"hu-HU\", label: \"Magyar\", data: \"hu-HU.json\" },\n  { lng: \"nl-NL\", label: \"Nederlands\", data: \"nl-NL.json\" },\n  { lng: \"nb-NO\", label: \"Norsk bokml\", data: \"nb-NO.json\" },\n  { lng: \"nn-NO\", label: \"Norsk nynorsk\", data: \"nn-NO.json\" },\n  { lng: \"pl-PL\", label: \"Polski\", data: \"pl-PL.json\" },\n  { lng: \"pt-PT\", label: \"Portugus\", data: \"pt-PT.json\" },\n  { lng: \"ru-RU\", label: \"\", data: \"ru-RU.json\" },\n  { lng: \"uk-UA\", label: \"\", data: \"uk-UA.json\" },\n  { lng: \"fi-FI\", label: \"Suomi\", data: \"fi-FI.json\" },\n  { lng: \"tr-TR\", label: \"Trke\", data: \"tr-TR.json\" },\n  { lng: \"ja-JP\", label: \"\", data: \"ja-JP.json\" },\n  { lng: \"ko-KR\", label: \"\", data: \"ko-KR.json\" },\n  { lng: \"zh-TW\", label: \"\", data: \"zh-TW.json\" },\n  { lng: \"zh-CN\", label: \"\", data: \"zh-CN.json\" },\n  { lng: \"ar-SA\", label: \"\", data: \"ar-SA.json\", rtl: true },\n  { lng: \"he-IL\", label: \"\", data: \"he-IL.json\", rtl: true },\n  { lng: \"hi-IN\", label: \"\", data: \"hi-IN.json\" },\n];\n\nexport const languages: Language[] = [\n  { lng: \"en\", label: \"English\", data: \"en.json\" },\n]\n  .concat(\n    allLanguages.sort((left, right) => (left.label > right.label ? 1 : -1)),\n  )\n  .filter(\n    (lang) =>\n      (percentages as Record<string, number>)[lang.lng] >\n      COMPLETION_THRESHOLD_TO_EXCEED,\n  );\n\nlet currentLanguage = languages[0];\nlet currentLanguageData = {};\nconst fallbackLanguage = languages[0];\n\nexport const setLanguage = async (newLng: string | undefined) => {\n  currentLanguage =\n    languages.find((language) => language.lng === newLng) || fallbackLanguage;\n\n  document.documentElement.dir = currentLanguage.rtl ? \"rtl\" : \"ltr\";\n\n  currentLanguageData = await import(`./locales/${currentLanguage.data}`);\n\n  languageDetector.cacheUserLanguage(currentLanguage.lng);\n};\n\nexport const setLanguageFirstTime = async () => {\n  const newLng: string | undefined = languageDetector.detect();\n\n  currentLanguage =\n    languages.find((language) => language.lng === newLng) || fallbackLanguage;\n\n  document.documentElement.dir = currentLanguage.rtl ? \"rtl\" : \"ltr\";\n\n  currentLanguageData = await import(`./locales/${currentLanguage.data}`);\n\n  languageDetector.cacheUserLanguage(currentLanguage.lng);\n};\n\nexport const getLanguage = () => currentLanguage;\n\nconst findPartsForData = (data: any, parts: string[]) => {\n  for (var i = 0; i < parts.length; ++i) {\n    const part = parts[i];\n    if (data[part] === undefined) {\n      return undefined;\n    }\n    data = data[part];\n  }\n  if (typeof data !== \"string\") {\n    return undefined;\n  }\n  return data;\n};\n\nexport const t = (path: string, replacement?: { [key: string]: string }) => {\n  const parts = path.split(\".\");\n  let translation =\n    findPartsForData(currentLanguageData, parts) ||\n    findPartsForData(fallbackLanguageData, parts);\n  if (translation === undefined) {\n    throw new Error(`Can't find translation for ${path}`);\n  }\n\n  if (replacement) {\n    for (var key in replacement) {\n      translation = translation.replace(`{{${key}}}`, replacement[key]);\n    }\n  }\n  return translation;\n};\n\nconst languageDetector = new LanguageDetector();\nlanguageDetector.init({\n  languageUtils: {\n    formatLanguageCode: (lng: string) => lng,\n    isWhitelisted: () => true,\n  },\n  checkWhitelist: false,\n});\n","import { ExcalidrawElement } from \"../element/types\";\nimport { getCommonBounds } from \"../element\";\nimport { FlooredNumber } from \"../types\";\nimport { ScrollBars } from \"./types\";\nimport { getGlobalCSSVariable } from \"../utils\";\nimport { getLanguage } from \"../i18n\";\n\nexport const SCROLLBAR_MARGIN = 4;\nexport const SCROLLBAR_WIDTH = 6;\nexport const SCROLLBAR_COLOR = \"rgba(0,0,0,0.3)\";\n\nexport const getScrollBars = (\n  elements: readonly ExcalidrawElement[],\n  viewportWidth: number,\n  viewportHeight: number,\n  {\n    scrollX,\n    scrollY,\n    zoom,\n  }: {\n    scrollX: FlooredNumber;\n    scrollY: FlooredNumber;\n    zoom: number;\n  },\n): ScrollBars => {\n  // This is the bounding box of all the elements\n  const [\n    elementsMinX,\n    elementsMinY,\n    elementsMaxX,\n    elementsMaxY,\n  ] = getCommonBounds(elements);\n\n  // Apply zoom\n  const viewportWidthWithZoom = viewportWidth / zoom;\n  const viewportHeightWithZoom = viewportHeight / zoom;\n\n  const viewportWidthDiff = viewportWidth - viewportWidthWithZoom;\n  const viewportHeightDiff = viewportHeight - viewportHeightWithZoom;\n\n  const safeArea = {\n    top: parseInt(getGlobalCSSVariable(\"sat\")),\n    bottom: parseInt(getGlobalCSSVariable(\"sab\")),\n    left: parseInt(getGlobalCSSVariable(\"sal\")),\n    right: parseInt(getGlobalCSSVariable(\"sar\")),\n  };\n\n  const isRTL = getLanguage().rtl;\n\n  // The viewport is the rectangle currently visible for the user\n  const viewportMinX = -scrollX + viewportWidthDiff / 2 + safeArea.left;\n  const viewportMinY = -scrollY + viewportHeightDiff / 2 + safeArea.top;\n  const viewportMaxX = viewportMinX + viewportWidthWithZoom - safeArea.right;\n  const viewportMaxY = viewportMinY + viewportHeightWithZoom - safeArea.bottom;\n\n  // The scene is the bounding box of both the elements and viewport\n  const sceneMinX = Math.min(elementsMinX, viewportMinX);\n  const sceneMinY = Math.min(elementsMinY, viewportMinY);\n  const sceneMaxX = Math.max(elementsMaxX, viewportMaxX);\n  const sceneMaxY = Math.max(elementsMaxY, viewportMaxY);\n\n  // The scrollbar represents where the viewport is in relationship to the scene\n\n  return {\n    horizontal:\n      viewportMinX === sceneMinX && viewportMaxX === sceneMaxX\n        ? null\n        : {\n            x:\n              Math.max(safeArea.left, SCROLLBAR_MARGIN) +\n              ((viewportMinX - sceneMinX) / (sceneMaxX - sceneMinX)) *\n                viewportWidth,\n            y:\n              viewportHeight -\n              SCROLLBAR_WIDTH -\n              Math.max(SCROLLBAR_MARGIN, safeArea.bottom),\n            width:\n              ((viewportMaxX - viewportMinX) / (sceneMaxX - sceneMinX)) *\n                viewportWidth -\n              Math.max(SCROLLBAR_MARGIN * 2, safeArea.left + safeArea.right),\n            height: SCROLLBAR_WIDTH,\n          },\n    vertical:\n      viewportMinY === sceneMinY && viewportMaxY === sceneMaxY\n        ? null\n        : {\n            x: isRTL\n              ? Math.max(safeArea.left, SCROLLBAR_MARGIN)\n              : viewportWidth -\n                SCROLLBAR_WIDTH -\n                Math.max(safeArea.right, SCROLLBAR_MARGIN),\n            y:\n              ((viewportMinY - sceneMinY) / (sceneMaxY - sceneMinY)) *\n                viewportHeight +\n              Math.max(safeArea.top, SCROLLBAR_MARGIN),\n            width: SCROLLBAR_WIDTH,\n            height:\n              ((viewportMaxY - viewportMinY) / (sceneMaxY - sceneMinY)) *\n                viewportHeight -\n              Math.max(SCROLLBAR_MARGIN * 2, safeArea.top + safeArea.bottom),\n          },\n  };\n};\n\nexport const isOverScrollBars = (\n  scrollBars: ScrollBars,\n  x: number,\n  y: number,\n): {\n  isOverEither: boolean;\n  isOverHorizontal: boolean;\n  isOverVertical: boolean;\n} => {\n  const [isOverHorizontal, isOverVertical] = [\n    scrollBars.horizontal,\n    scrollBars.vertical,\n  ].map((scrollBar) => {\n    return (\n      scrollBar != null &&\n      scrollBar.x <= x &&\n      x <= scrollBar.x + scrollBar.width &&\n      scrollBar.y <= y &&\n      y <= scrollBar.y + scrollBar.height\n    );\n  });\n  const isOverEither = isOverHorizontal || isOverVertical;\n  return { isOverEither, isOverHorizontal, isOverVertical };\n};\n","import {\n  ExcalidrawElement,\n  NonDeletedExcalidrawElement,\n} from \"../element/types\";\nimport { getElementAbsoluteCoords, getElementBounds } from \"../element\";\nimport { AppState } from \"../types\";\n\nexport const getElementsWithinSelection = (\n  elements: readonly NonDeletedExcalidrawElement[],\n  selection: NonDeletedExcalidrawElement,\n) => {\n  const [\n    selectionX1,\n    selectionY1,\n    selectionX2,\n    selectionY2,\n  ] = getElementAbsoluteCoords(selection);\n  return elements.filter((element) => {\n    const [elementX1, elementY1, elementX2, elementY2] = getElementBounds(\n      element,\n    );\n\n    return (\n      element.type !== \"selection\" &&\n      selectionX1 <= elementX1 &&\n      selectionY1 <= elementY1 &&\n      selectionX2 >= elementX2 &&\n      selectionY2 >= elementY2\n    );\n  });\n};\n\nexport const isSomeElementSelected = (\n  elements: readonly NonDeletedExcalidrawElement[],\n  appState: AppState,\n): boolean => {\n  return elements.some((element) => appState.selectedElementIds[element.id]);\n};\n\n/**\n * Returns common attribute (picked by `getAttribute` callback) of selected\n *  elements. If elements don't share the same value, returns `null`.\n */\nexport const getCommonAttributeOfSelectedElements = <T>(\n  elements: readonly NonDeletedExcalidrawElement[],\n  appState: AppState,\n  getAttribute: (element: ExcalidrawElement) => T,\n): T | null => {\n  const attributes = Array.from(\n    new Set(\n      getSelectedElements(elements, appState).map((element) =>\n        getAttribute(element),\n      ),\n    ),\n  );\n  return attributes.length === 1 ? attributes[0] : null;\n};\n\nexport const getSelectedElements = (\n  elements: readonly NonDeletedExcalidrawElement[],\n  appState: AppState,\n) => {\n  return elements.filter((element) => appState.selectedElementIds[element.id]);\n};\n\nexport const getTargetElement = (\n  elements: readonly NonDeletedExcalidrawElement[],\n  appState: AppState,\n) => {\n  return appState.editingElement\n    ? [appState.editingElement]\n    : getSelectedElements(elements, appState);\n};\n","import { AppState, FlooredNumber } from \"../types\";\nimport { ExcalidrawElement } from \"../element/types\";\nimport { getCommonBounds, getClosestElementBounds } from \"../element\";\n\nimport {\n  sceneCoordsToViewportCoords,\n  viewportCoordsToSceneCoords,\n} from \"../utils\";\n\nexport const normalizeScroll = (pos: number) =>\n  Math.floor(pos) as FlooredNumber;\n\nfunction isOutsideViewPort(\n  appState: AppState,\n  canvas: HTMLCanvasElement | null,\n  cords: Array<number>,\n) {\n  const [x1, y1, x2, y2] = cords;\n  const { x: viewportX1, y: viewportY1 } = sceneCoordsToViewportCoords(\n    { sceneX: x1, sceneY: y1 },\n    appState,\n    canvas,\n    window.devicePixelRatio,\n  );\n  const { x: viewportX2, y: viewportY2 } = sceneCoordsToViewportCoords(\n    { sceneX: x2, sceneY: y2 },\n    appState,\n    canvas,\n    window.devicePixelRatio,\n  );\n  return (\n    viewportX2 - viewportX1 > appState.width ||\n    viewportY2 - viewportY1 > appState.height\n  );\n}\n\nexport const calculateScrollCenter = (\n  elements: readonly ExcalidrawElement[],\n  appState: AppState,\n  canvas: HTMLCanvasElement | null,\n): { scrollX: FlooredNumber; scrollY: FlooredNumber } => {\n  if (!elements.length) {\n    return {\n      scrollX: normalizeScroll(0),\n      scrollY: normalizeScroll(0),\n    };\n  }\n  const scale = window.devicePixelRatio;\n  let [x1, y1, x2, y2] = getCommonBounds(elements);\n  if (isOutsideViewPort(appState, canvas, [x1, y1, x2, y2])) {\n    [x1, y1, x2, y2] = getClosestElementBounds(\n      elements,\n      viewportCoordsToSceneCoords(\n        { clientX: appState.scrollX, clientY: appState.scrollY },\n        appState,\n        canvas,\n        scale,\n      ),\n    );\n  }\n\n  const centerX = (x1 + x2) / 2;\n  const centerY = (y1 + y2) / 2;\n\n  return {\n    scrollX: normalizeScroll(appState.width / 2 - centerX),\n    scrollY: normalizeScroll(appState.height / 2 - centerY),\n  };\n};\n","import {\n  ExcalidrawElement,\n  NonDeletedExcalidrawElement,\n} from \"../element/types\";\n\nimport { getElementAbsoluteCoords, hitTest } from \"../element\";\nimport { AppState } from \"../types\";\n\nexport const hasBackground = (type: string) =>\n  type === \"rectangle\" ||\n  type === \"ellipse\" ||\n  type === \"diamond\" ||\n  type === \"draw\" ||\n  type === \"line\";\n\nexport const hasStroke = (type: string) =>\n  type === \"rectangle\" ||\n  type === \"ellipse\" ||\n  type === \"diamond\" ||\n  type === \"arrow\" ||\n  type === \"draw\" ||\n  type === \"line\";\n\nexport const hasText = (type: string) => type === \"text\";\n\nexport const getElementAtPosition = (\n  elements: readonly NonDeletedExcalidrawElement[],\n  appState: AppState,\n  x: number,\n  y: number,\n  zoom: number,\n) => {\n  let hitElement = null;\n  // We need to to hit testing from front (end of the array) to back (beginning of the array)\n  for (let i = elements.length - 1; i >= 0; --i) {\n    if (elements[i].isDeleted) {\n      continue;\n    }\n    if (hitTest(elements[i], appState, x, y, zoom)) {\n      hitElement = elements[i];\n      break;\n    }\n  }\n\n  return hitElement;\n};\n\nexport const getElementContainingPosition = (\n  elements: readonly ExcalidrawElement[],\n  x: number,\n  y: number,\n) => {\n  let hitElement = null;\n  // We need to to hit testing from front (end of the array) to back (beginning of the array)\n  for (let i = elements.length - 1; i >= 0; --i) {\n    if (elements[i].isDeleted) {\n      continue;\n    }\n    const [x1, y1, x2, y2] = getElementAbsoluteCoords(elements[i]);\n    if (x1 < x && x < x2 && y1 < y && y < y2) {\n      hitElement = elements[i];\n      break;\n    }\n  }\n  return hitElement;\n};\n","export const getZoomOrigin = (\n  canvas: HTMLCanvasElement | null,\n  scale: number,\n) => {\n  if (canvas === null) {\n    return { x: 0, y: 0 };\n  }\n  const context = canvas.getContext(\"2d\");\n  if (context === null) {\n    return { x: 0, y: 0 };\n  }\n\n  const normalizedCanvasWidth = canvas.width / scale;\n  const normalizedCanvasHeight = canvas.height / scale;\n\n  return {\n    x: normalizedCanvasWidth / 2,\n    y: normalizedCanvasHeight / 2,\n  };\n};\n\nexport const getNormalizedZoom = (zoom: number): number => {\n  const normalizedZoom = parseFloat(zoom.toFixed(2));\n  const clampedZoom = Math.max(0.1, Math.min(normalizedZoom, 2));\n  return clampedZoom;\n};\n","import {\n  ExcalidrawElement,\n  NonDeletedExcalidrawElement,\n  NonDeleted,\n} from \"../element/types\";\nimport {\n  getNonDeletedElements,\n  isNonDeletedElement,\n  getElementMap,\n} from \"../element\";\n\nexport interface SceneStateCallback {\n  (): void;\n}\n\nexport interface SceneStateCallbackRemover {\n  (): void;\n}\n\nclass GlobalScene {\n  private callbacks: Set<SceneStateCallback> = new Set();\n\n  private nonDeletedElements: readonly NonDeletedExcalidrawElement[] = [];\n  private elements: readonly ExcalidrawElement[] = [];\n  private elementsMap: {\n    [id: string]: ExcalidrawElement;\n  } = {};\n\n  getElementsIncludingDeleted() {\n    return this.elements;\n  }\n\n  getElements(): readonly NonDeletedExcalidrawElement[] {\n    return this.nonDeletedElements;\n  }\n\n  getElement(id: ExcalidrawElement[\"id\"]): ExcalidrawElement | null {\n    return this.elementsMap[id] || null;\n  }\n\n  getNonDeletedElement(\n    id: ExcalidrawElement[\"id\"],\n  ): NonDeleted<ExcalidrawElement> | null {\n    const element = this.getElement(id);\n    if (element && isNonDeletedElement(element)) {\n      return element;\n    }\n    return null;\n  }\n\n  replaceAllElements(nextElements: readonly ExcalidrawElement[]) {\n    this.elements = nextElements;\n    this.elementsMap = getElementMap(nextElements);\n    this.nonDeletedElements = getNonDeletedElements(this.elements);\n    this.informMutation();\n  }\n\n  informMutation() {\n    for (const callback of Array.from(this.callbacks)) {\n      callback();\n    }\n  }\n\n  addCallback(cb: SceneStateCallback): SceneStateCallbackRemover {\n    if (this.callbacks.has(cb)) {\n      throw new Error();\n    }\n\n    this.callbacks.add(cb);\n\n    return () => {\n      if (!this.callbacks.has(cb)) {\n        throw new Error();\n      }\n      this.callbacks.delete(cb);\n    };\n  }\n}\n\nexport const globalSceneState = new GlobalScene();\n","import { FlooredNumber } from \"./types\";\nimport { getZoomOrigin } from \"./scene\";\nimport { CURSOR_TYPE, FONT_FAMILY } from \"./constants\";\nimport { FontFamily, FontString } from \"./element/types\";\n\nexport const SVG_NS = \"http://www.w3.org/2000/svg\";\n\nlet mockDateTime: string | null = null;\n\nexport const setDateTimeForTests = (dateTime: string) => {\n  mockDateTime = dateTime;\n};\n\nexport const getDateTime = () => {\n  if (mockDateTime) {\n    return mockDateTime;\n  }\n\n  const date = new Date();\n  const year = date.getFullYear();\n  const month = `${date.getMonth() + 1}`.padStart(2, \"0\");\n  const day = `${date.getDate()}`.padStart(2, \"0\");\n  const hr = `${date.getHours()}`.padStart(2, \"0\");\n  const min = `${date.getMinutes()}`.padStart(2, \"0\");\n\n  return `${year}-${month}-${day}-${hr}${min}`;\n};\n\nexport const capitalizeString = (str: string) =>\n  str.charAt(0).toUpperCase() + str.slice(1);\n\nexport const isToolIcon = (\n  target: Element | EventTarget | null,\n): target is HTMLElement =>\n  target instanceof HTMLElement && target.className.includes(\"ToolIcon\");\n\nexport const isInputLike = (\n  target: Element | EventTarget | null,\n): target is\n  | HTMLInputElement\n  | HTMLTextAreaElement\n  | HTMLSelectElement\n  | HTMLBRElement\n  | HTMLDivElement =>\n  (target instanceof HTMLElement && target.dataset.type === \"wysiwyg\") ||\n  target instanceof HTMLBRElement || // newline in wysiwyg\n  target instanceof HTMLInputElement ||\n  target instanceof HTMLTextAreaElement ||\n  target instanceof HTMLSelectElement;\n\nexport const isWritableElement = (\n  target: Element | EventTarget | null,\n): target is\n  | HTMLInputElement\n  | HTMLTextAreaElement\n  | HTMLBRElement\n  | HTMLDivElement =>\n  (target instanceof HTMLElement && target.dataset.type === \"wysiwyg\") ||\n  target instanceof HTMLBRElement || // newline in wysiwyg\n  target instanceof HTMLTextAreaElement ||\n  (target instanceof HTMLInputElement &&\n    (target.type === \"text\" || target.type === \"number\"));\n\nexport const getFontFamilyString = ({\n  fontFamily,\n}: {\n  fontFamily: FontFamily;\n}) => {\n  return FONT_FAMILY[fontFamily];\n};\n\n/** returns fontSize+fontFamily string for assignment to DOM elements */\nexport const getFontString = ({\n  fontSize,\n  fontFamily,\n}: {\n  fontSize: number;\n  fontFamily: FontFamily;\n}) => {\n  return `${fontSize}px ${getFontFamilyString({ fontFamily })}` as FontString;\n};\n\n// https://github.com/grassator/canvas-text-editor/blob/master/lib/FontMetrics.js\nexport const measureText = (text: string, font: FontString) => {\n  const line = document.createElement(\"div\");\n  const body = document.body;\n  line.style.position = \"absolute\";\n  line.style.whiteSpace = \"pre\";\n  line.style.font = font;\n  body.appendChild(line);\n  line.innerText = text\n    .split(\"\\n\")\n    // replace empty lines with single space because leading/trailing empty\n    //  lines would be stripped from computation\n    .map((x) => x || \" \")\n    .join(\"\\n\");\n  const width = line.offsetWidth;\n  const height = line.offsetHeight;\n  // Now creating 1px sized item that will be aligned to baseline\n  // to calculate baseline shift\n  const span = document.createElement(\"span\");\n  span.style.display = \"inline-block\";\n  span.style.overflow = \"hidden\";\n  span.style.width = \"1px\";\n  span.style.height = \"1px\";\n  line.appendChild(span);\n  // Baseline is important for positioning text on canvas\n  const baseline = span.offsetTop + span.offsetHeight;\n  document.body.removeChild(line);\n\n  return { width, height, baseline };\n};\n\nexport const debounce = <T extends any[]>(\n  fn: (...args: T) => void,\n  timeout: number,\n) => {\n  let handle = 0;\n  let lastArgs: T;\n  const ret = (...args: T) => {\n    lastArgs = args;\n    clearTimeout(handle);\n    handle = window.setTimeout(() => fn(...args), timeout);\n  };\n  ret.flush = () => {\n    clearTimeout(handle);\n    fn(...lastArgs);\n  };\n  return ret;\n};\n\nexport const selectNode = (node: Element) => {\n  const selection = window.getSelection();\n  if (selection) {\n    const range = document.createRange();\n    range.selectNodeContents(node);\n    selection.removeAllRanges();\n    selection.addRange(range);\n  }\n};\n\nexport const removeSelection = () => {\n  const selection = window.getSelection();\n  if (selection) {\n    selection.removeAllRanges();\n  }\n};\n\nexport const distance = (x: number, y: number) => Math.abs(x - y);\n\nexport const resetCursor = () => {\n  document.documentElement.style.cursor = \"\";\n};\n\nexport const setCursorForShape = (shape: string) => {\n  if (shape === \"selection\") {\n    resetCursor();\n  } else {\n    document.documentElement.style.cursor = CURSOR_TYPE.CROSSHAIR;\n  }\n};\n\nexport const isFullScreen = () =>\n  document.fullscreenElement?.nodeName === \"HTML\";\n\nexport const allowFullScreen = () =>\n  document.documentElement.requestFullscreen();\n\nexport const exitFullScreen = () => document.exitFullscreen();\n\nexport const getShortcutKey = (shortcut: string): string => {\n  const isMac = /Mac|iPod|iPhone|iPad/.test(window.navigator.platform);\n  if (isMac) {\n    return `${shortcut\n      .replace(/\\bCtrlOrCmd\\b/i, \"Cmd\")\n      .replace(/\\bAlt\\b/i, \"Option\")\n      .replace(/\\bDel\\b/i, \"Delete\")\n      .replace(/\\b(Enter|Return)\\b/i, \"Enter\")}`;\n  }\n  return `${shortcut.replace(/\\bCtrlOrCmd\\b/i, \"Ctrl\")}`;\n};\nexport const viewportCoordsToSceneCoords = (\n  { clientX, clientY }: { clientX: number; clientY: number },\n  {\n    scrollX,\n    scrollY,\n    zoom,\n  }: {\n    scrollX: FlooredNumber;\n    scrollY: FlooredNumber;\n    zoom: number;\n  },\n  canvas: HTMLCanvasElement | null,\n  scale: number,\n) => {\n  const zoomOrigin = getZoomOrigin(canvas, scale);\n  const clientXWithZoom = zoomOrigin.x + (clientX - zoomOrigin.x) / zoom;\n  const clientYWithZoom = zoomOrigin.y + (clientY - zoomOrigin.y) / zoom;\n\n  const x = clientXWithZoom - scrollX;\n  const y = clientYWithZoom - scrollY;\n\n  return { x, y };\n};\n\nexport const sceneCoordsToViewportCoords = (\n  { sceneX, sceneY }: { sceneX: number; sceneY: number },\n  {\n    scrollX,\n    scrollY,\n    zoom,\n  }: {\n    scrollX: FlooredNumber;\n    scrollY: FlooredNumber;\n    zoom: number;\n  },\n  canvas: HTMLCanvasElement | null,\n  scale: number,\n) => {\n  const zoomOrigin = getZoomOrigin(canvas, scale);\n  const x = zoomOrigin.x - (zoomOrigin.x - sceneX - scrollX) * zoom;\n  const y = zoomOrigin.y - (zoomOrigin.y - sceneY - scrollY) * zoom;\n\n  return { x, y };\n};\n\nexport const getGlobalCSSVariable = (name: string) =>\n  getComputedStyle(document.documentElement).getPropertyValue(`--${name}`);\n\nconst RS_LTR_CHARS =\n  \"A-Za-z\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02B8\\u0300-\\u0590\\u0800-\\u1FFF\" +\n  \"\\u2C00-\\uFB1C\\uFDFE-\\uFE6F\\uFEFD-\\uFFFF\";\nconst RS_RTL_CHARS = \"\\u0591-\\u07FF\\uFB1D-\\uFDFD\\uFE70-\\uFEFC\";\nconst RE_RTL_CHECK = new RegExp(`^[^${RS_LTR_CHARS}]*[${RS_RTL_CHARS}]`);\n/**\n * Checks whether first directional character is RTL. Meaning whether it starts\n *  with RTL characters, or indeterminate (numbers etc.) characters followed by\n *  RTL.\n * See https://github.com/excalidraw/excalidraw/pull/1722#discussion_r436340171\n */\nexport const isRTL = (text: string) => {\n  return RE_RTL_CHECK.test(text);\n};\n\nexport function tupleToCoors(\n  xyTuple: [number, number],\n): { x: number; y: number } {\n  const [x, y] = xyTuple;\n  return { x, y };\n}\n","import React from \"react\";\nimport * as Sentry from \"@sentry/browser\";\nimport { resetCursor } from \"../utils\";\nimport { t } from \"../i18n\";\n\ninterface TopErrorBoundaryState {\n  hasError: boolean;\n  sentryEventId: string;\n  localStorage: string;\n}\n\nexport class TopErrorBoundary extends React.Component<\n  any,\n  TopErrorBoundaryState\n> {\n  state: TopErrorBoundaryState = {\n    hasError: false,\n    sentryEventId: \"\",\n    localStorage: \"\",\n  };\n\n  render() {\n    return this.state.hasError ? this.errorSplash() : this.props.children;\n  }\n\n  componentDidCatch(error: Error, errorInfo: any) {\n    resetCursor();\n    const _localStorage: any = {};\n    for (const [key, value] of Object.entries({ ...localStorage })) {\n      try {\n        _localStorage[key] = JSON.parse(value);\n      } catch (error) {\n        _localStorage[key] = value;\n      }\n    }\n\n    Sentry.withScope((scope) => {\n      scope.setExtras(errorInfo);\n      const eventId = Sentry.captureException(error);\n\n      this.setState((state) => ({\n        hasError: true,\n        sentryEventId: eventId,\n        localStorage: JSON.stringify(_localStorage),\n      }));\n    });\n  }\n\n  private selectTextArea(event: React.MouseEvent<HTMLTextAreaElement>) {\n    if (event.target !== document.activeElement) {\n      event.preventDefault();\n      (event.target as HTMLTextAreaElement).select();\n    }\n  }\n\n  private async createGithubIssue() {\n    let body = \"\";\n    try {\n      const templateStrFn = (await import(\"../bug-issue-template\")).default;\n      body = encodeURIComponent(templateStrFn(this.state.sentryEventId));\n    } catch (error) {\n      console.error(error);\n    }\n\n    window.open(\n      `https://github.com/excalidraw/excalidraw/issues/new?body=${body}`,\n    );\n  }\n\n  private errorSplash() {\n    return (\n      <div className=\"ErrorSplash\">\n        <div className=\"ErrorSplash-messageContainer\">\n          <div className=\"ErrorSplash-paragraph bigger align-center\">\n            {t(\"errorSplash.headingMain_pre\")}\n            <button onClick={() => window.location.reload()}>\n              {t(\"errorSplash.headingMain_button\")}\n            </button>\n          </div>\n          <div className=\"ErrorSplash-paragraph align-center\">\n            {t(\"errorSplash.clearCanvasMessage\")}\n            <button\n              onClick={() => {\n                try {\n                  localStorage.clear();\n                  window.location.reload();\n                } catch (error) {\n                  console.error(error);\n                }\n              }}\n            >\n              {t(\"errorSplash.clearCanvasMessage_button\")}\n            </button>\n            <br />\n            <div className=\"smaller\">\n              <span role=\"img\" aria-label=\"warning\">\n                \n              </span>\n              {t(\"errorSplash.clearCanvasCaveat\")}\n              <span role=\"img\" aria-hidden=\"true\">\n                \n              </span>\n            </div>\n          </div>\n          <div>\n            <div className=\"ErrorSplash-paragraph\">\n              {t(\"errorSplash.trackedToSentry_pre\")}\n              {this.state.sentryEventId}\n              {t(\"errorSplash.trackedToSentry_post\")}\n            </div>\n            <div className=\"ErrorSplash-paragraph\">\n              {t(\"errorSplash.openIssueMessage_pre\")}\n              <button onClick={() => this.createGithubIssue()}>\n                {t(\"errorSplash.openIssueMessage_button\")}\n              </button>\n              {t(\"errorSplash.openIssueMessage_post\")}\n            </div>\n            <div className=\"ErrorSplash-paragraph\">\n              <div className=\"ErrorSplash-details\">\n                <label>{t(\"errorSplash.sceneContent\")}</label>\n                <textarea\n                  rows={5}\n                  onPointerDown={this.selectTextArea}\n                  readOnly={true}\n                  value={this.state.localStorage}\n                />\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    );\n  }\n}\n","import React from \"react\";\n\nexport const LoadingMessage = () => {\n  // !! KEEP THIS IN SYNC WITH index.html !!\n  return (\n    <div className=\"LoadingMessage\">\n      <span>{\"Loading scene...\"}</span>\n    </div>\n  );\n};\n","import React from \"react\";\n\nimport { LoadingMessage } from \"./LoadingMessage\";\nimport { setLanguageFirstTime } from \"../i18n\";\n\nexport class InitializeApp extends React.Component<\n  any,\n  { isLoading: boolean }\n> {\n  public state: { isLoading: boolean } = {\n    isLoading: true,\n  };\n\n  async componentDidMount() {\n    await setLanguageFirstTime();\n    this.setState({\n      isLoading: false,\n    });\n  }\n\n  public render() {\n    return this.state.isLoading ? <LoadingMessage /> : this.props.children;\n  }\n}\n","import React, { useState, useEffect, useRef, useContext } from \"react\";\n\nconst context = React.createContext(false);\n\nexport const IsMobileProvider = ({\n  children,\n}: {\n  children: React.ReactNode;\n}) => {\n  const query = useRef<MediaQueryList>();\n  if (!query.current) {\n    query.current = window.matchMedia\n      ? window.matchMedia(\n          \"(max-width: 640px), (max-height: 500px) and (max-width: 1000px)\",\n        )\n      : (({\n          matches: false,\n          addListener: () => {},\n          removeListener: () => {},\n        } as any) as MediaQueryList);\n  }\n  const [isMobile, setMobile] = useState(query.current.matches);\n\n  useEffect(() => {\n    const handler = () => setMobile(query.current!.matches);\n    query.current!.addListener(handler);\n    return () => query.current!.removeListener(handler);\n  }, []);\n\n  return <context.Provider value={isMobile}>{children}</context.Provider>;\n};\n\nexport default function useIsMobile() {\n  return useContext(context);\n}\n","import oc from \"open-color\";\nimport { AppState, FlooredNumber } from \"./types\";\nimport { getDateTime } from \"./utils\";\nimport { t } from \"./i18n\";\nimport {\n  DEFAULT_FONT_SIZE,\n  DEFAULT_FONT_FAMILY,\n  DEFAULT_TEXT_ALIGN,\n} from \"./constants\";\n\nexport const getDefaultAppState = (): AppState => {\n  return {\n    isLoading: false,\n    errorMessage: null,\n    draggingElement: null,\n    resizingElement: null,\n    multiElement: null,\n    editingElement: null,\n    editingLinearElement: null,\n    elementType: \"selection\",\n    elementLocked: false,\n    exportBackground: true,\n    shouldAddWatermark: false,\n    currentItemStrokeColor: oc.black,\n    currentItemBackgroundColor: \"transparent\",\n    currentItemFillStyle: \"hachure\",\n    currentItemStrokeWidth: 1,\n    currentItemStrokeStyle: \"solid\",\n    currentItemRoughness: 1,\n    currentItemOpacity: 100,\n    currentItemFontSize: DEFAULT_FONT_SIZE,\n    currentItemFontFamily: DEFAULT_FONT_FAMILY,\n    currentItemTextAlign: DEFAULT_TEXT_ALIGN,\n    viewBackgroundColor: oc.white,\n    scrollX: 0 as FlooredNumber,\n    scrollY: 0 as FlooredNumber,\n    cursorX: 0,\n    cursorY: 0,\n    cursorButton: \"up\",\n    scrolledOutside: false,\n    name: `${t(\"labels.untitled\")}-${getDateTime()}`,\n    username: \"\",\n    isCollaborating: false,\n    isResizing: false,\n    isRotating: false,\n    selectionElement: null,\n    zoom: 1,\n    openMenu: null,\n    lastPointerDownWith: \"mouse\",\n    selectedElementIds: {},\n    previousSelectedElementIds: {},\n    collaborators: new Map(),\n    shouldCacheIgnoreZoom: false,\n    showShortcutsDialog: false,\n    zenModeEnabled: false,\n    gridSize: null,\n    editingGroupId: null,\n    selectedGroupIds: {},\n    width: window.innerWidth,\n    height: window.innerHeight,\n    isLibraryOpen: false,\n  };\n};\n\nexport const clearAppStateForLocalStorage = (appState: AppState) => {\n  const {\n    draggingElement,\n    resizingElement,\n    multiElement,\n    editingElement,\n    selectionElement,\n    isResizing,\n    isRotating,\n    collaborators,\n    isCollaborating,\n    isLoading,\n    errorMessage,\n    showShortcutsDialog,\n    editingLinearElement,\n    isLibraryOpen,\n    ...exportedState\n  } = appState;\n  return exportedState;\n};\n\nexport const cleanAppStateForExport = (appState: AppState) => {\n  return {\n    viewBackgroundColor: appState.viewBackgroundColor,\n    gridSize: appState.gridSize,\n  };\n};\n","import oc from \"open-color\";\n\nconst shades = (i: number) => [\n  oc.red[i],\n  oc.pink[i],\n  oc.grape[i],\n  oc.violet[i],\n  oc.indigo[i],\n  oc.blue[i],\n  oc.cyan[i],\n  oc.teal[i],\n  oc.green[i],\n  oc.lime[i],\n  oc.yellow[i],\n  oc.orange[i],\n];\n\nexport default {\n  canvasBackground: [oc.white, oc.gray[0], oc.gray[1], ...shades(0)],\n  elementBackground: [\"transparent\", oc.gray[4], oc.gray[6], ...shades(6)],\n  elementStroke: [oc.black, oc.gray[8], oc.gray[7], ...shades(9)],\n};\n","import colors from \"./colors\";\n\nexport const getClientColors = (clientId: string) => {\n  // Naive way of getting an integer out of the clientId\n  const sum = clientId.split(\"\").reduce((a, str) => a + str.charCodeAt(0), 0);\n\n  // Skip transparent background.\n  const backgrounds = colors.elementBackground.slice(1);\n  const strokes = colors.elementStroke.slice(1);\n  return {\n    background: backgrounds[sum % backgrounds.length],\n    stroke: strokes[sum % strokes.length],\n  };\n};\n\nexport const getClientInitials = (username?: string | null) => {\n  if (!username) {\n    return \"?\";\n  }\n  const names = username.trim().split(\" \");\n\n  if (names.length < 2) {\n    return names[0].substring(0, 2).toUpperCase();\n  }\n\n  const firstName = names[0];\n  const lastName = names[names.length - 1];\n\n  return (firstName[0] + lastName[0]).toUpperCase();\n};\n","import {\n  NonDeleted,\n  ExcalidrawLinearElement,\n  ExcalidrawElement,\n} from \"./types\";\nimport { distance2d, rotate, isPathALoop } from \"../math\";\nimport { getElementAbsoluteCoords } from \".\";\nimport { getElementPointsCoords } from \"./bounds\";\nimport { Point, AppState } from \"../types\";\nimport { mutateElement } from \"./mutateElement\";\nimport { SceneHistory } from \"../history\";\nimport { globalSceneState } from \"../scene\";\n\nexport class LinearElementEditor {\n  public elementId: ExcalidrawElement[\"id\"];\n  public activePointIndex: number | null;\n  public draggingElementPointIndex: number | null;\n  public lastUncommittedPoint: Point | null;\n\n  constructor(element: NonDeleted<ExcalidrawLinearElement>) {\n    LinearElementEditor.normalizePoints(element);\n\n    this.elementId = element.id;\n    this.activePointIndex = null;\n    this.lastUncommittedPoint = null;\n    this.draggingElementPointIndex = null;\n  }\n\n  // ---------------------------------------------------------------------------\n  // static methods\n  // ---------------------------------------------------------------------------\n\n  static POINT_HANDLE_SIZE = 20;\n\n  static getElement(id: ExcalidrawElement[\"id\"]) {\n    const element = globalSceneState.getNonDeletedElement(id);\n    if (element) {\n      return element as NonDeleted<ExcalidrawLinearElement>;\n    }\n    return null;\n  }\n\n  /** @returns whether point was dragged */\n  static handlePointDragging(\n    appState: AppState,\n    setState: React.Component<any, AppState>[\"setState\"],\n    scenePointerX: number,\n    scenePointerY: number,\n    lastX: number,\n    lastY: number,\n  ): boolean {\n    if (!appState.editingLinearElement) {\n      return false;\n    }\n    const { editingLinearElement } = appState;\n    let { draggingElementPointIndex, elementId } = editingLinearElement;\n\n    const element = LinearElementEditor.getElement(elementId);\n    if (!element) {\n      return false;\n    }\n\n    const clickedPointIndex =\n      draggingElementPointIndex ??\n      LinearElementEditor.getPointIndexUnderCursor(\n        element,\n        appState.zoom,\n        scenePointerX,\n        scenePointerY,\n      );\n\n    draggingElementPointIndex = draggingElementPointIndex ?? clickedPointIndex;\n    if (draggingElementPointIndex > -1) {\n      if (\n        editingLinearElement.draggingElementPointIndex !==\n          draggingElementPointIndex ||\n        editingLinearElement.activePointIndex !== clickedPointIndex\n      ) {\n        setState({\n          editingLinearElement: {\n            ...editingLinearElement,\n            draggingElementPointIndex,\n            activePointIndex: clickedPointIndex,\n          },\n        });\n      }\n\n      const [deltaX, deltaY] = rotate(\n        scenePointerX - lastX,\n        scenePointerY - lastY,\n        0,\n        0,\n        -element.angle,\n      );\n      const targetPoint = element.points[clickedPointIndex];\n      LinearElementEditor.movePoint(element, clickedPointIndex, [\n        targetPoint[0] + deltaX,\n        targetPoint[1] + deltaY,\n      ]);\n      return true;\n    }\n    return false;\n  }\n\n  static handlePointerUp(\n    editingLinearElement: LinearElementEditor,\n  ): LinearElementEditor {\n    const { elementId, draggingElementPointIndex } = editingLinearElement;\n    const element = LinearElementEditor.getElement(elementId);\n    if (!element) {\n      return editingLinearElement;\n    }\n\n    if (\n      draggingElementPointIndex !== null &&\n      (draggingElementPointIndex === 0 ||\n        draggingElementPointIndex === element.points.length - 1) &&\n      isPathALoop(element.points)\n    ) {\n      LinearElementEditor.movePoint(\n        element,\n        draggingElementPointIndex,\n        draggingElementPointIndex === 0\n          ? element.points[element.points.length - 1]\n          : element.points[0],\n      );\n    }\n    if (draggingElementPointIndex !== null) {\n      return {\n        ...editingLinearElement,\n        draggingElementPointIndex: null,\n      };\n    }\n    return editingLinearElement;\n  }\n\n  static handlePointerDown(\n    event: React.PointerEvent<HTMLCanvasElement>,\n    appState: AppState,\n    setState: React.Component<any, AppState>[\"setState\"],\n    history: SceneHistory,\n    scenePointerX: number,\n    scenePointerY: number,\n  ): {\n    didAddPoint: boolean;\n    hitElement: ExcalidrawElement | null;\n  } {\n    const ret: ReturnType<typeof LinearElementEditor[\"handlePointerDown\"]> = {\n      didAddPoint: false,\n      hitElement: null,\n    };\n\n    if (!appState.editingLinearElement) {\n      return ret;\n    }\n\n    const { elementId } = appState.editingLinearElement;\n    const element = LinearElementEditor.getElement(elementId);\n\n    if (!element) {\n      return ret;\n    }\n\n    if (event.altKey) {\n      if (!appState.editingLinearElement.lastUncommittedPoint) {\n        mutateElement(element, {\n          points: [\n            ...element.points,\n            LinearElementEditor.createPointAt(\n              element,\n              scenePointerX,\n              scenePointerY,\n            ),\n          ],\n        });\n      }\n      history.resumeRecording();\n      setState({\n        editingLinearElement: {\n          ...appState.editingLinearElement,\n          activePointIndex: element.points.length - 1,\n          lastUncommittedPoint: null,\n        },\n      });\n      ret.didAddPoint = true;\n      return ret;\n    }\n\n    const clickedPointIndex = LinearElementEditor.getPointIndexUnderCursor(\n      element,\n      appState.zoom,\n      scenePointerX,\n      scenePointerY,\n    );\n\n    // if we clicked on a point, set the element as hitElement otherwise\n    //  it would get deselected if the point is outside the hitbox area\n    if (clickedPointIndex > -1) {\n      ret.hitElement = element;\n    }\n\n    setState({\n      editingLinearElement: {\n        ...appState.editingLinearElement,\n        activePointIndex: clickedPointIndex > -1 ? clickedPointIndex : null,\n      },\n    });\n    return ret;\n  }\n\n  static handlePointerMove(\n    event: React.PointerEvent<HTMLCanvasElement>,\n    scenePointerX: number,\n    scenePointerY: number,\n    editingLinearElement: LinearElementEditor,\n  ): LinearElementEditor {\n    const { elementId, lastUncommittedPoint } = editingLinearElement;\n    const element = LinearElementEditor.getElement(elementId);\n    if (!element) {\n      return editingLinearElement;\n    }\n\n    const { points } = element;\n    const lastPoint = points[points.length - 1];\n\n    if (!event.altKey) {\n      if (lastPoint === lastUncommittedPoint) {\n        LinearElementEditor.movePoint(element, points.length - 1, \"delete\");\n      }\n      return editingLinearElement;\n    }\n\n    const newPoint = LinearElementEditor.createPointAt(\n      element,\n      scenePointerX,\n      scenePointerY,\n    );\n\n    if (lastPoint === lastUncommittedPoint) {\n      LinearElementEditor.movePoint(\n        element,\n        element.points.length - 1,\n        newPoint,\n      );\n    } else {\n      LinearElementEditor.movePoint(element, \"new\", newPoint);\n    }\n\n    return {\n      ...editingLinearElement,\n      lastUncommittedPoint: element.points[element.points.length - 1],\n    };\n  }\n\n  static getPointsGlobalCoordinates(\n    element: NonDeleted<ExcalidrawLinearElement>,\n  ) {\n    const [x1, y1, x2, y2] = getElementAbsoluteCoords(element);\n    const cx = (x1 + x2) / 2;\n    const cy = (y1 + y2) / 2;\n    return element.points.map((point) => {\n      let { x, y } = element;\n      [x, y] = rotate(x + point[0], y + point[1], cx, cy, element.angle);\n      return [x, y];\n    });\n  }\n\n  static getPointIndexUnderCursor(\n    element: NonDeleted<ExcalidrawLinearElement>,\n    zoom: AppState[\"zoom\"],\n    x: number,\n    y: number,\n  ) {\n    const pointHandles = this.getPointsGlobalCoordinates(element);\n    let idx = pointHandles.length;\n    // loop from right to left because points on the right are rendered over\n    //  points on the left, thus should take precedence when clicking, if they\n    //  overlap\n    while (--idx > -1) {\n      const point = pointHandles[idx];\n      if (\n        distance2d(x, y, point[0], point[1]) * zoom <\n        // +1px to account for outline stroke\n        this.POINT_HANDLE_SIZE / 2 + 1\n      ) {\n        return idx;\n      }\n    }\n    return -1;\n  }\n\n  static createPointAt(\n    element: NonDeleted<ExcalidrawLinearElement>,\n    scenePointerX: number,\n    scenePointerY: number,\n  ): Point {\n    const [x1, y1, x2, y2] = getElementAbsoluteCoords(element);\n    const cx = (x1 + x2) / 2;\n    const cy = (y1 + y2) / 2;\n    const [rotatedX, rotatedY] = rotate(\n      scenePointerX,\n      scenePointerY,\n      cx,\n      cy,\n      -element.angle,\n    );\n\n    return [rotatedX - element.x, rotatedY - element.y];\n  }\n\n  // element-mutating methods\n  // ---------------------------------------------------------------------------\n\n  /**\n   * Normalizes line points so that the start point is at [0,0]. This is\n   *  expected in various parts of the codebase.\n   */\n  static normalizePoints(element: NonDeleted<ExcalidrawLinearElement>) {\n    const { points } = element;\n\n    const offsetX = points[0][0];\n    const offsetY = points[0][1];\n\n    mutateElement(element, {\n      points: points.map((point, _idx) => {\n        return [point[0] - offsetX, point[1] - offsetY] as const;\n      }),\n      x: element.x + offsetX,\n      y: element.y + offsetY,\n    });\n  }\n\n  static movePoint(\n    element: NonDeleted<ExcalidrawLinearElement>,\n    pointIndex: number | \"new\",\n    targetPosition: Point | \"delete\",\n  ) {\n    const { points } = element;\n\n    // in case we're moving start point, instead of modifying its position\n    //  which would break the invariant of it being at [0,0], we move\n    //  all the other points in the opposite direction by delta to\n    //  offset it. We do the same with actual element.x/y position, so\n    //  this hacks are completely transparent to the user.\n    let offsetX = 0;\n    let offsetY = 0;\n\n    let nextPoints: (readonly [number, number])[];\n    if (targetPosition === \"delete\") {\n      // remove point\n      if (pointIndex === \"new\") {\n        throw new Error(\"invalid args in movePoint\");\n      }\n      nextPoints = points.slice();\n      nextPoints.splice(pointIndex, 1);\n      if (pointIndex === 0) {\n        // if deleting first point, make the next to be [0,0] and recalculate\n        //  positions of the rest with respect to it\n        offsetX = nextPoints[0][0];\n        offsetY = nextPoints[0][1];\n        nextPoints = nextPoints.map((point, idx) => {\n          if (idx === 0) {\n            return [0, 0];\n          }\n          return [point[0] - offsetX, point[1] - offsetY];\n        });\n      }\n    } else if (pointIndex === \"new\") {\n      nextPoints = [...points, targetPosition];\n    } else {\n      const deltaX = targetPosition[0] - points[pointIndex][0];\n      const deltaY = targetPosition[1] - points[pointIndex][1];\n      nextPoints = points.map((point, idx) => {\n        if (idx === pointIndex) {\n          if (idx === 0) {\n            offsetX = deltaX;\n            offsetY = deltaY;\n            return point;\n          }\n          offsetX = 0;\n          offsetY = 0;\n\n          return [point[0] + deltaX, point[1] + deltaY] as const;\n        }\n        return offsetX || offsetY\n          ? ([point[0] - offsetX, point[1] - offsetY] as const)\n          : point;\n      });\n    }\n\n    const nextCoords = getElementPointsCoords(element, nextPoints);\n    const prevCoords = getElementPointsCoords(element, points);\n    const nextCenterX = (nextCoords[0] + nextCoords[2]) / 2;\n    const nextCenterY = (nextCoords[1] + nextCoords[3]) / 2;\n    const prevCenterX = (prevCoords[0] + prevCoords[2]) / 2;\n    const prevCenterY = (prevCoords[1] + prevCoords[3]) / 2;\n    const dX = prevCenterX - nextCenterX;\n    const dY = prevCenterY - nextCenterY;\n    const rotated = rotate(offsetX, offsetY, dX, dY, element.angle);\n\n    mutateElement(element, {\n      points: nextPoints,\n      x: element.x + rotated[0],\n      y: element.y + rotated[1],\n    });\n  }\n}\n","import { RoughCanvas } from \"roughjs/bin/canvas\";\nimport { RoughSVG } from \"roughjs/bin/svg\";\nimport oc from \"open-color\";\n\nimport { FlooredNumber, AppState } from \"../types\";\nimport {\n  ExcalidrawElement,\n  NonDeletedExcalidrawElement,\n  ExcalidrawLinearElement,\n  NonDeleted,\n  GroupId,\n} from \"../element/types\";\nimport {\n  getElementAbsoluteCoords,\n  OMIT_SIDES_FOR_MULTIPLE_ELEMENTS,\n  handlerRectanglesFromCoords,\n  handlerRectangles,\n  getElementBounds,\n  getCommonBounds,\n} from \"../element\";\n\nimport { roundRect } from \"./roundRect\";\nimport { SceneState } from \"../scene/types\";\nimport {\n  getScrollBars,\n  SCROLLBAR_COLOR,\n  SCROLLBAR_WIDTH,\n} from \"../scene/scrollbars\";\nimport { getSelectedElements } from \"../scene/selection\";\n\nimport { renderElement, renderElementToSvg } from \"./renderElement\";\nimport { getClientColors } from \"../clients\";\nimport { isLinearElement } from \"../element/typeChecks\";\nimport { LinearElementEditor } from \"../element/linearElementEditor\";\nimport {\n  isSelectedViaGroup,\n  getSelectedGroupIds,\n  getElementsInGroup,\n} from \"../groups\";\n\ntype HandlerRectanglesRet = keyof ReturnType<typeof handlerRectangles>;\n\nconst strokeRectWithRotation = (\n  context: CanvasRenderingContext2D,\n  x: number,\n  y: number,\n  width: number,\n  height: number,\n  cx: number,\n  cy: number,\n  angle: number,\n  fill?: boolean,\n) => {\n  context.translate(cx, cy);\n  context.rotate(angle);\n  if (fill) {\n    context.fillRect(x - cx, y - cy, width, height);\n  }\n  context.strokeRect(x - cx, y - cy, width, height);\n  context.rotate(-angle);\n  context.translate(-cx, -cy);\n};\n\nconst strokeCircle = (\n  context: CanvasRenderingContext2D,\n  x: number,\n  y: number,\n  width: number,\n  height: number,\n) => {\n  context.beginPath();\n  context.arc(x + width / 2, y + height / 2, width / 2, 0, Math.PI * 2);\n  context.fill();\n  context.stroke();\n};\n\nconst strokeGrid = (\n  context: CanvasRenderingContext2D,\n  gridSize: number,\n  offsetX: number,\n  offsetY: number,\n  width: number,\n  height: number,\n) => {\n  const origStrokeStyle = context.strokeStyle;\n  context.strokeStyle = \"rgba(0,0,0,0.1)\";\n  context.beginPath();\n  for (let x = offsetX; x < offsetX + width + gridSize * 2; x += gridSize) {\n    context.moveTo(x, offsetY - gridSize);\n    context.lineTo(x, offsetY + height + gridSize * 2);\n  }\n  for (let y = offsetY; y < offsetY + height + gridSize * 2; y += gridSize) {\n    context.moveTo(offsetX - gridSize, y);\n    context.lineTo(offsetX + width + gridSize * 2, y);\n  }\n  context.stroke();\n  context.strokeStyle = origStrokeStyle;\n};\n\nconst renderLinearPointHandles = (\n  context: CanvasRenderingContext2D,\n  appState: AppState,\n  sceneState: SceneState,\n  element: NonDeleted<ExcalidrawLinearElement>,\n) => {\n  context.translate(sceneState.scrollX, sceneState.scrollY);\n  const origStrokeStyle = context.strokeStyle;\n  const lineWidth = context.lineWidth;\n  context.lineWidth = 1 / sceneState.zoom;\n\n  LinearElementEditor.getPointsGlobalCoordinates(element).forEach(\n    (point, idx) => {\n      context.strokeStyle = \"red\";\n      context.setLineDash([]);\n      context.fillStyle =\n        appState.editingLinearElement?.activePointIndex === idx\n          ? \"rgba(255, 127, 127, 0.9)\"\n          : \"rgba(255, 255, 255, 0.9)\";\n      const { POINT_HANDLE_SIZE } = LinearElementEditor;\n      strokeCircle(\n        context,\n        point[0] - POINT_HANDLE_SIZE / 2 / sceneState.zoom,\n        point[1] - POINT_HANDLE_SIZE / 2 / sceneState.zoom,\n        POINT_HANDLE_SIZE / sceneState.zoom,\n        POINT_HANDLE_SIZE / sceneState.zoom,\n      );\n    },\n  );\n  context.setLineDash([]);\n  context.lineWidth = lineWidth;\n  context.translate(-sceneState.scrollX, -sceneState.scrollY);\n  context.strokeStyle = origStrokeStyle;\n};\n\nexport const renderScene = (\n  elements: readonly NonDeletedExcalidrawElement[],\n  appState: AppState,\n  selectionElement: NonDeletedExcalidrawElement | null,\n  scale: number,\n  rc: RoughCanvas,\n  canvas: HTMLCanvasElement,\n  sceneState: SceneState,\n  // extra options, currently passed by export helper\n  {\n    renderScrollbars = true,\n    renderSelection = true,\n    // Whether to employ render optimizations to improve performance.\n    // Should not be turned on for export operations and similar, because it\n    //  doesn't guarantee pixel-perfect output.\n    renderOptimizations = false,\n    renderGrid = true,\n  }: {\n    renderScrollbars?: boolean;\n    renderSelection?: boolean;\n    renderOptimizations?: boolean;\n    renderGrid?: boolean;\n  } = {},\n) => {\n  if (!canvas) {\n    return { atLeastOneVisibleElement: false };\n  }\n\n  const context = canvas.getContext(\"2d\")!;\n  context.scale(scale, scale);\n\n  // When doing calculations based on canvas width we should used normalized one\n  const normalizedCanvasWidth = canvas.width / scale;\n  const normalizedCanvasHeight = canvas.height / scale;\n\n  // Paint background\n  if (typeof sceneState.viewBackgroundColor === \"string\") {\n    const hasTransparence =\n      sceneState.viewBackgroundColor === \"transparent\" ||\n      sceneState.viewBackgroundColor.length === 5 || // #RGBA\n      sceneState.viewBackgroundColor.length === 9 || // #RRGGBBA\n      /(hsla|rgba)\\(/.test(sceneState.viewBackgroundColor);\n    if (hasTransparence) {\n      context.clearRect(0, 0, normalizedCanvasWidth, normalizedCanvasHeight);\n    }\n    const fillStyle = context.fillStyle;\n    context.fillStyle = sceneState.viewBackgroundColor;\n    context.fillRect(0, 0, normalizedCanvasWidth, normalizedCanvasHeight);\n    context.fillStyle = fillStyle;\n  } else {\n    context.clearRect(0, 0, normalizedCanvasWidth, normalizedCanvasHeight);\n  }\n\n  // Apply zoom\n  const zoomTranslationX = (-normalizedCanvasWidth * (sceneState.zoom - 1)) / 2;\n  const zoomTranslationY =\n    (-normalizedCanvasHeight * (sceneState.zoom - 1)) / 2;\n  context.translate(zoomTranslationX, zoomTranslationY);\n  context.scale(sceneState.zoom, sceneState.zoom);\n\n  // Grid\n  if (renderGrid && appState.gridSize) {\n    strokeGrid(\n      context,\n      appState.gridSize,\n      -Math.ceil(zoomTranslationX / sceneState.zoom / appState.gridSize) *\n        appState.gridSize +\n        (sceneState.scrollX % appState.gridSize),\n      -Math.ceil(zoomTranslationY / sceneState.zoom / appState.gridSize) *\n        appState.gridSize +\n        (sceneState.scrollY % appState.gridSize),\n      normalizedCanvasWidth / sceneState.zoom,\n      normalizedCanvasHeight / sceneState.zoom,\n    );\n  }\n\n  // Paint visible elements\n  const visibleElements = elements.filter((element) =>\n    isVisibleElement(\n      element,\n      normalizedCanvasWidth,\n      normalizedCanvasHeight,\n      sceneState,\n    ),\n  );\n\n  visibleElements.forEach((element) => {\n    renderElement(element, rc, context, renderOptimizations, sceneState);\n    if (\n      isLinearElement(element) &&\n      appState.editingLinearElement &&\n      appState.editingLinearElement.elementId === element.id\n    ) {\n      renderLinearPointHandles(context, appState, sceneState, element);\n    }\n  });\n\n  // Paint selection element\n  if (selectionElement) {\n    renderElement(\n      selectionElement,\n      rc,\n      context,\n      renderOptimizations,\n      sceneState,\n    );\n  }\n\n  // Paint selected elements\n  if (\n    renderSelection &&\n    !appState.multiElement &&\n    !appState.editingLinearElement\n  ) {\n    context.translate(sceneState.scrollX, sceneState.scrollY);\n\n    const selections = elements.reduce((acc, element) => {\n      const selectionColors = [];\n      // local user\n      if (\n        appState.selectedElementIds[element.id] &&\n        !isSelectedViaGroup(appState, element)\n      ) {\n        selectionColors.push(oc.black);\n      }\n      // remote users\n      if (sceneState.remoteSelectedElementIds[element.id]) {\n        selectionColors.push(\n          ...sceneState.remoteSelectedElementIds[element.id].map((socketId) => {\n            const { background } = getClientColors(socketId);\n            return background;\n          }),\n        );\n      }\n      if (selectionColors.length) {\n        const [\n          elementX1,\n          elementY1,\n          elementX2,\n          elementY2,\n        ] = getElementAbsoluteCoords(element);\n        acc.push({\n          angle: element.angle,\n          elementX1,\n          elementY1,\n          elementX2,\n          elementY2,\n          selectionColors,\n        });\n      }\n      return acc;\n    }, [] as { angle: number; elementX1: number; elementY1: number; elementX2: number; elementY2: number; selectionColors: string[] }[]);\n\n    function addSelectionForGroupId(groupId: GroupId) {\n      const groupElements = getElementsInGroup(elements, groupId);\n      const [elementX1, elementY1, elementX2, elementY2] = getCommonBounds(\n        groupElements,\n      );\n      selections.push({\n        angle: 0,\n        elementX1,\n        elementX2,\n        elementY1,\n        elementY2,\n        selectionColors: [oc.black],\n      });\n    }\n\n    for (const groupId of getSelectedGroupIds(appState)) {\n      // TODO: support multiplayer selected group IDs\n      addSelectionForGroupId(groupId);\n    }\n\n    if (appState.editingGroupId) {\n      addSelectionForGroupId(appState.editingGroupId);\n    }\n\n    selections.forEach(\n      ({\n        angle,\n        elementX1,\n        elementY1,\n        elementX2,\n        elementY2,\n        selectionColors,\n      }) => {\n        const elementWidth = elementX2 - elementX1;\n        const elementHeight = elementY2 - elementY1;\n\n        const initialLineDash = context.getLineDash();\n        const lineWidth = context.lineWidth;\n        const lineDashOffset = context.lineDashOffset;\n        const strokeStyle = context.strokeStyle;\n\n        const dashedLinePadding = 4 / sceneState.zoom;\n        const dashWidth = 8 / sceneState.zoom;\n        const spaceWidth = 4 / sceneState.zoom;\n\n        context.lineWidth = 1 / sceneState.zoom;\n\n        const count = selectionColors.length;\n        for (var i = 0; i < count; ++i) {\n          context.strokeStyle = selectionColors[i];\n          context.setLineDash([\n            dashWidth,\n            spaceWidth + (dashWidth + spaceWidth) * (count - 1),\n          ]);\n          context.lineDashOffset = (dashWidth + spaceWidth) * i;\n          strokeRectWithRotation(\n            context,\n            elementX1 - dashedLinePadding,\n            elementY1 - dashedLinePadding,\n            elementWidth + dashedLinePadding * 2,\n            elementHeight + dashedLinePadding * 2,\n            elementX1 + elementWidth / 2,\n            elementY1 + elementHeight / 2,\n            angle,\n          );\n        }\n        context.lineDashOffset = lineDashOffset;\n        context.strokeStyle = strokeStyle;\n        context.lineWidth = lineWidth;\n        context.setLineDash(initialLineDash);\n      },\n    );\n    context.translate(-sceneState.scrollX, -sceneState.scrollY);\n\n    const locallySelectedElements = getSelectedElements(elements, appState);\n\n    // Paint resize handlers\n    if (locallySelectedElements.length === 1) {\n      context.translate(sceneState.scrollX, sceneState.scrollY);\n      context.fillStyle = oc.white;\n      const handlers = handlerRectangles(\n        locallySelectedElements[0],\n        sceneState.zoom,\n      );\n      Object.keys(handlers).forEach((key) => {\n        const handler = handlers[key as HandlerRectanglesRet];\n        if (handler !== undefined) {\n          const lineWidth = context.lineWidth;\n          context.lineWidth = 1 / sceneState.zoom;\n          if (key === \"rotation\") {\n            strokeCircle(\n              context,\n              handler[0],\n              handler[1],\n              handler[2],\n              handler[3],\n            );\n          } else {\n            strokeRectWithRotation(\n              context,\n              handler[0],\n              handler[1],\n              handler[2],\n              handler[3],\n              handler[0] + handler[2] / 2,\n              handler[1] + handler[3] / 2,\n              locallySelectedElements[0].angle,\n              true, // fill before stroke\n            );\n          }\n          context.lineWidth = lineWidth;\n        }\n      });\n      context.translate(-sceneState.scrollX, -sceneState.scrollY);\n    } else if (locallySelectedElements.length > 1) {\n      const dashedLinePadding = 4 / sceneState.zoom;\n      context.translate(sceneState.scrollX, sceneState.scrollY);\n      context.fillStyle = oc.white;\n      const [x1, y1, x2, y2] = getCommonBounds(locallySelectedElements);\n      const initialLineDash = context.getLineDash();\n      context.setLineDash([2 / sceneState.zoom]);\n      const lineWidth = context.lineWidth;\n      context.lineWidth = 1 / sceneState.zoom;\n      strokeRectWithRotation(\n        context,\n        x1 - dashedLinePadding,\n        y1 - dashedLinePadding,\n        x2 - x1 + dashedLinePadding * 2,\n        y2 - y1 + dashedLinePadding * 2,\n        (x1 + x2) / 2,\n        (y1 + y2) / 2,\n        0,\n      );\n      context.lineWidth = lineWidth;\n      context.setLineDash(initialLineDash);\n      const handlers = handlerRectanglesFromCoords(\n        [x1, y1, x2, y2],\n        0,\n        sceneState.zoom,\n        undefined,\n        OMIT_SIDES_FOR_MULTIPLE_ELEMENTS,\n      );\n      Object.keys(handlers).forEach((key) => {\n        const handler = handlers[key as HandlerRectanglesRet];\n        if (handler !== undefined) {\n          const lineWidth = context.lineWidth;\n          context.lineWidth = 1 / sceneState.zoom;\n          strokeRectWithRotation(\n            context,\n            handler[0],\n            handler[1],\n            handler[2],\n            handler[3],\n            handler[0] + handler[2] / 2,\n            handler[1] + handler[3] / 2,\n            0,\n            true, // fill before stroke\n          );\n          context.lineWidth = lineWidth;\n        }\n      });\n      context.translate(-sceneState.scrollX, -sceneState.scrollY);\n    }\n  }\n\n  // Reset zoom\n  context.scale(1 / sceneState.zoom, 1 / sceneState.zoom);\n  context.translate(-zoomTranslationX, -zoomTranslationY);\n\n  // Paint remote pointers\n  for (const clientId in sceneState.remotePointerViewportCoords) {\n    let { x, y } = sceneState.remotePointerViewportCoords[clientId];\n    const username = sceneState.remotePointerUsernames[clientId];\n\n    const width = 9;\n    const height = 14;\n\n    const isOutOfBounds =\n      x < 0 ||\n      x > normalizedCanvasWidth - width ||\n      y < 0 ||\n      y > normalizedCanvasHeight - height;\n\n    x = Math.max(x, 0);\n    x = Math.min(x, normalizedCanvasWidth - width);\n    y = Math.max(y, 0);\n    y = Math.min(y, normalizedCanvasHeight - height);\n\n    const { background, stroke } = getClientColors(clientId);\n\n    const strokeStyle = context.strokeStyle;\n    const fillStyle = context.fillStyle;\n    const globalAlpha = context.globalAlpha;\n    context.strokeStyle = stroke;\n    context.fillStyle = background;\n    if (isOutOfBounds) {\n      context.globalAlpha = 0.2;\n    }\n\n    if (\n      sceneState.remotePointerButton &&\n      sceneState.remotePointerButton[clientId] === \"down\"\n    ) {\n      context.beginPath();\n      context.arc(x, y, 15, 0, 2 * Math.PI, false);\n      context.lineWidth = 3;\n      context.strokeStyle = \"#ffffff88\";\n      context.stroke();\n      context.closePath();\n\n      context.beginPath();\n      context.arc(x, y, 15, 0, 2 * Math.PI, false);\n      context.lineWidth = 1;\n      context.strokeStyle = stroke;\n      context.stroke();\n      context.closePath();\n    }\n\n    context.beginPath();\n    context.moveTo(x, y);\n    context.lineTo(x + 1, y + 14);\n    context.lineTo(x + 4, y + 9);\n    context.lineTo(x + 9, y + 10);\n    context.lineTo(x, y);\n    context.fill();\n    context.stroke();\n\n    if (!isOutOfBounds && username) {\n      const offsetX = x + width;\n      const offsetY = y + height;\n      const paddingHorizontal = 4;\n      const paddingVertical = 4;\n      const measure = context.measureText(username);\n      const measureHeight =\n        measure.actualBoundingBoxDescent + measure.actualBoundingBoxAscent;\n\n      // Border\n      context.fillStyle = stroke;\n      context.globalAlpha = globalAlpha;\n      context.fillRect(\n        offsetX - 1,\n        offsetY - 1,\n        measure.width + 2 * paddingHorizontal + 2,\n        measureHeight + 2 * paddingVertical + 2,\n      );\n      // Background\n      context.fillStyle = background;\n      context.fillRect(\n        offsetX,\n        offsetY,\n        measure.width + 2 * paddingHorizontal,\n        measureHeight + 2 * paddingVertical,\n      );\n      context.fillStyle = oc.white;\n      context.fillText(\n        username,\n        offsetX + paddingHorizontal,\n        offsetY + paddingVertical + measure.actualBoundingBoxAscent,\n      );\n    }\n\n    context.strokeStyle = strokeStyle;\n    context.fillStyle = fillStyle;\n    context.globalAlpha = globalAlpha;\n    context.closePath();\n  }\n\n  // Paint scrollbars\n  let scrollBars;\n  if (renderScrollbars) {\n    scrollBars = getScrollBars(\n      elements,\n      normalizedCanvasWidth,\n      normalizedCanvasHeight,\n      sceneState,\n    );\n\n    const fillStyle = context.fillStyle;\n    const strokeStyle = context.strokeStyle;\n    context.fillStyle = SCROLLBAR_COLOR;\n    context.strokeStyle = \"rgba(255,255,255,0.8)\";\n    [scrollBars.horizontal, scrollBars.vertical].forEach((scrollBar) => {\n      if (scrollBar) {\n        roundRect(\n          context,\n          scrollBar.x,\n          scrollBar.y,\n          scrollBar.width,\n          scrollBar.height,\n          SCROLLBAR_WIDTH / 2,\n        );\n      }\n    });\n    context.fillStyle = fillStyle;\n    context.strokeStyle = strokeStyle;\n  }\n\n  context.scale(1 / scale, 1 / scale);\n\n  return { atLeastOneVisibleElement: visibleElements.length > 0, scrollBars };\n};\n\nconst isVisibleElement = (\n  element: ExcalidrawElement,\n  viewportWidth: number,\n  viewportHeight: number,\n  {\n    scrollX,\n    scrollY,\n    zoom,\n  }: {\n    scrollX: FlooredNumber;\n    scrollY: FlooredNumber;\n    zoom: number;\n  },\n) => {\n  const [x1, y1, x2, y2] = getElementBounds(element);\n\n  // Apply zoom\n  const viewportWidthWithZoom = viewportWidth / zoom;\n  const viewportHeightWithZoom = viewportHeight / zoom;\n\n  const viewportWidthDiff = viewportWidth - viewportWidthWithZoom;\n  const viewportHeightDiff = viewportHeight - viewportHeightWithZoom;\n\n  return (\n    x2 + scrollX - viewportWidthDiff / 2 >= 0 &&\n    x1 + scrollX - viewportWidthDiff / 2 <= viewportWidthWithZoom &&\n    y2 + scrollY - viewportHeightDiff / 2 >= 0 &&\n    y1 + scrollY - viewportHeightDiff / 2 <= viewportHeightWithZoom\n  );\n};\n\n// This should be only called for exporting purposes\nexport const renderSceneToSvg = (\n  elements: readonly NonDeletedExcalidrawElement[],\n  rsvg: RoughSVG,\n  svgRoot: SVGElement,\n  {\n    offsetX = 0,\n    offsetY = 0,\n  }: {\n    offsetX?: number;\n    offsetY?: number;\n  } = {},\n) => {\n  if (!svgRoot) {\n    return;\n  }\n  // render elements\n  elements.forEach((element) => {\n    if (!element.isDeleted) {\n      renderElementToSvg(\n        element,\n        rsvg,\n        svgRoot,\n        element.x + offsetX,\n        element.y + offsetY,\n      );\n    }\n  });\n};\n","/**\n * https://stackoverflow.com/a/3368118\n * Draws a rounded rectangle using the current state of the canvas.\n * @param {CanvasRenderingContext2D} context\n * @param {Number} x The top left x coordinate\n * @param {Number} y The top left y coordinate\n * @param {Number} width The width of the rectangle\n * @param {Number} height The height of the rectangle\n * @param {Number} radius The corner radius\n */\nexport const roundRect = (\n  context: CanvasRenderingContext2D,\n  x: number,\n  y: number,\n  width: number,\n  height: number,\n  radius: number,\n) => {\n  context.beginPath();\n  context.moveTo(x + radius, y);\n  context.lineTo(x + width - radius, y);\n  context.quadraticCurveTo(x + width, y, x + width, y + radius);\n  context.lineTo(x + width, y + height - radius);\n  context.quadraticCurveTo(\n    x + width,\n    y + height,\n    x + width - radius,\n    y + height,\n  );\n  context.lineTo(x + radius, y + height);\n  context.quadraticCurveTo(x, y + height, x, y + height - radius);\n  context.lineTo(x, y + radius);\n  context.quadraticCurveTo(x, y, x + radius, y);\n  context.closePath();\n  context.fill();\n  context.stroke();\n};\n","import rough from \"roughjs/bin/rough\";\nimport oc from \"open-color\";\nimport { newTextElement } from \"../element\";\nimport { NonDeletedExcalidrawElement } from \"../element/types\";\nimport { getCommonBounds } from \"../element/bounds\";\nimport { renderScene, renderSceneToSvg } from \"../renderer/renderScene\";\nimport { distance, SVG_NS } from \"../utils\";\nimport { normalizeScroll } from \"./scroll\";\nimport { AppState } from \"../types\";\nimport { t } from \"../i18n\";\nimport { DEFAULT_FONT_FAMILY, DEFAULT_VERTICAL_ALIGN } from \"../constants\";\n\nexport const SVG_EXPORT_TAG = `<!-- svg-source:excalidraw -->`;\n\nexport const exportToCanvas = (\n  elements: readonly NonDeletedExcalidrawElement[],\n  appState: AppState,\n  {\n    exportBackground,\n    exportPadding = 10,\n    viewBackgroundColor,\n    scale = 1,\n    shouldAddWatermark,\n  }: {\n    exportBackground: boolean;\n    exportPadding?: number;\n    scale?: number;\n    viewBackgroundColor: string;\n    shouldAddWatermark: boolean;\n  },\n  createCanvas: (width: number, height: number) => any = (width, height) => {\n    const tempCanvas = document.createElement(\"canvas\");\n    tempCanvas.width = width * scale;\n    tempCanvas.height = height * scale;\n    return tempCanvas;\n  },\n) => {\n  let sceneElements = elements;\n  if (shouldAddWatermark) {\n    const [, , maxX, maxY] = getCommonBounds(elements);\n    sceneElements = [...sceneElements, getWatermarkElement(maxX, maxY)];\n  }\n\n  // calculate smallest area to fit the contents in\n  const [minX, minY, maxX, maxY] = getCommonBounds(sceneElements);\n  const width = distance(minX, maxX) + exportPadding * 2;\n  const height =\n    distance(minY, maxY) +\n    exportPadding +\n    (shouldAddWatermark ? 0 : exportPadding);\n\n  const tempCanvas: any = createCanvas(width, height);\n\n  renderScene(\n    sceneElements,\n    appState,\n    null,\n    scale,\n    rough.canvas(tempCanvas),\n    tempCanvas,\n    {\n      viewBackgroundColor: exportBackground ? viewBackgroundColor : null,\n      scrollX: normalizeScroll(-minX + exportPadding),\n      scrollY: normalizeScroll(-minY + exportPadding),\n      zoom: 1,\n      remotePointerViewportCoords: {},\n      remoteSelectedElementIds: {},\n      shouldCacheIgnoreZoom: false,\n      remotePointerUsernames: {},\n    },\n    {\n      renderScrollbars: false,\n      renderSelection: false,\n      renderOptimizations: false,\n      renderGrid: false,\n    },\n  );\n\n  return tempCanvas;\n};\n\nexport const exportToSvg = (\n  elements: readonly NonDeletedExcalidrawElement[],\n  {\n    exportBackground,\n    exportPadding = 10,\n    viewBackgroundColor,\n    shouldAddWatermark,\n  }: {\n    exportBackground: boolean;\n    exportPadding?: number;\n    viewBackgroundColor: string;\n    shouldAddWatermark: boolean;\n  },\n): SVGSVGElement => {\n  let sceneElements = elements;\n  if (shouldAddWatermark) {\n    const [, , maxX, maxY] = getCommonBounds(elements);\n    sceneElements = [...sceneElements, getWatermarkElement(maxX, maxY)];\n  }\n\n  // calculate canvas dimensions\n  const [minX, minY, maxX, maxY] = getCommonBounds(sceneElements);\n  const width = distance(minX, maxX) + exportPadding * 2;\n  const height =\n    distance(minY, maxY) +\n    exportPadding +\n    (shouldAddWatermark ? 0 : exportPadding);\n\n  // initialze SVG root\n  const svgRoot = document.createElementNS(SVG_NS, \"svg\");\n  svgRoot.setAttribute(\"version\", \"1.1\");\n  svgRoot.setAttribute(\"xmlns\", SVG_NS);\n  svgRoot.setAttribute(\"viewBox\", `0 0 ${width} ${height}`);\n\n  svgRoot.innerHTML = `\n  ${SVG_EXPORT_TAG}\n  <defs>\n    <style>\n      @font-face {\n        font-family: \"Virgil\";\n        src: url(\"https://excalidraw.com/FG_Virgil.woff2\");\n      }\n      @font-face {\n        font-family: \"Cascadia\";\n        src: url(\"https://excalidraw.com/Cascadia.woff2\");\n      }\n    </style>\n  </defs>\n  `;\n\n  // render backgroiund rect\n  if (exportBackground && viewBackgroundColor) {\n    const rect = svgRoot.ownerDocument!.createElementNS(SVG_NS, \"rect\");\n    rect.setAttribute(\"x\", \"0\");\n    rect.setAttribute(\"y\", \"0\");\n    rect.setAttribute(\"width\", `${width}`);\n    rect.setAttribute(\"height\", `${height}`);\n    rect.setAttribute(\"fill\", viewBackgroundColor);\n    svgRoot.appendChild(rect);\n  }\n\n  const rsvg = rough.svg(svgRoot);\n  renderSceneToSvg(sceneElements, rsvg, svgRoot, {\n    offsetX: -minX + exportPadding,\n    offsetY: -minY + exportPadding,\n  });\n\n  return svgRoot;\n};\n\nconst getWatermarkElement = (maxX: number, maxY: number) => {\n  return newTextElement({\n    text: t(\"labels.madeWithExcalidraw\"),\n    fontSize: 16,\n    fontFamily: DEFAULT_FONT_FAMILY,\n    textAlign: \"right\",\n    verticalAlign: DEFAULT_VERTICAL_ALIGN,\n    x: maxX,\n    y: maxY + 16,\n    strokeColor: oc.gray[5],\n    backgroundColor: \"transparent\",\n    fillStyle: \"hachure\",\n    strokeWidth: 1,\n    strokeStyle: \"solid\",\n    roughness: 1,\n    opacity: 100,\n  });\n};\n","import { ExcalidrawElement } from \"./element/types\";\nimport { newElement, newTextElement } from \"./element\";\nimport { AppState } from \"./types\";\nimport { t } from \"./i18n\";\nimport { DEFAULT_VERTICAL_ALIGN } from \"./constants\";\n\ninterface Spreadsheet {\n  yAxisLabel: string | null;\n  labels: string[] | null;\n  values: number[];\n}\n\ntype ParseSpreadsheetResult =\n  | {\n      type: \"not a spreadsheet\";\n    }\n  | { type: \"spreadsheet\"; spreadsheet: Spreadsheet }\n  | {\n      type: \"malformed spreadsheet\";\n      error: string;\n    };\n\nfunction tryParseNumber(s: string): number | null {\n  const match = /^[$]?([0-9]+(\\.[0-9]+)?)$/.exec(s);\n  if (!match) {\n    return null;\n  }\n  return parseFloat(match[1]);\n}\n\nfunction isNumericColumn(lines: string[][], columnIndex: number) {\n  return lines\n    .slice(1)\n    .every((line) => tryParseNumber(line[columnIndex]) !== null);\n}\n\nfunction tryParseCells(cells: string[][]): ParseSpreadsheetResult {\n  const numCols = cells[0].length;\n\n  if (numCols > 2) {\n    return { type: \"malformed spreadsheet\", error: t(\"charts.tooManyColumns\") };\n  }\n\n  if (numCols === 1) {\n    if (!isNumericColumn(cells, 0)) {\n      return { type: \"not a spreadsheet\" };\n    }\n\n    const hasHeader = tryParseNumber(cells[0][0]) === null;\n    const values = (hasHeader ? cells.slice(1) : cells).map((line) =>\n      tryParseNumber(line[0]),\n    );\n\n    if (values.length < 2) {\n      return { type: \"not a spreadsheet\" };\n    }\n\n    return {\n      type: \"spreadsheet\",\n      spreadsheet: {\n        yAxisLabel: hasHeader ? cells[0][0] : null,\n        labels: null,\n        values: values as number[],\n      },\n    };\n  }\n\n  const valueColumnIndex = isNumericColumn(cells, 0) ? 0 : 1;\n\n  if (!isNumericColumn(cells, valueColumnIndex)) {\n    return {\n      type: \"malformed spreadsheet\",\n      error: t(\"charts.noNumericColumn\"),\n    };\n  }\n\n  const labelColumnIndex = (valueColumnIndex + 1) % 2;\n  const hasHeader = tryParseNumber(cells[0][valueColumnIndex]) === null;\n  const rows = hasHeader ? cells.slice(1) : cells;\n\n  if (rows.length < 2) {\n    return { type: \"not a spreadsheet\" };\n  }\n\n  return {\n    type: \"spreadsheet\",\n    spreadsheet: {\n      yAxisLabel: hasHeader ? cells[0][valueColumnIndex] : null,\n      labels: rows.map((row) => row[labelColumnIndex]),\n      values: rows.map((row) => tryParseNumber(row[valueColumnIndex])!),\n    },\n  };\n}\n\nfunction transposeCells(cells: string[][]) {\n  const nextCells: string[][] = [];\n  for (let col = 0; col < cells[0].length; col++) {\n    const nextCellRow: string[] = [];\n    for (let row = 0; row < cells.length; row++) {\n      nextCellRow.push(cells[row][col]);\n    }\n    nextCells.push(nextCellRow);\n  }\n\n  return nextCells;\n}\n\nexport function tryParseSpreadsheet(text: string): ParseSpreadsheetResult {\n  // copy/paste from excel, in-browser excel, and google sheets is tsv\n  // for now we only accept 2 columns with an optional header\n  const lines = text\n    .trim()\n    .split(\"\\n\")\n    .map((line) => line.trim().split(\"\\t\"));\n\n  if (lines.length === 0) {\n    return { type: \"not a spreadsheet\" };\n  }\n\n  const numColsFirstLine = lines[0].length;\n  const isASpreadsheet = lines.every(\n    (line) => line.length === numColsFirstLine,\n  );\n\n  if (!isASpreadsheet) {\n    return { type: \"not a spreadsheet\" };\n  }\n\n  const result = tryParseCells(lines);\n  if (result.type !== \"spreadsheet\") {\n    const transposedResults = tryParseCells(transposeCells(lines));\n    if (transposedResults.type === \"spreadsheet\") {\n      return transposedResults;\n    }\n  }\n\n  return result;\n}\n\nconst BAR_WIDTH = 32;\nconst BAR_SPACING = 12;\nconst BAR_HEIGHT = 192;\nconst LABEL_SPACING = 3 * BAR_SPACING;\nconst Y_AXIS_LABEL_SPACING = LABEL_SPACING;\nconst ANGLE = 5.87;\n\nexport function renderSpreadsheet(\n  appState: AppState,\n  spreadsheet: Spreadsheet,\n  x: number,\n  y: number,\n): ExcalidrawElement[] {\n  const max = Math.max(...spreadsheet.values);\n  const min = Math.min(0, ...spreadsheet.values);\n  const range = max - min;\n\n  const minYLabel = newTextElement({\n    x: x,\n    y: y + BAR_HEIGHT,\n    strokeColor: appState.currentItemStrokeColor,\n    backgroundColor: appState.currentItemBackgroundColor,\n    fillStyle: appState.currentItemFillStyle,\n    strokeWidth: appState.currentItemStrokeWidth,\n    strokeStyle: appState.currentItemStrokeStyle,\n    roughness: appState.currentItemRoughness,\n    opacity: appState.currentItemOpacity,\n    text: min.toLocaleString(),\n    fontSize: 16,\n    fontFamily: appState.currentItemFontFamily,\n    textAlign: appState.currentItemTextAlign,\n    verticalAlign: DEFAULT_VERTICAL_ALIGN,\n  });\n\n  const maxYLabel = newTextElement({\n    x: x,\n    y: y,\n    strokeColor: appState.currentItemStrokeColor,\n    backgroundColor: appState.currentItemBackgroundColor,\n    fillStyle: appState.currentItemFillStyle,\n    strokeWidth: appState.currentItemStrokeWidth,\n    strokeStyle: appState.currentItemStrokeStyle,\n    roughness: appState.currentItemRoughness,\n    opacity: appState.currentItemOpacity,\n    text: max.toLocaleString(),\n    fontSize: 16,\n    fontFamily: appState.currentItemFontFamily,\n    textAlign: appState.currentItemTextAlign,\n    verticalAlign: DEFAULT_VERTICAL_ALIGN,\n  });\n\n  const bars = spreadsheet.values.map((value, i) => {\n    const valueBarHeight = value - min;\n    const percentBarHeight = valueBarHeight / range;\n    const barHeight = percentBarHeight * BAR_HEIGHT;\n    const barX = i * (BAR_WIDTH + BAR_SPACING) + LABEL_SPACING;\n    const barY = BAR_HEIGHT - barHeight;\n    return newElement({\n      type: \"rectangle\",\n      x: barX + x,\n      y: barY + y,\n      width: BAR_WIDTH,\n      height: barHeight,\n      strokeColor: appState.currentItemStrokeColor,\n      backgroundColor: appState.currentItemBackgroundColor,\n      fillStyle: appState.currentItemFillStyle,\n      strokeWidth: appState.currentItemStrokeWidth,\n      strokeStyle: appState.currentItemStrokeStyle,\n      roughness: appState.currentItemRoughness,\n      opacity: appState.currentItemOpacity,\n    });\n  });\n\n  const xLabels =\n    spreadsheet.labels?.map((label, i) => {\n      const labelX =\n        i * (BAR_WIDTH + BAR_SPACING) + LABEL_SPACING + BAR_SPACING;\n      const labelY = BAR_HEIGHT + BAR_SPACING;\n      return newTextElement({\n        text: label.length > 8 ? `${label.slice(0, 5)}...` : label,\n        x: x + labelX,\n        y: y + labelY,\n        strokeColor: appState.currentItemStrokeColor,\n        backgroundColor: appState.currentItemBackgroundColor,\n        fillStyle: appState.currentItemFillStyle,\n        strokeWidth: appState.currentItemStrokeWidth,\n        strokeStyle: appState.currentItemStrokeStyle,\n        roughness: appState.currentItemRoughness,\n        opacity: appState.currentItemOpacity,\n        fontSize: 16,\n        fontFamily: appState.currentItemFontFamily,\n        textAlign: \"center\",\n        verticalAlign: DEFAULT_VERTICAL_ALIGN,\n        width: BAR_WIDTH,\n        angle: ANGLE,\n      });\n    }) || [];\n\n  const yAxisLabel = spreadsheet.yAxisLabel\n    ? newTextElement({\n        text: spreadsheet.yAxisLabel,\n        x: x - Y_AXIS_LABEL_SPACING,\n        y: y + BAR_HEIGHT / 2 - 10,\n        strokeColor: appState.currentItemStrokeColor,\n        backgroundColor: appState.currentItemBackgroundColor,\n        fillStyle: appState.currentItemFillStyle,\n        strokeWidth: appState.currentItemStrokeWidth,\n        strokeStyle: appState.currentItemStrokeStyle,\n        roughness: appState.currentItemRoughness,\n        opacity: appState.currentItemOpacity,\n        fontSize: 20,\n        fontFamily: appState.currentItemFontFamily,\n        textAlign: \"center\",\n        verticalAlign: DEFAULT_VERTICAL_ALIGN,\n        width: BAR_WIDTH,\n        angle: ANGLE,\n      })\n    : null;\n\n  return [...bars, yAxisLabel, minYLabel, maxYLabel, ...xLabels].filter(\n    (element) => element !== null,\n  ) as ExcalidrawElement[];\n}\n","import {\n  ExcalidrawElement,\n  NonDeletedExcalidrawElement,\n} from \"./element/types\";\nimport { getSelectedElements } from \"./scene\";\nimport { AppState } from \"./types\";\nimport { SVG_EXPORT_TAG } from \"./scene/export\";\nimport { tryParseSpreadsheet, renderSpreadsheet } from \"./charts\";\n\nlet CLIPBOARD = \"\";\nlet PREFER_APP_CLIPBOARD = false;\n\nexport const probablySupportsClipboardReadText =\n  \"clipboard\" in navigator && \"readText\" in navigator.clipboard;\n\nexport const probablySupportsClipboardWriteText =\n  \"clipboard\" in navigator && \"writeText\" in navigator.clipboard;\n\nexport const probablySupportsClipboardBlob =\n  \"clipboard\" in navigator &&\n  \"write\" in navigator.clipboard &&\n  \"ClipboardItem\" in window &&\n  \"toBlob\" in HTMLCanvasElement.prototype;\n\nexport const copyToAppClipboard = async (\n  elements: readonly NonDeletedExcalidrawElement[],\n  appState: AppState,\n) => {\n  CLIPBOARD = JSON.stringify(getSelectedElements(elements, appState));\n  try {\n    // when copying to in-app clipboard, clear system clipboard so that if\n    //  system clip contains text on paste we know it was copied *after* user\n    //  copied elements, and thus we should prefer the text content.\n    await copyTextToSystemClipboard(null);\n    PREFER_APP_CLIPBOARD = false;\n  } catch {\n    // if clearing system clipboard didn't work, we should prefer in-app\n    //  clipboard even if there's text in system clipboard on paste, because\n    //  we can't be sure of the order of copy operations\n    PREFER_APP_CLIPBOARD = true;\n  }\n};\n\nexport const getAppClipboard = (): {\n  elements?: readonly ExcalidrawElement[];\n} => {\n  if (!CLIPBOARD) {\n    return {};\n  }\n\n  try {\n    const clipboardElements = JSON.parse(CLIPBOARD);\n\n    if (\n      Array.isArray(clipboardElements) &&\n      clipboardElements.length > 0 &&\n      clipboardElements[0].type // need to implement a better check here...\n    ) {\n      return { elements: clipboardElements };\n    }\n  } catch (error) {\n    console.error(error);\n  }\n\n  return {};\n};\n\nexport const getClipboardContent = async (\n  appState: AppState,\n  cursorX: number,\n  cursorY: number,\n  event: ClipboardEvent | null,\n): Promise<{\n  text?: string;\n  elements?: readonly ExcalidrawElement[];\n  error?: string;\n}> => {\n  try {\n    const text = event\n      ? event.clipboardData?.getData(\"text/plain\").trim()\n      : probablySupportsClipboardReadText &&\n        (await navigator.clipboard.readText());\n\n    if (text && !PREFER_APP_CLIPBOARD && !text.includes(SVG_EXPORT_TAG)) {\n      const result = tryParseSpreadsheet(text);\n      if (result.type === \"spreadsheet\") {\n        return {\n          elements: renderSpreadsheet(\n            appState,\n            result.spreadsheet,\n            cursorX,\n            cursorY,\n          ),\n        };\n      } else if (result.type === \"malformed spreadsheet\") {\n        return { error: result.error };\n      }\n      return { text };\n    }\n  } catch (error) {\n    console.error(error);\n  }\n\n  return getAppClipboard();\n};\n\nexport const copyCanvasToClipboardAsPng = async (canvas: HTMLCanvasElement) =>\n  new Promise((resolve, reject) => {\n    try {\n      canvas.toBlob(async (blob: any) => {\n        try {\n          await navigator.clipboard.write([\n            new window.ClipboardItem({ \"image/png\": blob }),\n          ]);\n          resolve();\n        } catch (error) {\n          reject(error);\n        }\n      });\n    } catch (error) {\n      reject(error);\n    }\n  });\n\nexport const copyCanvasToClipboardAsSvg = async (svgroot: SVGSVGElement) => {\n  try {\n    await navigator.clipboard.writeText(svgroot.outerHTML);\n  } catch (error) {\n    console.error(error);\n  }\n};\n\nexport const copyTextToSystemClipboard = async (text: string | null) => {\n  let copied = false;\n  if (probablySupportsClipboardWriteText) {\n    try {\n      // NOTE: doesn't work on FF on non-HTTPS domains, or when document\n      //  not focused\n      await navigator.clipboard.writeText(text || \"\");\n      copied = true;\n    } catch (error) {\n      console.error(error);\n    }\n  }\n\n  // Note that execCommand doesn't allow copying empty strings, so if we're\n  //  clearing clipboard using this API, we must copy at least an empty char\n  if (!copied && !copyTextViaExecCommand(text || \" \")) {\n    throw new Error(\"couldn't copy\");\n  }\n};\n\n// adapted from https://github.com/zenorocha/clipboard.js/blob/ce79f170aa655c408b6aab33c9472e8e4fa52e19/src/clipboard-action.js#L48\nconst copyTextViaExecCommand = (text: string) => {\n  const isRTL = document.documentElement.getAttribute(\"dir\") === \"rtl\";\n\n  const textarea = document.createElement(\"textarea\");\n\n  textarea.style.border = \"0\";\n  textarea.style.padding = \"0\";\n  textarea.style.margin = \"0\";\n  textarea.style.position = \"absolute\";\n  textarea.style[isRTL ? \"right\" : \"left\"] = \"-9999px\";\n  const yPosition = window.pageYOffset || document.documentElement.scrollTop;\n  textarea.style.top = `${yPosition}px`;\n  // Prevent zooming on iOS\n  textarea.style.fontSize = \"12pt\";\n\n  textarea.setAttribute(\"readonly\", \"\");\n  textarea.value = text;\n\n  document.body.appendChild(textarea);\n\n  let success = false;\n\n  try {\n    textarea.select();\n    textarea.setSelectionRange(0, textarea.value.length);\n\n    success = document.execCommand(\"copy\");\n  } catch (error) {\n    console.error(error);\n  }\n\n  textarea.remove();\n\n  return success;\n};\n","import {\n  ExcalidrawElement,\n  FontFamily,\n  ExcalidrawSelectionElement,\n} from \"../element/types\";\nimport { AppState } from \"../types\";\nimport { DataState } from \"./types\";\nimport { isInvisiblySmallElement, getNormalizedDimensions } from \"../element\";\nimport { calculateScrollCenter } from \"../scene\";\nimport { randomId } from \"../random\";\nimport {\n  FONT_FAMILY,\n  DEFAULT_FONT_FAMILY,\n  DEFAULT_TEXT_ALIGN,\n  DEFAULT_VERTICAL_ALIGN,\n} from \"../constants\";\n\nconst getFontFamilyByName = (fontFamilyName: string): FontFamily => {\n  for (const [id, fontFamilyString] of Object.entries(FONT_FAMILY)) {\n    if (fontFamilyString.includes(fontFamilyName)) {\n      return parseInt(id) as FontFamily;\n    }\n  }\n  return DEFAULT_FONT_FAMILY;\n};\n\nfunction migrateElementWithProperties<T extends ExcalidrawElement>(\n  element: T,\n  extra: Omit<T, keyof ExcalidrawElement>,\n): T {\n  const base: Pick<T, keyof ExcalidrawElement> = {\n    type: element.type,\n    // all elements must have version > 0 so getDrawingVersion() will pick up\n    //  newly added elements\n    version: element.version || 1,\n    versionNonce: element.versionNonce ?? 0,\n    isDeleted: false,\n    id: element.id || randomId(),\n    fillStyle: element.fillStyle || \"hachure\",\n    strokeWidth: element.strokeWidth || 1,\n    strokeStyle: element.strokeStyle ?? \"solid\",\n    roughness: element.roughness ?? 1,\n    opacity: element.opacity == null ? 100 : element.opacity,\n    angle: element.angle || 0,\n    x: element.x || 0,\n    y: element.y || 0,\n    strokeColor: element.strokeColor,\n    backgroundColor: element.backgroundColor,\n    width: element.width || 0,\n    height: element.height || 0,\n    seed: element.seed ?? 1,\n    groupIds: element.groupIds || [],\n  };\n\n  return {\n    ...base,\n    ...getNormalizedDimensions(base),\n    ...extra,\n  } as T;\n}\n\nconst migrateElement = (\n  element: Exclude<ExcalidrawElement, ExcalidrawSelectionElement>,\n): typeof element => {\n  switch (element.type) {\n    case \"text\":\n      let fontSize = element.fontSize;\n      let fontFamily = element.fontFamily;\n      if (\"font\" in element) {\n        const [fontPx, _fontFamily]: [\n          string,\n          string,\n        ] = (element as any).font.split(\" \");\n        fontSize = parseInt(fontPx, 10);\n        fontFamily = getFontFamilyByName(_fontFamily);\n      }\n      return migrateElementWithProperties(element, {\n        fontSize,\n        fontFamily,\n        text: element.text ?? \"\",\n        baseline: element.baseline,\n        textAlign: element.textAlign || DEFAULT_TEXT_ALIGN,\n        verticalAlign: element.verticalAlign || DEFAULT_VERTICAL_ALIGN,\n      });\n    case \"draw\":\n    case \"line\":\n    case \"arrow\": {\n      return migrateElementWithProperties(element, {\n        points:\n          // migrate old arrow model to new one\n          !Array.isArray(element.points) || element.points.length < 2\n            ? [\n                [0, 0],\n                [element.width, element.height],\n              ]\n            : element.points,\n      });\n    }\n    // generic elements\n    case \"ellipse\":\n    case \"rectangle\":\n    case \"diamond\":\n      return migrateElementWithProperties(element, {});\n\n    // don't use default case so as to catch a missing an element type case\n    //  (we also don't want to throw, but instead return void so we\n    //   filter out these unsupported elements from the restored array)\n  }\n};\n\nexport const restore = (\n  savedElements: readonly ExcalidrawElement[],\n  savedState: AppState | null,\n  opts?: { scrollToContent: boolean },\n): DataState => {\n  const elements = savedElements.reduce((elements, element) => {\n    // filtering out selection, which is legacy, no longer kept in elements,\n    //  and causing issues if retained\n    if (element.type !== \"selection\" && !isInvisiblySmallElement(element)) {\n      const migratedElement = migrateElement(element);\n      console.log(migratedElement)\n      if (migratedElement) {\n        elements.push(migratedElement);\n      }\n    }\n    return elements;\n  }, [] as ExcalidrawElement[]);\n\n  if (opts?.scrollToContent && savedState) {\n    savedState = {\n      ...savedState,\n      ...calculateScrollCenter(elements, savedState, null),\n    };\n  }\n\n  return {\n    elements: elements,\n    appState: savedState,\n  };\n};\n","import { getDefaultAppState } from \"../appState\";\nimport { restore } from \"./restore\";\nimport { t } from \"../i18n\";\n\nexport const loadFromBlob = async (blob: any) => {\n  const updateAppState = (contents: string) => {\n    const defaultAppState = getDefaultAppState();\n    let elements = [];\n    let appState = defaultAppState;\n    try {\n      const data = JSON.parse(contents);\n      if (data.type !== \"excalidraw\") {\n        throw new Error(t(\"alerts.couldNotLoadInvalidFile\"));\n      }\n      elements = data.elements || [];\n      appState = { ...defaultAppState, ...data.appState };\n    } catch {\n      throw new Error(t(\"alerts.couldNotLoadInvalidFile\"));\n    }\n    return { elements, appState };\n  };\n\n  if (blob.handle) {\n    (window as any).handle = blob.handle;\n  }\n  let contents;\n  if (\"text\" in Blob) {\n    contents = await blob.text();\n  } else {\n    contents = await new Promise((resolve) => {\n      const reader = new FileReader();\n      reader.readAsText(blob, \"utf8\");\n      reader.onloadend = () => {\n        if (reader.readyState === FileReader.DONE) {\n          resolve(reader.result as string);\n        }\n      };\n    });\n  }\n\n  const { elements, appState } = updateAppState(contents);\n  return restore(elements, appState, { scrollToContent: true });\n};\n","import { ExcalidrawElement } from \"../element/types\";\nimport { AppState } from \"../types\";\nimport { cleanAppStateForExport } from \"../appState\";\n\nimport { fileOpen, fileSave } from \"browser-nativefs\";\nimport { loadFromBlob } from \"./blob\";\n\nexport const serializeAsJSON = (\n  elements: readonly ExcalidrawElement[],\n  appState: AppState,\n): string =>\n  JSON.stringify(\n    {\n      type: \"excalidraw\",\n      version: 2,\n      source: window.location.origin,\n      elements: elements.filter((element) => !element.isDeleted),\n      appState: cleanAppStateForExport(appState),\n    },\n    null,\n    2,\n  );\n\nexport const saveAsJSON = async (\n  elements: readonly ExcalidrawElement[],\n  appState: AppState,\n  fileHandle: any,\n) => {\n  const serialized = serializeAsJSON(elements, appState);\n  const blob = new Blob([serialized], {\n    type: \"application/json\",\n  });\n  const name = `${appState.name}.excalidraw`;\n  (window as any).handle = await fileSave(\n    blob,\n    {\n      fileName: name,\n      description: \"Excalidraw file\",\n      extensions: [\"excalidraw\"],\n    },\n    fileHandle || null,\n  );\n};\n\nexport const loadFromJSON = async () => {\n  const blob = await fileOpen({\n    description: \"Excalidraw files\",\n    extensions: [\"json\", \"excalidraw\"],\n    mimeTypes: [\"application/json\"],\n  });\n  return loadFromBlob(blob);\n};\n","import { ExcalidrawElement } from \"../element/types\";\nimport { AppState, LibraryItems } from \"../types\";\nimport { clearAppStateForLocalStorage } from \"../appState\";\nimport { restore } from \"./restore\";\n\nconst LOCAL_STORAGE_KEY = \"excalidraw\";\nconst LOCAL_STORAGE_KEY_STATE = \"excalidraw-state\";\nconst LOCAL_STORAGE_KEY_COLLAB = \"excalidraw-collab\";\nconst LOCAL_STORAGE_KEY_LIBRARY = \"excalidraw-library\";\n\nlet _LATEST_LIBRARY_ITEMS: LibraryItems | null = null;\nexport const loadLibrary = (): Promise<LibraryItems> => {\n  return new Promise(async (resolve) => {\n    if (_LATEST_LIBRARY_ITEMS) {\n      return resolve(JSON.parse(JSON.stringify(_LATEST_LIBRARY_ITEMS)));\n    }\n\n    try {\n      const data = localStorage.getItem(LOCAL_STORAGE_KEY_LIBRARY);\n      if (!data) {\n        return resolve([]);\n      }\n\n      const items = (JSON.parse(data) as ExcalidrawElement[][]).map(\n        (elements) => restore(elements, null).elements,\n      ) as Mutable<LibraryItems>;\n\n      // clone to ensure we don't mutate the cached library elements in the app\n      _LATEST_LIBRARY_ITEMS = JSON.parse(JSON.stringify(items));\n\n      resolve(items);\n    } catch (e) {\n      console.error(e);\n      resolve([]);\n    }\n  });\n};\n\nexport const saveLibrary = (items: LibraryItems) => {\n  const prevLibraryItems = _LATEST_LIBRARY_ITEMS;\n  try {\n    const serializedItems = JSON.stringify(items);\n    // cache optimistically so that consumers have access to the latest\n    //  immediately\n    _LATEST_LIBRARY_ITEMS = JSON.parse(serializedItems);\n    localStorage.setItem(LOCAL_STORAGE_KEY_LIBRARY, serializedItems);\n  } catch (e) {\n    _LATEST_LIBRARY_ITEMS = prevLibraryItems;\n    console.error(e);\n  }\n};\n\nexport const saveUsernameToLocalStorage = (username: string) => {\n  try {\n    localStorage.setItem(\n      LOCAL_STORAGE_KEY_COLLAB,\n      JSON.stringify({ username }),\n    );\n  } catch (error) {\n    // Unable to access window.localStorage\n    console.error(error);\n  }\n};\n\nexport const restoreUsernameFromLocalStorage = (): string | null => {\n  try {\n    const data = localStorage.getItem(LOCAL_STORAGE_KEY_COLLAB);\n    if (data) {\n      return JSON.parse(data).username;\n    }\n  } catch (error) {\n    // Unable to access localStorage\n    console.error(error);\n  }\n\n  return null;\n};\n\nexport const saveToLocalStorage = (\n  elements: readonly ExcalidrawElement[],\n  appState: AppState,\n) => {\n  try {\n    localStorage.setItem(\n      LOCAL_STORAGE_KEY,\n      JSON.stringify(elements.filter((element) => !element.isDeleted)),\n    );\n    localStorage.setItem(\n      LOCAL_STORAGE_KEY_STATE,\n      JSON.stringify(clearAppStateForLocalStorage(appState)),\n    );\n  } catch (error) {\n    // Unable to access window.localStorage\n    console.error(error);\n  }\n};\n\nexport const restoreFromLocalStorage = () => {\n  let savedElements = null;\n  let savedState = null;\n\n  try {\n    savedElements = localStorage.getItem(LOCAL_STORAGE_KEY);\n    savedState = localStorage.getItem(LOCAL_STORAGE_KEY_STATE);\n  } catch (error) {\n    // Unable to access localStorage\n    console.error(error);\n  }\n\n  let elements = [];\n  if (savedElements) {\n    try {\n      elements = JSON.parse(savedElements);\n    } catch {\n      // Do nothing because elements array is already empty\n    }\n  }\n\n  let appState = null;\n  if (savedState) {\n    try {\n      appState = JSON.parse(savedState) as AppState;\n      // If we're retrieving from local storage, we should not be collaborating\n      appState.isCollaborating = false;\n      appState.collaborators = new Map();\n      delete appState.width;\n      delete appState.height;\n    } catch {\n      // Do nothing because appState is already null\n    }\n  }\n  return restore(elements, appState);\n};\n","import { AppState, LibraryItems } from \"../types\";\nimport { restore } from \"./restore\";\nimport { getDefaultAppState } from \"../appState\";\nimport Window from \"../components/App\"\nconst axios = require('axios');\n\n/*\n\n      __      __  __  __         ______ _          _     _______                              _       _                    _   _               _       _                 _ \n     / /     / / |  \\/  |       |  ____(_)        | |   |__   __|                            (_)     | |                  | | | |             | |     | |               | |\n    / /     / /  | \\  / |_   _  | |__   _ _ __ ___| |_     | |_   _ _ __   ___  ___  ___ _ __ _ _ __ | |_   _ __ ___   ___| |_| |__   ___   __| |  ___| |_ ___  _ __ ___| |\n   / /     / /   | |\\/| | | | | |  __| | | '__/ __| __|    | | | | | '_ \\ / _ \\/ __|/ __| '__| | '_ \\| __| | '_ ` _ \\ / _ \\ __| '_ \\ / _ \\ / _` | / __| __/ _ \\| '__/ _ \\ |\n  / /     / /    | |  | | |_| | | |    | | |  \\__ \\ |_     | | |_| | |_) |  __/\\__ \\ (__| |  | | |_) | |_  | | | | | |  __/ |_| | | | (_) | (_| | \\__ \\ || (_) | | |  __/_|\n /_/     /_/     |_|  |_|\\__, | |_|    |_|_|  |___/\\__|    |_|\\__, | .__/ \\___||___/\\___|_|  |_| .__/ \\__| |_| |_| |_|\\___|\\__|_| |_|\\___/ \\__,_| |___/\\__\\___/|_|  \\___(_)\n                          __/ |                                __/ | |                         | |                                                                         \n                         |___/                                |___/|_|                         |_|                                                                         \n\n*/\n\n\n\nexport const restoreFromUrl = async (url:String):Promise<any> => {\n\n    let savedElements = null;\n    let savedState = null;\n\n    // Future me's problem .. this should probably live in a try catch block.\n    let response\n    try {\n    response = await axios.get(url)\n        savedElements = response.data.elements\n        savedState = response.data.state\n    } catch {\n        console.log(\"Restore from URL failed.\")\n    }\n    \n      let elements = [];\n      if (savedElements) {\n        try {\n          elements = JSON.parse(savedElements);\n        } catch {\n          console.log(\"could not parse elements\")\n        }\n      }\n    \n      let appState = null;\n      let defaultAppState = getDefaultAppState();\n\n      if (savedState) {\n        try {\n          appState = JSON.parse(savedState) as AppState;\n          // If we're retrieving from local storage, we should not be collaborating\n          appState.isCollaborating = false;\n          appState.collaborators = new Map();\n          delete appState.width;\n          delete appState.height;\n\n          appState = {...appState,...defaultAppState}\n        } catch {\n          console.log(\"could not parse state\")\n        }\n      }\n      console.log(elements)\n      console.log(appState)\n\n      window.lastHttpStatus = response.status+\"\"\n      let leadingDigit = window.lastHttpStatus.substr(0,1);\n      if(leadingDigit === \"2\"){\n        window.lastSuccessfulPut = new Date();\n      }\n    \n      return restore(elements, appState);\n    \n  };\n  \n\n","import {\n  ExcalidrawElement,\n  NonDeletedExcalidrawElement,\n} from \"../element/types\";\n\nimport { getDefaultAppState } from \"../appState\";\n\nimport { AppState } from \"../types\";\nimport { exportToCanvas, exportToSvg } from \"../scene/export\";\nimport { fileSave } from \"browser-nativefs\";\n\nimport { t } from \"../i18n\";\nimport {\n  copyCanvasToClipboardAsPng,\n  copyCanvasToClipboardAsSvg,\n} from \"../clipboard\";\nimport { serializeAsJSON } from \"./json\";\n\nimport { ExportType } from \"../scene/types\";\nimport { restore } from \"./restore\";\nimport { restoreFromLocalStorage } from \"./localStorage\";\nimport { restoreFromUrl } from \"./urlStorage\";\n\nexport { loadFromBlob } from \"./blob\";\nexport { saveAsJSON, loadFromJSON } from \"./json\";\nexport { saveToLocalStorage  } from \"./localStorage\";\n\nconst BACKEND_GET = process.env.REACT_APP_BACKEND_V1_GET_URL;\n\nconst BACKEND_V2_POST = process.env.REACT_APP_BACKEND_V2_POST_URL;\nconst BACKEND_V2_GET = process.env.REACT_APP_BACKEND_V2_GET_URL;\n\nexport const SOCKET_SERVER = process.env.REACT_APP_SOCKET_SERVER_URL;\n\nexport type EncryptedData = {\n  data: ArrayBuffer;\n  iv: Uint8Array;\n};\n\nexport type SocketUpdateDataSource = {\n  SCENE_INIT: {\n    type: \"SCENE_INIT\";\n    payload: {\n      elements: readonly ExcalidrawElement[];\n    };\n  };\n  SCENE_UPDATE: {\n    type: \"SCENE_UPDATE\";\n    payload: {\n      elements: readonly ExcalidrawElement[];\n    };\n  };\n  MOUSE_LOCATION: {\n    type: \"MOUSE_LOCATION\";\n    payload: {\n      socketID: string;\n      pointerCoords: { x: number; y: number };\n      button: \"down\" | \"up\";\n      selectedElementIds: AppState[\"selectedElementIds\"];\n      username: string;\n    };\n  };\n};\n\nexport type SocketUpdateDataIncoming =\n  | SocketUpdateDataSource[keyof SocketUpdateDataSource]\n  | {\n      type: \"INVALID_RESPONSE\";\n    };\n\n// TODO: Defined globally, since file handles aren't yet serializable.\n// Once `FileSystemFileHandle` can be serialized, make this\n// part of `AppState`.\n(window as any).handle = null;\n\nconst byteToHex = (byte: number): string => `0${byte.toString(16)}`.slice(-2);\n\nconst generateRandomID = async () => {\n  const arr = new Uint8Array(10);\n  window.crypto.getRandomValues(arr);\n  return Array.from(arr, byteToHex).join(\"\");\n};\n\nconst generateEncryptionKey = async () => {\n  const key = await window.crypto.subtle.generateKey(\n    {\n      name: \"AES-GCM\",\n      length: 128,\n    },\n    true, // extractable\n    [\"encrypt\", \"decrypt\"],\n  );\n  return (await window.crypto.subtle.exportKey(\"jwk\", key)).k;\n};\n\nconst createIV = () => {\n  const arr = new Uint8Array(12);\n  return window.crypto.getRandomValues(arr);\n};\n\nexport const getCollaborationLinkData = (link: string) => {\n  if (link.length === 0) {\n    return;\n  }\n  const hash = new URL(link).hash;\n  return hash.match(/^#room=([a-zA-Z0-9_-]+),([a-zA-Z0-9_-]+)$/);\n};\n\nexport const generateCollaborationLink = async () => {\n  const id = await generateRandomID();\n  const key = await generateEncryptionKey();\n  return `${window.location.origin}${window.location.pathname}#room=${id},${key}`;\n};\n\nconst getImportedKey = (key: string, usage: KeyUsage) =>\n  window.crypto.subtle.importKey(\n    \"jwk\",\n    {\n      alg: \"A128GCM\",\n      ext: true,\n      k: key,\n      key_ops: [\"encrypt\", \"decrypt\"],\n      kty: \"oct\",\n    },\n    {\n      name: \"AES-GCM\",\n      length: 128,\n    },\n    false, // extractable\n    [usage],\n  );\n\nexport const encryptAESGEM = async (\n  data: Uint8Array,\n  key: string,\n): Promise<EncryptedData> => {\n  const importedKey = await getImportedKey(key, \"encrypt\");\n  const iv = createIV();\n  return {\n    data: await window.crypto.subtle.encrypt(\n      {\n        name: \"AES-GCM\",\n        iv,\n      },\n      importedKey,\n      data,\n    ),\n    iv,\n  };\n};\n\nexport const decryptAESGEM = async (\n  data: ArrayBuffer,\n  key: string,\n  iv: Uint8Array,\n): Promise<SocketUpdateDataIncoming> => {\n  try {\n    const importedKey = await getImportedKey(key, \"decrypt\");\n    const decrypted = await window.crypto.subtle.decrypt(\n      {\n        name: \"AES-GCM\",\n        iv: iv,\n      },\n      importedKey,\n      data,\n    );\n\n    const decodedData = new TextDecoder(\"utf-8\").decode(\n      new Uint8Array(decrypted) as any,\n    );\n    return JSON.parse(decodedData);\n  } catch (error) {\n    window.alert(t(\"alerts.decryptFailed\"));\n    console.error(error);\n  }\n  return {\n    type: \"INVALID_RESPONSE\",\n  };\n};\n\nexport const exportToBackend = async (\n  elements: readonly ExcalidrawElement[],\n  appState: AppState,\n) => {\n  const json = serializeAsJSON(elements, appState);\n  const encoded = new TextEncoder().encode(json);\n\n  const key = await window.crypto.subtle.generateKey(\n    {\n      name: \"AES-GCM\",\n      length: 128,\n    },\n    true, // extractable\n    [\"encrypt\", \"decrypt\"],\n  );\n  // The iv is set to 0. We are never going to reuse the same key so we don't\n  // need to have an iv. (I hope that's correct...)\n  const iv = new Uint8Array(12);\n  // We use symmetric encryption. AES-GCM is the recommended algorithm and\n  // includes checks that the ciphertext has not been modified by an attacker.\n  const encrypted = await window.crypto.subtle.encrypt(\n    {\n      name: \"AES-GCM\",\n      iv: iv,\n    },\n    key,\n    encoded,\n  );\n  // We use jwk encoding to be able to extract just the base64 encoded key.\n  // We will hardcode the rest of the attributes when importing back the key.\n  const exportedKey = await window.crypto.subtle.exportKey(\"jwk\", key);\n\n  try {\n    const response = await fetch(BACKEND_V2_POST, {\n      method: \"POST\",\n      body: encrypted,\n    });\n    const json = await response.json();\n    if (json.id) {\n      const url = new URL(window.location.href);\n      // We need to store the key (and less importantly the id) as hash instead\n      // of queryParam in order to never send it to the server\n      url.hash = `json=${json.id},${exportedKey.k!}`;\n      const urlString = url.toString();\n\n      window.prompt(`${t(\"alerts.uploadedSecurly\")}`, urlString);\n    } else {\n      window.alert(t(\"alerts.couldNotCreateShareableLink\"));\n    }\n  } catch (error) {\n    console.error(error);\n    window.alert(t(\"alerts.couldNotCreateShareableLink\"));\n  }\n};\n\nexport const importFromBackend = async (\n  id: string | null,\n  privateKey: string | undefined,\n) => {\n  let elements: readonly ExcalidrawElement[] = [];\n  let appState: AppState = getDefaultAppState();\n\n  try {\n    const response = await fetch(\n      privateKey ? `${BACKEND_V2_GET}${id}` : `${BACKEND_GET}${id}.json`,\n    );\n    if (!response.ok) {\n      window.alert(t(\"alerts.importBackendFailed\"));\n      return restore(elements, appState, { scrollToContent: true });\n    }\n    let data;\n    if (privateKey) {\n      const buffer = await response.arrayBuffer();\n      const key = await getImportedKey(privateKey, \"decrypt\");\n      const iv = new Uint8Array(12);\n      const decrypted = await window.crypto.subtle.decrypt(\n        {\n          name: \"AES-GCM\",\n          iv: iv,\n        },\n        key,\n        buffer,\n      );\n      // We need to convert the decrypted array buffer to a string\n      const string = new window.TextDecoder(\"utf-8\").decode(\n        new Uint8Array(decrypted) as any,\n      );\n      data = JSON.parse(string);\n    } else {\n      // Legacy format\n      data = await response.json();\n    }\n\n    elements = data.elements || elements;\n    appState = { ...appState, ...data.appState };\n  } catch (error) {\n    window.alert(t(\"alerts.importBackendFailed\"));\n    console.error(error);\n  } finally {\n    return restore(elements, appState, { scrollToContent: true });\n  }\n};\n\nexport const exportCanvas = async (\n  type: ExportType,\n  elements: readonly NonDeletedExcalidrawElement[],\n  appState: AppState,\n  canvas: HTMLCanvasElement,\n  {\n    exportBackground,\n    exportPadding = 10,\n    viewBackgroundColor,\n    name,\n    scale = 1,\n    shouldAddWatermark,\n  }: {\n    exportBackground: boolean;\n    exportPadding?: number;\n    viewBackgroundColor: string;\n    name: string;\n    scale?: number;\n    shouldAddWatermark: boolean;\n  },\n) => {\n  if (elements.length === 0) {\n    return window.alert(t(\"alerts.cannotExportEmptyCanvas\"));\n  }\n  if (type === \"svg\" || type === \"clipboard-svg\") {\n    const tempSvg = exportToSvg(elements, {\n      exportBackground,\n      viewBackgroundColor,\n      exportPadding,\n      shouldAddWatermark,\n    });\n    if (type === \"svg\") {\n      await fileSave(new Blob([tempSvg.outerHTML], { type: \"image/svg+xml\" }), {\n        fileName: `${name}.svg`,\n      });\n      return;\n    } else if (type === \"clipboard-svg\") {\n      copyCanvasToClipboardAsSvg(tempSvg);\n      return;\n    }\n  }\n\n  const tempCanvas = exportToCanvas(elements, appState, {\n    exportBackground,\n    viewBackgroundColor,\n    exportPadding,\n    scale,\n    shouldAddWatermark,\n  });\n  tempCanvas.style.display = \"none\";\n  document.body.appendChild(tempCanvas);\n\n  if (type === \"png\") {\n    const fileName = `${name}.png`;\n    tempCanvas.toBlob(async (blob: any) => {\n      if (blob) {\n        await fileSave(blob, {\n          fileName: fileName,\n        });\n      }\n    });\n  } else if (type === \"clipboard\") {\n    try {\n      copyCanvasToClipboardAsPng(tempCanvas);\n    } catch {\n      window.alert(t(\"alerts.couldNotCopyToClipboard\"));\n    }\n  } else if (type === \"backend\") {\n    exportToBackend(elements, {\n      ...appState,\n      viewBackgroundColor: exportBackground\n        ? appState.viewBackgroundColor\n        : getDefaultAppState().viewBackgroundColor,\n    });\n  }\n\n  // clean up the DOM\n  if (tempCanvas !== canvas) {\n    tempCanvas.remove();\n  }\n};\n\nexport const loadScene = async (id: string | null, privateKey?: string) => {\n  let data;\n\n  if (id && (id.indexOf(':')!== -1)){\n    data = await restoreFromUrl(\"\"+id)\n  } else if (id != null) {\n    // the private key is used to decrypt the content from the server, take\n    // extra care not to leak it\n    data = await importFromBackend(id, privateKey);\n  } else {\n    data = restoreFromLocalStorage();\n  }\n\n  return {\n    elements: data.elements,\n    appState: data.appState && { ...data.appState },\n    commitToHistory: false,\n  };\n};\n","import { encryptAESGEM } from \"../data\";\n\nimport { SocketUpdateData } from \"../types\";\nimport { BROADCAST, SCENE } from \"../constants\";\nimport App from \"./App\";\n\nclass Portal {\n  app: App;\n  socket: SocketIOClient.Socket | null = null;\n  socketInitialized: boolean = false; // we don't want the socket to emit any updates until it is fully initialized\n  roomID: string | null = null;\n  roomKey: string | null = null;\n\n  constructor(app: App) {\n    this.app = app;\n  }\n\n  open(socket: SocketIOClient.Socket, id: string, key: string) {\n    this.socket = socket;\n    this.roomID = id;\n    this.roomKey = key;\n\n    // Initialize socket listeners (moving from App)\n    this.socket.on(\"init-room\", () => {\n      if (this.socket) {\n        this.socket.emit(\"join-room\", this.roomID);\n\n        this.app.restoreUserName();\n      }\n    });\n    this.socket.on(\"new-user\", async (_socketID: string) => {\n      this.app.broadcastScene(SCENE.INIT, /* syncAll */ true);\n    });\n    this.socket.on(\"room-user-change\", (clients: string[]) => {\n      this.app.setCollaborators(clients);\n    });\n  }\n\n  close() {\n    if (!this.socket) {\n      return;\n    }\n    this.socket.close();\n    this.socket = null;\n    this.roomID = null;\n    this.roomKey = null;\n  }\n\n  isOpen() {\n    return !!(\n      this.socketInitialized &&\n      this.socket &&\n      this.roomID &&\n      this.roomKey\n    );\n  }\n\n  async _broadcastSocketData(\n    data: SocketUpdateData,\n    volatile: boolean = false,\n  ) {\n    if (this.isOpen()) {\n      const json = JSON.stringify(data);\n      const encoded = new TextEncoder().encode(json);\n      const encrypted = await encryptAESGEM(encoded, this.roomKey!);\n      this.socket!.emit(\n        volatile ? BROADCAST.SERVER_VOLATILE : BROADCAST.SERVER,\n        this.roomID,\n        encrypted.data,\n        encrypted.iv,\n      );\n    }\n  }\n}\nexport default Portal;\n","import React from \"react\";\nimport oc from \"open-color\";\n\n// We inline font-awesome icons in order to save on js size rather than including the font awesome react library\nexport const SHAPES = [\n  {\n    icon: (\n      // fa-mouse-pointer\n      <svg viewBox=\"0 0 320 512\" className=\"\">\n        <path d=\"M302.189 329.126H196.105l55.831 135.993c3.889 9.428-.555 19.999-9.444 23.999l-49.165 21.427c-9.165 4-19.443-.571-23.332-9.714l-53.053-129.136-86.664 89.138C18.729 472.71 0 463.554 0 447.977V18.299C0 1.899 19.921-6.096 30.277 5.443l284.412 292.542c11.472 11.179 3.007 31.141-12.5 31.141z\" />\n      </svg>\n    ),\n    value: \"selection\",\n    key: \"s\",\n  },\n  {\n    icon: (\n      // fa-square\n      <svg viewBox=\"0 0 448 512\">\n        <path d=\"M400 32H48C21.5 32 0 53.5 0 80v352c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48V80c0-26.5-21.5-48-48-48z\" />\n      </svg>\n    ),\n    value: \"rectangle\",\n    key: \"r\",\n  },\n  {\n    icon: (\n      // custom\n      <svg viewBox=\"0 0 223.646 223.646\">\n        <path d=\"M111.823 0L16.622 111.823 111.823 223.646 207.025 111.823z\" />\n      </svg>\n    ),\n    value: \"diamond\",\n    key: \"d\",\n  },\n  {\n    icon: (\n      // fa-circle\n      <svg viewBox=\"0 0 512 512\">\n        <path d=\"M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8z\" />\n      </svg>\n    ),\n    value: \"ellipse\",\n    key: \"e\",\n  },\n  {\n    icon: (\n      // fa-long-arrow-alt-right\n      <svg viewBox=\"0 0 448 512\" className=\"rtl-mirror\">\n        <path d=\"M313.941 216H12c-6.627 0-12 5.373-12 12v56c0 6.627 5.373 12 12 12h301.941v46.059c0 21.382 25.851 32.09 40.971 16.971l86.059-86.059c9.373-9.373 9.373-24.569 0-33.941l-86.059-86.059c-15.119-15.119-40.971-4.411-40.971 16.971V216z\" />\n      </svg>\n    ),\n    value: \"arrow\",\n    key: \"a\",\n  },\n  {\n    icon: (\n      // custom\n      <svg viewBox=\"0 0 6 6\">\n        <line\n          x1=\"0\"\n          y1=\"3\"\n          x2=\"6\"\n          y2=\"3\"\n          stroke={oc.black}\n          strokeLinecap=\"round\"\n        />\n      </svg>\n    ),\n    value: \"line\",\n    key: \"l\",\n  },\n  {\n    icon: (\n      // fa-pencil\n      <svg viewBox=\"0 0 512 512\">\n        <path\n          fill=\"currentColor\"\n          d=\"M290.74 93.24l128.02 128.02-277.99 277.99-114.14 12.6C11.35 513.54-1.56 500.62.14 485.34l12.7-114.22 277.9-277.88zm207.2-19.06l-60.11-60.11c-18.75-18.75-49.16-18.75-67.91 0l-56.55 56.55 128.02 128.02 56.55-56.55c18.75-18.76 18.75-49.16 0-67.91z\"\n        ></path>\n      </svg>\n    ),\n    value: \"draw\",\n    key: \"x\",\n  },\n  {\n    icon: (\n      // fa-font\n      <svg viewBox=\"0 0 448 512\">\n        <path d=\"M432 416h-23.41L277.88 53.69A32 32 0 0 0 247.58 32h-47.16a32 32 0 0 0-30.3 21.69L39.41 416H16a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h128a16 16 0 0 0 16-16v-32a16 16 0 0 0-16-16h-19.58l23.3-64h152.56l23.3 64H304a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h128a16 16 0 0 0 16-16v-32a16 16 0 0 0-16-16zM176.85 272L224 142.51 271.15 272z\" />\n      </svg>\n    ),\n    value: \"text\",\n    key: \"t\",\n  },\n] as const;\n\nexport const shapesShortcutKeys = SHAPES.map((shape, index) => [\n  shape.key,\n  (index + 1).toString(),\n]).flat(1);\n\nexport const findShapeByKey = (key: string) =>\n  SHAPES.find((shape, index) => {\n    return shape.key === key.toLowerCase() || key === (index + 1).toString();\n  })?.value || \"selection\";\n","import { AppState } from \"./types\";\nimport { ExcalidrawElement } from \"./element/types\";\nimport { isLinearElement } from \"./element/typeChecks\";\nimport { deepCopyElement } from \"./element/newElement\";\n\nexport interface HistoryEntry {\n  appState: ReturnType<typeof clearAppStatePropertiesForHistory>;\n  elements: ExcalidrawElement[];\n}\n\ninterface DehydratedExcalidrawElement {\n  id: string;\n  versionNonce: number;\n}\n\ninterface DehydratedHistoryEntry {\n  appState: string;\n  elements: DehydratedExcalidrawElement[];\n}\n\nconst clearAppStatePropertiesForHistory = (appState: AppState) => {\n  return {\n    selectedElementIds: appState.selectedElementIds,\n    viewBackgroundColor: appState.viewBackgroundColor,\n    editingLinearElement: appState.editingLinearElement,\n    editingGroupId: appState.editingGroupId,\n    name: appState.name,\n  };\n};\n\nexport class SceneHistory {\n  private elementCache = new Map<string, Map<number, ExcalidrawElement>>();\n  private recording: boolean = true;\n  private stateHistory: DehydratedHistoryEntry[] = [];\n  private redoStack: DehydratedHistoryEntry[] = [];\n  private lastEntry: HistoryEntry | null = null;\n\n  private hydrateHistoryEntry({\n    appState,\n    elements,\n  }: DehydratedHistoryEntry): HistoryEntry {\n    return {\n      appState: JSON.parse(appState),\n      elements: elements.map((dehydratedExcalidrawElement) => {\n        const element = this.elementCache\n          .get(dehydratedExcalidrawElement.id)\n          ?.get(dehydratedExcalidrawElement.versionNonce);\n        if (!element) {\n          throw new Error(\n            `Element not found: ${dehydratedExcalidrawElement.id}:${dehydratedExcalidrawElement.versionNonce}`,\n          );\n        }\n        return element;\n      }),\n    };\n  }\n\n  private dehydrateHistoryEntry({\n    appState,\n    elements,\n  }: HistoryEntry): DehydratedHistoryEntry {\n    return {\n      appState: JSON.stringify(appState),\n      elements: elements.map((element: ExcalidrawElement) => {\n        if (!this.elementCache.has(element.id)) {\n          this.elementCache.set(element.id, new Map());\n        }\n        const versions = this.elementCache.get(element.id)!;\n        if (!versions.has(element.versionNonce)) {\n          versions.set(element.versionNonce, deepCopyElement(element));\n        }\n        return {\n          id: element.id,\n          versionNonce: element.versionNonce,\n        };\n      }),\n    };\n  }\n\n  getSnapshotForTest() {\n    return {\n      recording: this.recording,\n      stateHistory: this.stateHistory.map((dehydratedHistoryEntry) =>\n        this.hydrateHistoryEntry(dehydratedHistoryEntry),\n      ),\n      redoStack: this.redoStack.map((dehydratedHistoryEntry) =>\n        this.hydrateHistoryEntry(dehydratedHistoryEntry),\n      ),\n    };\n  }\n\n  clear() {\n    this.stateHistory.length = 0;\n    this.redoStack.length = 0;\n    this.lastEntry = null;\n    this.elementCache.clear();\n  }\n\n  private generateEntry = (\n    appState: AppState,\n    elements: readonly ExcalidrawElement[],\n  ): DehydratedHistoryEntry =>\n    this.dehydrateHistoryEntry({\n      appState: clearAppStatePropertiesForHistory(appState),\n      elements: elements.reduce((elements, element) => {\n        if (\n          isLinearElement(element) &&\n          appState.multiElement &&\n          appState.multiElement.id === element.id\n        ) {\n          // don't store multi-point arrow if still has only one point\n          if (\n            appState.multiElement &&\n            appState.multiElement.id === element.id &&\n            element.points.length < 2\n          ) {\n            return elements;\n          }\n\n          elements.push({\n            ...element,\n            // don't store last point if not committed\n            points:\n              element.lastCommittedPoint !==\n              element.points[element.points.length - 1]\n                ? element.points.slice(0, -1)\n                : element.points,\n          });\n        } else {\n          elements.push(element);\n        }\n        return elements;\n      }, [] as Mutable<typeof elements>),\n    });\n\n  shouldCreateEntry(nextEntry: HistoryEntry): boolean {\n    const { lastEntry } = this;\n\n    if (!lastEntry) {\n      return true;\n    }\n\n    if (nextEntry.elements.length !== lastEntry.elements.length) {\n      return true;\n    }\n\n    // loop from right to left as changes are likelier to happen on new elements\n    for (let i = nextEntry.elements.length - 1; i > -1; i--) {\n      const prev = nextEntry.elements[i];\n      const next = lastEntry.elements[i];\n      if (\n        !prev ||\n        !next ||\n        prev.id !== next.id ||\n        prev.versionNonce !== next.versionNonce\n      ) {\n        return true;\n      }\n    }\n\n    // note: this is safe because entry's appState is guaranteed no excess props\n    let key: keyof typeof nextEntry.appState;\n    for (key in nextEntry.appState) {\n      if (key === \"editingLinearElement\") {\n        if (\n          nextEntry.appState[key]?.elementId ===\n          lastEntry.appState[key]?.elementId\n        ) {\n          continue;\n        }\n      }\n      if (key === \"selectedElementIds\") {\n        continue;\n      }\n      if (nextEntry.appState[key] !== lastEntry.appState[key]) {\n        return true;\n      }\n    }\n\n    return false;\n  }\n\n  pushEntry(appState: AppState, elements: readonly ExcalidrawElement[]) {\n    const newEntryDehydrated = this.generateEntry(appState, elements);\n    const newEntry: HistoryEntry = this.hydrateHistoryEntry(newEntryDehydrated);\n\n    if (newEntry) {\n      if (!this.shouldCreateEntry(newEntry)) {\n        return;\n      }\n\n      this.stateHistory.push(newEntryDehydrated);\n      this.lastEntry = newEntry;\n      // As a new entry was pushed, we invalidate the redo stack\n      this.clearRedoStack();\n    }\n  }\n\n  clearRedoStack() {\n    this.redoStack.splice(0, this.redoStack.length);\n  }\n\n  redoOnce(): HistoryEntry | null {\n    if (this.redoStack.length === 0) {\n      return null;\n    }\n\n    const entryToRestore = this.redoStack.pop();\n\n    if (entryToRestore !== undefined) {\n      this.stateHistory.push(entryToRestore);\n      return this.hydrateHistoryEntry(entryToRestore);\n    }\n\n    return null;\n  }\n\n  undoOnce(): HistoryEntry | null {\n    if (this.stateHistory.length === 1) {\n      return null;\n    }\n\n    const currentEntry = this.stateHistory.pop();\n\n    const entryToRestore = this.stateHistory[this.stateHistory.length - 1];\n\n    if (currentEntry !== undefined) {\n      this.redoStack.push(currentEntry);\n      return this.hydrateHistoryEntry(entryToRestore);\n    }\n\n    return null;\n  }\n\n  /**\n   * Updates history's `lastEntry` to latest app state. This is necessary\n   *  when doing undo/redo which itself doesn't commit to history, but updates\n   *  app state in a way that would break `shouldCreateEntry` which relies on\n   *  `lastEntry` to reflect last comittable history state.\n   * We can't update `lastEntry` from within history when calling undo/redo\n   *  because the action potentially mutates appState/elements before storing\n   *  it.\n   */\n  setCurrentState(appState: AppState, elements: readonly ExcalidrawElement[]) {\n    this.lastEntry = this.hydrateHistoryEntry(\n      this.generateEntry(appState, elements),\n    );\n  }\n\n  // Suspicious that this is called so many places. Seems error-prone.\n  resumeRecording() {\n    this.recording = true;\n  }\n\n  record(state: AppState, elements: readonly ExcalidrawElement[]) {\n    if (this.recording) {\n      this.pushEntry(state, elements);\n      this.recording = false;\n    }\n  }\n}\n\nexport const createHistory: () => { history: SceneHistory } = () => {\n  const history = new SceneHistory();\n  return { history };\n};\n","import React, { useLayoutEffect, useRef, useEffect } from \"react\";\nimport \"./Popover.css\";\nimport { unstable_batchedUpdates } from \"react-dom\";\n\ntype Props = {\n  top?: number;\n  left?: number;\n  children?: React.ReactNode;\n  onCloseRequest?(event: PointerEvent): void;\n  fitInViewport?: boolean;\n};\n\nexport const Popover = ({\n  children,\n  left,\n  top,\n  onCloseRequest,\n  fitInViewport = false,\n}: Props) => {\n  const popoverRef = useRef<HTMLDivElement>(null);\n\n  // ensure the popover doesn't overflow the viewport\n  useLayoutEffect(() => {\n    if (fitInViewport && popoverRef.current) {\n      const element = popoverRef.current;\n      const { x, y, width, height } = element.getBoundingClientRect();\n\n      const viewportWidth = window.innerWidth;\n      if (x + width > viewportWidth) {\n        element.style.left = `${viewportWidth - width}px`;\n      }\n      const viewportHeight = window.innerHeight;\n      if (y + height > viewportHeight) {\n        element.style.top = `${viewportHeight - height}px`;\n      }\n    }\n  }, [fitInViewport]);\n\n  useEffect(() => {\n    if (onCloseRequest) {\n      const handler = (event: PointerEvent) => {\n        if (!popoverRef.current?.contains(event.target as Node)) {\n          unstable_batchedUpdates(() => onCloseRequest(event));\n        }\n      };\n      document.addEventListener(\"pointerdown\", handler, false);\n      return () => document.removeEventListener(\"pointerdown\", handler, false);\n    }\n  }, [onCloseRequest]);\n\n  return (\n    <div className=\"popover\" style={{ top: top, left: left }} ref={popoverRef}>\n      {children}\n    </div>\n  );\n};\n","import React from \"react\";\nimport { Popover } from \"./Popover\";\nimport { render, unmountComponentAtNode } from \"react-dom\";\n\nimport \"./ContextMenu.scss\";\n\ntype ContextMenuOption = {\n  label: string;\n  action(): void;\n};\n\ntype Props = {\n  options: ContextMenuOption[];\n  onCloseRequest?(): void;\n  top: number;\n  left: number;\n};\n\nconst ContextMenu = ({ options, onCloseRequest, top, left }: Props) => (\n  <Popover\n    onCloseRequest={onCloseRequest}\n    top={top}\n    left={left}\n    fitInViewport={true}\n  >\n    <ul\n      className=\"context-menu\"\n      onContextMenu={(event) => event.preventDefault()}\n    >\n      {options.map((option, idx) => (\n        <li key={idx} onClick={onCloseRequest}>\n          <ContextMenuOption {...option} />\n        </li>\n      ))}\n    </ul>\n  </Popover>\n);\n\nconst ContextMenuOption = ({ label, action }: ContextMenuOption) => (\n  <button className=\"context-menu-option\" onClick={action}>\n    {label}\n  </button>\n);\n\nlet contextMenuNode: HTMLDivElement;\nconst getContextMenuNode = (): HTMLDivElement => {\n  if (contextMenuNode) {\n    return contextMenuNode;\n  }\n  const div = document.createElement(\"div\");\n  document.body.appendChild(div);\n  return (contextMenuNode = div);\n};\n\ntype ContextMenuParams = {\n  options: (ContextMenuOption | false | null | undefined)[];\n  top: number;\n  left: number;\n};\n\nconst handleClose = () => {\n  unmountComponentAtNode(getContextMenuNode());\n};\n\nexport default {\n  push(params: ContextMenuParams) {\n    const options = Array.of<ContextMenuOption>();\n    params.options.forEach((option) => {\n      if (option) {\n        options.push(option);\n      }\n    });\n    if (options.length) {\n      render(\n        <ContextMenu\n          top={params.top}\n          left={params.left}\n          options={options}\n          onCloseRequest={handleClose}\n        />,\n        getContextMenuNode(),\n      );\n    }\n  },\n};\n","import React from \"react\";\nimport {\n  Action,\n  ActionsManagerInterface,\n  UpdaterFn,\n  ActionFilterFn,\n  ActionName,\n} from \"./types\";\nimport { ExcalidrawElement } from \"../element/types\";\nimport { AppState } from \"../types\";\nimport { t } from \"../i18n\";\nimport { globalSceneState } from \"../scene\";\n\nexport class ActionManager implements ActionsManagerInterface {\n  actions = {} as ActionsManagerInterface[\"actions\"];\n\n  updater: UpdaterFn;\n\n  getAppState: () => AppState;\n\n  getElementsIncludingDeleted: () => readonly ExcalidrawElement[];\n\n  constructor(\n    updater: UpdaterFn,\n    getAppState: () => AppState,\n    getElementsIncludingDeleted: () => ReturnType<\n      typeof globalSceneState[\"getElementsIncludingDeleted\"]\n    >,\n  ) {\n    this.updater = updater;\n    this.getAppState = getAppState;\n    this.getElementsIncludingDeleted = getElementsIncludingDeleted;\n  }\n\n  registerAction(action: Action) {\n    this.actions[action.name] = action;\n  }\n\n  registerAll(actions: readonly Action[]) {\n    actions.forEach((action) => this.registerAction(action));\n  }\n\n  handleKeyDown(event: KeyboardEvent) {\n    const data = Object.values(this.actions)\n      .sort((a, b) => (b.keyPriority || 0) - (a.keyPriority || 0))\n      .filter(\n        (action) =>\n          action.keyTest &&\n          action.keyTest(\n            event,\n            this.getAppState(),\n            this.getElementsIncludingDeleted(),\n          ),\n      );\n\n    if (data.length === 0) {\n      return false;\n    }\n\n    event.preventDefault();\n    this.updater(\n      data[0].perform(\n        this.getElementsIncludingDeleted(),\n        this.getAppState(),\n        null,\n      ),\n    );\n    return true;\n  }\n\n  executeAction(action: Action) {\n    this.updater(\n      action.perform(\n        this.getElementsIncludingDeleted(),\n        this.getAppState(),\n        null,\n      ),\n    );\n  }\n\n  getContextMenuItems(actionFilter: ActionFilterFn = (action) => action) {\n    return Object.values(this.actions)\n      .filter(actionFilter)\n      .filter((action) => \"contextItemLabel\" in action)\n      .filter((action) =>\n        action.contextItemPredicate\n          ? action.contextItemPredicate(\n              this.getElementsIncludingDeleted(),\n              this.getAppState(),\n            )\n          : true,\n      )\n      .sort(\n        (a, b) =>\n          (a.contextMenuOrder !== undefined ? a.contextMenuOrder : 999) -\n          (b.contextMenuOrder !== undefined ? b.contextMenuOrder : 999),\n      )\n      .map((action) => ({\n        label: action.contextItemLabel ? t(action.contextItemLabel) : \"\",\n        action: () => {\n          this.updater(\n            action.perform(\n              this.getElementsIncludingDeleted(),\n              this.getAppState(),\n              null,\n            ),\n          );\n        },\n      }));\n  }\n\n  // Id is an attribute that we can use to pass in data like keys.\n  // This is needed for dynamically generated action components\n  // like the user list. We can use this key to extract more\n  // data from app state. This is an alternative to generic prop hell!\n  renderAction = (name: ActionName, id?: string) => {\n    if (this.actions[name] && \"PanelComponent\" in this.actions[name]) {\n      const action = this.actions[name];\n      const PanelComponent = action.PanelComponent!;\n      const updateData = (formState?: any) => {\n        this.updater(\n          action.perform(\n            this.getElementsIncludingDeleted(),\n            this.getAppState(),\n            formState,\n          ),\n        );\n      };\n\n      return (\n        <PanelComponent\n          elements={this.getElementsIncludingDeleted()}\n          appState={this.getAppState()}\n          updateData={updateData}\n          id={id}\n        />\n      );\n    }\n\n    return null;\n  };\n}\n","import \"./ToolIcon.scss\";\n\nimport React from \"react\";\n\ntype ToolIconSize = \"s\" | \"m\";\n\ntype ToolButtonBaseProps = {\n  icon?: React.ReactNode;\n  \"aria-label\": string;\n  \"aria-keyshortcuts\"?: string;\n  \"data-testid\"?: string;\n  label?: string;\n  title?: string;\n  name?: string;\n  id?: string;\n  size?: ToolIconSize;\n  keyBindingLabel?: string;\n  showAriaLabel?: boolean;\n  hidden?: boolean;\n  visible?: boolean;\n  selected?: boolean;\n  className?: string;\n};\n\ntype ToolButtonProps =\n  | (ToolButtonBaseProps & {\n      type: \"button\";\n      children?: React.ReactNode;\n      onClick?(): void;\n    })\n  | (ToolButtonBaseProps & {\n      type: \"radio\";\n\n      checked: boolean;\n      onChange?(): void;\n    });\n\nconst DEFAULT_SIZE: ToolIconSize = \"m\";\n\nexport const ToolButton = React.forwardRef((props: ToolButtonProps, ref) => {\n  const innerRef = React.useRef(null);\n  React.useImperativeHandle(ref, () => innerRef.current);\n  const sizeCn = `ToolIcon_size_${props.size || DEFAULT_SIZE}`;\n\n  if (props.type === \"button\") {\n    return (\n      <button\n        className={`ToolIcon_type_button ${\n          !props.hidden ? \"ToolIcon\" : \"\"\n        } ${sizeCn}${props.selected ? \" ToolIcon--selected\" : \"\"} ${\n          props.className\n        } ${\n          props.visible && !props.hidden\n            ? \"ToolIcon_type_button--show\"\n            : \"ToolIcon_type_button--hide\"\n        }`}\n        hidden={props.hidden}\n        title={props.title}\n        aria-label={props[\"aria-label\"]}\n        type=\"button\"\n        onClick={props.onClick}\n        ref={innerRef}\n      >\n        <div className=\"ToolIcon__icon\" aria-hidden=\"true\">\n          {props.icon || props.label}\n          {props.keyBindingLabel && (\n            <span className=\"ToolIcon__keybinding\">\n              {props.keyBindingLabel}\n            </span>\n          )}\n        </div>\n        {props.showAriaLabel && (\n          <div className=\"ToolIcon__label\">{props[\"aria-label\"]}</div>\n        )}\n        {props.children}\n      </button>\n    );\n  }\n\n  return (\n    <label className=\"ToolIcon\" title={props.title}>\n      <input\n        className={`ToolIcon_type_radio ${sizeCn}`}\n        type=\"radio\"\n        name={props.name}\n        aria-label={props[\"aria-label\"]}\n        aria-keyshortcuts={props[\"aria-keyshortcuts\"]}\n        data-testid={props[\"data-testid\"]}\n        id={props.id}\n        onChange={props.onChange}\n        checked={props.checked}\n        ref={innerRef}\n      />\n      <div className=\"ToolIcon__icon\">\n        {props.icon}\n        {props.keyBindingLabel && (\n          <span className=\"ToolIcon__keybinding\">{props.keyBindingLabel}</span>\n        )}\n      </div>\n    </label>\n  );\n});\n\nToolButton.defaultProps = {\n  visible: true,\n  className: \"\",\n};\n","//\n// All icons are imported from https://fontawesome.com/icons?d=gallery\n// Icons are under the license https://fontawesome.com/license\n//\n\nimport React from \"react\";\n\nimport oc from \"open-color\";\n\nconst ACTIVE_ELEMENT_COLOR = oc.orange[4];\ntype Opts = { width?: number; height?: number; mirror?: true } & React.SVGProps<\n  SVGSVGElement\n>;\n\nconst createIcon = (d: string | React.ReactNode, opts: number | Opts = 512) => {\n  const { width = 512, height = width, mirror, style } =\n    typeof opts === \"number\" ? ({ width: opts } as Opts) : opts;\n  return (\n    <svg\n      aria-hidden=\"true\"\n      focusable=\"false\"\n      role=\"img\"\n      viewBox={`0 0 ${width} ${height}`}\n      className={mirror && \"rtl-mirror\"}\n      style={style}\n    >\n      {typeof d === \"string\" ? <path fill=\"currentColor\" d={d} /> : d}\n    </svg>\n  );\n};\n\nexport const link = createIcon(\n  \"M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z\",\n  { mirror: true },\n);\n\nexport const save = createIcon(\n  \"M433.941 129.941l-83.882-83.882A48 48 0 0 0 316.118 32H48C21.49 32 0 53.49 0 80v352c0 26.51 21.49 48 48 48h352c26.51 0 48-21.49 48-48V163.882a48 48 0 0 0-14.059-33.941zM224 416c-35.346 0-64-28.654-64-64 0-35.346 28.654-64 64-64s64 28.654 64 64c0 35.346-28.654 64-64 64zm96-304.52V212c0 6.627-5.373 12-12 12H76c-6.627 0-12-5.373-12-12V108c0-6.627 5.373-12 12-12h228.52c3.183 0 6.235 1.264 8.485 3.515l3.48 3.48A11.996 11.996 0 0 1 320 111.48z\",\n  { width: 448, height: 512 },\n);\n\nexport const saveAs = createIcon(\n  \"M252 54L203 8a28 27 0 00-20-8H28C12 0 0 12 0 27v195c0 15 12 26 28 26h204c15 0 28-11 28-26V73a28 27 0 00-8-19zM130 213c-21 0-37-16-37-36 0-19 16-35 37-35 20 0 37 16 37 35 0 20-17 36-37 36zm56-169v56c0 4-4 6-7 6H44c-4 0-7-2-7-6V42c0-4 3-7 7-7h133l4 2 3 2a7 7 0 012 5z M296 201l87 95-188 205-78 9c-10 1-19-8-18-20l9-84zm141-14l-41-44a31 31 0 00-46 0l-38 41 87 95 38-42c13-14 13-36 0-50z\",\n  { width: 448, height: 512 },\n);\n\nexport const load = createIcon(\n  \"M572.694 292.093L500.27 416.248A63.997 63.997 0 0 1 444.989 448H45.025c-18.523 0-30.064-20.093-20.731-36.093l72.424-124.155A64 64 0 0 1 152 256h399.964c18.523 0 30.064 20.093 20.73 36.093zM152 224h328v-48c0-26.51-21.49-48-48-48H272l-64-64H48C21.49 64 0 85.49 0 112v278.046l69.077-118.418C86.214 242.25 117.989 224 152 224z\",\n  { width: 576, height: 512, mirror: true },\n);\n\nexport const clipboard = createIcon(\n  \"M384 112v352c0 26.51-21.49 48-48 48H48c-26.51 0-48-21.49-48-48V112c0-26.51 21.49-48 48-48h80c0-35.29 28.71-64 64-64s64 28.71 64 64h80c26.51 0 48 21.49 48 48zM192 40c-13.255 0-24 10.745-24 24s10.745 24 24 24 24-10.745 24-24-10.745-24-24-24m96 114v-20a6 6 0 0 0-6-6H102a6 6 0 0 0-6 6v20a6 6 0 0 0 6 6h180a6 6 0 0 0 6-6z\",\n  { width: 384, height: 512 },\n);\n\nexport const trash = createIcon(\n  \"M32 464a48 48 0 0 0 48 48h288a48 48 0 0 0 48-48V128H32zm272-256a16 16 0 0 1 32 0v224a16 16 0 0 1-32 0zm-96 0a16 16 0 0 1 32 0v224a16 16 0 0 1-32 0zm-96 0a16 16 0 0 1 32 0v224a16 16 0 0 1-32 0zM432 32H312l-9.4-18.7A24 24 0 0 0 281.1 0H166.8a23.72 23.72 0 0 0-21.4 13.3L136 32H16A16 16 0 0 0 0 48v32a16 16 0 0 0 16 16h416a16 16 0 0 0 16-16V48a16 16 0 0 0-16-16z\",\n  { width: 448, height: 512 },\n);\n\nexport const palette = createIcon(\n  \"M204.3 5C104.9 24.4 24.8 104.3 5.2 203.4c-37 187 131.7 326.4 258.8 306.7 41.2-6.4 61.4-54.6 42.5-91.7-23.1-45.4 9.9-98.4 60.9-98.4h79.7c35.8 0 64.8-29.6 64.9-65.3C511.5 97.1 368.1-26.9 204.3 5zM96 320c-17.7 0-32-14.3-32-32s14.3-32 32-32 32 14.3 32 32-14.3 32-32 32zm32-128c-17.7 0-32-14.3-32-32s14.3-32 32-32 32 14.3 32 32-14.3 32-32 32zm128-64c-17.7 0-32-14.3-32-32s14.3-32 32-32 32 14.3 32 32-14.3 32-32 32zm128 64c-17.7 0-32-14.3-32-32s14.3-32 32-32 32 14.3 32 32-14.3 32-32 32z\",\n);\n\nexport const exportFile = createIcon(\n  \"M384 121.9c0-6.3-2.5-12.4-7-16.9L279.1 7c-4.5-4.5-10.6-7-17-7H256v128h128zM571 308l-95.7-96.4c-10.1-10.1-27.4-3-27.4 11.3V288h-64v64h64v65.2c0 14.3 17.3 21.4 27.4 11.3L571 332c6.6-6.6 6.6-17.4 0-24zm-379 28v-32c0-8.8 7.2-16 16-16h176V160H248c-13.2 0-24-10.8-24-24V0H24C10.7 0 0 10.7 0 24v464c0 13.3 10.7 24 24 24h336c13.3 0 24-10.7 24-24V352H208c-8.8 0-16-7.2-16-16z\",\n  { width: 576, height: 512, mirror: true },\n);\n\nexport const zoomIn = createIcon(\n  \"M416 208H272V64c0-17.67-14.33-32-32-32h-32c-17.67 0-32 14.33-32 32v144H32c-17.67 0-32 14.33-32 32v32c0 17.67 14.33 32 32 32h144v144c0 17.67 14.33 32 32 32h32c17.67 0 32-14.33 32-32V304h144c17.67 0 32-14.33 32-32v-32c0-17.67-14.33-32-32-32z\",\n  { width: 448, height: 512 },\n);\n\nexport const zoomOut = createIcon(\n  \"M416 208H32c-17.67 0-32 14.33-32 32v32c0 17.67 14.33 32 32 32h384c17.67 0 32-14.33 32-32v-32c0-17.67-14.33-32-32-32z\",\n  { width: 448, height: 512 },\n);\n\nexport const done = createIcon(\n  \"M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206 0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204 0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204 0l36.203 36.204c9.997 9.997 9.997 26.206 0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z\",\n  { mirror: true },\n);\n\nexport const menu = createIcon(\n  \"M16 132h416c8.837 0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163 0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z\",\n);\n\nexport const undo = createIcon(\n  \"M255.545 8c-66.269.119-126.438 26.233-170.86 68.685L48.971 40.971C33.851 25.851 8 36.559 8 57.941V192c0 13.255 10.745 24 24 24h134.059c21.382 0 32.09-25.851 16.971-40.971l-41.75-41.75c30.864-28.899 70.801-44.907 113.23-45.273 92.398-.798 170.283 73.977 169.484 169.442C423.236 348.009 349.816 424 256 424c-41.127 0-79.997-14.678-110.63-41.556-4.743-4.161-11.906-3.908-16.368.553L89.34 422.659c-4.872 4.872-4.631 12.815.482 17.433C133.798 479.813 192.074 504 256 504c136.966 0 247.999-111.033 248-247.998C504.001 119.193 392.354 7.755 255.545 8z\",\n  { mirror: true },\n);\n\nexport const redo = createIcon(\n  \"M256.455 8c66.269.119 126.437 26.233 170.859 68.685l35.715-35.715C478.149 25.851 504 36.559 504 57.941V192c0 13.255-10.745 24-24 24H345.941c-21.382 0-32.09-25.851-16.971-40.971l41.75-41.75c-30.864-28.899-70.801-44.907-113.23-45.273-92.398-.798-170.283 73.977-169.484 169.442C88.764 348.009 162.184 424 256 424c41.127 0 79.997-14.678 110.629-41.556 4.743-4.161 11.906-3.908 16.368.553l39.662 39.662c4.872 4.872 4.631 12.815-.482 17.433C378.202 479.813 319.926 504 256 504 119.034 504 8.001 392.967 8 256.002 7.999 119.193 119.646 7.755 256.455 8z\",\n  { mirror: true },\n);\n\n// Icon imported form Storybook\n// Storybook is licensed under MIT https://github.com/storybookjs/storybook/blob/next/LICENSE\nexport const resetZoom = createIcon(\n  <path\n    stroke=\"currentColor\"\n    strokeWidth=\"40\"\n    fill=\"currentColor\"\n    d=\"M148 560a318 318 0 0 0 522 110 316 316 0 0 0 0-450 316 316 0 0 0-450 0c-11 11-21 22-30 34v4h47c25 0 46 21 46 46s-21 45-46 45H90c-13 0-25-6-33-14-9-9-14-20-14-33V156c0-25 20-45 45-45s45 20 45 45v32l1 1a401 401 0 0 1 623 509l212 212a42 42 0 0 1-59 59L698 757A401 401 0 0 1 65 570a42 42 0 0 1 83-10z\"\n  />,\n  { width: 1024 },\n);\n\nexport const bringForward = createIcon(\n  <>\n    <path\n      d=\"M22 9.556C22 8.696 21.303 8 20.444 8H16v8H8v4.444C8 21.304 8.697 22 9.556 22h10.888c.86 0 1.556-.697 1.556-1.556V9.556z\"\n      stroke={oc.black}\n      strokeWidth=\"2\"\n    />\n    <path\n      d=\"M16 3.556C16 2.696 15.303 2 14.444 2H3.556C2.696 2 2 2.697 2 3.556v10.888C2 15.304 2.697 16 3.556 16h10.888c.86 0 1.556-.697 1.556-1.556V3.556z\"\n      fill={ACTIVE_ELEMENT_COLOR}\n      stroke={ACTIVE_ELEMENT_COLOR}\n      strokeWidth=\"2\"\n    />\n  </>,\n  { width: 24 },\n);\n\nexport const sendBackward = createIcon(\n  <>\n    <path\n      d=\"M16 3.556C16 2.696 15.303 2 14.444 2H3.556C2.696 2 2 2.697 2 3.556v10.888C2 15.304 2.697 16 3.556 16h10.888c.86 0 1.556-.697 1.556-1.556V3.556z\"\n      fill={ACTIVE_ELEMENT_COLOR}\n      stroke={ACTIVE_ELEMENT_COLOR}\n      strokeWidth=\"2\"\n    />\n    <path\n      d=\"M22 9.556C22 8.696 21.303 8 20.444 8H9.556C8.696 8 8 8.697 8 9.556v10.888C8 21.304 8.697 22 9.556 22h10.888c.86 0 1.556-.697 1.556-1.556V9.556z\"\n      stroke={oc.black}\n      strokeWidth=\"2\"\n    />\n  </>,\n  { width: 24 },\n);\n\nexport const bringToFront = createIcon(\n  <>\n    <path\n      d=\"M13 21a1 1 0 001 1h7a1 1 0 001-1v-7a1 1 0 00-1-1h-3v5h-5v3zM11 3a1 1 0 00-1-1H3a1 1 0 00-1 1v7a1 1 0 001 1h3V6h5V3z\"\n      stroke={oc.black}\n      strokeWidth=\"2\"\n    />\n    <path\n      d=\"M18 7.333C18 6.597 17.403 6 16.667 6H7.333C6.597 6 6 6.597 6 7.333v9.334C6 17.403 6.597 18 7.333 18h9.334c.736 0 1.333-.597 1.333-1.333V7.333z\"\n      fill={ACTIVE_ELEMENT_COLOR}\n      stroke={ACTIVE_ELEMENT_COLOR}\n      strokeWidth=\"2\"\n    />\n  </>,\n  { width: 24 },\n);\n\nexport const sendToBack = createIcon(\n  <>\n    <path\n      d=\"M18 7.333C18 6.597 17.403 6 16.667 6H7.333C6.597 6 6 6.597 6 7.333v9.334C6 17.403 6.597 18 7.333 18h9.334c.736 0 1.333-.597 1.333-1.333V7.333z\"\n      fill={ACTIVE_ELEMENT_COLOR}\n      stroke={ACTIVE_ELEMENT_COLOR}\n      strokeLinejoin=\"round\"\n      strokeWidth=\"2\"\n    />\n    <path\n      d=\"M11 3a1 1 0 00-1-1H3a1 1 0 00-1 1v7a1 1 0 001 1h8V3zM22 14a1 1 0 00-1-1h-7a1 1 0 00-1 1v7a1 1 0 001 1h8v-8z\"\n      stroke={oc.black}\n      strokeLinejoin=\"round\"\n      strokeWidth=\"2\"\n    />\n  </>,\n  { width: 24 },\n);\n\nexport const users = createIcon(\n  \"M192 256c61.9 0 112-50.1 112-112S253.9 32 192 32 80 82.1 80 144s50.1 112 112 112zm76.8 32h-8.3c-20.8 10-43.9 16-68.5 16s-47.6-6-68.5-16h-8.3C51.6 288 0 339.6 0 403.2V432c0 26.5 21.5 48 48 48h288c26.5 0 48-21.5 48-48v-28.8c0-63.6-51.6-115.2-115.2-115.2zM480 256c53 0 96-43 96-96s-43-96-96-96-96 43-96 96 43 96 96 96zm48 32h-3.8c-13.9 4.8-28.6 8-44.2 8s-30.3-3.2-44.2-8H432c-20.4 0-39.2 5.9-55.7 15.4 24.4 26.3 39.7 61.2 39.7 99.8v38.4c0 2.2-.5 4.3-.6 6.4H592c26.5 0 48-21.5 48-48 0-61.9-50.1-112-112-112z\",\n  { width: 640, height: 512, mirror: true },\n);\n\nexport const start = createIcon(\n  \"M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm115.7 272l-176 101c-15.8 8.8-35.7-2.5-35.7-21V152c0-18.4 19.8-29.8 35.7-21l176 107c16.4 9.2 16.4 32.9 0 42z\",\n);\n\nexport const stop = createIcon(\n  \"M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm96 328c0 8.8-7.2 16-16 16H176c-8.8 0-16-7.2-16-16V176c0-8.8 7.2-16 16-16h160c8.8 0 16 7.2 16 16v160z\",\n);\n\nexport const close = createIcon(\n  \"M242.72 256l100.07-100.07c12.28-12.28 12.28-32.19 0-44.48l-22.24-22.24c-12.28-12.28-32.19-12.28-44.48 0L176 189.28 75.93 89.21c-12.28-12.28-32.19-12.28-44.48 0L9.21 111.45c-12.28 12.28-12.28 32.19 0 44.48L109.28 256 9.21 356.07c-12.28 12.28-12.28 32.19 0 44.48l22.24 22.24c12.28 12.28 32.2 12.28 44.48 0L176 322.72l100.07 100.07c12.28 12.28 32.2 12.28 44.48 0l22.24-22.24c12.28-12.28 12.28-32.19 0-44.48L242.72 256z\",\n  { width: 352, height: 512 },\n);\n\nexport const back = createIcon(\n  \"M34.52 239.03L228.87 44.69c9.37-9.37 24.57-9.37 33.94 0l22.67 22.67c9.36 9.36 9.37 24.52.04 33.9L131.49 256l154.02 154.75c9.34 9.38 9.32 24.54-.04 33.9l-22.67 22.67c-9.37 9.37-24.57 9.37-33.94 0L34.52 272.97c-9.37-9.37-9.37-24.57 0-33.94z\",\n  { width: 320, height: 512, style: { marginLeft: \"-0.2rem\" }, mirror: true },\n);\n\nexport const clone = createIcon(\n  \"M464 0c26.51 0 48 21.49 48 48v288c0 26.51-21.49 48-48 48H176c-26.51 0-48-21.49-48-48V48c0-26.51 21.49-48 48-48h288M176 416c-44.112 0-80-35.888-80-80V128H48c-26.51 0-48 21.49-48 48v288c0 26.51 21.49 48 48 48h288c26.51 0 48-21.49 48-48v-48H176z\",\n  { mirror: true },\n);\n\n// modified https://feathericons.com/?query=shield\nexport const shield = createIcon(\n  \"M11.553 22.894a.998.998 0 00.894 0s3.037-1.516 5.465-4.097C19.616 16.987 21 14.663 21 12V5a1 1 0 00-.649-.936l-8-3a.998.998 0 00-.702 0l-8 3A1 1 0 003 5v7c0 2.663 1.384 4.987 3.088 6.797 2.428 2.581 5.465 4.097 5.465 4.097zm-1.303-8.481l6.644-6.644a.856.856 0 111.212 1.212l-7.25 7.25a.856.856 0 01-1.212 0l-3.75-3.75a.856.856 0 111.212-1.212l3.144 3.144z\",\n  { width: 24 },\n);\n","import { Action } from \"./types\";\n\nexport let actions: readonly Action[] = [];\n\nexport const register = (action: Action): Action => {\n  actions = actions.concat(action);\n  return action;\n};\n","import { isSomeElementSelected } from \"../scene\";\nimport { KEYS } from \"../keys\";\nimport { ToolButton } from \"../components/ToolButton\";\nimport React from \"react\";\nimport { trash } from \"../components/icons\";\nimport { t } from \"../i18n\";\nimport { register } from \"./register\";\nimport { getNonDeletedElements } from \"../element\";\nimport { ExcalidrawElement } from \"../element/types\";\nimport { AppState } from \"../types\";\nimport { newElementWith } from \"../element/mutateElement\";\nimport { getElementsInGroup } from \"../groups\";\nimport { LinearElementEditor } from \"../element/linearElementEditor\";\n\nconst deleteSelectedElements = (\n  elements: readonly ExcalidrawElement[],\n  appState: AppState,\n) => {\n  return {\n    elements: elements.map((el) => {\n      if (appState.selectedElementIds[el.id]) {\n        return newElementWith(el, { isDeleted: true });\n      }\n      return el;\n    }),\n    appState: {\n      ...appState,\n      selectedElementIds: {},\n    },\n  };\n};\n\nfunction handleGroupEditingState(\n  appState: AppState,\n  elements: readonly ExcalidrawElement[],\n): AppState {\n  if (appState.editingGroupId) {\n    const siblingElements = getElementsInGroup(\n      getNonDeletedElements(elements),\n      appState.editingGroupId!,\n    );\n    if (siblingElements.length) {\n      return {\n        ...appState,\n        selectedElementIds: { [siblingElements[0].id]: true },\n      };\n    }\n  }\n  return appState;\n}\n\nexport const actionDeleteSelected = register({\n  name: \"deleteSelectedElements\",\n  perform: (elements, appState) => {\n    if (appState.editingLinearElement) {\n      const { elementId, activePointIndex } = appState.editingLinearElement;\n      const element = LinearElementEditor.getElement(elementId);\n      if (!element) {\n        return false;\n      }\n      if (\n        // case: no point selected  delete whole element\n        activePointIndex == null ||\n        activePointIndex === -1 ||\n        // case: deleting last point\n        element.points.length < 2\n      ) {\n        const nextElements = elements.filter((el) => el.id !== element.id);\n        const nextAppState = handleGroupEditingState(appState, nextElements);\n\n        return {\n          elements: nextElements,\n          appState: {\n            ...nextAppState,\n            editingLinearElement: null,\n          },\n          commitToHistory: false,\n        };\n      }\n\n      LinearElementEditor.movePoint(element, activePointIndex, \"delete\");\n\n      return {\n        elements: elements,\n        appState: {\n          ...appState,\n          editingLinearElement: {\n            ...appState.editingLinearElement,\n            activePointIndex: activePointIndex > 0 ? activePointIndex - 1 : 0,\n          },\n        },\n        commitToHistory: true,\n      };\n    }\n\n    let {\n      elements: nextElements,\n      appState: nextAppState,\n    } = deleteSelectedElements(elements, appState);\n\n    nextAppState = handleGroupEditingState(nextAppState, nextElements);\n\n    return {\n      elements: nextElements,\n      appState: {\n        ...nextAppState,\n        elementType: \"selection\",\n        multiElement: null,\n      },\n      commitToHistory: isSomeElementSelected(\n        getNonDeletedElements(elements),\n        appState,\n      ),\n    };\n  },\n  contextItemLabel: \"labels.delete\",\n  contextMenuOrder: 3,\n  keyTest: (event) => event.key === KEYS.BACKSPACE || event.key === KEYS.DELETE,\n  PanelComponent: ({ elements, appState, updateData }) => (\n    <ToolButton\n      type=\"button\"\n      icon={trash}\n      title={t(\"labels.delete\")}\n      aria-label={t(\"labels.delete\")}\n      onClick={() => updateData(null)}\n      visible={isSomeElementSelected(getNonDeletedElements(elements), appState)}\n    />\n  ),\n});\n","const swap = <T>(elements: T[], indexA: number, indexB: number) => {\n  const element = elements[indexA];\n  elements[indexA] = elements[indexB];\n  elements[indexB] = element;\n};\n\nexport const moveOneLeft = <T>(elements: T[], indicesToMove: number[]) => {\n  indicesToMove.sort((a: number, b: number) => a - b);\n  let isSorted = true;\n  // We go from left to right to avoid overriding the wrong elements\n  indicesToMove.forEach((index, i) => {\n    // We don't want to bubble the first elements that are sorted as they are\n    // already in their correct position\n    isSorted = isSorted && index === i;\n    if (isSorted) {\n      return;\n    }\n    swap(elements, index - 1, index);\n  });\n\n  return elements;\n};\n\nexport const moveOneRight = <T>(elements: T[], indicesToMove: number[]) => {\n  const reversedIndicesToMove = indicesToMove.sort(\n    (a: number, b: number) => b - a,\n  );\n  let isSorted = true;\n\n  // We go from right to left to avoid overriding the wrong elements\n  reversedIndicesToMove.forEach((index, i) => {\n    // We don't want to bubble the first elements that are sorted as they are\n    // already in their correct position\n    isSorted = isSorted && index === elements.length - i - 1;\n    if (isSorted) {\n      return;\n    }\n    swap(elements, index + 1, index);\n  });\n  return elements;\n};\n\n// Let's go through an example\n//        |        |\n// [a, b, c, d, e, f, g]\n// -->\n// [c, f, a, b, d, e, g]\n//\n// We are going to override all the elements we want to move, so we keep them in an array\n// that we will restore at the end.\n// [c, f]\n//\n// From now on, we'll never read those values from the array anymore\n//        |1       |0\n// [a, b, _, d, e, _, g]\n//\n// The idea is that we want to shift all the elements between the marker 0 and 1\n// by one slot to the right.\n//\n//        |1       |0\n// [a, b, _, d, e, _, g]\n//          -> ->\n//\n// which gives us\n//\n//        |1       |0\n// [a, b, _, _, d, e, g]\n//\n// Now, we need to move all the elements from marker 1 to the beginning by two (not one)\n// slots to the right, which gives us\n//\n//        |1       |0\n// [a, b, _, _, d, e, g]\n//  ---|--^  ^\n//     ------|\n//\n// which gives us\n//\n//        |1       |0\n// [_, _, a, b, d, e, g]\n//\n// At this point, we can fill back the leftmost elements with the array we saved at\n// the beginning\n//\n//        |1       |0\n// [c, f, a, b, d, e, g]\n//\n// And we are done!\nexport const moveAllLeft = <T>(elements: T[], indicesToMove: number[]) => {\n  indicesToMove.sort((a: number, b: number) => a - b);\n\n  // Copy the elements to move\n  const leftMostElements = indicesToMove.map((index) => elements[index]);\n\n  const reversedIndicesToMove = indicesToMove\n    // We go from right to left to avoid overriding elements.\n    .reverse()\n    // We add 0 for the final marker\n    .concat([0]);\n\n  reversedIndicesToMove.forEach((index, i) => {\n    // We skip the first one as it is not paired with anything else\n    if (i === 0) {\n      return;\n    }\n\n    // We go from the next marker to the right (i - 1) to the current one (index)\n    for (let pos = reversedIndicesToMove[i - 1] - 1; pos >= index; --pos) {\n      // We move by 1 the first time, 2 the second... So we can use the index i in the array\n      elements[pos + i] = elements[pos];\n    }\n  });\n\n  // The final step\n  leftMostElements.forEach((element, i) => {\n    elements[i] = element;\n  });\n\n  return elements;\n};\n\n// Let's go through an example\n//        |        |\n// [a, b, c, d, e, f, g]\n// -->\n// [a, b, d, e, g, c, f]\n//\n// We are going to override all the elements we want to move, so we keep them in an array\n// that we will restore at the end.\n// [c, f]\n//\n// From now on, we'll never read those values from the array anymore\n//        |0       |1\n// [a, b, _, d, e, _, g]\n//\n// The idea is that we want to shift all the elements between the marker 0 and 1\n// by one slot to the left.\n//\n//        |0       |1\n// [a, b, _, d, e, _, g]\n//          <- <-\n//\n// which gives us\n//\n//        |0       |1\n// [a, b, d, e, _, _, g]\n//\n// Now, we need to move all the elements from marker 1 to the end by two (not one)\n// slots to the left, which gives us\n//\n//        |0       |1\n// [a, b, d, e, _, _, g]\n//              ^------\n//\n// which gives us\n//\n//        |0       |1\n// [a, b, d, e, g, _, _]\n//\n// At this point, we can fill back the rightmost elements with the array we saved at\n// the beginning\n//\n//        |0       |1\n// [a, b, d, e, g, c, f]\n//\n// And we are done!\nexport const moveAllRight = <T>(elements: T[], indicesToMove: number[]) => {\n  const reversedIndicesToMove = indicesToMove.sort(\n    (a: number, b: number) => b - a,\n  );\n\n  // Copy the elements to move\n  const rightMostElements = reversedIndicesToMove.map(\n    (index) => elements[index],\n  );\n\n  indicesToMove = reversedIndicesToMove\n    // We go from left to right to avoid overriding elements.\n    .reverse()\n    // We last element index for the final marker\n    .concat([elements.length]);\n\n  indicesToMove.forEach((index, i) => {\n    // We skip the first one as it is not paired with anything else\n    if (i === 0) {\n      return;\n    }\n\n    // We go from the next marker to the left (i - 1) to the current one (index)\n    for (let pos = indicesToMove[i - 1] + 1; pos < index; ++pos) {\n      // We move by 1 the first time, 2 the second... So we can use the index i in the array\n      elements[pos - i] = elements[pos];\n    }\n  });\n\n  // The final step\n  rightMostElements.forEach((element, i) => {\n    elements[elements.length - i - 1] = element;\n  });\n\n  return elements;\n};\n","import React from \"react\";\nimport {\n  moveOneLeft,\n  moveOneRight,\n  moveAllLeft,\n  moveAllRight,\n} from \"../zindex\";\nimport { KEYS, isDarwin } from \"../keys\";\nimport { t } from \"../i18n\";\nimport { getShortcutKey } from \"../utils\";\nimport { register } from \"./register\";\nimport {\n  sendBackward,\n  bringToFront,\n  sendToBack,\n  bringForward,\n} from \"../components/icons\";\nimport { ExcalidrawElement } from \"../element/types\";\nimport { AppState } from \"../types\";\n\nconst getElementIndices = (\n  direction: \"left\" | \"right\",\n  elements: readonly ExcalidrawElement[],\n  appState: AppState,\n) => {\n  const selectedIndices: number[] = [];\n  let deletedIndicesCache: number[] = [];\n\n  const cb = (element: ExcalidrawElement, index: number) => {\n    if (element.isDeleted) {\n      // we want to build an array of deleted elements that are preceeding\n      //  a selected element so that we move them together\n      deletedIndicesCache.push(index);\n    } else {\n      if (appState.selectedElementIds[element.id]) {\n        selectedIndices.push(...deletedIndicesCache, index);\n      }\n      // always empty cache of deleted elements after either pushing a group\n      //  of selected/deleted elements, of after encountering non-deleted elem\n      deletedIndicesCache = [];\n    }\n  };\n\n  // sending back  select contiguous deleted elements that are to the left of\n  //  selected element(s)\n  if (direction === \"left\") {\n    let i = -1;\n    const len = elements.length;\n    while (++i < len) {\n      cb(elements[i], i);\n    }\n    // moving to front  loop from right to left so that we don't need to\n    //  backtrack when gathering deleted elements\n  } else {\n    let i = elements.length;\n    while (--i > -1) {\n      cb(elements[i], i);\n    }\n  }\n  // sort in case we were gathering indexes from right to left\n  return selectedIndices.sort();\n};\n\nconst moveElements = (\n  func: typeof moveOneLeft,\n  elements: readonly ExcalidrawElement[],\n  appState: AppState,\n) => {\n  const _elements = elements.slice();\n  const direction =\n    func === moveOneLeft || func === moveAllLeft ? \"left\" : \"right\";\n  const indices = getElementIndices(direction, _elements, appState);\n  return func(_elements, indices);\n};\n\nexport const actionSendBackward = register({\n  name: \"sendBackward\",\n  perform: (elements, appState) => {\n    return {\n      elements: moveElements(moveOneLeft, elements, appState),\n      appState,\n      commitToHistory: true,\n    };\n  },\n  contextItemLabel: \"labels.sendBackward\",\n  keyPriority: 40,\n  keyTest: (event) =>\n    event[KEYS.CTRL_OR_CMD] && !event.shiftKey && event.code === \"BracketLeft\",\n  PanelComponent: ({ updateData }) => (\n    <button\n      type=\"button\"\n      className=\"zIndexButton\"\n      onClick={() => updateData(null)}\n      title={`${t(\"labels.sendBackward\")}  ${getShortcutKey(\"CtrlOrCmd+[\")}`}\n    >\n      {sendBackward}\n    </button>\n  ),\n});\n\nexport const actionBringForward = register({\n  name: \"bringForward\",\n  perform: (elements, appState) => {\n    return {\n      elements: moveElements(moveOneRight, elements, appState),\n      appState,\n      commitToHistory: true,\n    };\n  },\n  contextItemLabel: \"labels.bringForward\",\n  keyPriority: 40,\n  keyTest: (event) =>\n    event[KEYS.CTRL_OR_CMD] && !event.shiftKey && event.code === \"BracketRight\",\n  PanelComponent: ({ updateData }) => (\n    <button\n      type=\"button\"\n      className=\"zIndexButton\"\n      onClick={() => updateData(null)}\n      title={`${t(\"labels.bringForward\")}  ${getShortcutKey(\"CtrlOrCmd+]\")}`}\n    >\n      {bringForward}\n    </button>\n  ),\n});\n\nexport const actionSendToBack = register({\n  name: \"sendToBack\",\n  perform: (elements, appState) => {\n    return {\n      elements: moveElements(moveAllLeft, elements, appState),\n      appState,\n      commitToHistory: true,\n    };\n  },\n  contextItemLabel: \"labels.sendToBack\",\n  keyTest: (event) => {\n    return isDarwin\n      ? event[KEYS.CTRL_OR_CMD] && event.altKey && event.code === \"BracketLeft\"\n      : event[KEYS.CTRL_OR_CMD] &&\n          event.shiftKey &&\n          event.code === \"BracketLeft\";\n  },\n  PanelComponent: ({ updateData }) => (\n    <button\n      type=\"button\"\n      className=\"zIndexButton\"\n      onClick={() => updateData(null)}\n      title={`${t(\"labels.sendToBack\")}  ${\n        isDarwin\n          ? getShortcutKey(\"CtrlOrCmd+Alt+[\")\n          : getShortcutKey(\"CtrlOrCmd+Shift+[\")\n      }`}\n    >\n      {sendToBack}\n    </button>\n  ),\n});\n\nexport const actionBringToFront = register({\n  name: \"bringToFront\",\n  perform: (elements, appState) => {\n    return {\n      elements: moveElements(moveAllRight, elements, appState),\n      appState,\n      commitToHistory: true,\n    };\n  },\n  contextItemLabel: \"labels.bringToFront\",\n  keyTest: (event) => {\n    return isDarwin\n      ? event[KEYS.CTRL_OR_CMD] && event.altKey && event.code === \"BracketRight\"\n      : event[KEYS.CTRL_OR_CMD] &&\n          event.shiftKey &&\n          event.code === \"BracketRight\";\n  },\n  PanelComponent: ({ updateData }) => (\n    <button\n      type=\"button\"\n      className=\"zIndexButton\"\n      onClick={(event) => updateData(null)}\n      title={`${t(\"labels.bringToFront\")}  ${\n        isDarwin\n          ? getShortcutKey(\"CtrlOrCmd+Alt+]\")\n          : getShortcutKey(\"CtrlOrCmd+Shift+]\")\n      }`}\n    >\n      {bringToFront}\n    </button>\n  ),\n});\n","import React from \"react\";\n\nexport const ButtonSelect = <T extends Object>({\n  options,\n  value,\n  onChange,\n  group,\n}: {\n  options: { value: T; text: string }[];\n  value: T | null;\n  onChange: (value: T) => void;\n  group: string;\n}) => (\n  <div className=\"buttonList\">\n    {options.map((option) => (\n      <label\n        key={option.text}\n        className={value === option.value ? \"active\" : \"\"}\n      >\n        <input\n          type=\"radio\"\n          name={group}\n          onChange={() => onChange(option.value)}\n          checked={value === option.value ? true : false}\n        />\n        {option.text}\n      </label>\n    ))}\n  </div>\n);\n","import { KEYS } from \"../keys\";\nimport { register } from \"./register\";\nimport { selectGroupsForSelectedElements } from \"../groups\";\nimport { getNonDeletedElements } from \"../element\";\n\nexport const actionSelectAll = register({\n  name: \"selectAll\",\n  perform: (elements, appState) => {\n    if (appState.editingLinearElement) {\n      return false;\n    }\n    return {\n      appState: selectGroupsForSelectedElements(\n        {\n          ...appState,\n          editingGroupId: null,\n          selectedElementIds: elements.reduce((map, element) => {\n            if (!element.isDeleted) {\n              map[element.id] = true;\n            }\n            return map;\n          }, {} as any),\n        },\n        getNonDeletedElements(elements),\n      ),\n      commitToHistory: true,\n    };\n  },\n  contextItemLabel: \"labels.selectAll\",\n  keyTest: (event) => event[KEYS.CTRL_OR_CMD] && event.key === \"a\",\n});\n","import React from \"react\";\nimport { KEYS } from \"../keys\";\nimport { register } from \"./register\";\nimport { ExcalidrawElement } from \"../element/types\";\nimport { duplicateElement, getNonDeletedElements } from \"../element\";\nimport { isSomeElementSelected } from \"../scene\";\nimport { ToolButton } from \"../components/ToolButton\";\nimport { clone } from \"../components/icons\";\nimport { t } from \"../i18n\";\nimport { getShortcutKey } from \"../utils\";\nimport { LinearElementEditor } from \"../element/linearElementEditor\";\nimport { mutateElement } from \"../element/mutateElement\";\n\nexport const actionDuplicateSelection = register({\n  name: \"duplicateSelection\",\n  perform: (elements, appState) => {\n    // duplicate point if selected while editing multi-point element\n    if (appState.editingLinearElement) {\n      const { activePointIndex, elementId } = appState.editingLinearElement;\n      const element = LinearElementEditor.getElement(elementId);\n      if (!element || activePointIndex === null) {\n        return false;\n      }\n      const { points } = element;\n      const selectedPoint = points[activePointIndex];\n      const nextPoint = points[activePointIndex + 1];\n      mutateElement(element, {\n        points: [\n          ...points.slice(0, activePointIndex + 1),\n          nextPoint\n            ? [\n                (selectedPoint[0] + nextPoint[0]) / 2,\n                (selectedPoint[1] + nextPoint[1]) / 2,\n              ]\n            : [selectedPoint[0] + 30, selectedPoint[1] + 30],\n          ...points.slice(activePointIndex + 1),\n        ],\n      });\n      return {\n        appState: {\n          ...appState,\n          editingLinearElement: {\n            ...appState.editingLinearElement,\n            activePointIndex: activePointIndex + 1,\n          },\n        },\n        elements,\n        commitToHistory: true,\n      };\n    }\n\n    const groupIdMap = new Map();\n    return {\n      appState,\n      elements: elements.reduce(\n        (acc: Array<ExcalidrawElement>, element: ExcalidrawElement) => {\n          if (appState.selectedElementIds[element.id]) {\n            const newElement = duplicateElement(\n              appState.editingGroupId,\n              groupIdMap,\n              element,\n              {\n                x: element.x + 10,\n                y: element.y + 10,\n              },\n            );\n            appState.selectedElementIds[newElement.id] = true;\n            delete appState.selectedElementIds[element.id];\n            return acc.concat([element, newElement]);\n          }\n          return acc.concat(element);\n        },\n        [],\n      ),\n      commitToHistory: true,\n    };\n  },\n  contextItemLabel: \"labels.duplicateSelection\",\n  keyTest: (event) => event[KEYS.CTRL_OR_CMD] && event.key === \"d\",\n  PanelComponent: ({ elements, appState, updateData }) => (\n    <ToolButton\n      type=\"button\"\n      icon={clone}\n      title={`${t(\"labels.duplicateSelection\")}  ${getShortcutKey(\n        \"CtrlOrCmd+D\",\n      )}`}\n      aria-label={t(\"labels.duplicateSelection\")}\n      onClick={() => updateData(null)}\n      visible={isSomeElementSelected(getNonDeletedElements(elements), appState)}\n    />\n  ),\n});\n","import React from \"react\";\nimport { Popover } from \"./Popover\";\n\nimport \"./ColorPicker.scss\";\nimport { KEYS } from \"../keys\";\nimport { t, getLanguage } from \"../i18n\";\nimport { isWritableElement } from \"../utils\";\nimport colors from \"../colors\";\n\nconst isValidColor = (color: string) => {\n  const style = new Option().style;\n  style.color = color;\n  return !!style.color;\n};\n\nconst getColor = (color: string): string | null => {\n  if (color === \"transparent\") {\n    return color;\n  }\n\n  return isValidColor(color)\n    ? color\n    : isValidColor(`#${color}`)\n    ? `#${color}`\n    : null;\n};\n\n// This is a narrow reimplementation of the awesome react-color Twitter component\n// https://github.com/casesandberg/react-color/blob/master/src/components/twitter/Twitter.js\n\n// Unfortunately, we can't detect keyboard layout in the browser. So this will\n// only work well for QWERTY but not AZERTY or others...\nconst keyBindings = [\n  [\"1\", \"2\", \"3\", \"4\", \"5\"],\n  [\"q\", \"w\", \"e\", \"r\", \"t\"],\n  [\"a\", \"s\", \"d\", \"f\", \"g\"],\n].flat();\n\nconst Picker = ({\n  colors,\n  color,\n  onChange,\n  onClose,\n  label,\n  showInput = true,\n}: {\n  colors: string[];\n  color: string | null;\n  onChange: (color: string) => void;\n  onClose: () => void;\n  label: string;\n  showInput: boolean;\n}) => {\n  const firstItem = React.useRef<HTMLButtonElement>();\n  const activeItem = React.useRef<HTMLButtonElement>();\n  const gallery = React.useRef<HTMLDivElement>();\n  const colorInput = React.useRef<HTMLInputElement>();\n\n  React.useEffect(() => {\n    // After the component is first mounted\n    // focus on first input\n    if (activeItem.current) {\n      activeItem.current.focus();\n    } else if (colorInput.current) {\n      colorInput.current.focus();\n    }\n  }, []);\n\n  const handleKeyDown = (event: React.KeyboardEvent) => {\n    if (event.key === KEYS.TAB) {\n      const { activeElement } = document;\n      if (event.shiftKey) {\n        if (activeElement === firstItem.current) {\n          colorInput.current?.focus();\n          event.preventDefault();\n        }\n      } else {\n        if (activeElement === colorInput.current) {\n          firstItem.current?.focus();\n          event.preventDefault();\n        }\n      }\n    } else if (\n      event.key === KEYS.ARROW_RIGHT ||\n      event.key === KEYS.ARROW_LEFT ||\n      event.key === KEYS.ARROW_UP ||\n      event.key === KEYS.ARROW_DOWN\n    ) {\n      const { activeElement } = document;\n      const isRTL = getLanguage().rtl;\n      const index = Array.prototype.indexOf.call(\n        gallery!.current!.children,\n        activeElement,\n      );\n      if (index !== -1) {\n        const length = gallery!.current!.children.length - (showInput ? 1 : 0);\n        const nextIndex =\n          event.key === (isRTL ? KEYS.ARROW_LEFT : KEYS.ARROW_RIGHT)\n            ? (index + 1) % length\n            : event.key === (isRTL ? KEYS.ARROW_RIGHT : KEYS.ARROW_LEFT)\n            ? (length + index - 1) % length\n            : event.key === KEYS.ARROW_DOWN\n            ? (index + 5) % length\n            : event.key === KEYS.ARROW_UP\n            ? (length + index - 5) % length\n            : index;\n        (gallery!.current!.children![nextIndex] as any).focus();\n      }\n      event.preventDefault();\n    } else if (\n      keyBindings.includes(event.key.toLowerCase()) &&\n      !isWritableElement(event.target)\n    ) {\n      const index = keyBindings.indexOf(event.key.toLowerCase());\n      (gallery!.current!.children![index] as any).focus();\n      event.preventDefault();\n    } else if (event.key === KEYS.ESCAPE || event.key === KEYS.ENTER) {\n      event.preventDefault();\n      onClose();\n    }\n    event.nativeEvent.stopImmediatePropagation();\n  };\n\n  return (\n    <div\n      className=\"color-picker\"\n      role=\"dialog\"\n      aria-modal=\"true\"\n      aria-label={t(\"labels.colorPicker\")}\n      onKeyDown={handleKeyDown}\n    >\n      <div className=\"color-picker-triangle color-picker-triangle-shadow\"></div>\n      <div className=\"color-picker-triangle\"></div>\n      <div\n        className=\"color-picker-content\"\n        ref={(el) => {\n          if (el) {\n            gallery.current = el;\n          }\n        }}\n      >\n        {colors.map((_color, i) => (\n          <button\n            className=\"color-picker-swatch\"\n            onClick={(event) => {\n              (event.currentTarget as HTMLButtonElement).focus();\n              onChange(_color);\n            }}\n            title={`${_color}  ${keyBindings[i].toUpperCase()}`}\n            aria-label={_color}\n            aria-keyshortcuts={keyBindings[i]}\n            style={{ color: _color }}\n            key={_color}\n            ref={(el) => {\n              if (el && i === 0) {\n                firstItem.current = el;\n              }\n              if (el && _color === color) {\n                activeItem.current = el;\n              }\n            }}\n            onFocus={() => {\n              onChange(_color);\n            }}\n          >\n            {_color === \"transparent\" ? (\n              <div className=\"color-picker-transparent\"></div>\n            ) : undefined}\n            <span className=\"color-picker-keybinding\">{keyBindings[i]}</span>\n          </button>\n        ))}\n        {showInput && (\n          <ColorInput\n            color={color}\n            label={label}\n            onChange={(color) => {\n              onChange(color);\n            }}\n            ref={colorInput}\n          />\n        )}\n      </div>\n    </div>\n  );\n};\n\nconst ColorInput = React.forwardRef(\n  (\n    {\n      color,\n      onChange,\n      label,\n    }: {\n      color: string | null;\n      onChange: (color: string) => void;\n      label: string;\n    },\n    ref,\n  ) => {\n    const [innerValue, setInnerValue] = React.useState(color);\n    const inputRef = React.useRef(null);\n\n    React.useEffect(() => {\n      setInnerValue(color);\n    }, [color]);\n\n    React.useImperativeHandle(ref, () => inputRef.current);\n\n    const changeColor = React.useCallback(\n      (inputValue: string) => {\n        const value = inputValue.toLowerCase();\n        const color = getColor(value);\n        if (color) {\n          onChange(color);\n        }\n        setInnerValue(value);\n      },\n      [onChange],\n    );\n\n    return (\n      <label className=\"color-input-container\">\n        <div className=\"color-picker-hash\">#</div>\n        <input\n          spellCheck={false}\n          className=\"color-picker-input\"\n          aria-label={label}\n          onChange={(event) => changeColor(event.target.value)}\n          value={(innerValue || \"\").replace(/^#/, \"\")}\n          onBlur={() => setInnerValue(color)}\n          ref={inputRef}\n        />\n      </label>\n    );\n  },\n);\n\nexport const ColorPicker = ({\n  type,\n  color,\n  onChange,\n  label,\n}: {\n  type: \"canvasBackground\" | \"elementBackground\" | \"elementStroke\";\n  color: string | null;\n  onChange: (color: string) => void;\n  label: string;\n}) => {\n  const [isActive, setActive] = React.useState(false);\n  const pickerButton = React.useRef<HTMLButtonElement>(null);\n\n  return (\n    <div>\n      <div className=\"color-picker-control-container\">\n        <button\n          className=\"color-picker-label-swatch\"\n          aria-label={label}\n          style={\n            color\n              ? ({ \"--swatch-color\": color } as React.CSSProperties)\n              : undefined\n          }\n          onClick={() => setActive(!isActive)}\n          ref={pickerButton}\n        />\n        <ColorInput\n          color={color}\n          label={label}\n          onChange={(color) => {\n            onChange(color);\n          }}\n        />\n      </div>\n      <React.Suspense fallback=\"\">\n        {isActive ? (\n          <Popover\n            onCloseRequest={(event) =>\n              event.target !== pickerButton.current && setActive(false)\n            }\n          >\n            <Picker\n              colors={colors[type]}\n              color={color || null}\n              onChange={(changedColor) => {\n                onChange(changedColor);\n              }}\n              onClose={() => {\n                setActive(false);\n                pickerButton.current?.focus();\n              }}\n              label={label}\n              showInput={false}\n            />\n          </Popover>\n        ) : null}\n      </React.Suspense>\n    </div>\n  );\n};\n","import React from \"react\";\nimport {\n  ExcalidrawElement,\n  ExcalidrawTextElement,\n  TextAlign,\n  FontFamily,\n} from \"../element/types\";\nimport {\n  getCommonAttributeOfSelectedElements,\n  isSomeElementSelected,\n} from \"../scene\";\nimport { ButtonSelect } from \"../components/ButtonSelect\";\nimport {\n  isTextElement,\n  redrawTextBoundingBox,\n  getNonDeletedElements,\n} from \"../element\";\nimport { ColorPicker } from \"../components/ColorPicker\";\nimport { AppState } from \"../../src/types\";\nimport { t } from \"../i18n\";\nimport { register } from \"./register\";\nimport { newElementWith } from \"../element/mutateElement\";\nimport { DEFAULT_FONT_SIZE, DEFAULT_FONT_FAMILY } from \"../constants\";\n\nconst changeProperty = (\n  elements: readonly ExcalidrawElement[],\n  appState: AppState,\n  callback: (element: ExcalidrawElement) => ExcalidrawElement,\n) => {\n  return elements.map((element) => {\n    if (\n      appState.selectedElementIds[element.id] ||\n      element.id === appState.editingElement?.id\n    ) {\n      return callback(element);\n    }\n    return element;\n  });\n};\n\nconst getFormValue = function <T>(\n  elements: readonly ExcalidrawElement[],\n  appState: AppState,\n  getAttribute: (element: ExcalidrawElement) => T,\n  defaultValue?: T,\n): T | null {\n  const editingElement = appState.editingElement;\n  const nonDeletedElements = getNonDeletedElements(elements);\n  return (\n    (editingElement && getAttribute(editingElement)) ??\n    (isSomeElementSelected(nonDeletedElements, appState)\n      ? getCommonAttributeOfSelectedElements(\n          nonDeletedElements,\n          appState,\n          getAttribute,\n        )\n      : defaultValue) ??\n    null\n  );\n};\n\nexport const actionChangeStrokeColor = register({\n  name: \"changeStrokeColor\",\n  perform: (elements, appState, value) => {\n    return {\n      elements: changeProperty(elements, appState, (el) =>\n        newElementWith(el, {\n          strokeColor: value,\n        }),\n      ),\n      appState: { ...appState, currentItemStrokeColor: value },\n      commitToHistory: true,\n    };\n  },\n  PanelComponent: ({ elements, appState, updateData }) => (\n    <>\n      <h3 aria-hidden=\"true\">{t(\"labels.stroke\")}</h3>\n      <ColorPicker\n        type=\"elementStroke\"\n        label={t(\"labels.stroke\")}\n        color={getFormValue(\n          elements,\n          appState,\n          (element) => element.strokeColor,\n          appState.currentItemStrokeColor,\n        )}\n        onChange={updateData}\n      />\n    </>\n  ),\n});\n\nexport const actionChangeBackgroundColor = register({\n  name: \"changeBackgroundColor\",\n  perform: (elements, appState, value) => {\n    return {\n      elements: changeProperty(elements, appState, (el) =>\n        newElementWith(el, {\n          backgroundColor: value,\n        }),\n      ),\n      appState: { ...appState, currentItemBackgroundColor: value },\n      commitToHistory: true,\n    };\n  },\n  PanelComponent: ({ elements, appState, updateData }) => (\n    <>\n      <h3 aria-hidden=\"true\">{t(\"labels.background\")}</h3>\n      <ColorPicker\n        type=\"elementBackground\"\n        label={t(\"labels.background\")}\n        color={getFormValue(\n          elements,\n          appState,\n          (element) => element.backgroundColor,\n          appState.currentItemBackgroundColor,\n        )}\n        onChange={updateData}\n      />\n    </>\n  ),\n});\n\nexport const actionChangeFillStyle = register({\n  name: \"changeFillStyle\",\n  perform: (elements, appState, value) => {\n    return {\n      elements: changeProperty(elements, appState, (el) =>\n        newElementWith(el, {\n          fillStyle: value,\n        }),\n      ),\n      appState: { ...appState, currentItemFillStyle: value },\n      commitToHistory: true,\n    };\n  },\n  PanelComponent: ({ elements, appState, updateData }) => (\n    <fieldset>\n      <legend>{t(\"labels.fill\")}</legend>\n      <ButtonSelect\n        options={[\n          { value: \"hachure\", text: t(\"labels.hachure\") },\n          { value: \"cross-hatch\", text: t(\"labels.crossHatch\") },\n          { value: \"solid\", text: t(\"labels.solid\") },\n        ]}\n        group=\"fill\"\n        value={getFormValue(\n          elements,\n          appState,\n          (element) => element.fillStyle,\n          appState.currentItemFillStyle,\n        )}\n        onChange={(value) => {\n          updateData(value);\n        }}\n      />\n    </fieldset>\n  ),\n});\n\nexport const actionChangeStrokeWidth = register({\n  name: \"changeStrokeWidth\",\n  perform: (elements, appState, value) => {\n    return {\n      elements: changeProperty(elements, appState, (el) =>\n        newElementWith(el, {\n          strokeWidth: value,\n        }),\n      ),\n      appState: { ...appState, currentItemStrokeWidth: value },\n      commitToHistory: true,\n    };\n  },\n  PanelComponent: ({ elements, appState, updateData }) => (\n    <fieldset>\n      <legend>{t(\"labels.strokeWidth\")}</legend>\n      <ButtonSelect\n        group=\"stroke-width\"\n        options={[\n          { value: 1, text: t(\"labels.thin\") },\n          { value: 2, text: t(\"labels.bold\") },\n          { value: 4, text: t(\"labels.extraBold\") },\n        ]}\n        value={getFormValue(\n          elements,\n          appState,\n          (element) => element.strokeWidth,\n          appState.currentItemStrokeWidth,\n        )}\n        onChange={(value) => updateData(value)}\n      />\n    </fieldset>\n  ),\n});\n\nexport const actionChangeSloppiness = register({\n  name: \"changeSloppiness\",\n  perform: (elements, appState, value) => {\n    return {\n      elements: changeProperty(elements, appState, (el) =>\n        newElementWith(el, {\n          roughness: value,\n        }),\n      ),\n      appState: { ...appState, currentItemRoughness: value },\n      commitToHistory: true,\n    };\n  },\n  PanelComponent: ({ elements, appState, updateData }) => (\n    <fieldset>\n      <legend>{t(\"labels.sloppiness\")}</legend>\n      <ButtonSelect\n        group=\"sloppiness\"\n        options={[\n          { value: 0, text: t(\"labels.architect\") },\n          { value: 1, text: t(\"labels.artist\") },\n          { value: 2, text: t(\"labels.cartoonist\") },\n        ]}\n        value={getFormValue(\n          elements,\n          appState,\n          (element) => element.roughness,\n          appState.currentItemRoughness,\n        )}\n        onChange={(value) => updateData(value)}\n      />\n    </fieldset>\n  ),\n});\n\nexport const actionChangeStrokeStyle = register({\n  name: \"changeStrokeStyle\",\n  perform: (elements, appState, value) => {\n    return {\n      elements: changeProperty(elements, appState, (el) =>\n        newElementWith(el, {\n          strokeStyle: value,\n        }),\n      ),\n      appState: { ...appState, currentItemStrokeStyle: value },\n      commitToHistory: true,\n    };\n  },\n  PanelComponent: ({ elements, appState, updateData }) => (\n    <fieldset>\n      <legend>{t(\"labels.strokeStyle\")}</legend>\n      <ButtonSelect\n        group=\"strokeStyle\"\n        options={[\n          { value: \"solid\", text: t(\"labels.strokeStyle_solid\") },\n          { value: \"dashed\", text: t(\"labels.strokeStyle_dashed\") },\n          { value: \"dotted\", text: t(\"labels.strokeStyle_dotted\") },\n        ]}\n        value={getFormValue(\n          elements,\n          appState,\n          (element) => element.strokeStyle,\n          appState.currentItemStrokeStyle,\n        )}\n        onChange={(value) => updateData(value)}\n      />\n    </fieldset>\n  ),\n});\n\nexport const actionChangeOpacity = register({\n  name: \"changeOpacity\",\n  perform: (elements, appState, value) => {\n    return {\n      elements: changeProperty(elements, appState, (el) =>\n        newElementWith(el, {\n          opacity: value,\n        }),\n      ),\n      appState: { ...appState, currentItemOpacity: value },\n      commitToHistory: true,\n    };\n  },\n  PanelComponent: ({ elements, appState, updateData }) => (\n    <label className=\"control-label\">\n      {t(\"labels.opacity\")}\n      <input\n        type=\"range\"\n        min=\"0\"\n        max=\"100\"\n        step=\"10\"\n        onChange={(event) => updateData(+event.target.value)}\n        onWheel={(event) => {\n          event.stopPropagation();\n          const target = event.target as HTMLInputElement;\n          const STEP = 10;\n          const MAX = 100;\n          const MIN = 0;\n          const value = +target.value;\n\n          if (event.deltaY < 0 && value < MAX) {\n            updateData(value + STEP);\n          } else if (event.deltaY > 0 && value > MIN) {\n            updateData(value - STEP);\n          }\n        }}\n        value={\n          getFormValue(\n            elements,\n            appState,\n            (element) => element.opacity,\n            appState.currentItemOpacity,\n          ) ?? undefined\n        }\n      />\n    </label>\n  ),\n});\n\nexport const actionChangeFontSize = register({\n  name: \"changeFontSize\",\n  perform: (elements, appState, value) => {\n    return {\n      elements: changeProperty(elements, appState, (el) => {\n        if (isTextElement(el)) {\n          const element: ExcalidrawTextElement = newElementWith(el, {\n            fontSize: value,\n          });\n          redrawTextBoundingBox(element);\n          return element;\n        }\n\n        return el;\n      }),\n      appState: {\n        ...appState,\n        currentItemFontSize: value,\n      },\n      commitToHistory: true,\n    };\n  },\n  PanelComponent: ({ elements, appState, updateData }) => (\n    <fieldset>\n      <legend>{t(\"labels.fontSize\")}</legend>\n      <ButtonSelect\n        group=\"font-size\"\n        options={[\n          { value: 16, text: t(\"labels.small\") },\n          { value: 20, text: t(\"labels.medium\") },\n          { value: 28, text: t(\"labels.large\") },\n          { value: 36, text: t(\"labels.veryLarge\") },\n        ]}\n        value={getFormValue(\n          elements,\n          appState,\n          (element) => isTextElement(element) && element.fontSize,\n          appState.currentItemFontSize || DEFAULT_FONT_SIZE,\n        )}\n        onChange={(value) => updateData(value)}\n      />\n    </fieldset>\n  ),\n});\n\nexport const actionChangeFontFamily = register({\n  name: \"changeFontFamily\",\n  perform: (elements, appState, value) => {\n    return {\n      elements: changeProperty(elements, appState, (el) => {\n        if (isTextElement(el)) {\n          const element: ExcalidrawTextElement = newElementWith(el, {\n            fontFamily: value,\n          });\n          redrawTextBoundingBox(element);\n          return element;\n        }\n\n        return el;\n      }),\n      appState: {\n        ...appState,\n        currentItemFontFamily: value,\n      },\n      commitToHistory: true,\n    };\n  },\n  PanelComponent: ({ elements, appState, updateData }) => {\n    const options: { value: FontFamily; text: string }[] = [\n      { value: 1, text: t(\"labels.handDrawn\") },\n      { value: 2, text: t(\"labels.normal\") },\n      { value: 3, text: t(\"labels.code\") },\n    ];\n\n    return (\n      <fieldset>\n        <legend>{t(\"labels.fontFamily\")}</legend>\n        <ButtonSelect<FontFamily | false>\n          group=\"font-family\"\n          options={options}\n          value={getFormValue(\n            elements,\n            appState,\n            (element) => isTextElement(element) && element.fontFamily,\n            appState.currentItemFontFamily || DEFAULT_FONT_FAMILY,\n          )}\n          onChange={(value) => updateData(value)}\n        />\n      </fieldset>\n    );\n  },\n});\n\nexport const actionChangeTextAlign = register({\n  name: \"changeTextAlign\",\n  perform: (elements, appState, value) => {\n    return {\n      elements: changeProperty(elements, appState, (el) => {\n        if (isTextElement(el)) {\n          const element: ExcalidrawTextElement = newElementWith(el, {\n            textAlign: value,\n          });\n          redrawTextBoundingBox(element);\n          return element;\n        }\n\n        return el;\n      }),\n      appState: {\n        ...appState,\n        currentItemTextAlign: value,\n      },\n      commitToHistory: true,\n    };\n  },\n  PanelComponent: ({ elements, appState, updateData }) => (\n    <fieldset>\n      <legend>{t(\"labels.textAlign\")}</legend>\n      <ButtonSelect<TextAlign | false>\n        group=\"text-align\"\n        options={[\n          { value: \"left\", text: t(\"labels.left\") },\n          { value: \"center\", text: t(\"labels.center\") },\n          { value: \"right\", text: t(\"labels.right\") },\n        ]}\n        value={getFormValue(\n          elements,\n          appState,\n          (element) => isTextElement(element) && element.textAlign,\n          appState.currentItemTextAlign,\n        )}\n        onChange={(value) => updateData(value)}\n      />\n    </fieldset>\n  ),\n});\n","import React from \"react\";\nimport { ColorPicker } from \"../components/ColorPicker\";\nimport { getDefaultAppState } from \"../appState\";\nimport { trash, zoomIn, zoomOut, resetZoom } from \"../components/icons\";\nimport { ToolButton } from \"../components/ToolButton\";\nimport { t } from \"../i18n\";\nimport { getNormalizedZoom, normalizeScroll } from \"../scene\";\nimport { KEYS } from \"../keys\";\nimport { getShortcutKey } from \"../utils\";\nimport useIsMobile from \"../is-mobile\";\nimport { register } from \"./register\";\nimport { newElementWith } from \"../element/mutateElement\";\nimport { AppState, FlooredNumber } from \"../types\";\nimport { getCommonBounds } from \"../element\";\n\nexport const actionChangeViewBackgroundColor = register({\n  name: \"changeViewBackgroundColor\",\n  perform: (_, appState, value) => {\n    return {\n      appState: { ...appState, viewBackgroundColor: value },\n      commitToHistory: true,\n    };\n  },\n  PanelComponent: ({ appState, updateData }) => {\n    return (\n      <div style={{ position: \"relative\" }}>\n        <ColorPicker\n          label={t(\"labels.canvasBackground\")}\n          type=\"canvasBackground\"\n          color={appState.viewBackgroundColor}\n          onChange={(color) => updateData(color)}\n        />\n      </div>\n    );\n  },\n});\n\nexport const actionClearCanvas = register({\n  name: \"clearCanvas\",\n  perform: (elements, appState: AppState) => {\n    return {\n      elements: elements.map((element) =>\n        newElementWith(element, { isDeleted: true }),\n      ),\n      appState: {\n        ...getDefaultAppState(),\n        username: appState.username,\n      },\n      commitToHistory: true,\n    };\n  },\n  PanelComponent: ({ updateData }) => (\n    <ToolButton\n      type=\"button\"\n      icon={trash}\n      title={t(\"buttons.clearReset\")}\n      aria-label={t(\"buttons.clearReset\")}\n      showAriaLabel={useIsMobile()}\n      onClick={() => {\n        if (window.confirm(t(\"alerts.clearReset\"))) {\n          // TODO: Make this part of `AppState`.\n          (window as any).handle = null;\n          updateData(null);\n        }\n      }}\n    />\n  ),\n});\n\nconst ZOOM_STEP = 0.1;\n\nconst KEY_CODES = {\n  MINUS: \"Minus\",\n  EQUAL: \"Equal\",\n  ONE: \"Digit1\",\n  ZERO: \"Digit0\",\n  NUM_SUBTRACT: \"NumpadSubtract\",\n  NUM_ADD: \"NumpadAdd\",\n  NUM_ZERO: \"Numpad0\",\n};\n\nexport const actionZoomIn = register({\n  name: \"zoomIn\",\n  perform: (_elements, appState) => {\n    return {\n      appState: {\n        ...appState,\n        zoom: getNormalizedZoom(appState.zoom + ZOOM_STEP),\n      },\n      commitToHistory: false,\n    };\n  },\n  PanelComponent: ({ updateData }) => (\n    <ToolButton\n      type=\"button\"\n      icon={zoomIn}\n      title={`${t(\"buttons.zoomIn\")}  ${getShortcutKey(\"CtrlOrCmd++\")}`}\n      aria-label={t(\"buttons.zoomIn\")}\n      onClick={() => {\n        updateData(null);\n      }}\n    />\n  ),\n  keyTest: (event) =>\n    (event.code === KEY_CODES.EQUAL || event.code === KEY_CODES.NUM_ADD) &&\n    (event[KEYS.CTRL_OR_CMD] || event.shiftKey),\n});\n\nexport const actionZoomOut = register({\n  name: \"zoomOut\",\n  perform: (_elements, appState) => {\n    return {\n      appState: {\n        ...appState,\n        zoom: getNormalizedZoom(appState.zoom - ZOOM_STEP),\n      },\n      commitToHistory: false,\n    };\n  },\n  PanelComponent: ({ updateData }) => (\n    <ToolButton\n      type=\"button\"\n      icon={zoomOut}\n      title={`${t(\"buttons.zoomOut\")}  ${getShortcutKey(\"CtrlOrCmd+-\")}`}\n      aria-label={t(\"buttons.zoomOut\")}\n      onClick={() => {\n        updateData(null);\n      }}\n    />\n  ),\n  keyTest: (event) =>\n    (event.code === KEY_CODES.MINUS || event.code === KEY_CODES.NUM_SUBTRACT) &&\n    (event[KEYS.CTRL_OR_CMD] || event.shiftKey),\n});\n\nexport const actionResetZoom = register({\n  name: \"resetZoom\",\n  perform: (_elements, appState) => {\n    return {\n      appState: {\n        ...appState,\n        zoom: 1,\n      },\n      commitToHistory: false,\n    };\n  },\n  PanelComponent: ({ updateData }) => (\n    <ToolButton\n      type=\"button\"\n      icon={resetZoom}\n      title={t(\"buttons.resetZoom\")}\n      aria-label={t(\"buttons.resetZoom\")}\n      onClick={() => {\n        updateData(null);\n      }}\n    />\n  ),\n  keyTest: (event) =>\n    (event.code === KEY_CODES.ZERO || event.code === KEY_CODES.NUM_ZERO) &&\n    (event[KEYS.CTRL_OR_CMD] || event.shiftKey),\n});\n\nconst calculateZoom = (\n  commonBounds: number[],\n  currentZoom: number,\n  {\n    scrollX,\n    scrollY,\n  }: {\n    scrollX: FlooredNumber;\n    scrollY: FlooredNumber;\n  },\n): number => {\n  const { innerWidth, innerHeight } = window;\n  const [x, y] = commonBounds;\n  const zoomX = -innerWidth / (2 * scrollX + 2 * x - innerWidth);\n  const zoomY = -innerHeight / (2 * scrollY + 2 * y - innerHeight);\n  const margin = 0.01;\n  let newZoom;\n\n  if (zoomX < zoomY) {\n    newZoom = zoomX - margin;\n  } else if (zoomY <= zoomX) {\n    newZoom = zoomY - margin;\n  } else {\n    newZoom = currentZoom;\n  }\n\n  if (newZoom <= 0.1) {\n    return 0.1;\n  }\n  if (newZoom >= 1) {\n    return 1;\n  }\n\n  return newZoom;\n};\n\nexport const actionZoomToFit = register({\n  name: \"zoomToFit\",\n  perform: (elements, appState) => {\n    const nonDeletedElements = elements.filter((element) => !element.isDeleted);\n    const commonBounds = getCommonBounds(nonDeletedElements);\n    const [x1, y1, x2, y2] = commonBounds;\n    const centerX = (x1 + x2) / 2;\n    const centerY = (y1 + y2) / 2;\n    const scrollX = normalizeScroll(appState.width / 2 - centerX);\n    const scrollY = normalizeScroll(appState.height / 2 - centerY);\n    const zoom = calculateZoom(commonBounds, appState.zoom, {\n      scrollX,\n      scrollY,\n    });\n\n    return {\n      appState: {\n        ...appState,\n        scrollX,\n        scrollY,\n        zoom,\n      },\n      commitToHistory: false,\n    };\n  },\n  keyTest: (event) =>\n    event.code === KEY_CODES.ONE &&\n    event.shiftKey &&\n    !event.altKey &&\n    !event[KEYS.CTRL_OR_CMD],\n});\n","import { KEYS } from \"../keys\";\nimport { isInvisiblySmallElement } from \"../element\";\nimport { resetCursor } from \"../utils\";\nimport React from \"react\";\nimport { ToolButton } from \"../components/ToolButton\";\nimport { done } from \"../components/icons\";\nimport { t } from \"../i18n\";\nimport { register } from \"./register\";\nimport { mutateElement } from \"../element/mutateElement\";\nimport { isPathALoop } from \"../math\";\nimport { LinearElementEditor } from \"../element/linearElementEditor\";\n\nexport const actionFinalize = register({\n  name: \"finalize\",\n  perform: (elements, appState) => {\n    if (appState.editingLinearElement) {\n      const { elementId } = appState.editingLinearElement;\n      const element = LinearElementEditor.getElement(elementId);\n\n      if (element) {\n        return {\n          elements:\n            element.points.length < 2 || isInvisiblySmallElement(element)\n              ? elements.filter((el) => el.id !== element.id)\n              : undefined,\n          appState: {\n            ...appState,\n            editingLinearElement: null,\n          },\n          commitToHistory: true,\n        };\n      }\n    }\n\n    let newElements = elements;\n    if (window.document.activeElement instanceof HTMLElement) {\n      window.document.activeElement.blur();\n    }\n\n    const multiPointElement = appState.multiElement\n      ? appState.multiElement\n      : appState.editingElement?.type === \"draw\"\n      ? appState.editingElement\n      : null;\n\n    if (multiPointElement) {\n      // pen and mouse have hover\n      if (\n        multiPointElement.type !== \"draw\" &&\n        appState.lastPointerDownWith !== \"touch\"\n      ) {\n        const { points, lastCommittedPoint } = multiPointElement;\n        if (\n          !lastCommittedPoint ||\n          points[points.length - 1] !== lastCommittedPoint\n        ) {\n          mutateElement(multiPointElement, {\n            points: multiPointElement.points.slice(0, -1),\n          });\n        }\n      }\n      if (isInvisiblySmallElement(multiPointElement)) {\n        newElements = newElements.slice(0, -1);\n      }\n\n      // If the multi point line closes the loop,\n      // set the last point to first point.\n      // This ensures that loop remains closed at different scales.\n      if (\n        multiPointElement.type === \"line\" ||\n        multiPointElement.type === \"draw\"\n      ) {\n        if (isPathALoop(multiPointElement.points)) {\n          const linePoints = multiPointElement.points;\n          const firstPoint = linePoints[0];\n          mutateElement(multiPointElement, {\n            points: linePoints.map((point, i) =>\n              i === linePoints.length - 1\n                ? ([firstPoint[0], firstPoint[1]] as const)\n                : point,\n            ),\n          });\n        }\n      }\n\n      if (!appState.elementLocked) {\n        appState.selectedElementIds[multiPointElement.id] = true;\n      }\n    }\n    if (!appState.elementLocked || !multiPointElement) {\n      resetCursor();\n    }\n    return {\n      elements: newElements,\n      appState: {\n        ...appState,\n        elementType:\n          appState.elementLocked && multiPointElement\n            ? appState.elementType\n            : \"selection\",\n        draggingElement: null,\n        multiElement: null,\n        editingElement: null,\n        selectedElementIds:\n          multiPointElement && !appState.elementLocked\n            ? {\n                ...appState.selectedElementIds,\n                [multiPointElement.id]: true,\n              }\n            : appState.selectedElementIds,\n      },\n      commitToHistory: appState.elementType === \"draw\",\n    };\n  },\n  keyTest: (event, appState) =>\n    (event.key === KEYS.ESCAPE &&\n      (appState.editingLinearElement !== null ||\n        (!appState.draggingElement && appState.multiElement === null))) ||\n    ((event.key === KEYS.ESCAPE || event.key === KEYS.ENTER) &&\n      appState.multiElement !== null),\n  PanelComponent: ({ appState, updateData }) => (\n    <ToolButton\n      type=\"button\"\n      icon={done}\n      title={t(\"buttons.done\")}\n      aria-label={t(\"buttons.done\")}\n      onClick={updateData}\n      visible={appState.multiElement != null}\n    />\n  ),\n});\n","import \"./TextInput.scss\";\n\nimport React, { Component } from \"react\";\nimport { selectNode, removeSelection } from \"../utils\";\n\ntype Props = {\n  value: string;\n  onChange: (value: string) => void;\n  label: string;\n};\n\nexport class ProjectName extends Component<Props> {\n  private handleFocus = (event: React.FocusEvent<HTMLElement>) => {\n    selectNode(event.currentTarget);\n  };\n\n  private handleBlur = (event: React.FocusEvent<HTMLElement>) => {\n    const value = event.currentTarget.innerText.trim();\n    if (value !== this.props.value) {\n      this.props.onChange(value);\n    }\n    removeSelection();\n  };\n\n  private handleKeyDown = (event: React.KeyboardEvent<HTMLElement>) => {\n    if (event.key === \"Enter\") {\n      event.preventDefault();\n      if (event.nativeEvent.isComposing || event.keyCode === 229) {\n        return;\n      }\n      event.currentTarget.blur();\n    }\n  };\n  private makeEditable = (editable: HTMLSpanElement | null) => {\n    if (!editable) {\n      return;\n    }\n    try {\n      editable.contentEditable = \"plaintext-only\";\n    } catch {\n      editable.contentEditable = \"true\";\n    }\n  };\n\n  public render() {\n    return (\n      <span\n        suppressContentEditableWarning\n        ref={this.makeEditable}\n        data-type=\"wysiwyg\"\n        className=\"TextInput\"\n        role=\"textbox\"\n        aria-label={this.props.label}\n        onBlur={this.handleBlur}\n        onKeyDown={this.handleKeyDown}\n        onFocus={this.handleFocus}\n      >\n        {this.props.value}\n      </span>\n    );\n  }\n}\n","import React from \"react\";\nimport { ProjectName } from \"../components/ProjectName\";\nimport { saveAsJSON, loadFromJSON } from \"../data\";\nimport { load, save, saveAs } from \"../components/icons\";\nimport { ToolButton } from \"../components/ToolButton\";\nimport { t } from \"../i18n\";\nimport useIsMobile from \"../is-mobile\";\nimport { register } from \"./register\";\nimport { KEYS } from \"../keys\";\n\nexport const actionChangeProjectName = register({\n  name: \"changeProjectName\",\n  perform: (_elements, appState, value) => {\n    return { appState: { ...appState, name: value }, commitToHistory: false };\n  },\n  PanelComponent: ({ appState, updateData }) => (\n    <ProjectName\n      label={t(\"labels.fileTitle\")}\n      value={appState.name || \"Unnamed\"}\n      onChange={(name: string) => updateData(name)}\n    />\n  ),\n});\n\nexport const actionChangeExportBackground = register({\n  name: \"changeExportBackground\",\n  perform: (_elements, appState, value) => {\n    return {\n      appState: { ...appState, exportBackground: value },\n      commitToHistory: false,\n    };\n  },\n  PanelComponent: ({ appState, updateData }) => (\n    <label>\n      <input\n        type=\"checkbox\"\n        checked={appState.exportBackground}\n        onChange={(event) => updateData(event.target.checked)}\n      />{\" \"}\n      {t(\"labels.withBackground\")}\n    </label>\n  ),\n});\n\nexport const actionChangeShouldAddWatermark = register({\n  name: \"changeShouldAddWatermark\",\n  perform: (_elements, appState, value) => {\n    return {\n      appState: { ...appState, shouldAddWatermark: value },\n      commitToHistory: false,\n    };\n  },\n  PanelComponent: ({ appState, updateData }) => (\n    <label>\n      <input\n        type=\"checkbox\"\n        checked={appState.shouldAddWatermark}\n        onChange={(event) => updateData(event.target.checked)}\n      />{\" \"}\n      {t(\"labels.addWatermark\")}\n    </label>\n  ),\n});\n\nexport const actionSaveScene = register({\n  name: \"saveScene\",\n  perform: (elements, appState, value) => {\n    saveAsJSON(elements, appState, (window as any).handle).catch((error) =>\n      console.error(error),\n    );\n    return { commitToHistory: false };\n  },\n  keyTest: (event) => {\n    return event.key === \"s\" && event[KEYS.CTRL_OR_CMD] && !event.shiftKey;\n  },\n  PanelComponent: ({ updateData }) => (\n    <ToolButton\n      type=\"button\"\n      icon={save}\n      title={t(\"buttons.save\")}\n      aria-label={t(\"buttons.save\")}\n      showAriaLabel={useIsMobile()}\n      onClick={() => updateData(null)}\n    />\n  ),\n});\n\nexport const actionSaveAsScene = register({\n  name: \"saveAsScene\",\n  perform: (elements, appState, value) => {\n    saveAsJSON(elements, appState, null).catch((error) => console.error(error));\n    return { commitToHistory: false };\n  },\n  keyTest: (event) => {\n    return event.key === \"s\" && event.shiftKey && event[KEYS.CTRL_OR_CMD];\n  },\n  PanelComponent: ({ updateData }) => (\n    <ToolButton\n      type=\"button\"\n      icon={saveAs}\n      title={t(\"buttons.saveAs\")}\n      aria-label={t(\"buttons.saveAs\")}\n      showAriaLabel={useIsMobile()}\n      hidden={!(\"chooseFileSystemEntries\" in window)}\n      onClick={() => updateData(null)}\n    />\n  ),\n});\n\nexport const actionLoadScene = register({\n  name: \"loadScene\",\n  perform: (\n    elements,\n    appState,\n    { elements: loadedElements, appState: loadedAppState, error },\n  ) => {\n    return {\n      elements: loadedElements,\n      appState: {\n        ...loadedAppState,\n        errorMessage: error,\n      },\n      commitToHistory: false,\n    };\n  },\n  PanelComponent: ({ updateData }) => (\n    <ToolButton\n      type=\"button\"\n      icon={load}\n      title={t(\"buttons.load\")}\n      aria-label={t(\"buttons.load\")}\n      showAriaLabel={useIsMobile()}\n      onClick={() => {\n        loadFromJSON()\n          .then(({ elements, appState }) => {\n            updateData({ elements: elements, appState: appState });\n          })\n          .catch((error) => {\n            // if user cancels, ignore the error\n            if (error.name === \"AbortError\") {\n              return;\n            }\n            updateData({ error: error.message });\n          });\n      }}\n    />\n  ),\n});\n","import {\n  isTextElement,\n  isExcalidrawElement,\n  redrawTextBoundingBox,\n} from \"../element\";\nimport { KEYS } from \"../keys\";\nimport { register } from \"./register\";\nimport { mutateElement, newElementWith } from \"../element/mutateElement\";\nimport {\n  DEFAULT_FONT_SIZE,\n  DEFAULT_FONT_FAMILY,\n  DEFAULT_TEXT_ALIGN,\n} from \"../constants\";\n\nlet copiedStyles: string = \"{}\";\n\nexport const actionCopyStyles = register({\n  name: \"copyStyles\",\n  perform: (elements, appState) => {\n    const element = elements.find((el) => appState.selectedElementIds[el.id]);\n    if (element) {\n      copiedStyles = JSON.stringify(element);\n    }\n    return {\n      commitToHistory: false,\n    };\n  },\n  contextItemLabel: \"labels.copyStyles\",\n  keyTest: (event) =>\n    event[KEYS.CTRL_OR_CMD] &&\n    event.altKey &&\n    event.keyCode === KEYS.C_KEY_CODE,\n  contextMenuOrder: 0,\n});\n\nexport const actionPasteStyles = register({\n  name: \"pasteStyles\",\n  perform: (elements, appState) => {\n    const pastedElement = JSON.parse(copiedStyles);\n    if (!isExcalidrawElement(pastedElement)) {\n      return { elements, commitToHistory: false };\n    }\n    return {\n      elements: elements.map((element) => {\n        if (appState.selectedElementIds[element.id]) {\n          const newElement = newElementWith(element, {\n            backgroundColor: pastedElement?.backgroundColor,\n            strokeWidth: pastedElement?.strokeWidth,\n            strokeColor: pastedElement?.strokeColor,\n            strokeStyle: pastedElement?.strokeStyle,\n            fillStyle: pastedElement?.fillStyle,\n            opacity: pastedElement?.opacity,\n            roughness: pastedElement?.roughness,\n          });\n          if (isTextElement(newElement)) {\n            mutateElement(newElement, {\n              fontSize: pastedElement?.fontSize || DEFAULT_FONT_SIZE,\n              fontFamily: pastedElement?.fontFamily || DEFAULT_FONT_FAMILY,\n              textAlign: pastedElement?.textAlign || DEFAULT_TEXT_ALIGN,\n            });\n            redrawTextBoundingBox(newElement);\n          }\n          return newElement;\n        }\n        return element;\n      }),\n      commitToHistory: true,\n    };\n  },\n  contextItemLabel: \"labels.pasteStyles\",\n  keyTest: (event) =>\n    event[KEYS.CTRL_OR_CMD] &&\n    event.altKey &&\n    event.keyCode === KEYS.V_KEY_CODE,\n  contextMenuOrder: 1,\n});\n","import React from \"react\";\n\ntype HelpIconProps = {\n  title?: string;\n  name?: string;\n  id?: string;\n  onClick?(): void;\n};\n\nconst ICON = (\n  <svg\n    width=\"30\"\n    height=\"22\"\n    viewBox=\"0 0 512 512\"\n    xmlns=\"http://www.w3.org/2000/svg\"\n  >\n    <path d=\"M528 448H48c-26.51 0-48-21.49-48-48V112c0-26.51 21.49-48 48-48h480c26.51 0 48 21.49 48 48v288c0 26.51-21.49 48-48 48zM128 180v-40c0-6.627-5.373-12-12-12H76c-6.627 0-12 5.373-12 12v40c0 6.627 5.373 12 12 12h40c6.627 0 12-5.373 12-12zm96 0v-40c0-6.627-5.373-12-12-12h-40c-6.627 0-12 5.373-12 12v40c0 6.627 5.373 12 12 12h40c6.627 0 12-5.373 12-12zm96 0v-40c0-6.627-5.373-12-12-12h-40c-6.627 0-12 5.373-12 12v40c0 6.627 5.373 12 12 12h40c6.627 0 12-5.373 12-12zm96 0v-40c0-6.627-5.373-12-12-12h-40c-6.627 0-12 5.373-12 12v40c0 6.627 5.373 12 12 12h40c6.627 0 12-5.373 12-12zm96 0v-40c0-6.627-5.373-12-12-12h-40c-6.627 0-12 5.373-12 12v40c0 6.627 5.373 12 12 12h40c6.627 0 12-5.373 12-12zm-336 96v-40c0-6.627-5.373-12-12-12h-40c-6.627 0-12 5.373-12 12v40c0 6.627 5.373 12 12 12h40c6.627 0 12-5.373 12-12zm96 0v-40c0-6.627-5.373-12-12-12h-40c-6.627 0-12 5.373-12 12v40c0 6.627 5.373 12 12 12h40c6.627 0 12-5.373 12-12zm96 0v-40c0-6.627-5.373-12-12-12h-40c-6.627 0-12 5.373-12 12v40c0 6.627 5.373 12 12 12h40c6.627 0 12-5.373 12-12zm96 0v-40c0-6.627-5.373-12-12-12h-40c-6.627 0-12 5.373-12 12v40c0 6.627 5.373 12 12 12h40c6.627 0 12-5.373 12-12zm-336 96v-40c0-6.627-5.373-12-12-12H76c-6.627 0-12 5.373-12 12v40c0 6.627 5.373 12 12 12h40c6.627 0 12-5.373 12-12zm288 0v-40c0-6.627-5.373-12-12-12H172c-6.627 0-12 5.373-12 12v40c0 6.627 5.373 12 12 12h232c6.627 0 12-5.373 12-12zm96 0v-40c0-6.627-5.373-12-12-12h-40c-6.627 0-12 5.373-12 12v40c0 6.627 5.373 12 12 12h40c6.627 0 12-5.373 12-12z\" />\n  </svg>\n);\n\nexport const HelpIcon = (props: HelpIconProps) => (\n  <label title={`${props.title}  ?`} className=\"help-icon\">\n    <div onClick={props.onClick}>{ICON}</div>\n  </label>\n);\n","import React from \"react\";\nimport { menu, palette } from \"../components/icons\";\nimport { ToolButton } from \"../components/ToolButton\";\nimport { t } from \"../i18n\";\nimport { showSelectedShapeActions, getNonDeletedElements } from \"../element\";\nimport { register } from \"./register\";\nimport { allowFullScreen, exitFullScreen, isFullScreen } from \"../utils\";\nimport { KEYS } from \"../keys\";\nimport { HelpIcon } from \"../components/HelpIcon\";\n\nexport const actionToggleCanvasMenu = register({\n  name: \"toggleCanvasMenu\",\n  perform: (_, appState) => ({\n    appState: {\n      ...appState,\n      openMenu: appState.openMenu === \"canvas\" ? null : \"canvas\",\n    },\n    commitToHistory: false,\n  }),\n  PanelComponent: ({ appState, updateData }) => (\n    <ToolButton\n      type=\"button\"\n      icon={menu}\n      aria-label={t(\"buttons.menu\")}\n      onClick={updateData}\n      selected={appState.openMenu === \"canvas\"}\n    />\n  ),\n});\n\nexport const actionToggleEditMenu = register({\n  name: \"toggleEditMenu\",\n  perform: (_elements, appState) => ({\n    appState: {\n      ...appState,\n      openMenu: appState.openMenu === \"shape\" ? null : \"shape\",\n    },\n    commitToHistory: false,\n  }),\n  PanelComponent: ({ elements, appState, updateData }) => (\n    <ToolButton\n      visible={showSelectedShapeActions(\n        appState,\n        getNonDeletedElements(elements),\n      )}\n      type=\"button\"\n      icon={palette}\n      aria-label={t(\"buttons.edit\")}\n      onClick={updateData}\n      selected={appState.openMenu === \"shape\"}\n    />\n  ),\n});\n\nexport const actionFullScreen = register({\n  name: \"toggleFullScreen\",\n  perform: () => {\n    if (!isFullScreen()) {\n      allowFullScreen();\n    }\n    if (isFullScreen()) {\n      exitFullScreen();\n    }\n    return {\n      commitToHistory: false,\n    };\n  },\n  keyTest: (event) => event.keyCode === KEYS.F_KEY_CODE,\n});\n\nexport const actionShortcuts = register({\n  name: \"toggleShortcuts\",\n  perform: (_elements, appState) => {\n    return {\n      appState: {\n        ...appState,\n        showShortcutsDialog: true,\n      },\n      commitToHistory: false,\n    };\n  },\n  PanelComponent: ({ updateData }) => (\n    <HelpIcon title={t(\"shortcutsDialog.title\")} onClick={updateData} />\n  ),\n  keyTest: (event) => event.key === KEYS.QUESTION_MARK,\n});\n","import { KEYS } from \"../keys\";\nimport { register } from \"./register\";\nimport { newElementWith } from \"../element/mutateElement\";\nimport { getSelectedElements } from \"../scene\";\nimport {\n  getSelectedGroupIds,\n  selectGroup,\n  selectGroupsForSelectedElements,\n  getElementsInGroup,\n  addToGroup,\n  removeFromSelectedGroups,\n  isElementInGroup,\n} from \"../groups\";\nimport { getNonDeletedElements } from \"../element\";\nimport { randomId } from \"../random\";\n\nexport const actionGroup = register({\n  name: \"group\",\n  perform: (elements, appState) => {\n    const selectedElements = getSelectedElements(\n      getNonDeletedElements(elements),\n      appState,\n    );\n    if (selectedElements.length < 2) {\n      // nothing to group\n      return { appState, elements, commitToHistory: false };\n    }\n    // if everything is already grouped into 1 group, there is nothing to do\n    const selectedGroupIds = getSelectedGroupIds(appState);\n    if (selectedGroupIds.length === 1) {\n      const selectedGroupId = selectedGroupIds[0];\n      const elementIdsInGroup = new Set(\n        getElementsInGroup(elements, selectedGroupId).map(\n          (element) => element.id,\n        ),\n      );\n      const selectedElementIds = new Set(\n        selectedElements.map((element) => element.id),\n      );\n      const combinedSet = new Set([\n        ...Array.from(elementIdsInGroup),\n        ...Array.from(selectedElementIds),\n      ]);\n      if (combinedSet.size === elementIdsInGroup.size) {\n        // no incremental ids in the selected ids\n        return { appState, elements, commitToHistory: false };\n      }\n    }\n    const newGroupId = randomId();\n    const updatedElements = elements.map((element) => {\n      if (!appState.selectedElementIds[element.id]) {\n        return element;\n      }\n      return newElementWith(element, {\n        groupIds: addToGroup(\n          element.groupIds,\n          newGroupId,\n          appState.editingGroupId,\n        ),\n      });\n    });\n    // keep the z order within the group the same, but move them\n    // to the z order of the highest element in the layer stack\n    const elementsInGroup = getElementsInGroup(updatedElements, newGroupId);\n    const lastElementInGroup = elementsInGroup[elementsInGroup.length - 1];\n    const lastGroupElementIndex = updatedElements.lastIndexOf(\n      lastElementInGroup,\n    );\n    const elementsAfterGroup = updatedElements.slice(lastGroupElementIndex + 1);\n    const elementsBeforeGroup = updatedElements\n      .slice(0, lastGroupElementIndex)\n      .filter(\n        (updatedElement) => !isElementInGroup(updatedElement, newGroupId),\n      );\n    const updatedElementsInOrder = [\n      ...elementsBeforeGroup,\n      ...elementsInGroup,\n      ...elementsAfterGroup,\n    ];\n\n    return {\n      appState: selectGroup(\n        newGroupId,\n        { ...appState, selectedGroupIds: {} },\n        getNonDeletedElements(updatedElementsInOrder),\n      ),\n      elements: updatedElementsInOrder,\n      commitToHistory: true,\n    };\n  },\n  contextMenuOrder: 4,\n  contextItemLabel: \"labels.group\",\n  contextItemPredicate: (elements, appState) =>\n    getSelectedElements(getNonDeletedElements(elements), appState).length > 1,\n  keyTest: (event) => {\n    return (\n      !event.shiftKey &&\n      event[KEYS.CTRL_OR_CMD] &&\n      event.keyCode === KEYS.G_KEY_CODE\n    );\n  },\n});\n\nexport const actionUngroup = register({\n  name: \"ungroup\",\n  perform: (elements, appState) => {\n    const groupIds = getSelectedGroupIds(appState);\n    if (groupIds.length === 0) {\n      return { appState, elements, commitToHistory: false };\n    }\n    const nextElements = elements.map((element) => {\n      const nextGroupIds = removeFromSelectedGroups(\n        element.groupIds,\n        appState.selectedGroupIds,\n      );\n      if (nextGroupIds.length === element.groupIds.length) {\n        return element;\n      }\n      return newElementWith(element, {\n        groupIds: nextGroupIds,\n      });\n    });\n    return {\n      appState: selectGroupsForSelectedElements(\n        { ...appState, selectedGroupIds: {} },\n        getNonDeletedElements(nextElements),\n      ),\n      elements: nextElements,\n      commitToHistory: true,\n    };\n  },\n  keyTest: (event) => {\n    return (\n      event.shiftKey &&\n      event[KEYS.CTRL_OR_CMD] &&\n      event.keyCode === KEYS.G_KEY_CODE\n    );\n  },\n  contextMenuOrder: 5,\n  contextItemLabel: \"labels.ungroup\",\n  contextItemPredicate: (elements, appState) =>\n    getSelectedGroupIds(appState).length > 0,\n});\n","import \"./Avatar.scss\";\n\nimport React from \"react\";\n\ntype AvatarProps = {\n  children: string;\n  className?: string;\n  onClick: (e: React.MouseEvent<HTMLDivElement, MouseEvent>) => void;\n  color: string;\n};\n\nexport const Avatar = ({\n  children,\n  className,\n  color,\n  onClick,\n}: AvatarProps) => (\n  <div\n    className={`Avatar ${className}`}\n    style={{ background: color }}\n    onClick={onClick}\n  >\n    {children}\n  </div>\n);\n","import { PointerCoords } from \"./types\";\nimport { normalizeScroll } from \"./scene\";\n\nexport const getCenter = (pointers: Map<number, PointerCoords>) => {\n  const allCoords = Array.from(pointers.values());\n  return {\n    x: normalizeScroll(sum(allCoords, (coords) => coords.x) / allCoords.length),\n    y: normalizeScroll(sum(allCoords, (coords) => coords.y) / allCoords.length),\n  };\n};\n\nexport const getDistance = ([a, b]: readonly PointerCoords[]) =>\n  Math.hypot(a.x - b.x, a.y - b.y);\n\nconst sum = <T>(array: readonly T[], mapper: (item: T) => number): number =>\n  array.reduce((acc, item) => acc + mapper(item), 0);\n","import React from \"react\";\nimport { Avatar } from \"../components/Avatar\";\nimport { register } from \"./register\";\nimport { getClientColors, getClientInitials } from \"../clients\";\nimport { Collaborator } from \"../types\";\nimport { normalizeScroll } from \"../scene\";\n\nexport const actionGoToCollaborator = register({\n  name: \"goToCollaborator\",\n  perform: (_elements, appState, value) => {\n    const point = value as Collaborator[\"pointer\"];\n    if (!point) {\n      return { appState, commitToHistory: false };\n    }\n\n    return {\n      appState: {\n        ...appState,\n        scrollX: normalizeScroll(appState.width / 2 - point.x),\n        scrollY: normalizeScroll(appState.height / 2 - point.y),\n        // Close mobile menu\n        openMenu: appState.openMenu === \"canvas\" ? null : appState.openMenu,\n      },\n      commitToHistory: false,\n    };\n  },\n  PanelComponent: ({ appState, updateData, id }) => {\n    const clientId = id;\n\n    if (!clientId) {\n      return null;\n    }\n\n    const collaborator = appState.collaborators.get(clientId);\n\n    if (!collaborator) {\n      return null;\n    }\n\n    const { background } = getClientColors(clientId);\n    const shortName = getClientInitials(collaborator.username);\n\n    return (\n      <Avatar\n        color={background}\n        onClick={() => updateData(collaborator.pointer)}\n      >\n        {shortName}\n      </Avatar>\n    );\n  },\n});\n","import { register } from \"./register\";\nimport { getSelectedElements } from \"../scene\";\nimport { getNonDeletedElements } from \"../element\";\nimport { deepCopyElement } from \"../element/newElement\";\nimport { loadLibrary, saveLibrary } from \"../data/localStorage\";\n\nexport const actionAddToLibrary = register({\n  name: \"addToLibrary\",\n  perform: (elements, appState) => {\n    const selectedElements = getSelectedElements(\n      getNonDeletedElements(elements),\n      appState,\n    );\n\n    loadLibrary().then((items) => {\n      saveLibrary([...items, selectedElements.map(deepCopyElement)]);\n    });\n\n    return false;\n  },\n  contextMenuOrder: 6,\n  contextItemLabel: \"labels.addToLibrary\",\n});\n","import { Action, ActionResult } from \"./types\";\nimport React from \"react\";\nimport { undo, redo } from \"../components/icons\";\nimport { ToolButton } from \"../components/ToolButton\";\nimport { t } from \"../i18n\";\nimport { SceneHistory, HistoryEntry } from \"../history\";\nimport { ExcalidrawElement } from \"../element/types\";\nimport { AppState } from \"../types\";\nimport { KEYS } from \"../keys\";\nimport { getElementMap } from \"../element\";\nimport { newElementWith } from \"../element/mutateElement\";\n\nconst writeData = (\n  prevElements: readonly ExcalidrawElement[],\n  appState: AppState,\n  updater: () => HistoryEntry | null,\n): ActionResult => {\n  const commitToHistory = false;\n  if (\n    !appState.multiElement &&\n    !appState.resizingElement &&\n    !appState.editingElement &&\n    !appState.draggingElement\n  ) {\n    const data = updater();\n    if (data === null) {\n      return { commitToHistory };\n    }\n\n    const prevElementMap = getElementMap(prevElements);\n    const nextElements = data.elements;\n    const nextElementMap = getElementMap(nextElements);\n\n    const elements = nextElements\n      .map((nextElement) =>\n        newElementWith(\n          prevElementMap[nextElement.id] || nextElement,\n          nextElement,\n        ),\n      )\n      .concat(\n        prevElements\n          .filter(\n            (prevElement) => !nextElementMap.hasOwnProperty(prevElement.id),\n          )\n          .map((prevElement) =>\n            newElementWith(prevElement, { isDeleted: true }),\n          ),\n      );\n\n    return {\n      elements,\n      appState: { ...appState, ...data.appState },\n      commitToHistory,\n      syncHistory: true,\n    };\n  }\n  return { commitToHistory };\n};\n\nconst testUndo = (shift: boolean) => (event: KeyboardEvent) =>\n  event[KEYS.CTRL_OR_CMD] && /z/i.test(event.key) && event.shiftKey === shift;\n\ntype ActionCreator = (history: SceneHistory) => Action;\n\nexport const createUndoAction: ActionCreator = (history) => ({\n  name: \"undo\",\n  perform: (elements, appState) =>\n    writeData(elements, appState, () => history.undoOnce()),\n  keyTest: testUndo(false),\n  PanelComponent: ({ updateData }) => (\n    <ToolButton\n      type=\"button\"\n      icon={undo}\n      aria-label={t(\"buttons.undo\")}\n      onClick={updateData}\n    />\n  ),\n  commitToHistory: () => false,\n});\n\nexport const createRedoAction: ActionCreator = (history) => ({\n  name: \"redo\",\n  perform: (elements, appState) =>\n    writeData(elements, appState, () => history.redoOnce()),\n  keyTest: testUndo(true),\n  PanelComponent: ({ updateData }) => (\n    <ToolButton\n      type=\"button\"\n      icon={redo}\n      aria-label={t(\"buttons.redo\")}\n      onClick={updateData}\n    />\n  ),\n  commitToHistory: () => false,\n});\n","import \"./Island.scss\";\n\nimport React from \"react\";\n\ntype IslandProps = {\n  children: React.ReactNode;\n  padding?: number;\n  className?: string | boolean;\n  style?: object;\n};\n\nexport const Island = React.forwardRef<HTMLDivElement, IslandProps>(\n  ({ children, padding, className, style }, ref) => (\n    <div\n      className={`${className ?? \"\"} Island`}\n      style={{ \"--padding\": padding, ...style } as React.CSSProperties}\n      ref={ref}\n    >\n      {children}\n    </div>\n  ),\n);\n","import \"./Stack.css\";\n\nimport React from \"react\";\n\ntype StackProps = {\n  children: React.ReactNode;\n  gap?: number;\n  align?: \"start\" | \"center\" | \"end\" | \"baseline\";\n  justifyContent?: \"center\" | \"space-around\" | \"space-between\";\n  className?: string | boolean;\n};\n\nconst RowStack = ({\n  children,\n  gap,\n  align,\n  justifyContent,\n  className,\n}: StackProps) => {\n  return (\n    <div\n      className={`Stack Stack_horizontal ${className || \"\"}`}\n      style={\n        {\n          \"--gap\": gap,\n          alignItems: align,\n          justifyContent,\n        } as React.CSSProperties\n      }\n    >\n      {children}\n    </div>\n  );\n};\n\nconst ColStack = ({\n  children,\n  gap,\n  align,\n  justifyContent,\n  className,\n}: StackProps) => {\n  return (\n    <div\n      className={`Stack Stack_vertical ${className || \"\"}`}\n      style={\n        {\n          \"--gap\": gap,\n          justifyItems: align,\n          justifyContent,\n        } as React.CSSProperties\n      }\n    >\n      {children}\n    </div>\n  );\n};\n\nexport default {\n  Row: RowStack,\n  Col: ColStack,\n};\n","import \"./FixedSideContainer.css\";\n\nimport React from \"react\";\n\ntype FixedSideContainerProps = {\n  children: React.ReactNode;\n  side: \"top\" | \"left\" | \"right\";\n  className?: string;\n};\n\nexport const FixedSideContainer = ({\n  children,\n  side,\n  className,\n}: FixedSideContainerProps) => (\n  <div\n    className={`FixedSideContainer FixedSideContainer_side_${side} ${className}`}\n  >\n    {children}\n  </div>\n);\n","import \"./UserList.css\";\n\nimport React from \"react\";\n\ntype UserListProps = {\n  children: React.ReactNode;\n  className?: string;\n  mobile?: boolean;\n};\n\nexport const UserList = ({ children, className, mobile }: UserListProps) => {\n  let compClassName = \"UserList\";\n\n  if (className) {\n    compClassName += ` ${className}`;\n  }\n\n  if (mobile) {\n    compClassName += \" UserList_mobile\";\n  }\n\n  return <div className={compClassName}>{children}</div>;\n};\n","import \"./ToolIcon.scss\";\n\nimport React from \"react\";\n\ntype LockIconSize = \"s\" | \"m\";\n\ntype LockIconProps = {\n  title?: string;\n  name?: string;\n  id?: string;\n  checked: boolean;\n  onChange?(): void;\n  size?: LockIconSize;\n  zenModeEnabled?: boolean;\n};\n\nconst DEFAULT_SIZE: LockIconSize = \"m\";\n\nconst ICONS = {\n  CHECKED: (\n    <svg\n      width=\"1792\"\n      height=\"1792\"\n      viewBox=\"0 0 1792 1792\"\n      xmlns=\"http://www.w3.org/2000/svg\"\n    >\n      <path d=\"M640 768h512v-192q0-106-75-181t-181-75-181 75-75 181v192zm832 96v576q0 40-28 68t-68 28h-960q-40 0-68-28t-28-68v-576q0-40 28-68t68-28h32v-192q0-184 132-316t316-132 316 132 132 316v192h32q40 0 68 28t28 68z\" />\n    </svg>\n  ),\n  UNCHECKED: (\n    <svg\n      width=\"1792\"\n      height=\"1792\"\n      viewBox=\"0 0 1792 1792\"\n      xmlns=\"http://www.w3.org/2000/svg\"\n      className=\"unlocked-icon rtl-mirror\"\n    >\n      <path d=\"M1728 576v256q0 26-19 45t-45 19h-64q-26 0-45-19t-19-45v-256q0-106-75-181t-181-75-181 75-75 181v192h96q40 0 68 28t28 68v576q0 40-28 68t-68 28h-960q-40 0-68-28t-28-68v-576q0-40 28-68t68-28h672v-192q0-185 131.5-316.5t316.5-131.5 316.5 131.5 131.5 316.5z\" />\n    </svg>\n  ),\n};\n\nexport const LockIcon = (props: LockIconProps) => {\n  const sizeCn = `ToolIcon_size_${props.size || DEFAULT_SIZE}`;\n\n  return (\n    <label\n      className={`ToolIcon ToolIcon__lock ToolIcon_type_floating ${sizeCn} zen-mode-visibility ${\n        props.zenModeEnabled && \"zen-mode-visibility--hidden\"\n      }`}\n      title={`${props.title}  Q`}\n    >\n      <input\n        className=\"ToolIcon_type_checkbox\"\n        type=\"checkbox\"\n        name={props.name}\n        id={props.id}\n        onChange={props.onChange}\n        checked={props.checked}\n        aria-label={props.title}\n      />\n      <div className=\"ToolIcon__icon\">\n        {props.checked ? ICONS.CHECKED : ICONS.UNCHECKED}\n      </div>\n    </label>\n  );\n};\n","import \"./Modal.scss\";\n\nimport React, { useEffect, useState } from \"react\";\nimport { createPortal } from \"react-dom\";\nimport { KEYS } from \"../keys\";\n\nexport const Modal = (props: {\n  className?: string;\n  children: React.ReactNode;\n  maxWidth?: number;\n  onCloseRequest(): void;\n  labelledBy: string;\n}) => {\n  const modalRoot = useBodyRoot();\n\n  const handleKeydown = (event: React.KeyboardEvent) => {\n    if (event.key === KEYS.ESCAPE) {\n      event.nativeEvent.stopImmediatePropagation();\n      props.onCloseRequest();\n    }\n  };\n  return createPortal(\n    <div\n      className={`Modal ${props.className ?? \"\"}`}\n      role=\"dialog\"\n      aria-modal=\"true\"\n      onKeyDown={handleKeydown}\n      aria-labelledby={props.labelledBy}\n    >\n      <div className=\"Modal__background\" onClick={props.onCloseRequest}></div>\n      <div\n        className=\"Modal__content\"\n        style={\n          {\n            \"--max-width\": `${props.maxWidth}px`,\n            maxHeight: \"100%\",\n            overflowY: \"scroll\",\n          } as any\n        }\n      >\n        {props.children}\n      </div>\n    </div>,\n    modalRoot,\n  );\n};\n\nconst useBodyRoot = () => {\n  const createDiv = () => {\n    const div = document.createElement(\"div\");\n    document.body.appendChild(div);\n    return div;\n  };\n  const [div] = useState(createDiv);\n  useEffect(() => {\n    return () => {\n      document.body.removeChild(div);\n    };\n  }, [div]);\n  return div;\n};\n","import React, { useEffect, useRef } from \"react\";\nimport { Modal } from \"./Modal\";\nimport { Island } from \"./Island\";\nimport { t } from \"../i18n\";\nimport useIsMobile from \"../is-mobile\";\nimport { back, close } from \"./icons\";\nimport { KEYS } from \"../keys\";\n\nimport \"./Dialog.scss\";\n\nexport const Dialog = (props: {\n  children: React.ReactNode;\n  className?: string;\n  maxWidth?: number;\n  onCloseRequest(): void;\n  title: React.ReactNode;\n}) => {\n  const islandRef = useRef<HTMLDivElement>(null);\n\n  useEffect(() => {\n    const focusableElements = queryFocusableElements();\n\n    if (focusableElements.length > 0) {\n      // If there's an element other than close, focus it.\n      (focusableElements[1] || focusableElements[0]).focus();\n    }\n  }, []);\n\n  useEffect(() => {\n    if (!islandRef.current) {\n      return;\n    }\n\n    const handleKeyDown = (event: KeyboardEvent) => {\n      if (event.key === KEYS.TAB) {\n        const focusableElements = queryFocusableElements();\n        const { activeElement } = document;\n        const currentIndex = focusableElements.findIndex(\n          (element) => element === activeElement,\n        );\n\n        if (currentIndex === 0 && event.shiftKey) {\n          focusableElements[focusableElements.length - 1].focus();\n          event.preventDefault();\n        } else if (\n          currentIndex === focusableElements.length - 1 &&\n          !event.shiftKey\n        ) {\n          focusableElements[0].focus();\n          event.preventDefault();\n        }\n      }\n    };\n\n    const node = islandRef.current;\n    node.addEventListener(\"keydown\", handleKeyDown);\n\n    return () => node.removeEventListener(\"keydown\", handleKeyDown);\n  }, []);\n\n  const queryFocusableElements = () => {\n    const focusableElements = islandRef.current?.querySelectorAll<HTMLElement>(\n      \"button, a, input, select, textarea, div[tabindex]\",\n    );\n\n    return focusableElements ? Array.from(focusableElements) : [];\n  };\n\n  return (\n    <Modal\n      className={`${props.className ?? \"\"} Dialog`}\n      labelledBy=\"dialog-title\"\n      maxWidth={props.maxWidth}\n      onCloseRequest={props.onCloseRequest}\n    >\n      <Island padding={4} ref={islandRef}>\n        <h2 id=\"dialog-title\" className=\"Dialog__title\">\n          <span className=\"Dialog__titleContent\">{props.title}</span>\n          <button\n            className=\"Modal__close\"\n            onClick={props.onCloseRequest}\n            aria-label={t(\"buttons.close\")}\n          >\n            {useIsMobile() ? back : close}\n          </button>\n        </h2>\n        {props.children}\n      </Island>\n    </Modal>\n  );\n};\n","import \"./ExportDialog.scss\";\n\nimport React, { useState, useEffect, useRef } from \"react\";\n\nimport { ToolButton } from \"./ToolButton\";\nimport { clipboard, exportFile, link } from \"./icons\";\nimport { NonDeletedExcalidrawElement } from \"../element/types\";\nimport { AppState } from \"../types\";\nimport { exportToCanvas } from \"../scene/export\";\nimport { ActionsManagerInterface } from \"../actions/types\";\nimport Stack from \"./Stack\";\nimport { t } from \"../i18n\";\n\nimport { probablySupportsClipboardBlob } from \"../clipboard\";\nimport { getSelectedElements, isSomeElementSelected } from \"../scene\";\nimport useIsMobile from \"../is-mobile\";\nimport { Dialog } from \"./Dialog\";\n\nconst scales = [1, 2, 3];\nconst defaultScale = scales.includes(devicePixelRatio) ? devicePixelRatio : 1;\n\nexport type ExportCB = (\n  elements: readonly NonDeletedExcalidrawElement[],\n  scale?: number,\n) => void;\n\nconst ExportModal = ({\n  elements,\n  appState,\n  exportPadding = 10,\n  actionManager,\n  onExportToPng,\n  onExportToSvg,\n  onExportToClipboard,\n  onExportToBackend,\n}: {\n  appState: AppState;\n  elements: readonly NonDeletedExcalidrawElement[];\n  exportPadding?: number;\n  actionManager: ActionsManagerInterface;\n  onExportToPng: ExportCB;\n  onExportToSvg: ExportCB;\n  onExportToClipboard: ExportCB;\n  onExportToBackend: ExportCB;\n  onCloseRequest: () => void;\n}) => {\n  const someElementIsSelected = isSomeElementSelected(elements, appState);\n  const [scale, setScale] = useState(defaultScale);\n  const [exportSelected, setExportSelected] = useState(someElementIsSelected);\n  const previewRef = useRef<HTMLDivElement>(null);\n  const {\n    exportBackground,\n    viewBackgroundColor,\n    shouldAddWatermark,\n  } = appState;\n\n  const exportedElements = exportSelected\n    ? getSelectedElements(elements, appState)\n    : elements;\n\n  useEffect(() => {\n    setExportSelected(someElementIsSelected);\n  }, [someElementIsSelected]);\n\n  useEffect(() => {\n    const previewNode = previewRef.current;\n    const canvas = exportToCanvas(exportedElements, appState, {\n      exportBackground,\n      viewBackgroundColor,\n      exportPadding,\n      scale,\n      shouldAddWatermark,\n    });\n    previewNode?.appendChild(canvas);\n    return () => {\n      previewNode?.removeChild(canvas);\n    };\n  }, [\n    appState,\n    exportedElements,\n    exportBackground,\n    exportPadding,\n    viewBackgroundColor,\n    scale,\n    shouldAddWatermark,\n  ]);\n\n  return (\n    <div className=\"ExportDialog\">\n      <div className=\"ExportDialog__preview\" ref={previewRef}></div>\n      <Stack.Col gap={2} align=\"center\">\n        <div className=\"ExportDialog__actions\">\n          <Stack.Row gap={2}>\n            <ToolButton\n              type=\"button\"\n              label=\"PNG\"\n              title={t(\"buttons.exportToPng\")}\n              aria-label={t(\"buttons.exportToPng\")}\n              onClick={() => onExportToPng(exportedElements, scale)}\n            />\n            <ToolButton\n              type=\"button\"\n              label=\"SVG\"\n              title={t(\"buttons.exportToSvg\")}\n              aria-label={t(\"buttons.exportToSvg\")}\n              onClick={() => onExportToSvg(exportedElements, scale)}\n            />\n            {probablySupportsClipboardBlob && (\n              <ToolButton\n                type=\"button\"\n                icon={clipboard}\n                title={t(\"buttons.copyPngToClipboard\")}\n                aria-label={t(\"buttons.copyPngToClipboard\")}\n                onClick={() => onExportToClipboard(exportedElements, scale)}\n              />\n            )}\n            <ToolButton\n              type=\"button\"\n              icon={link}\n              title={t(\"buttons.getShareableLink\")}\n              aria-label={t(\"buttons.getShareableLink\")}\n              onClick={() => onExportToBackend(exportedElements)}\n            />\n          </Stack.Row>\n          <div className=\"ExportDialog__name\">\n            {actionManager.renderAction(\"changeProjectName\")}\n          </div>\n          <Stack.Row gap={2}>\n            {scales.map((s) => (\n              <ToolButton\n                key={s}\n                size=\"s\"\n                type=\"radio\"\n                icon={`x${s}`}\n                name=\"export-canvas-scale\"\n                aria-label={`Scale ${s} x`}\n                id=\"export-canvas-scale\"\n                checked={s === scale}\n                onChange={() => setScale(s)}\n              />\n            ))}\n          </Stack.Row>\n        </div>\n        {actionManager.renderAction(\"changeExportBackground\")}\n        {someElementIsSelected && (\n          <div>\n            <label>\n              <input\n                type=\"checkbox\"\n                checked={exportSelected}\n                onChange={(event) =>\n                  setExportSelected(event.currentTarget.checked)\n                }\n              />{\" \"}\n              {t(\"labels.onlySelected\")}\n            </label>\n          </div>\n        )}\n        {actionManager.renderAction(\"changeShouldAddWatermark\")}\n      </Stack.Col>\n    </div>\n  );\n};\n\nexport const ExportDialog = ({\n  elements,\n  appState,\n  exportPadding = 10,\n  actionManager,\n  onExportToPng,\n  onExportToSvg,\n  onExportToClipboard,\n  onExportToBackend,\n}: {\n  appState: AppState;\n  elements: readonly NonDeletedExcalidrawElement[];\n  exportPadding?: number;\n  actionManager: ActionsManagerInterface;\n  onExportToPng: ExportCB;\n  onExportToSvg: ExportCB;\n  onExportToClipboard: ExportCB;\n  onExportToBackend: ExportCB;\n}) => {\n  const [modalIsShown, setModalIsShown] = useState(false);\n  const triggerButton = useRef<HTMLButtonElement>(null);\n\n  const handleClose = React.useCallback(() => {\n    setModalIsShown(false);\n    triggerButton.current?.focus();\n  }, []);\n\n  return (\n    <>\n      <ToolButton\n        onClick={() => setModalIsShown(true)}\n        icon={exportFile}\n        type=\"button\"\n        aria-label={t(\"buttons.export\")}\n        showAriaLabel={useIsMobile()}\n        title={t(\"buttons.export\")}\n        ref={triggerButton}\n      />\n      {modalIsShown && (\n        <Dialog\n          maxWidth={800}\n          onCloseRequest={handleClose}\n          title={t(\"buttons.export\")}\n        >\n          <ExportModal\n            elements={elements}\n            appState={appState}\n            exportPadding={exportPadding}\n            actionManager={actionManager}\n            onExportToPng={onExportToPng}\n            onExportToSvg={onExportToSvg}\n            onExportToClipboard={onExportToClipboard}\n            onExportToBackend={onExportToBackend}\n            onCloseRequest={handleClose}\n          />\n        </Dialog>\n      )}\n    </>\n  );\n};\n","import React from \"react\";\nimport * as i18n from \"../i18n\";\n\nexport const LanguageList = ({\n  onChange,\n  languages = i18n.languages,\n  currentLanguage = i18n.getLanguage().lng,\n  floating,\n}: {\n  languages?: { lng: string; label: string }[];\n  onChange: (value: string) => void;\n  currentLanguage?: string;\n  floating?: boolean;\n}) => (\n  <React.Fragment>\n    <select\n      className={`dropdown-select dropdown-select__language${\n        floating ? \" dropdown-select--floating\" : \"\"\n      }`}\n      onChange={({ target }) => onChange(target.value)}\n      value={currentLanguage}\n      aria-label={i18n.t(\"buttons.selectLanguage\")}\n    >\n      {languages.map((language) => (\n        <option key={language.lng} value={language.lng}>\n          {language.label}\n        </option>\n      ))}\n    </select>\n  </React.Fragment>\n);\n","import React from \"react\";\nimport { t } from \"../i18n\";\nimport { NonDeletedExcalidrawElement } from \"../element/types\";\nimport { getSelectedElements } from \"../scene\";\n\nimport \"./HintViewer.scss\";\nimport { AppState } from \"../types\";\nimport { isLinearElement } from \"../element/typeChecks\";\nimport { getShortcutKey } from \"../utils\";\n\ninterface Hint {\n  appState: AppState;\n  elements: readonly NonDeletedExcalidrawElement[];\n}\n\nconst getHints = ({ appState, elements }: Hint) => {\n  const { elementType, isResizing, isRotating, lastPointerDownWith } = appState;\n  const multiMode = appState.multiElement !== null;\n  if (elementType === \"arrow\" || elementType === \"line\") {\n    if (!multiMode) {\n      return t(\"hints.linearElement\");\n    }\n    return t(\"hints.linearElementMulti\");\n  }\n\n  if (elementType === \"draw\") {\n    return t(\"hints.freeDraw\");\n  }\n\n  const selectedElements = getSelectedElements(elements, appState);\n  if (\n    isResizing &&\n    lastPointerDownWith === \"mouse\" &&\n    selectedElements.length === 1\n  ) {\n    const targetElement = selectedElements[0];\n    if (isLinearElement(targetElement) && targetElement.points.length > 2) {\n      return null;\n    }\n    return t(\"hints.resize\");\n  }\n\n  if (isRotating && lastPointerDownWith === \"mouse\") {\n    return t(\"hints.rotate\");\n  }\n\n  if (selectedElements.length === 1 && isLinearElement(selectedElements[0])) {\n    if (appState.editingLinearElement) {\n      return appState.editingLinearElement.activePointIndex\n        ? t(\"hints.lineEditor_pointSelected\")\n        : t(\"hints.lineEditor_nothingSelected\");\n    }\n    return t(\"hints.lineEditor_info\");\n  }\n\n  return null;\n};\n\nexport const HintViewer = ({ appState, elements }: Hint) => {\n  let hint = getHints({\n    appState,\n    elements,\n  });\n  if (!hint) {\n    return null;\n  }\n\n  hint = getShortcutKey(hint);\n\n  return (\n    <div className=\"HintViewer\">\n      <span>{hint}</span>\n    </div>\n  );\n};\n","import React from \"react\";\nimport { AppState } from \"../types\";\nimport { ExcalidrawElement } from \"../element/types\";\nimport { ActionManager } from \"../actions/manager\";\nimport { hasBackground, hasStroke, hasText, getTargetElement } from \"../scene\";\nimport { t } from \"../i18n\";\nimport { SHAPES } from \"../shapes\";\nimport { ToolButton } from \"./ToolButton\";\nimport { capitalizeString, setCursorForShape } from \"../utils\";\nimport Stack from \"./Stack\";\nimport useIsMobile from \"../is-mobile\";\nimport { getNonDeletedElements } from \"../element\";\n\nexport const SelectedShapeActions = ({\n  appState,\n  elements,\n  renderAction,\n  elementType,\n}: {\n  appState: AppState;\n  elements: readonly ExcalidrawElement[];\n  renderAction: ActionManager[\"renderAction\"];\n  elementType: ExcalidrawElement[\"type\"];\n}) => {\n  const targetElements = getTargetElement(\n    getNonDeletedElements(elements),\n    appState,\n  );\n  const isEditing = Boolean(appState.editingElement);\n  const isMobile = useIsMobile();\n\n  return (\n    <div className=\"panelColumn\">\n      {renderAction(\"changeStrokeColor\")}\n      {(hasBackground(elementType) ||\n        targetElements.some((element) => hasBackground(element.type))) && (\n        <>\n          {renderAction(\"changeBackgroundColor\")}\n\n          {renderAction(\"changeFillStyle\")}\n        </>\n      )}\n\n      {(hasStroke(elementType) ||\n        targetElements.some((element) => hasStroke(element.type))) && (\n        <>\n          {renderAction(\"changeStrokeWidth\")}\n          {renderAction(\"changeStrokeStyle\")}\n          {renderAction(\"changeSloppiness\")}\n        </>\n      )}\n\n      {(hasText(elementType) ||\n        targetElements.some((element) => hasText(element.type))) && (\n        <>\n          {renderAction(\"changeFontSize\")}\n\n          {renderAction(\"changeFontFamily\")}\n\n          {renderAction(\"changeTextAlign\")}\n        </>\n      )}\n\n      {renderAction(\"changeOpacity\")}\n\n      <fieldset>\n        <legend>{t(\"labels.layers\")}</legend>\n        <div className=\"buttonList\">\n          {renderAction(\"sendToBack\")}\n          {renderAction(\"sendBackward\")}\n          {renderAction(\"bringToFront\")}\n          {renderAction(\"bringForward\")}\n        </div>\n      </fieldset>\n      {!isMobile && !isEditing && targetElements.length > 0 && (\n        <fieldset>\n          <legend>{t(\"labels.actions\")}</legend>\n          <div className=\"buttonList\">\n            {renderAction(\"duplicateSelection\")}\n            {renderAction(\"deleteSelectedElements\")}\n          </div>\n        </fieldset>\n      )}\n    </div>\n  );\n};\n\nconst LIBRARY_ICON = (\n  // fa-th-large\n  <svg viewBox=\"0 0 512 512\">\n    <path d=\"M296 32h192c13.255 0 24 10.745 24 24v160c0 13.255-10.745 24-24 24H296c-13.255 0-24-10.745-24-24V56c0-13.255 10.745-24 24-24zm-80 0H24C10.745 32 0 42.745 0 56v160c0 13.255 10.745 24 24 24h192c13.255 0 24-10.745 24-24V56c0-13.255-10.745-24-24-24zM0 296v160c0 13.255 10.745 24 24 24h192c13.255 0 24-10.745 24-24V296c0-13.255-10.745-24-24-24H24c-13.255 0-24 10.745-24 24zm296 184h192c13.255 0 24-10.745 24-24V296c0-13.255-10.745-24-24-24H296c-13.255 0-24 10.745-24 24v160c0 13.255 10.745 24 24 24z\" />\n  </svg>\n);\n\nexport const ShapesSwitcher = ({\n  elementType,\n  setAppState,\n  isLibraryOpen,\n}: {\n  elementType: ExcalidrawElement[\"type\"];\n  setAppState: (appState: Partial<AppState>) => void;\n  isLibraryOpen: boolean;\n}) => (\n  <>\n    {SHAPES.map(({ value, icon, key }, index) => {\n      const label = t(`toolBar.${value}`);\n      const shortcut = `${capitalizeString(key)} ${t(\"shortcutsDialog.or\")} ${\n        index + 1\n      }`;\n      return (\n        <ToolButton\n          key={value}\n          type=\"radio\"\n          icon={icon}\n          checked={elementType === value}\n          name=\"editor-current-shape\"\n          title={`${capitalizeString(label)}  ${shortcut}`}\n          keyBindingLabel={`${index + 1}`}\n          aria-label={capitalizeString(label)}\n          aria-keyshortcuts={`${key} ${index + 1}`}\n          data-testid={value}\n          onChange={() => {\n            setAppState({\n              elementType: value,\n              multiElement: null,\n              selectedElementIds: {},\n            });\n            setCursorForShape(value);\n            setAppState({});\n          }}\n        />\n      );\n    })}\n    <ToolButton\n      type=\"button\"\n      icon={LIBRARY_ICON}\n      name=\"editor-library\"\n      keyBindingLabel=\"9\"\n      aria-keyshortcuts=\"9\"\n      title={`${capitalizeString(t(\"toolBar.library\"))}  9`}\n      aria-label={capitalizeString(t(\"toolBar.library\"))}\n      onClick={() => {\n        setAppState({ isLibraryOpen: !isLibraryOpen });\n      }}\n    />\n  </>\n);\n\nexport const ZoomActions = ({\n  renderAction,\n  zoom,\n}: {\n  renderAction: ActionManager[\"renderAction\"];\n  zoom: number;\n}) => (\n  <Stack.Col gap={1}>\n    <Stack.Row gap={1} align=\"center\">\n      {renderAction(\"zoomIn\")}\n      {renderAction(\"zoomOut\")}\n      {renderAction(\"resetZoom\")}\n      <div style={{ marginInlineStart: 4 }}>{(zoom * 100).toFixed(0)}%</div>\n    </Stack.Row>\n  </Stack.Col>\n);\n","import React from \"react\";\nimport { t } from \"../i18n\";\n\ninterface SectionProps extends React.HTMLProps<HTMLElement> {\n  heading: string;\n  children: React.ReactNode | ((header: React.ReactNode) => React.ReactNode);\n}\n\nexport const Section = ({ heading, children, ...props }: SectionProps) => {\n  const header = (\n    <h2 className=\"visually-hidden\" id={`${heading}-title`}>\n      {t(`headings.${heading}`)}\n    </h2>\n  );\n  return (\n    <section {...props} aria-labelledby={`${heading}-title`}>\n      {typeof children === \"function\" ? (\n        children(header)\n      ) : (\n        <>\n          {header}\n          {children}\n        </>\n      )}\n    </section>\n  );\n};\n","import React, { useState, useEffect, useRef } from \"react\";\nimport { ToolButton } from \"./ToolButton\";\nimport { t } from \"../i18n\";\nimport useIsMobile from \"../is-mobile\";\nimport { users, clipboard, start, stop } from \"./icons\";\n\nimport \"./RoomDialog.scss\";\nimport { copyTextToSystemClipboard } from \"../clipboard\";\nimport { Dialog } from \"./Dialog\";\nimport { AppState } from \"../types\";\n\nconst RoomModal = ({\n  activeRoomLink,\n  username,\n  onUsernameChange,\n  onRoomCreate,\n  onRoomDestroy,\n  onPressingEnter,\n}: {\n  activeRoomLink: string;\n  username: string;\n  onUsernameChange: (username: string) => void;\n  onRoomCreate: () => void;\n  onRoomDestroy: () => void;\n  onPressingEnter: () => void;\n}) => {\n  const roomLinkInput = useRef<HTMLInputElement>(null);\n\n  const copyRoomLink = () => {\n    copyTextToSystemClipboard(activeRoomLink);\n    if (roomLinkInput.current) {\n      roomLinkInput.current.select();\n    }\n  };\n  const selectInput = (event: React.MouseEvent<HTMLInputElement>) => {\n    if (event.target !== document.activeElement) {\n      event.preventDefault();\n      (event.target as HTMLInputElement).select();\n    }\n  };\n\n  return (\n    <div className=\"RoomDialog-modal\">\n      {!activeRoomLink && (\n        <>\n          <p>{t(\"roomDialog.desc_intro\")}</p>\n          <p>{` ${t(\"roomDialog.desc_privacy\")}`}</p>\n          <div className=\"RoomDialog-sessionStartButtonContainer\">\n            <ToolButton\n              className=\"RoomDialog-startSession\"\n              type=\"button\"\n              icon={start}\n              title={t(\"roomDialog.button_startSession\")}\n              aria-label={t(\"roomDialog.button_startSession\")}\n              showAriaLabel={true}\n              onClick={onRoomCreate}\n            />\n          </div>\n        </>\n      )}\n      {activeRoomLink && (\n        <>\n          <p>{t(\"roomDialog.desc_inProgressIntro\")}</p>\n          <p>{t(\"roomDialog.desc_shareLink\")}</p>\n          <div className=\"RoomDialog-linkContainer\">\n            <ToolButton\n              type=\"button\"\n              icon={clipboard}\n              title={t(\"labels.copy\")}\n              aria-label={t(\"labels.copy\")}\n              onClick={copyRoomLink}\n            />\n            <input\n              value={activeRoomLink}\n              readOnly={true}\n              className=\"RoomDialog-link\"\n              ref={roomLinkInput}\n              onPointerDown={selectInput}\n            />\n          </div>\n          <div className=\"RoomDialog-usernameContainer\">\n            <label className=\"RoomDialog-usernameLabel\" htmlFor=\"username\">\n              {t(\"labels.yourName\")}\n            </label>\n            <input\n              id=\"username\"\n              value={username || \"\"}\n              className=\"RoomDialog-username TextInput\"\n              onChange={(event) => onUsernameChange(event.target.value)}\n              onKeyPress={(event) => event.key === \"Enter\" && onPressingEnter()}\n            />\n          </div>\n          <p>{` ${t(\"roomDialog.desc_privacy\")}`}</p>\n          <p>\n            <span role=\"img\" aria-hidden=\"true\">\n              \n            </span>{\" \"}\n            {t(\"roomDialog.desc_persistenceWarning\")}\n          </p>\n          <p>{t(\"roomDialog.desc_exitSession\")}</p>\n          <div className=\"RoomDialog-sessionStartButtonContainer\">\n            <ToolButton\n              className=\"RoomDialog-stopSession\"\n              type=\"button\"\n              icon={stop}\n              title={t(\"roomDialog.button_stopSession\")}\n              aria-label={t(\"roomDialog.button_stopSession\")}\n              showAriaLabel={true}\n              onClick={onRoomDestroy}\n            />\n          </div>\n        </>\n      )}\n    </div>\n  );\n};\n\nexport const RoomDialog = ({\n  isCollaborating,\n  collaboratorCount,\n  username,\n  onUsernameChange,\n  onRoomCreate,\n  onRoomDestroy,\n}: {\n  isCollaborating: AppState[\"isCollaborating\"];\n  collaboratorCount: number;\n  username: string;\n  onUsernameChange: (username: string) => void;\n  onRoomCreate: () => void;\n  onRoomDestroy: () => void;\n}) => {\n  const [modalIsShown, setModalIsShown] = useState(false);\n  const [activeRoomLink, setActiveRoomLink] = useState(\"\");\n\n  const triggerButton = useRef<HTMLButtonElement>(null);\n\n  const handleClose = React.useCallback(() => {\n    setModalIsShown(false);\n    triggerButton.current?.focus();\n  }, []);\n\n  useEffect(() => {\n    setActiveRoomLink(isCollaborating ? window.location.href : \"\");\n  }, [isCollaborating]);\n\n  return (\n    <>\n      <ToolButton\n        className={`RoomDialog-modalButton ${\n          isCollaborating ? \"is-collaborating\" : \"\"\n        }`}\n        onClick={() => setModalIsShown(true)}\n        icon={users}\n        type=\"button\"\n        title={t(\"buttons.roomDialog\")}\n        aria-label={t(\"buttons.roomDialog\")}\n        showAriaLabel={useIsMobile()}\n        ref={triggerButton}\n      >\n        {collaboratorCount > 0 && (\n          <div className=\"RoomDialog-modalButton-collaborators\">\n            {collaboratorCount}\n          </div>\n        )}\n      </ToolButton>\n      {modalIsShown && (\n        <Dialog\n          maxWidth={800}\n          onCloseRequest={handleClose}\n          title={t(\"labels.createRoom\")}\n        >\n          <RoomModal\n            activeRoomLink={activeRoomLink}\n            username={username}\n            onUsernameChange={onUsernameChange}\n            onRoomCreate={onRoomCreate}\n            onRoomDestroy={onRoomDestroy}\n            onPressingEnter={handleClose}\n          />\n        </Dialog>\n      )}\n    </>\n  );\n};\n","import React from \"react\";\nimport { AppState } from \"../types\";\nimport { ActionManager } from \"../actions/manager\";\nimport { t, setLanguage } from \"../i18n\";\nimport Stack from \"./Stack\";\nimport { LanguageList } from \"./LanguageList\";\nimport { showSelectedShapeActions } from \"../element\";\nimport { NonDeletedExcalidrawElement } from \"../element/types\";\nimport { FixedSideContainer } from \"./FixedSideContainer\";\nimport { Island } from \"./Island\";\nimport { HintViewer } from \"./HintViewer\";\nimport { calculateScrollCenter } from \"../scene\";\nimport { SelectedShapeActions, ShapesSwitcher } from \"./Actions\";\nimport { Section } from \"./Section\";\nimport { RoomDialog } from \"./RoomDialog\";\nimport { SCROLLBAR_WIDTH, SCROLLBAR_MARGIN } from \"../scene/scrollbars\";\nimport { LockIcon } from \"./LockIcon\";\nimport { LoadingMessage } from \"./LoadingMessage\";\nimport { UserList } from \"./UserList\";\n\ntype MobileMenuProps = {\n  appState: AppState;\n  actionManager: ActionManager;\n  exportButton: React.ReactNode;\n  setAppState: any;\n  elements: readonly NonDeletedExcalidrawElement[];\n  onRoomCreate: () => void;\n  onUsernameChange: (username: string) => void;\n  onRoomDestroy: () => void;\n  onLockToggle: () => void;\n  canvas: HTMLCanvasElement | null;\n};\n\nexport const MobileMenu = ({\n  appState,\n  elements,\n  actionManager,\n  exportButton,\n  setAppState,\n  onRoomCreate,\n  onUsernameChange,\n  onRoomDestroy,\n  onLockToggle,\n  canvas,\n}: MobileMenuProps) => (\n  <>\n    {appState.isLoading && <LoadingMessage />}\n    <FixedSideContainer side=\"top\">\n      <Section heading=\"shapes\">\n        {(heading) => (\n          <Stack.Col gap={4} align=\"center\">\n            <Stack.Row gap={1}>\n              <Island padding={1}>\n                {heading}\n                <Stack.Row gap={1}>\n                  <ShapesSwitcher\n                    elementType={appState.elementType}\n                    setAppState={setAppState}\n                    isLibraryOpen={appState.isLibraryOpen}\n                  />\n                </Stack.Row>\n              </Island>\n              <LockIcon\n                checked={appState.elementLocked}\n                onChange={onLockToggle}\n                title={t(\"toolBar.lock\")}\n              />\n            </Stack.Row>\n          </Stack.Col>\n        )}\n      </Section>\n      <HintViewer appState={appState} elements={elements} />\n    </FixedSideContainer>\n    <div\n      className=\"App-bottom-bar\"\n      style={{\n        marginBottom: SCROLLBAR_WIDTH + SCROLLBAR_MARGIN * 2,\n        marginLeft: SCROLLBAR_WIDTH + SCROLLBAR_MARGIN * 2,\n        marginRight: SCROLLBAR_WIDTH + SCROLLBAR_MARGIN * 2,\n      }}\n    >\n      <Island padding={3}>\n        {appState.openMenu === \"canvas\" ? (\n          <Section className=\"App-mobile-menu\" heading=\"canvasActions\">\n            <div className=\"panelColumn\">\n              <Stack.Col gap={4}>\n                {actionManager.renderAction(\"loadScene\")}\n                {actionManager.renderAction(\"saveScene\")}\n                {actionManager.renderAction(\"saveAsScene\")}\n                {exportButton}\n                {actionManager.renderAction(\"clearCanvas\")}\n                <RoomDialog\n                  isCollaborating={appState.isCollaborating}\n                  collaboratorCount={appState.collaborators.size}\n                  username={appState.username}\n                  onUsernameChange={onUsernameChange}\n                  onRoomCreate={onRoomCreate}\n                  onRoomDestroy={onRoomDestroy}\n                />\n                {actionManager.renderAction(\"changeViewBackgroundColor\")}\n                <fieldset>\n                  <legend>{t(\"labels.language\")}</legend>\n                  <LanguageList\n                    onChange={async (lng) => {\n                      await setLanguage(lng);\n                      setAppState({});\n                    }}\n                  />\n                </fieldset>\n                <fieldset>\n                  <legend>{t(\"labels.collaborators\")}</legend>\n                  <UserList mobile>\n                    {Array.from(appState.collaborators)\n                      // Collaborator is either not initialized or is actually the current user.\n                      .filter(([_, client]) => Object.keys(client).length !== 0)\n                      .map(([clientId, client]) => (\n                        <React.Fragment key={clientId}>\n                          {actionManager.renderAction(\n                            \"goToCollaborator\",\n                            clientId,\n                          )}\n                        </React.Fragment>\n                      ))}\n                  </UserList>\n                </fieldset>\n              </Stack.Col>\n            </div>\n          </Section>\n        ) : appState.openMenu === \"shape\" &&\n          showSelectedShapeActions(appState, elements) ? (\n          <Section className=\"App-mobile-menu\" heading=\"selectedShapeActions\">\n            <SelectedShapeActions\n              appState={appState}\n              elements={elements}\n              renderAction={actionManager.renderAction}\n              elementType={appState.elementType}\n            />\n          </Section>\n        ) : null}\n        <footer className=\"App-toolbar\">\n          <div className=\"App-toolbar-content\">\n            {actionManager.renderAction(\"toggleCanvasMenu\")}\n            {actionManager.renderAction(\"toggleEditMenu\")}\n            {actionManager.renderAction(\"undo\")}\n            {actionManager.renderAction(\"redo\")}\n            {actionManager.renderAction(\n              appState.multiElement ? \"finalize\" : \"duplicateSelection\",\n            )}\n            {actionManager.renderAction(\"deleteSelectedElements\")}\n          </div>\n          {appState.scrolledOutside && (\n            <button\n              className=\"scroll-back-to-content\"\n              onClick={() => {\n                setAppState({\n                  ...calculateScrollCenter(elements, appState, canvas),\n                });\n              }}\n            >\n              {t(\"buttons.scrollBackToContent\")}\n            </button>\n          )}\n        </footer>\n      </Island>\n    </div>\n  </>\n);\n","import React, { useState } from \"react\";\nimport { t } from \"../i18n\";\n\nimport { Dialog } from \"./Dialog\";\n\nexport const ErrorDialog = ({\n  message,\n  onClose,\n}: {\n  message: string;\n  onClose?: () => void;\n}) => {\n  const [modalIsShown, setModalIsShown] = useState(!!message);\n\n  const handleClose = React.useCallback(() => {\n    setModalIsShown(false);\n\n    if (onClose) {\n      onClose();\n    }\n  }, [onClose]);\n\n  return (\n    <>\n      {modalIsShown && (\n        <Dialog\n          maxWidth={500}\n          onCloseRequest={handleClose}\n          title={t(\"errorDialog.title\")}\n        >\n          <div>{message}</div>\n        </Dialog>\n      )}\n    </>\n  );\n};\n","import React from \"react\";\nimport oc from \"open-color\";\nimport { t } from \"../i18n\";\nimport { isDarwin } from \"../keys\";\nimport { Dialog } from \"./Dialog\";\nimport { getShortcutKey } from \"../utils\";\n\nconst Columns = (props: { children: React.ReactNode }) => (\n  <div\n    style={{\n      display: \"flex\",\n      flexDirection: \"row\",\n      flexWrap: \"wrap\",\n      justifyContent: \"space-between\",\n    }}\n  >\n    {props.children}\n  </div>\n);\n\nconst Column = (props: { children: React.ReactNode }) => (\n  <div\n    style={{\n      width: \"49%\",\n    }}\n  >\n    {props.children}\n  </div>\n);\n\nconst ShortcutIsland = (props: {\n  caption: string;\n  children: React.ReactNode;\n}) => (\n  <div\n    style={{\n      border: `1px solid ${oc.gray[4]}`,\n      marginBottom: \"16px\",\n    }}\n  >\n    <h3\n      style={{\n        margin: \"0\",\n        padding: \"4px\",\n        backgroundColor: oc.gray[2],\n        textAlign: \"center\",\n      }}\n    >\n      {props.caption}\n    </h3>\n    {props.children}\n  </div>\n);\n\nconst Shortcut = (props: {\n  label: string;\n  shortcuts: string[];\n  isOr: boolean;\n}) => {\n  const isRTL = document.documentElement.getAttribute(\"dir\") === \"rtl\";\n  return (\n    <div\n      style={{\n        borderTop: `1px solid ${oc.gray[4]}`,\n      }}\n    >\n      <div\n        style={{\n          display: \"flex\",\n          margin: \"0\",\n          padding: \"4px 8px\",\n          alignItems: \"center\",\n        }}\n      >\n        <div\n          style={{\n            lineHeight: 1.4,\n          }}\n        >\n          {props.label}\n        </div>\n        <div\n          style={{\n            display: \"flex\",\n            flex: \"0 0 auto\",\n            justifyContent: \"flex-end\",\n            marginLeft: isRTL ? \"0em\" : \"auto\",\n            marginRight: isRTL ? \"auto\" : \"0em\",\n            minWidth: \"30%\",\n          }}\n        >\n          {props.shortcuts.map((shortcut, index) => (\n            <React.Fragment key={index}>\n              <ShortcutKey>{shortcut}</ShortcutKey>\n              {props.isOr &&\n                index !== props.shortcuts.length - 1 &&\n                t(\"shortcutsDialog.or\")}\n            </React.Fragment>\n          ))}\n        </div>\n      </div>\n    </div>\n  );\n};\n\nShortcut.defaultProps = {\n  isOr: true,\n};\n\nconst ShortcutKey = (props: { children: React.ReactNode }) => (\n  <span\n    style={{\n      wordBreak: \"keep-all\",\n      border: `1px solid ${oc.gray[4]}`,\n      padding: \"2px 8px\",\n      margin: \"auto 4px\",\n      backgroundColor: oc.gray[2],\n      borderRadius: \"2px\",\n      fontSize: \"0.8em\",\n      minHeight: \"26px\",\n      boxSizing: \"border-box\",\n      display: \"flex\",\n      alignItems: \"center\",\n    }}\n    {...props}\n  />\n);\n\nconst Footer = () => (\n  <div\n    style={{\n      display: \"flex\",\n      flexDirection: \"row\",\n      justifyContent: \"space-evenly\",\n      borderTop: `1px solid ${oc.gray[4]}`,\n      marginTop: 8,\n      paddingTop: 16,\n    }}\n  >\n    <a\n      href=\"https://blog.excalidraw.com\"\n      target=\"_blank\"\n      rel=\"noopener noreferrer\"\n    >\n      {t(\"shortcutsDialog.blog\")}\n    </a>\n    <a\n      href=\"https://howto.excalidraw.com\"\n      target=\"_blank\"\n      rel=\"noopener noreferrer\"\n    >\n      {t(\"shortcutsDialog.howto\")}\n    </a>\n    <a\n      href=\"https://github.com/excalidraw/excalidraw/issues\"\n      target=\"_blank\"\n      rel=\"noopener noreferrer\"\n    >\n      {t(\"shortcutsDialog.github\")}\n    </a>\n  </div>\n);\n\nexport const ShortcutsDialog = ({ onClose }: { onClose?: () => void }) => {\n  const handleClose = React.useCallback(() => {\n    if (onClose) {\n      onClose();\n    }\n  }, [onClose]);\n\n  return (\n    <>\n      <Dialog\n        maxWidth={900}\n        onCloseRequest={handleClose}\n        title={t(\"shortcutsDialog.title\")}\n      >\n        <Columns>\n          <Column>\n            <ShortcutIsland caption={t(\"shortcutsDialog.shapes\")}>\n              <Shortcut label={t(\"toolBar.selection\")} shortcuts={[\"S\", \"1\"]} />\n              <Shortcut label={t(\"toolBar.rectangle\")} shortcuts={[\"R\", \"2\"]} />\n              <Shortcut label={t(\"toolBar.diamond\")} shortcuts={[\"D\", \"3\"]} />\n              <Shortcut label={t(\"toolBar.ellipse\")} shortcuts={[\"E\", \"4\"]} />\n              <Shortcut label={t(\"toolBar.arrow\")} shortcuts={[\"A\", \"5\"]} />\n              <Shortcut label={t(\"toolBar.line\")} shortcuts={[\"L\", \"6\"]} />\n              <Shortcut label={t(\"toolBar.draw\")} shortcuts={[\"X\", \"7\"]} />\n              <Shortcut label={t(\"toolBar.text\")} shortcuts={[\"T\", \"8\"]} />\n              <Shortcut\n                label={t(\"shortcutsDialog.textNewLine\")}\n                shortcuts={[\n                  getShortcutKey(\"Enter\"),\n                  getShortcutKey(\"Shift+Enter\"),\n                ]}\n              />\n              <Shortcut\n                label={t(\"shortcutsDialog.textFinish\")}\n                shortcuts={[\n                  getShortcutKey(\"Esc\"),\n                  getShortcutKey(\"CtrlOrCmd+Enter\"),\n                ]}\n              />\n              <Shortcut\n                label={t(\"shortcutsDialog.curvedArrow\")}\n                shortcuts={[\n                  \"A\",\n                  t(\"shortcutsDialog.click\"),\n                  t(\"shortcutsDialog.click\"),\n                  t(\"shortcutsDialog.click\"),\n                ]}\n                isOr={false}\n              />\n              <Shortcut\n                label={t(\"shortcutsDialog.curvedLine\")}\n                shortcuts={[\n                  \"L\",\n                  t(\"shortcutsDialog.click\"),\n                  t(\"shortcutsDialog.click\"),\n                  t(\"shortcutsDialog.click\"),\n                ]}\n                isOr={false}\n              />\n              <Shortcut label={t(\"toolBar.lock\")} shortcuts={[\"Q\"]} />\n            </ShortcutIsland>\n            <ShortcutIsland caption={t(\"shortcutsDialog.view\")}>\n              <Shortcut\n                label={t(\"buttons.zoomIn\")}\n                shortcuts={[getShortcutKey(\"CtrlOrCmd++\")]}\n              />\n              <Shortcut\n                label={t(\"buttons.zoomOut\")}\n                shortcuts={[getShortcutKey(\"CtrlOrCmd+-\")]}\n              />\n              <Shortcut\n                label={t(\"buttons.resetZoom\")}\n                shortcuts={[getShortcutKey(\"CtrlOrCmd+0\")]}\n              />\n              <Shortcut\n                label={t(\"shortcutsDialog.zoomToFit\")}\n                shortcuts={[\"Shift+1\"]}\n              />\n              <Shortcut\n                label={t(\"buttons.toggleFullScreen\")}\n                shortcuts={[\"F\"]}\n              />\n              <Shortcut\n                label={t(\"buttons.toggleZenMode\")}\n                shortcuts={[getShortcutKey(\"Alt+Z\")]}\n              />\n              <Shortcut\n                label={t(\"labels.toggleGridMode\")}\n                shortcuts={[getShortcutKey(\"CtrlOrCmd+'\")]}\n              />\n            </ShortcutIsland>\n          </Column>\n          <Column>\n            <ShortcutIsland caption={t(\"shortcutsDialog.editor\")}>\n              <Shortcut\n                label={t(\"labels.selectAll\")}\n                shortcuts={[getShortcutKey(\"CtrlOrCmd+A\")]}\n              />\n              <Shortcut\n                label={t(\"labels.multiSelect\")}\n                shortcuts={[\n                  getShortcutKey(`Shift+${t(\"shortcutsDialog.click\")}`),\n                ]}\n              />\n              <Shortcut\n                label={t(\"labels.moveCanvas\")}\n                shortcuts={[\n                  getShortcutKey(`Space+${t(\"shortcutsDialog.drag\")}`),\n                  getShortcutKey(`Wheel+${t(\"shortcutsDialog.drag\")}`),\n                ]}\n                isOr={true}\n              />\n              <Shortcut\n                label={t(\"labels.copy\")}\n                shortcuts={[getShortcutKey(\"CtrlOrCmd+C\")]}\n              />\n              <Shortcut\n                label={t(\"labels.paste\")}\n                shortcuts={[getShortcutKey(\"CtrlOrCmd+V\")]}\n              />\n              <Shortcut\n                label={t(\"labels.copyAsPng\")}\n                shortcuts={[getShortcutKey(\"Shift+Alt+C\")]}\n              />\n              <Shortcut\n                label={t(\"labels.copyStyles\")}\n                shortcuts={[getShortcutKey(\"CtrlOrCmd+Alt+C\")]}\n              />\n              <Shortcut\n                label={t(\"labels.pasteStyles\")}\n                shortcuts={[getShortcutKey(\"CtrlOrCmd+Alt+V\")]}\n              />\n              <Shortcut\n                label={t(\"labels.delete\")}\n                shortcuts={[getShortcutKey(\"Del\")]}\n              />\n              <Shortcut\n                label={t(\"labels.sendToBack\")}\n                shortcuts={[\n                  isDarwin\n                    ? getShortcutKey(\"CtrlOrCmd+Alt+[\")\n                    : getShortcutKey(\"CtrlOrCmd+Shift+[\"),\n                ]}\n              />\n              <Shortcut\n                label={t(\"labels.bringToFront\")}\n                shortcuts={[\n                  isDarwin\n                    ? getShortcutKey(\"CtrlOrCmd+Alt+]\")\n                    : getShortcutKey(\"CtrlOrCmd+Shift+]\"),\n                ]}\n              />\n              <Shortcut\n                label={t(\"labels.sendBackward\")}\n                shortcuts={[getShortcutKey(\"CtrlOrCmd+[\")]}\n              />\n              <Shortcut\n                label={t(\"labels.bringForward\")}\n                shortcuts={[getShortcutKey(\"CtrlOrCmd+]\")]}\n              />\n              <Shortcut\n                label={t(\"labels.duplicateSelection\")}\n                shortcuts={[\n                  getShortcutKey(\"CtrlOrCmd+D\"),\n                  getShortcutKey(`Alt+${t(\"shortcutsDialog.drag\")}`),\n                ]}\n              />\n              <Shortcut\n                label={t(\"buttons.undo\")}\n                shortcuts={[getShortcutKey(\"CtrlOrCmd+Z\")]}\n              />\n              <Shortcut\n                label={t(\"buttons.redo\")}\n                shortcuts={[getShortcutKey(\"CtrlOrCmd+Shift+Z\")]}\n              />\n              <Shortcut\n                label={t(\"labels.group\")}\n                shortcuts={[getShortcutKey(\"CtrlOrCmd+G\")]}\n              />\n              <Shortcut\n                label={t(\"labels.ungroup\")}\n                shortcuts={[getShortcutKey(\"CtrlOrCmd+Shift+G\")]}\n              />\n            </ShortcutIsland>\n          </Column>\n        </Columns>\n        <Footer />\n      </Dialog>\n    </>\n  );\n};\n","import React from \"react\";\nimport oc from \"open-color\";\n\n// https://github.com/tholman/github-corners\nexport const GitHubCorner = React.memo(() => (\n  <svg\n    xmlns=\"http://www.w3.org/2000/svg\"\n    width=\"40\"\n    height=\"40\"\n    viewBox=\"0 0 250 250\"\n    className=\"github-corner rtl-mirror\"\n  >\n    <a\n      href=\"https://github.com/excalidraw/excalidraw\"\n      target=\"_blank\"\n      rel=\"noopener noreferrer\"\n      aria-label=\"GitHub repository\"\n    >\n      <path d=\"M0 0l115 115h15l12 27 108 108V0z\" fill={oc.gray[6]} />\n      <path\n        className=\"octo-arm\"\n        d=\"M128 109c-15-9-9-19-9-19 3-7 2-11 2-11-1-7 3-2 3-2 4 5 2 11 2 11-3 10 5 15 9 16\"\n        style={{ transformOrigin: \"130px 106px\" }}\n        fill={oc.white}\n      />\n      <path\n        className=\"octo-body\"\n        d=\"M115 115s4 2 5 0l14-14c3-2 6-3 8-3-8-11-15-24 2-41 5-5 10-7 16-7 1-2 3-7 12-11 0 0 5 3 7 16 4 2 8 5 12 9s7 8 9 12c14 3 17 7 17 7-4 8-9 11-11 11 0 6-2 11-7 16-16 16-30 10-41 2 0 3-1 7-5 11l-12 11c-1 1 1 5 1 5z\"\n        fill={oc.white}\n      />\n    </a>\n  </svg>\n));\n","import \"./Tooltip.scss\";\n\nimport React from \"react\";\n\ntype TooltipProps = {\n  children: React.ReactNode;\n  label: string;\n};\n\nexport const Tooltip = ({ children, label }: TooltipProps) => (\n  <div className=\"Tooltip\">\n    <span className=\"Tooltip__label\">{label}</span>\n    {children}\n  </div>\n);\n","import React, { useRef, useEffect, useState } from \"react\";\nimport { exportToSvg } from \"../scene/export\";\nimport { ExcalidrawElement, NonDeleted } from \"../element/types\";\nimport { close } from \"../components/icons\";\n\nimport \"./LibraryUnit.scss\";\nimport { t } from \"../i18n\";\n\n// fa-plus\nconst PLUS_ICON = (\n  <svg viewBox=\"0 0 1792 1792\">\n    <path d=\"M1600 736v192q0 40-28 68t-68 28h-416v416q0 40-28 68t-68 28h-192q-40 0-68-28t-28-68v-416h-416q-40 0-68-28t-28-68v-192q0-40 28-68t68-28h416v-416q0-40 28-68t68-28h192q40 0 68 28t28 68v416h416q40 0 68 28t28 68z\" />\n  </svg>\n);\n\nexport const LibraryUnit = ({\n  elements,\n  pendingElements,\n  onRemoveFromLibrary,\n  onClick,\n}: {\n  elements?: NonDeleted<ExcalidrawElement>[];\n  pendingElements?: NonDeleted<ExcalidrawElement>[];\n  onRemoveFromLibrary: () => void;\n  onClick: () => void;\n}) => {\n  const ref = useRef<HTMLDivElement | null>(null);\n  useEffect(() => {\n    const elementsToRender = elements || pendingElements;\n    if (!elementsToRender) {\n      return;\n    }\n    const svg = exportToSvg(elementsToRender, {\n      exportBackground: false,\n      viewBackgroundColor: \"#fff\",\n      shouldAddWatermark: false,\n    });\n    for (const child of ref.current!.children) {\n      if (child.tagName !== \"svg\") {\n        continue;\n      }\n      ref.current!.removeChild(child);\n    }\n    ref.current!.appendChild(svg);\n\n    const current = ref.current!;\n    return () => {\n      current.removeChild(svg);\n    };\n  }, [elements, pendingElements]);\n\n  const [isHovered, setIsHovered] = useState(false);\n\n  const adder = isHovered && pendingElements && (\n    <div className=\"library-unit__adder\">{PLUS_ICON}</div>\n  );\n\n  return (\n    <div\n      className={`library-unit ${\n        elements || pendingElements ? \"library-unit__active\" : \"\"\n      }`}\n      onMouseEnter={() => setIsHovered(true)}\n      onMouseLeave={() => setIsHovered(false)}\n    >\n      <div\n        className={`library-unit__dragger ${\n          !!pendingElements ? \"library-unit__pulse\" : \"\"\n        }`}\n        ref={ref}\n        draggable={!!elements}\n        onClick={!!elements || !!pendingElements ? onClick : undefined}\n        onDragStart={(event) => {\n          setIsHovered(false);\n          event.dataTransfer.setData(\n            \"application/vnd.excalidraw.json\",\n            JSON.stringify(elements),\n          );\n        }}\n      />\n      {adder}\n      {elements && isHovered && (\n        <button\n          className=\"library-unit__removeFromLibrary\"\n          aria-label={t(\"labels.removeFromLibrary\")}\n          onClick={onRemoveFromLibrary}\n        >\n          {close}\n        </button>\n      )}\n    </div>\n  );\n};\n","import React, {\n  useRef,\n  useState,\n  RefObject,\n  useEffect,\n  useCallback,\n} from \"react\";\nimport { showSelectedShapeActions } from \"../element\";\nimport { calculateScrollCenter, getSelectedElements } from \"../scene\";\nimport { exportCanvas } from \"../data\";\n\nimport { AppState, LibraryItems } from \"../types\";\nimport {\n  NonDeletedExcalidrawElement,\n  ExcalidrawElement,\n  NonDeleted,\n} from \"../element/types\";\n\nimport { ActionManager } from \"../actions/manager\";\nimport { Island } from \"./Island\";\nimport Stack from \"./Stack\";\nimport { FixedSideContainer } from \"./FixedSideContainer\";\nimport { UserList } from \"./UserList\";\nimport { LockIcon } from \"./LockIcon\";\nimport { ExportDialog, ExportCB } from \"./ExportDialog\";\nimport { LanguageList } from \"./LanguageList\";\nimport { t, languages, setLanguage } from \"../i18n\";\nimport { HintViewer } from \"./HintViewer\";\nimport useIsMobile from \"../is-mobile\";\n\nimport { ExportType } from \"../scene/types\";\nimport { MobileMenu } from \"./MobileMenu\";\nimport { ZoomActions, SelectedShapeActions, ShapesSwitcher } from \"./Actions\";\nimport { Section } from \"./Section\";\nimport { RoomDialog } from \"./RoomDialog\";\nimport { ErrorDialog } from \"./ErrorDialog\";\nimport { ShortcutsDialog } from \"./ShortcutsDialog\";\nimport { LoadingMessage } from \"./LoadingMessage\";\nimport { CLASSES } from \"../constants\";\nimport { shield } from \"./icons\";\nimport { GitHubCorner } from \"./GitHubCorner\";\nimport { Tooltip } from \"./Tooltip\";\n\nimport \"./LayerUI.scss\";\nimport { LibraryUnit } from \"./LibraryUnit\";\nimport { loadLibrary, saveLibrary } from \"../data/localStorage\";\n\ninterface LayerUIProps {\n  actionManager: ActionManager;\n  appState: AppState;\n  canvas: HTMLCanvasElement | null;\n  setAppState: any;\n  elements: readonly NonDeletedExcalidrawElement[];\n  onRoomCreate: () => void;\n  onUsernameChange: (username: string) => void;\n  onRoomDestroy: () => void;\n  onLockToggle: () => void;\n  onInsertShape: (elements: readonly NonDeleted<ExcalidrawElement>[]) => void;\n  zenModeEnabled: boolean;\n  toggleZenMode: () => void;\n  lng: string;\n}\n\nfunction useOnClickOutside(\n  ref: RefObject<HTMLElement>,\n  cb: (event: MouseEvent) => void,\n) {\n  useEffect(() => {\n    const listener = (event: MouseEvent) => {\n      if (!ref.current) {\n        return;\n      }\n\n      if (\n        event.target instanceof Element &&\n        (ref.current.contains(event.target) ||\n          !document.body.contains(event.target))\n      ) {\n        return;\n      }\n\n      cb(event);\n    };\n    document.addEventListener(\"pointerdown\", listener, false);\n\n    return () => {\n      document.removeEventListener(\"pointerdown\", listener);\n    };\n  }, [ref, cb]);\n}\n\nconst LibraryMenuItems = ({\n  library,\n  onRemoveFromLibrary,\n  onAddToLibrary,\n  onInsertShape,\n  pendingElements,\n}: {\n  library: LibraryItems;\n  pendingElements: NonDeleted<ExcalidrawElement>[];\n  onClickOutside: (event: MouseEvent) => void;\n  onRemoveFromLibrary: (index: number) => void;\n  onInsertShape: (elements: readonly NonDeleted<ExcalidrawElement>[]) => void;\n  onAddToLibrary: (elements: NonDeleted<ExcalidrawElement>[]) => void;\n}) => {\n  const numCells = library.length + (pendingElements.length > 0 ? 1 : 0);\n  const CELLS_PER_ROW = 3;\n  const numRows = Math.max(1, Math.ceil(numCells / CELLS_PER_ROW));\n  const rows = [];\n  let addedPendingElements = false;\n\n  for (let row = 0; row < numRows; row++) {\n    const i = CELLS_PER_ROW * row;\n    const children = [];\n    for (let j = 0; j < 3; j++) {\n      const shouldAddPendingElements: boolean =\n        pendingElements.length > 0 &&\n        !addedPendingElements &&\n        i + j >= library.length;\n      addedPendingElements = addedPendingElements || shouldAddPendingElements;\n\n      children.push(\n        <Stack.Col key={j}>\n          <LibraryUnit\n            elements={library[i + j]}\n            pendingElements={\n              shouldAddPendingElements ? pendingElements : undefined\n            }\n            onRemoveFromLibrary={onRemoveFromLibrary.bind(null, i + j)}\n            onClick={\n              shouldAddPendingElements\n                ? onAddToLibrary.bind(null, pendingElements)\n                : onInsertShape.bind(null, library[i + j])\n            }\n          />\n        </Stack.Col>,\n      );\n    }\n    rows.push(\n      <Stack.Row align=\"center\" gap={1} key={row}>\n        {children}\n      </Stack.Row>,\n    );\n  }\n\n  return (\n    <Stack.Col align=\"center\" gap={1} className=\"layer-ui__library-items\">\n      {rows}\n    </Stack.Col>\n  );\n};\n\nconst LibraryMenu = ({\n  onClickOutside,\n  onInsertShape,\n  pendingElements,\n  onAddToLibrary,\n}: {\n  pendingElements: NonDeleted<ExcalidrawElement>[];\n  onClickOutside: (event: MouseEvent) => void;\n  onInsertShape: (elements: readonly NonDeleted<ExcalidrawElement>[]) => void;\n  onAddToLibrary: () => void;\n}) => {\n  const ref = useRef<HTMLDivElement | null>(null);\n  useOnClickOutside(ref, onClickOutside);\n\n  const [libraryItems, setLibraryItems] = useState<LibraryItems>([]);\n\n  const [loadingState, setIsLoading] = useState<\n    \"preloading\" | \"loading\" | \"ready\"\n  >(\"preloading\");\n\n  const loadingTimerRef = useRef<NodeJS.Timeout | null>(null);\n\n  useEffect(() => {\n    Promise.race([\n      new Promise((resolve) => {\n        loadingTimerRef.current = setTimeout(() => {\n          resolve(\"loading\");\n        }, 100);\n      }),\n      loadLibrary().then((items) => {\n        setLibraryItems(items);\n        setIsLoading(\"ready\");\n      }),\n    ]).then((data) => {\n      if (data === \"loading\") {\n        setIsLoading(\"loading\");\n      }\n    });\n    return () => {\n      clearTimeout(loadingTimerRef.current!);\n    };\n  }, []);\n\n  const removeFromLibrary = useCallback(async (indexToRemove) => {\n    const items = await loadLibrary();\n    const nextItems = items.filter((_, index) => index !== indexToRemove);\n    saveLibrary(nextItems);\n    setLibraryItems(nextItems);\n  }, []);\n\n  const addToLibrary = useCallback(\n    async (elements: NonDeleted<ExcalidrawElement>[]) => {\n      const items = await loadLibrary();\n      const nextItems = [...items, elements];\n      onAddToLibrary();\n      saveLibrary(nextItems);\n      setLibraryItems(nextItems);\n    },\n    [onAddToLibrary],\n  );\n\n  return loadingState === \"preloading\" ? null : (\n    <Island padding={1} ref={ref} className=\"layer-ui__library\">\n      {loadingState === \"loading\" ? (\n        <div className=\"layer-ui__library-message\">\n          {t(\"labels.libraryLoadingMessage\")}\n        </div>\n      ) : (\n        <LibraryMenuItems\n          library={libraryItems}\n          onClickOutside={onClickOutside}\n          onRemoveFromLibrary={removeFromLibrary}\n          onAddToLibrary={addToLibrary}\n          onInsertShape={onInsertShape}\n          pendingElements={pendingElements}\n        />\n      )}\n    </Island>\n  );\n};\n\nconst LayerUI = ({\n  actionManager,\n  appState,\n  setAppState,\n  canvas,\n  elements,\n  onRoomCreate,\n  onUsernameChange,\n  onRoomDestroy,\n  onLockToggle,\n  onInsertShape,\n  zenModeEnabled,\n  toggleZenMode,\n}: LayerUIProps) => {\n  const isMobile = useIsMobile();\n\n  // TODO: Extend tooltip component and use here.\n  const renderEncryptedIcon = () => (\n    <a\n      className={`encrypted-icon tooltip zen-mode-visibility ${\n        zenModeEnabled ? \"zen-mode-visibility--hidden\" : \"\"\n      }`}\n      href=\"https://blog.excalidraw.com/end-to-end-encryption/\"\n      target=\"_blank\"\n      rel=\"noopener noreferrer\"\n    >\n      <span className=\"tooltip-text\" dir=\"auto\">\n        {t(\"encrypted.tooltip\")}\n      </span>\n      {shield}\n    </a>\n  );\n\n  const renderExportDialog = () => {\n    const createExporter = (type: ExportType): ExportCB => (\n      exportedElements,\n      scale,\n    ) => {\n      if (canvas) {\n        exportCanvas(type, exportedElements, appState, canvas, {\n          exportBackground: appState.exportBackground,\n          name: appState.name,\n          viewBackgroundColor: appState.viewBackgroundColor,\n          scale,\n          shouldAddWatermark: appState.shouldAddWatermark,\n        });\n      }\n    };\n    return (\n      <ExportDialog\n        elements={elements}\n        appState={appState}\n        actionManager={actionManager}\n        onExportToPng={createExporter(\"png\")}\n        onExportToSvg={createExporter(\"svg\")}\n        onExportToClipboard={createExporter(\"clipboard\")}\n        onExportToBackend={(exportedElements) => {\n          if (canvas) {\n            exportCanvas(\n              \"backend\",\n              exportedElements,\n              {\n                ...appState,\n                selectedElementIds: {},\n              },\n              canvas,\n              appState,\n            );\n          }\n        }}\n      />\n    );\n  };\n\n  const renderCanvasActions = () => (\n    <Section\n      heading=\"canvasActions\"\n      className={`zen-mode-transition ${zenModeEnabled && \"transition-left\"}`}\n    >\n      {/* the zIndex ensures this menu has higher stacking order,\n         see https://github.com/excalidraw/excalidraw/pull/1445 */}\n      <Island padding={4} style={{ zIndex: 1 }}>\n        <Stack.Col gap={4}>\n          <Stack.Row gap={1} justifyContent=\"space-between\">\n            {actionManager.renderAction(\"loadScene\")}\n            {actionManager.renderAction(\"saveScene\")}\n            {actionManager.renderAction(\"saveAsScene\")}\n            {renderExportDialog()}\n            {actionManager.renderAction(\"clearCanvas\")}\n            <RoomDialog\n              isCollaborating={appState.isCollaborating}\n              collaboratorCount={appState.collaborators.size}\n              username={appState.username}\n              onUsernameChange={onUsernameChange}\n              onRoomCreate={onRoomCreate}\n              onRoomDestroy={onRoomDestroy}\n            />\n          </Stack.Row>\n          {actionManager.renderAction(\"changeViewBackgroundColor\")}\n        </Stack.Col>\n      </Island>\n    </Section>\n  );\n\n  const renderSelectedShapeActions = () => (\n    <Section\n      heading=\"selectedShapeActions\"\n      className={`zen-mode-transition ${zenModeEnabled && \"transition-left\"}`}\n    >\n      <Island className={CLASSES.SHAPE_ACTIONS_MENU} padding={4}>\n        <SelectedShapeActions\n          appState={appState}\n          elements={elements}\n          renderAction={actionManager.renderAction}\n          elementType={appState.elementType}\n        />\n      </Island>\n    </Section>\n  );\n\n  const closeLibrary = useCallback(\n    (event) => {\n      setAppState({ isLibraryOpen: false });\n    },\n    [setAppState],\n  );\n\n  const deselectItems = useCallback(() => {\n    setAppState({\n      selectedElementIds: {},\n      selectedGroupIds: {},\n    });\n  }, [setAppState]);\n\n  const renderFixedSideContainer = () => {\n    const shouldRenderSelectedShapeActions = showSelectedShapeActions(\n      appState,\n      elements,\n    );\n    const libraryMenu = appState.isLibraryOpen ? (\n      <LibraryMenu\n        pendingElements={getSelectedElements(elements, appState)}\n        onClickOutside={closeLibrary}\n        onInsertShape={onInsertShape}\n        onAddToLibrary={deselectItems}\n      />\n    ) : null;\n    return (\n      <FixedSideContainer side=\"top\">\n        <HintViewer appState={appState} elements={elements} />\n        <div className=\"App-menu App-menu_top\">\n          <Stack.Col\n            gap={4}\n            className={zenModeEnabled && \"disable-pointerEvents\"}\n          >\n            {renderCanvasActions()}\n            {shouldRenderSelectedShapeActions && renderSelectedShapeActions()}\n          </Stack.Col>\n          <Section heading=\"shapes\">\n            {(heading) => (\n              <Stack.Col gap={4} align=\"start\">\n                <Stack.Row gap={1}>\n                  <Island padding={1} className={zenModeEnabled && \"zen-mode\"}>\n                    {heading}\n                    <Stack.Row gap={1}>\n                      <ShapesSwitcher\n                        elementType={appState.elementType}\n                        setAppState={setAppState}\n                        isLibraryOpen={appState.isLibraryOpen}\n                      />\n                    </Stack.Row>\n                  </Island>\n                  <LockIcon\n                    zenModeEnabled={zenModeEnabled}\n                    checked={appState.elementLocked}\n                    onChange={onLockToggle}\n                    title={t(\"toolBar.lock\")}\n                  />\n                </Stack.Row>\n                {libraryMenu}\n              </Stack.Col>\n            )}\n          </Section>\n          <UserList\n            className={`zen-mode-transition ${\n              zenModeEnabled && \"transition-right\"\n            }`}\n          >\n            {Array.from(appState.collaborators)\n              // Collaborator is either not initialized or is actually the current user.\n              .filter(([_, client]) => Object.keys(client).length !== 0)\n              .map(([clientId, client]) => (\n                <Tooltip\n                  label={client.username || \"Unknown user\"}\n                  key={clientId}\n                >\n                  {actionManager.renderAction(\"goToCollaborator\", clientId)}\n                </Tooltip>\n              ))}\n          </UserList>\n        </div>\n      </FixedSideContainer>\n    );\n  };\n\n  const renderBottomAppMenu = () => {\n    return (\n      <div\n        className={`App-menu App-menu_bottom zen-mode-transition ${\n          zenModeEnabled && \"App-menu_bottom--transition-left\"\n        }`}\n      >\n        <Stack.Col gap={2}>\n          <Section heading=\"canvasActions\">\n            <Island padding={1}>\n              <ZoomActions\n                renderAction={actionManager.renderAction}\n                zoom={appState.zoom}\n              />\n            </Island>\n            {renderEncryptedIcon()}\n          </Section>\n        </Stack.Col>\n      </div>\n    );\n  };\n\n  const renderFooter = () => (\n    <footer role=\"contentinfo\" className=\"layer-ui__wrapper__footer\">\n      <div\n        className={`zen-mode-transition ${\n          zenModeEnabled && \"transition-right disable-pointerEvents\"\n        }`}\n      >\n        <LanguageList\n          onChange={async (lng) => {\n            await setLanguage(lng);\n            setAppState({});\n          }}\n          languages={languages}\n          floating\n        />\n        {actionManager.renderAction(\"toggleShortcuts\")}\n      </div>\n      <button\n        className={`disable-zen-mode ${\n          zenModeEnabled && \"disable-zen-mode--visible\"\n        }`}\n        onClick={toggleZenMode}\n      >\n        {t(\"buttons.exitZenMode\")}\n      </button>\n      {appState.scrolledOutside && (\n        <button\n          className=\"scroll-back-to-content\"\n          onClick={() => {\n            setAppState({\n              ...calculateScrollCenter(elements, appState, canvas),\n            });\n          }}\n        >\n          {t(\"buttons.scrollBackToContent\")}\n        </button>\n      )}\n    </footer>\n  );\n\n  return isMobile ? (\n    <MobileMenu\n      appState={appState}\n      elements={elements}\n      actionManager={actionManager}\n      exportButton={renderExportDialog()}\n      setAppState={setAppState}\n      onUsernameChange={onUsernameChange}\n      onRoomCreate={onRoomCreate}\n      onRoomDestroy={onRoomDestroy}\n      onLockToggle={onLockToggle}\n      canvas={canvas}\n    />\n  ) : (\n    <div className=\"layer-ui__wrapper\">\n      {appState.isLoading && <LoadingMessage />}\n      {appState.errorMessage && (\n        <ErrorDialog\n          message={appState.errorMessage}\n          onClose={() => setAppState({ errorMessage: null })}\n        />\n      )}\n      {appState.showShortcutsDialog && (\n        <ShortcutsDialog\n          onClose={() => setAppState({ showShortcutsDialog: null })}\n        />\n      )}\n      {renderFixedSideContainer()}\n      {renderBottomAppMenu()}\n      {\n        <aside\n          className={`layer-ui__wrapper__github-corner zen-mode-transition ${\n            zenModeEnabled && \"transition-right\"\n          }`}\n        >\n          <GitHubCorner />\n        </aside>\n      }\n      {renderFooter()}\n    </div>\n  );\n};\n\nconst areEqual = (prev: LayerUIProps, next: LayerUIProps) => {\n  const getNecessaryObj = (appState: AppState): Partial<AppState> => {\n    const {\n      draggingElement,\n      resizingElement,\n      multiElement,\n      editingElement,\n      isResizing,\n      cursorX,\n      cursorY,\n      ...ret\n    } = appState;\n    return ret;\n  };\n  const prevAppState = getNecessaryObj(prev.appState);\n  const nextAppState = getNecessaryObj(next.appState);\n\n  const keys = Object.keys(prevAppState) as (keyof Partial<AppState>)[];\n\n  return (\n    prev.lng === next.lng &&\n    prev.elements === next.elements &&\n    keys.every((key) => prevAppState[key] === nextAppState[key])\n  );\n};\n\nexport default React.memo(LayerUI, areEqual);\n","import React from \"react\";\n\nimport rough from \"roughjs/bin/rough\";\nimport { RoughCanvas } from \"roughjs/bin/canvas\";\nimport { simplify, Point } from \"points-on-curve\";\nimport { FlooredNumber, SocketUpdateData } from \"../types\";\n\nimport {\n  newElement,\n  newTextElement,\n  duplicateElement,\n  resizeTest,\n  isInvisiblySmallElement,\n  isTextElement,\n  textWysiwyg,\n  getCommonBounds,\n  getCursorForResizingElement,\n  getPerfectElementSize,\n  getNormalizedDimensions,\n  getElementMap,\n  getDrawingVersion,\n  getSyncableElements,\n  newLinearElement,\n  resizeElements,\n  getElementWithResizeHandler,\n  getResizeOffsetXY,\n  getResizeArrowDirection,\n  getResizeHandlerFromCoords,\n  isNonDeletedElement,\n  updateTextElement,\n  dragSelectedElements,\n  getDragOffsetXY,\n  dragNewElement,\n} from \"../element\";\nimport {\n  getElementsWithinSelection,\n  isOverScrollBars,\n  getElementAtPosition,\n  getElementContainingPosition,\n  getNormalizedZoom,\n  getSelectedElements,\n  globalSceneState,\n  isSomeElementSelected,\n  calculateScrollCenter,\n} from \"../scene\";\nimport {\n  decryptAESGEM,\n  saveToLocalStorage,\n  loadScene,\n  loadFromBlob,\n  SOCKET_SERVER,\n  SocketUpdateDataSource,\n  exportCanvas,\n} from \"../data\";\nimport Portal from \"./Portal\";\n\nimport { renderScene } from \"../renderer\";\nimport { AppState, GestureEvent, Gesture } from \"../types\";\nimport {\n  ExcalidrawElement,\n  ExcalidrawProps,\n  ExcalidrawTextElement,\n  NonDeleted,\n  ExcalidrawGenericElement,\n} from \"../element/types\";\n\nimport { distance2d, isPathALoop, getGridPoint } from \"../math\";\n\nimport {\n  isWritableElement,\n  isInputLike,\n  isToolIcon,\n  debounce,\n  distance,\n  resetCursor,\n  viewportCoordsToSceneCoords,\n  sceneCoordsToViewportCoords,\n  setCursorForShape,\n  tupleToCoors,\n} from \"../utils\";\nimport {\n  KEYS,\n  isArrowKey,\n  getResizeCenterPointKey,\n  getResizeWithSidesSameLengthKey,\n  getRotateWithDiscreteAngleKey,\n} from \"../keys\";\n\nimport { findShapeByKey, shapesShortcutKeys } from \"../shapes\";\nimport { createHistory, SceneHistory } from \"../history\";\n\nimport ContextMenu from \"./ContextMenu\";\n\nimport { ActionManager } from \"../actions/manager\";\nimport \"../actions\";\nimport { actions } from \"../actions/register\";\n\nimport { ActionResult } from \"../actions/types\";\nimport { getDefaultAppState } from \"../appState\";\nimport { t, getLanguage } from \"../i18n\";\n\nimport {\n  copyToAppClipboard,\n  getClipboardContent,\n  probablySupportsClipboardBlob,\n  probablySupportsClipboardWriteText,\n} from \"../clipboard\";\nimport { normalizeScroll } from \"../scene\";\nimport { getCenter, getDistance } from \"../gesture\";\nimport { createUndoAction, createRedoAction } from \"../actions/actionHistory\";\n\nimport {\n  CURSOR_TYPE,\n  ELEMENT_SHIFT_TRANSLATE_AMOUNT,\n  ELEMENT_TRANSLATE_AMOUNT,\n  POINTER_BUTTON,\n  DRAGGING_THRESHOLD,\n  TEXT_TO_CENTER_SNAP_THRESHOLD,\n  LINE_CONFIRM_THRESHOLD,\n  SCENE,\n  EVENT,\n  ENV,\n  CANVAS_ONLY_ACTIONS,\n  DEFAULT_VERTICAL_ALIGN,\n  GRID_SIZE,\n  LOCAL_STORAGE_KEY_COLLAB_FORCE_FLAG,\n} from \"../constants\";\nimport {\n  INITAL_SCENE_UPDATE_TIMEOUT,\n  TAP_TWICE_TIMEOUT,\n  SYNC_FULL_SCENE_INTERVAL_MS,\n  TOUCH_CTX_MENU_TIMEOUT,\n} from \"../time_constants\";\n\nimport LayerUI from \"./LayerUI\";\nimport { ScrollBars, SceneState } from \"../scene/types\";\nimport { generateCollaborationLink, getCollaborationLinkData } from \"../data\";\nimport { mutateElement, newElementWith } from \"../element/mutateElement\";\nimport { invalidateShapeForElement } from \"../renderer/renderElement\";\nimport { unstable_batchedUpdates } from \"react-dom\";\nimport { SceneStateCallbackRemover } from \"../scene/globalScene\";\nimport { isLinearElement } from \"../element/typeChecks\";\nimport { actionFinalize, actionDeleteSelected } from \"../actions\";\nimport {\n  restoreUsernameFromLocalStorage,\n  saveUsernameToLocalStorage,\n} from \"../data/localStorage\";\n\nimport throttle from \"lodash.throttle\";\nimport { LinearElementEditor } from \"../element/linearElementEditor\";\nimport {\n  getSelectedGroupIds,\n  selectGroupsForSelectedElements,\n  isElementInGroup,\n  getSelectedGroupIdForElement,\n} from \"../groups\";\n\nimport axios from 'axios';\nimport { clearAppStateForLocalStorage } from \"../appState\";\nimport { resolveModuleNameFromCache } from \"typescript\";\n\n\n\n/**\n * @param func handler taking at most single parameter (event).\n */\nconst withBatchedUpdates = <\n  TFunction extends ((event: any) => void) | (() => void)\n>(\n  func: Parameters<TFunction>[\"length\"] extends 0 | 1 ? TFunction : never,\n) =>\n  ((event) => {\n    unstable_batchedUpdates(func as TFunction, event);\n  }) as TFunction;\n\nconst { history } = createHistory();\n\nlet didTapTwice: boolean = false;\nlet tappedTwiceTimer = 0;\nlet cursorX = 0;\nlet cursorY = 0;\nlet isHoldingSpace: boolean = false;\nlet isPanning: boolean = false;\nlet isDraggingScrollBar: boolean = false;\nlet currentScrollBars: ScrollBars = { horizontal: null, vertical: null };\nlet touchTimeout = 0;\nlet touchMoving = false;\n\nlet lastPointerUp: ((event: any) => void) | null = null;\nconst gesture: Gesture = {\n  pointers: new Map(),\n  lastCenter: null,\n  initialDistance: null,\n  initialScale: null,\n};\n\n\n\n\n// All this to add a function to the window?   .. OOF!\ndeclare global {\n  class CloudDocInfo{\n    id:number;\n    name:string;\n    dateLastSaved:Date;\n  }\n\n  // THE WINDOW\n\n/*\n -  The diffiuclty presented here is that we want to avoid an empty state\n     being saved to the Database.  We would assume that to prevent \n     this we would \n     \n     1) don't save if fetching the doc fails. \n\n    2) As an extra safeguard, don't save if all elements are blank.\n\n    3) \n\n\n\n*/\n\n  export interface Window {   // It may be that the functions should be declared here instead\n                       // of the body of typescript.\n                       // TS linter may be helpful here.\n    restoreFromURL(name: string): any; // implemented\n    SaveToURL(url:string,name: string): any; // implemented\n    listDocs():any; // lists cached docs - complains if there's no server \n    fetchDocs():any; // populates docs cache , depends on activcate cloud lists docs.\n    loadDoc(id:number,isRefresh?:boolean):any; // loads a doc by index from the server  \n    getVersions(id:number):any; // lists version for a given ID - not implemented servderside\n    saveAlt(id:number):any; \n    activateCloud(URL:string):any; // should set the server URL, then fetch + list the docs.\n    saveActiveDoc():any;\n    saveNewDoc(name:string):any;\n    activeDocIndex:number;\n    activeDocName:String;\n    isOnOldVersion:boolean;\n    isCloudConnected:boolean;\n    serverURL:string;\n    SaveDoc():any;\n    cloudDocs:CloudDocInfo[];\n    docsUpToDate:boolean;\n    OverwriteDoc():any;\n    lastHttpStatus:string;\n    lastSuccessfulPut:Date;\n    reloadDoc():any;\n  }\n}\n\n\n\n\n\n\n\n\n\n// ------ OOF!! \n\n\ntype PointerDownState = Readonly<{\n  // The first position at which pointerDown happened\n  origin: Readonly<{ x: number; y: number }>;\n  // Same as \"origin\" but snapped to the grid, if grid is on\n  originInGrid: Readonly<{ x: number; y: number }>;\n  // Scrollbar checks\n  scrollbars: ReturnType<typeof isOverScrollBars>;\n  // The previous pointer position\n  lastCoords: { x: number; y: number };\n  resize: {\n    // Handle when resizing, might change during the pointer interaction\n    handle: ReturnType<typeof resizeTest>;\n    // This is determined on the initial pointer down event\n    isResizing: boolean;\n    // This is determined on the initial pointer down event\n    offset: { x: number; y: number };\n    // This is determined on the initial pointer down event\n    arrowDirection: \"origin\" | \"end\";\n  };\n  hit: {\n    // The element the pointer is \"hitting\", is determined on the initial\n    // pointer down event\n    element: ExcalidrawElement | null;\n    // This is determined on the initial pointer down event\n    wasAddedToSelection: boolean;\n    // Whether selected element(s) were duplicated, might change during the\n    // pointer interation\n    hasBeenDuplicated: boolean;\n  };\n  drag: {\n    // Might change during the pointer interation\n    hasOccurred: boolean;\n    // Might change during the pointer interation\n    offset: { x: number; y: number } | null;\n  };\n  // We need to have these in the state so that we can unsubscribe them\n  eventListeners: {\n    // It's defined on the initial pointer down event\n    onMove: null | ((event: PointerEvent) => void);\n    // It's defined on the initial pointer down event\n    onUp: null | ((event: PointerEvent) => void);\n  };\n}>;\n\nclass App extends React.Component<ExcalidrawProps, AppState> {\n  canvas: HTMLCanvasElement | null = null;\n  rc: RoughCanvas | null = null;\n  portal: Portal = new Portal(this);\n  lastBroadcastedOrReceivedSceneVersion: number = -1;\n  broadcastedElementVersions: Map<string, number> = new Map();\n  removeSceneCallback: SceneStateCallbackRemover | null = null;\n  unmounted: boolean = false;\n  actionManager: ActionManager;\n\n  public static defaultProps: Partial<ExcalidrawProps> = {\n    width: window.innerWidth,\n    height: window.innerHeight,\n  };\n\n  \n\n  constructor(props: any) {\n    super(props);\n    const defaultAppState = getDefaultAppState();\n\n    const { width, height } = props;\n    this.state = {\n      ...defaultAppState,\n      isLoading: true,\n      width,\n      height,\n    };\n\n    this.actionManager = new ActionManager(\n      this.syncActionResult,\n      () => this.state,\n      () => globalSceneState.getElementsIncludingDeleted(),\n    );\n    this.actionManager.registerAll(actions);\n\n    this.actionManager.registerAction(createUndoAction(history));\n    this.actionManager.registerAction(createRedoAction(history));\n    \n\n    // I PUT IT HERE.\n    // window.OverwriteDoc = (id:number) => {  WILL IMPLEMENT EVENTUALLY BUT RN THERE's A WORKAROUND!\n    //     if (!window.isCloudConnected){\n    //       console.log(\"Can't do this if you aren't connected\");\n    //       return;\n    //     }\n    //     window.activeDocIndex = id;\n    //     window.saveActiveDoc();\n    // }\n\n    /*\n       Dotnet is still far from ideal in terms of a development language\n       There are definately very helpful things about it, but the developer\n       culture of accepting the barriers to intuitive understanding\n       can be somewhat detrimental to actually getting things done \n       quickly and effectively. \n    */\n\n\n    window.SaveToURL = async (url:string,name?:string) => {\n\n      // This method is synchronous up until the post request.\n      \n      let appState = clearAppStateForLocalStorage(this.state);\n      let elements = globalSceneState.getElements();\n\n      let appStateJSON = JSON.stringify(appState)\n      let elementsJSON = JSON.stringify(elements)\n      let update = false;\n\n      let statCodeString\n      let codeLeadingDigit\n\n      if(name == \"\" || name == undefined){ // this is hacky AF\n        update = true;\n       }\n\n       if (elements.length == 0 && update == true){\n        console.log(\"aborting save, elements array was empty.\");\n       return;\n     }  \n\n       let reqData =  {\n        elements:elementsJSON,\n        state:appStateJSON,\n        lastSaved:window.lastSuccessfulPut.toISOString(),\n      }\n\n      let result =  await axios({ // hopefully this returns the ID. \n        method: update?'put':'post',\n        url: url,\n        headers: {\n          'Access-Control-Allow-Origin': '*',\n          'Content-Type':'application/json'\n        },\n        // add the ID only if this is an update and the activeDocIndex isn't -1\n        data:((update && window.activeDocIndex !=-1)?{...reqData,id:window.activeDocIndex}:{...reqData,name:name,}),\n        }\n      );\n      //  Blatent violation of dry :)  here twice because one is broken, I don't know which though.\n      window.lastHttpStatus = result.status+\"\"\n      let leadingDigit = window.lastHttpStatus.substr(0,1);\n      if(leadingDigit === \"2\"){\n        window.lastSuccessfulPut = new Date();\n      }\n\n       statCodeString = result.status+\"\"\n       codeLeadingDigit = statCodeString.substr(0,1)\n      if(codeLeadingDigit == \"2\"){\n        window.lastSuccessfulPut = new Date();\n      }\n    \n      \n      return result;\n    };\n    // \n\n    window.restoreFromURL = async (url: string) => {\n      this.setState({\n        isLoading: true\n      });\n\n      let scene = await loadScene(url);\n      this.syncActionResult(scene);\n\n      this.setState({\n        isLoading: false\n      });\n  }; \n\n    window.fetchDocs = async () => {\n      // needs to fetch the docs list from the server,\n      // but that hasn't been set yet so.\n      let response = await axios.get(window.serverURL+\"/names\")\n      // should auto map\n      window.cloudDocs = response.data;\n      console.log(window.cloudDocs.length + \"records fetched\");\n      return response.data;\n  };\n\n    window.listDocs = async () => {\n      if(window.cloudDocs){\n          window.cloudDocs.forEach((e) => \n        {console.log(`${e.id} ${e.name} ${e.dateLastSaved}`)});\n      }\n    }\n\n    window.activateCloud = async (url: string) => {\n     // needs to set the serverURL value.\n     console.log(\"Cloud server is now\" + url);\n     window.serverURL = url;\n     await window.fetchDocs();\n     await window.listDocs();  \n     window.isCloudConnected = true;\n     window.activeDocIndex = -1;\n     window.lastSuccessfulPut = new Date(1970,1,1);\n     // this may not belong here.\n     let href = window.location.href\n     if (href.indexOf('?') != -1){\n      const urlParams = new URLSearchParams(window.location.search);\n      const docToLoad =  Number.parseInt(urlParams.get('docId')+\"\")\n      await window.loadDoc(docToLoad);\n     }\n\n  };\n\n  window.saveActiveDoc = async () => {\n    let response;\n    if(window.activeDocIndex>0){\n       response = await window.SaveToURL(window.serverURL+\"/\"+window.activeDocIndex,\"\")\n      } else {\n        console.log(\"save failed, no active doc\")\n      }\n      if(response.status == 400){\n        console.log(\"Doc is out of date, fetching latest version\")\n        window.loadDoc(window.activeDocIndex,true);\n      }\n\n      return response; // Hack to ensure things are executed in order, find a better way to do this.\n  }\n\n  \n\n  window.loadDoc = async (id:number,isRefresh?:boolean) => {\n\n    // add exception handling for if you put the wrong number in here.\n\n    // Save the previous document if one was open\n    if(window.isCloudConnected && window.activeDocIndex>0 && (isRefresh == undefined || isRefresh == false)){\n      let s = await window.saveActiveDoc();\n      window.activeDocIndex = -1;\n    }\n    \n    try {\n    let req = await window.restoreFromURL(window.serverURL+\"/\"+id);\n    window.activeDocIndex = id;\n    window.isCloudConnected = true;\n\n    if(window.location.search.indexOf (\"docId\") == -1){\n      let params = new URLSearchParams(window.location.search)\n      params.set(\"docId\",id+\"\")\n      const newurl = window.location.protocol + \"//\" + window.location.host + window.location.pathname + params.toString();\n      window.history.pushState({path:newurl},'',newurl);\n    }\n\n    window.activeDocName = window.cloudDocs.filter(e => {return e.id=id})[0].name;\n\n    console.log(`document number ${id} restored! from cloud.`)\n  }\n    catch {\n      console.log(\" I'm sorryworry senpai, I couldn't fetch the document ~UwU\")\n    }\n  }\n\n  window.reloadDoc = () => {\n    if(window.activeDocIndex == -1){\n      console.log(\"there is no loaded doc!\")\n      return\n    }\n\n    window.loadDoc(window.activeDocIndex);\n  }\n    \n  window.saveNewDoc = async (name:string) => {\n      if(name == \"\"){\n        console.log(\"can't save document without a name\")\n        return\n      }\n      try{\n\n       let l = await window.SaveToURL(window.serverURL,name);\n      \n       window.activeDocIndex = -1;\n       await window.loadDoc(l.data.id);  // name collision? \n      console.log(`new doc saved with id: ${l.data.id}`)\n      }\n      catch(e){\n        console.log(\"unable to save doc\");\n        if (e) console.log(e);\n    }\n  }\n   window.activateCloud(\"http://\"+window.location.host + \"/excalidrawapi/Excalidraw\");\n\n\n}\n\n  public render() {\n    const {\n      zenModeEnabled,\n      width: canvasDOMWidth,\n      height: canvasDOMHeight,\n    } = this.state;\n\n    const canvasScale = window.devicePixelRatio;\n\n    const canvasWidth = canvasDOMWidth * canvasScale;\n    const canvasHeight = canvasDOMHeight * canvasScale;\n\n    return (\n      <div className=\"excalidraw\">\n        <LayerUI\n          canvas={this.canvas}\n          appState={this.state}\n          setAppState={this.setAppState}\n          actionManager={this.actionManager}\n          elements={globalSceneState.getElements()}\n          onRoomCreate={this.openPortal}\n          onRoomDestroy={this.closePortal}\n          onUsernameChange={(username) => {\n            saveUsernameToLocalStorage(username);\n            this.setState({\n              username,\n            });\n          }}\n          onLockToggle={this.toggleLock}\n          onInsertShape={(elements) =>\n            this.addElementsFromPasteOrLibrary(elements)\n          }\n          zenModeEnabled={zenModeEnabled}\n          toggleZenMode={this.toggleZenMode}\n          lng={getLanguage().lng}\n        />\n        <main>\n          <canvas\n            id=\"canvas\"\n            style={{\n              width: canvasDOMWidth,\n              height: canvasDOMHeight,\n            }}\n            width={canvasWidth}\n            height={canvasHeight}\n            ref={this.handleCanvasRef}\n            onContextMenu={this.handleCanvasContextMenu}\n            onPointerDown={this.handleCanvasPointerDown}\n            onDoubleClick={this.handleCanvasDoubleClick}\n            onPointerMove={this.handleCanvasPointerMove}\n            onPointerUp={this.removePointer}\n            onPointerCancel={this.removePointer}\n            onTouchMove={this.handleTouchMove}\n            onDrop={this.handleCanvasOnDrop}\n          >\n            {t(\"labels.drawingCanvas\")}\n          </canvas>\n        </main>\n      </div>\n    );\n  }\n\n  private syncActionResult = withBatchedUpdates(\n    (actionResult: ActionResult) => {\n      if (this.unmounted || actionResult === false) {\n        return;\n      }\n\n      let editingElement: AppState[\"editingElement\"] | null = null;\n      if (actionResult.elements) {\n        actionResult.elements.forEach((element) => {\n          if (\n            this.state.editingElement?.id === element.id &&\n            this.state.editingElement !== element &&\n            isNonDeletedElement(element)\n          ) {\n            editingElement = element;\n          }\n        });\n        globalSceneState.replaceAllElements(actionResult.elements);\n        if (actionResult.commitToHistory) {\n          history.resumeRecording();\n        }\n      }\n\n      if (actionResult.appState || editingElement) {\n        if (actionResult.commitToHistory) {\n          history.resumeRecording();\n        }\n        this.setState(\n          (state) => ({\n            ...actionResult.appState,\n            editingElement:\n              editingElement || actionResult.appState?.editingElement || null,\n            isCollaborating: state.isCollaborating,\n            collaborators: state.collaborators,\n          }),\n          () => {\n            if (actionResult.syncHistory) {\n              history.setCurrentState(\n                this.state,\n                globalSceneState.getElementsIncludingDeleted(),\n              );\n            }\n          },\n        );\n      }\n    },\n  );\n\n  // Lifecycle\n\n  private onBlur = withBatchedUpdates(() => {\n    isHoldingSpace = false;\n    this.saveDebounced();\n    this.saveDebounced.flush();\n  });\n\n  private onUnload = () => {\n    this.destroySocketClient();\n    this.onBlur();\n  };\n\n  private disableEvent: EventHandlerNonNull = (event) => {\n    event.preventDefault();\n  };\n\n  private onFontLoaded = () => {\n    globalSceneState.getElementsIncludingDeleted().forEach((element) => {\n      if (isTextElement(element)) {\n        invalidateShapeForElement(element);\n      }\n    });\n    this.onSceneUpdated();\n  };\n\n  private shouldForceLoadScene(\n    scene: ResolutionType<typeof loadScene>,\n  ): boolean {\n    if (!scene.elements.length) {\n      return true;\n    }\n\n    const roomMatch = getCollaborationLinkData(window.location.href);\n\n    if (!roomMatch) {\n      return false;\n    }\n    const collabForceLoadFlag = localStorage.getItem(\n      LOCAL_STORAGE_KEY_COLLAB_FORCE_FLAG,\n    );\n    if (collabForceLoadFlag) {\n      try {\n        const {\n          room: previousRoom,\n          timestamp,\n        }: { room: string; timestamp: number } = JSON.parse(\n          collabForceLoadFlag,\n        );\n        // if loading same room as the one previously unloaded within 15sec\n        //  force reload without prompting\n        if (previousRoom === roomMatch[1] && Date.now() - timestamp < 15000) {\n          return true;\n        }\n      } catch {}\n    }\n    return false;\n  }\n\n  private initializeScene = async () => {\n    const searchParams = new URLSearchParams(window.location.search);\n    const id = searchParams.get(\"id\");\n    const jsonMatch = window.location.hash.match(\n      /^#json=([0-9]+),([a-zA-Z0-9_-]+)$/,\n    );\n\n    if (!this.state.isLoading) {\n      this.setState({ isLoading: true });\n    }\n\n    let scene = await loadScene(null);\n\n    let isCollaborationScene = !!getCollaborationLinkData(window.location.href);\n    const isExternalScene = !!(id || jsonMatch || isCollaborationScene);\n\n    if (isExternalScene) {\n      if (\n        this.shouldForceLoadScene(scene) ||\n        window.confirm(t(\"alerts.loadSceneOverridePrompt\"))\n      ) {\n        // Backwards compatibility with legacy url format\n        if (id) {\n          scene = await loadScene(id);\n        } else if (jsonMatch) {\n          scene = await loadScene(jsonMatch[1], jsonMatch[2]);\n        }\n        if (!isCollaborationScene) {\n          window.history.replaceState({}, \"Excalidraw\", window.location.origin);\n        }\n      } else {\n        isCollaborationScene = false;\n        window.history.replaceState({}, \"Excalidraw\", window.location.origin);\n      }\n    }\n\n    if (this.state.isLoading) {\n      this.setState({ isLoading: false });\n    }\n\n    if (isCollaborationScene) {\n      this.initializeSocketClient({ showLoadingState: true });\n    } else if (scene) {\n      this.syncActionResult(scene);\n    }\n  };\n\n  public async componentDidMount() {\n    if (\n      process.env.NODE_ENV === ENV.TEST ||\n      process.env.NODE_ENV === ENV.DEVELOPMENT\n    ) {\n      const setState = this.setState.bind(this);\n      Object.defineProperties(window.h, {\n        state: {\n          configurable: true,\n          get: () => {\n            return this.state;\n          },\n        },\n        setState: {\n          configurable: true,\n          value: (...args: Parameters<typeof setState>) => {\n            return this.setState(...args);\n          },\n        },\n        app: {\n          configurable: true,\n          value: this,\n        },\n      });\n    }\n\n    this.removeSceneCallback = globalSceneState.addCallback(\n      this.onSceneUpdated,\n    );\n\n    this.addEventListeners();\n    this.initializeScene();\n  }\n\n  public componentWillUnmount() {\n    this.unmounted = true;\n    this.removeSceneCallback!();\n    this.removeEventListeners();\n\n    clearTimeout(touchTimeout);\n  }\n\n  private onResize = withBatchedUpdates(() => {\n    globalSceneState\n      .getElementsIncludingDeleted()\n      .forEach((element) => invalidateShapeForElement(element));\n    this.setState({});\n  });\n\n  private onHashChange = (event: HashChangeEvent) => {\n    if (window.location.hash.length > 1) {\n      this.initializeScene();\n    }\n  };\n\n  private removeEventListeners() {\n    document.removeEventListener(EVENT.COPY, this.onCopy);\n    document.removeEventListener(EVENT.PASTE, this.pasteFromClipboard);\n    document.removeEventListener(EVENT.CUT, this.onCut);\n\n    document.removeEventListener(EVENT.KEYDOWN, this.onKeyDown, false);\n    document.removeEventListener(\n      EVENT.MOUSE_MOVE,\n      this.updateCurrentCursorPosition,\n      false,\n    );\n    document.removeEventListener(EVENT.KEYUP, this.onKeyUp);\n    window.removeEventListener(EVENT.RESIZE, this.onResize, false);\n    window.removeEventListener(EVENT.UNLOAD, this.onUnload, false);\n    window.removeEventListener(EVENT.BLUR, this.onBlur, false);\n    window.removeEventListener(EVENT.DRAG_OVER, this.disableEvent, false);\n    window.removeEventListener(EVENT.DROP, this.disableEvent, false);\n    window.removeEventListener(EVENT.HASHCHANGE, this.onHashChange, false);\n\n    document.removeEventListener(\n      EVENT.GESTURE_START,\n      this.onGestureStart as any,\n      false,\n    );\n    document.removeEventListener(\n      EVENT.GESTURE_CHANGE,\n      this.onGestureChange as any,\n      false,\n    );\n    document.removeEventListener(\n      EVENT.GESTURE_END,\n      this.onGestureEnd as any,\n      false,\n    );\n    window.removeEventListener(EVENT.BEFORE_UNLOAD, this.beforeUnload);\n  }\n\n  private addEventListeners() {\n    document.addEventListener(EVENT.COPY, this.onCopy);\n    document.addEventListener(EVENT.PASTE, this.pasteFromClipboard);\n    document.addEventListener(EVENT.CUT, this.onCut);\n\n    document.addEventListener(EVENT.KEYDOWN, this.onKeyDown, false);\n    document.addEventListener(EVENT.KEYUP, this.onKeyUp, { passive: true });\n    document.addEventListener(\n      EVENT.MOUSE_MOVE,\n      this.updateCurrentCursorPosition,\n    );\n    window.addEventListener(EVENT.RESIZE, this.onResize, false);\n    window.addEventListener(EVENT.UNLOAD, this.onUnload, false);\n    window.addEventListener(EVENT.BLUR, this.onBlur, false);\n    window.addEventListener(EVENT.DRAG_OVER, this.disableEvent, false);\n    window.addEventListener(EVENT.DROP, this.disableEvent, false);\n    window.addEventListener(EVENT.HASHCHANGE, this.onHashChange, false);\n\n    // rerender text elements on font load to fix #637 && #1553\n    document.fonts?.addEventListener?.(\"loadingdone\", this.onFontLoaded);\n\n    // Safari-only desktop pinch zoom\n    document.addEventListener(\n      EVENT.GESTURE_START,\n      this.onGestureStart as any,\n      false,\n    );\n    document.addEventListener(\n      EVENT.GESTURE_CHANGE,\n      this.onGestureChange as any,\n      false,\n    );\n    document.addEventListener(\n      EVENT.GESTURE_END,\n      this.onGestureEnd as any,\n      false,\n    );\n    window.addEventListener(EVENT.BEFORE_UNLOAD, this.beforeUnload);\n  }\n\n  private beforeUnload = withBatchedUpdates((event: BeforeUnloadEvent) => {\n    if (this.state.isCollaborating && this.portal.roomID) {\n      localStorage.setItem(\n        LOCAL_STORAGE_KEY_COLLAB_FORCE_FLAG,\n        JSON.stringify({\n          timestamp: Date.now(),\n          room: this.portal.roomID,\n        }),\n      );\n    }\n    if (\n      this.state.isCollaborating &&\n      globalSceneState.getElements().length > 0\n    ) {\n      event.preventDefault();\n      // NOTE: modern browsers no longer allow showing a custom message here\n      event.returnValue = \"\";\n    }\n  });\n\n  queueBroadcastAllElements = throttle(() => {\n    this.broadcastScene(SCENE.UPDATE, /* syncAll */ true);\n  }, SYNC_FULL_SCENE_INTERVAL_MS);\n\n  componentDidUpdate(prevProps: ExcalidrawProps) {\n    const { width: prevWidth, height: prevHeight } = prevProps;\n    const { width: currentWidth, height: currentHeight } = this.props;\n    if (prevWidth !== currentWidth || prevHeight !== currentHeight) {\n      this.setState({\n        width: currentWidth,\n        height: currentHeight,\n      });\n    }\n\n    if (this.state.isCollaborating && !this.portal.socket) {\n      this.initializeSocketClient({ showLoadingState: true });\n    }\n\n    if (\n      this.state.editingLinearElement &&\n      !this.state.selectedElementIds[this.state.editingLinearElement.elementId]\n    ) {\n      // defer so that the commitToHistory flag isn't reset via current update\n      setTimeout(() => {\n        this.actionManager.executeAction(actionFinalize);\n      });\n    }\n\n    const cursorButton: {\n      [id: string]: string | undefined;\n    } = {};\n    const pointerViewportCoords: SceneState[\"remotePointerViewportCoords\"] = {};\n    const remoteSelectedElementIds: SceneState[\"remoteSelectedElementIds\"] = {};\n    const pointerUsernames: { [id: string]: string } = {};\n    this.state.collaborators.forEach((user, socketID) => {\n      if (user.selectedElementIds) {\n        for (const id of Object.keys(user.selectedElementIds)) {\n          if (!(id in remoteSelectedElementIds)) {\n            remoteSelectedElementIds[id] = [];\n          }\n          remoteSelectedElementIds[id].push(socketID);\n        }\n      }\n      if (!user.pointer) {\n        return;\n      }\n      if (user.username) {\n        pointerUsernames[socketID] = user.username;\n      }\n      pointerViewportCoords[socketID] = sceneCoordsToViewportCoords(\n        {\n          sceneX: user.pointer.x,\n          sceneY: user.pointer.y,\n        },\n        this.state,\n        this.canvas,\n        window.devicePixelRatio,\n      );\n      cursorButton[socketID] = user.button;\n    });\n    const elements = globalSceneState.getElements();\n    const { atLeastOneVisibleElement, scrollBars } = renderScene(\n      elements.filter((element) => {\n        // don't render text element that's being currently edited (it's\n        //  rendered on remote only)\n        return (\n          !this.state.editingElement ||\n          this.state.editingElement.type !== \"text\" ||\n          element.id !== this.state.editingElement.id\n        );\n      }),\n      this.state,\n      this.state.selectionElement,\n      window.devicePixelRatio,\n      this.rc!,\n      this.canvas!,\n      {\n        scrollX: this.state.scrollX,\n        scrollY: this.state.scrollY,\n        viewBackgroundColor: this.state.viewBackgroundColor,\n        zoom: this.state.zoom,\n        remotePointerViewportCoords: pointerViewportCoords,\n        remotePointerButton: cursorButton,\n        remoteSelectedElementIds: remoteSelectedElementIds,\n        remotePointerUsernames: pointerUsernames,\n        shouldCacheIgnoreZoom: this.state.shouldCacheIgnoreZoom,\n      },\n      {\n        renderOptimizations: true,\n      },\n    );\n    if (scrollBars) {\n      currentScrollBars = scrollBars;\n    }\n    const scrolledOutside =\n      // hide when editing text\n      this.state.editingElement?.type === \"text\"\n        ? false\n        : !atLeastOneVisibleElement && elements.length > 0;\n    if (this.state.scrolledOutside !== scrolledOutside) {\n      this.setState({ scrolledOutside: scrolledOutside });\n    }\n    this.saveDebounced();\n\n    if (\n      getDrawingVersion(globalSceneState.getElementsIncludingDeleted()) >\n      this.lastBroadcastedOrReceivedSceneVersion\n    ) {\n      this.broadcastScene(SCENE.UPDATE, /* syncAll */ false);\n      this.queueBroadcastAllElements();\n    }\n\n    history.record(this.state, globalSceneState.getElementsIncludingDeleted());\n  }\n\n  // Copy/paste\n\n  private onCut = withBatchedUpdates((event: ClipboardEvent) => {\n    if (isWritableElement(event.target)) {\n      return;\n    }\n    this.copyAll();\n    this.actionManager.executeAction(actionDeleteSelected);\n    event.preventDefault();\n  });\n\n  private onCopy = withBatchedUpdates((event: ClipboardEvent) => {\n    if (isWritableElement(event.target)) {\n      return;\n    }\n    this.copyAll();\n    event.preventDefault();\n  });\n\n  private copyAll = () => {\n    copyToAppClipboard(globalSceneState.getElements(), this.state);\n  };\n\n  private copyToClipboardAsPng = () => {\n    const elements = globalSceneState.getElements();\n\n    const selectedElements = getSelectedElements(elements, this.state);\n    exportCanvas(\n      \"clipboard\",\n      selectedElements.length ? selectedElements : elements,\n      this.state,\n      this.canvas!,\n      this.state,\n    );\n  };\n\n  private copyToClipboardAsSvg = () => {\n    const selectedElements = getSelectedElements(\n      globalSceneState.getElements(),\n      this.state,\n    );\n    exportCanvas(\n      \"clipboard-svg\",\n      selectedElements.length\n        ? selectedElements\n        : globalSceneState.getElements(),\n      this.state,\n      this.canvas!,\n      this.state,\n    );\n  };\n\n  private static resetTapTwice() {\n    didTapTwice = false;\n  }\n\n  private onTapStart = (event: TouchEvent) => {\n    if (!didTapTwice) {\n      didTapTwice = true;\n      clearTimeout(tappedTwiceTimer);\n      tappedTwiceTimer = window.setTimeout(\n        App.resetTapTwice,\n        TAP_TWICE_TIMEOUT,\n      );\n      return;\n    }\n    // insert text only if we tapped twice with a single finger\n    // event.touches.length === 1 will also prevent inserting text when user's zooming\n    if (didTapTwice && event.touches.length === 1) {\n      const [touch] = event.touches;\n      // @ts-ignore\n      this.handleCanvasDoubleClick({\n        clientX: touch.clientX,\n        clientY: touch.clientY,\n      });\n      didTapTwice = false;\n      clearTimeout(tappedTwiceTimer);\n    }\n    event.preventDefault();\n    if (event.touches.length === 2) {\n      this.setState({\n        selectedElementIds: {},\n      });\n    }\n  };\n\n  private onTapEnd = (event: TouchEvent) => {\n    event.preventDefault();\n    if (event.touches.length > 0) {\n      const { previousSelectedElementIds } = this.state;\n      this.setState({\n        previousSelectedElementIds: {},\n        selectedElementIds: previousSelectedElementIds,\n      });\n    }\n  };\n\n  private pasteFromClipboard = withBatchedUpdates(\n    async (event: ClipboardEvent | null) => {\n      // #686\n      const target = document.activeElement;\n      const elementUnderCursor = document.elementFromPoint(cursorX, cursorY);\n      if (\n        // if no ClipboardEvent supplied, assume we're pasting via contextMenu\n        //  thus these checks don't make sense\n        event &&\n        (!(elementUnderCursor instanceof HTMLCanvasElement) ||\n          isWritableElement(target))\n      ) {\n        return;\n      }\n      const data = await getClipboardContent(\n        this.state,\n        cursorX,\n        cursorY,\n        event,\n      );\n      if (data.error) {\n        alert(data.error);\n      } else if (data.elements) {\n        this.addElementsFromPasteOrLibrary(data.elements);\n      } else if (data.text) {\n        this.addTextFromPaste(data.text);\n      }\n      this.selectShapeTool(\"selection\");\n      event?.preventDefault();\n    },\n  );\n\n  private addElementsFromPasteOrLibrary = (\n    clipboardElements: readonly ExcalidrawElement[],\n    clientX = cursorX,\n    clientY = cursorY,\n  ) => {\n    const [minX, minY, maxX, maxY] = getCommonBounds(clipboardElements);\n\n    const elementsCenterX = distance(minX, maxX) / 2;\n    const elementsCenterY = distance(minY, maxY) / 2;\n\n    const { x, y } = viewportCoordsToSceneCoords(\n      { clientX, clientY },\n      this.state,\n      this.canvas,\n      window.devicePixelRatio,\n    );\n\n    const dx = x - elementsCenterX;\n    const dy = y - elementsCenterY;\n    const groupIdMap = new Map();\n\n    const newElements = clipboardElements.map((element) =>\n      duplicateElement(this.state.editingGroupId, groupIdMap, element, {\n        x: element.x + dx - minX,\n        y: element.y + dy - minY,\n      }),\n    );\n\n    globalSceneState.replaceAllElements([\n      ...globalSceneState.getElementsIncludingDeleted(),\n      ...newElements,\n    ]);\n    history.resumeRecording();\n    this.setState({\n      isLibraryOpen: false,\n      selectedElementIds: newElements.reduce((map, element) => {\n        map[element.id] = true;\n        return map;\n      }, {} as any),\n    });\n  };\n\n  private addTextFromPaste(text: any) {\n    const { x, y } = viewportCoordsToSceneCoords(\n      { clientX: cursorX, clientY: cursorY },\n      this.state,\n      this.canvas,\n      window.devicePixelRatio,\n    );\n\n    const element = newTextElement({\n      x: x,\n      y: y,\n      strokeColor: this.state.currentItemStrokeColor,\n      backgroundColor: this.state.currentItemBackgroundColor,\n      fillStyle: this.state.currentItemFillStyle,\n      strokeWidth: this.state.currentItemStrokeWidth,\n      strokeStyle: this.state.currentItemStrokeStyle,\n      roughness: this.state.currentItemRoughness,\n      opacity: this.state.currentItemOpacity,\n      text: text,\n      fontSize: this.state.currentItemFontSize,\n      fontFamily: this.state.currentItemFontFamily,\n      textAlign: this.state.currentItemTextAlign,\n      verticalAlign: DEFAULT_VERTICAL_ALIGN,\n    });\n\n    globalSceneState.replaceAllElements([\n      ...globalSceneState.getElementsIncludingDeleted(),\n      element,\n    ]);\n    this.setState({ selectedElementIds: { [element.id]: true } });\n    history.resumeRecording();\n  }\n\n  // Collaboration\n\n  setAppState = (obj: any) => {\n    this.setState(obj);\n  };\n\n  removePointer = (event: React.PointerEvent<HTMLElement>) => {\n    // remove touch handler for context menu on touch devices\n    if (event.pointerType === \"touch\" && touchTimeout) {\n      clearTimeout(touchTimeout);\n      touchMoving = false;\n    }\n\n    gesture.pointers.delete(event.pointerId);\n  };\n\n  openPortal = async () => {\n    window.history.pushState(\n      {},\n      \"Excalidraw\",\n      await generateCollaborationLink(),\n    );\n    this.initializeSocketClient({ showLoadingState: false });\n  };\n\n  closePortal = () => {\n    window.history.pushState({}, \"Excalidraw\", window.location.origin);\n    this.destroySocketClient();\n  };\n\n  toggleLock = () => {\n    this.setState((prevState) => ({\n      elementLocked: !prevState.elementLocked,\n      elementType: prevState.elementLocked\n        ? \"selection\"\n        : prevState.elementType,\n    }));\n  };\n\n  toggleZenMode = () => {\n    this.setState({\n      zenModeEnabled: !this.state.zenModeEnabled,\n    });\n  };\n\n  toggleGridMode = () => {\n    this.setState({\n      gridSize: this.state.gridSize ? null : GRID_SIZE,\n    });\n  };\n\n  private destroySocketClient = () => {\n    this.setState({\n      isCollaborating: false,\n      collaborators: new Map(),\n    });\n    this.portal.close();\n  };\n\n  private initializeSocketClient = async (opts: {\n    showLoadingState: boolean;\n  }) => {\n    if (this.portal.socket) {\n      return;\n    }\n    const roomMatch = getCollaborationLinkData(window.location.href);\n    if (roomMatch) {\n      const initialize = () => {\n        this.portal.socketInitialized = true;\n        clearTimeout(initializationTimer);\n        if (this.state.isLoading && !this.unmounted) {\n          this.setState({ isLoading: false });\n        }\n      };\n      // fallback in case you're not alone in the room but still don't receive\n      //  initial SCENE_UPDATE message\n      const initializationTimer = setTimeout(\n        initialize,\n        INITAL_SCENE_UPDATE_TIMEOUT,\n      );\n\n      const updateScene = (\n        decryptedData: SocketUpdateDataSource[SCENE.INIT | SCENE.UPDATE],\n        { scrollToContent = false }: { scrollToContent?: boolean } = {},\n      ) => {\n        const { elements: remoteElements } = decryptedData.payload;\n\n        if (scrollToContent) {\n          this.setState({\n            ...this.state,\n            ...calculateScrollCenter(\n              remoteElements.filter((element: { isDeleted: boolean }) => {\n                return !element.isDeleted;\n              }),\n              this.state,\n              this.canvas,\n            ),\n          });\n        }\n\n        // Perform reconciliation - in collaboration, if we encounter\n        // elements with more staler versions than ours, ignore them\n        // and keep ours.\n        if (\n          globalSceneState.getElementsIncludingDeleted() == null ||\n          globalSceneState.getElementsIncludingDeleted().length === 0\n        ) {\n          globalSceneState.replaceAllElements(remoteElements);\n        } else {\n          // create a map of ids so we don't have to iterate\n          // over the array more than once.\n          const localElementMap = getElementMap(\n            globalSceneState.getElementsIncludingDeleted(),\n          );\n\n          // Reconcile\n          const newElements = remoteElements\n            .reduce((elements, element) => {\n              // if the remote element references one that's currently\n              //  edited on local, skip it (it'll be added in the next\n              //  step)\n              if (\n                element.id === this.state.editingElement?.id ||\n                element.id === this.state.resizingElement?.id ||\n                element.id === this.state.draggingElement?.id\n              ) {\n                return elements;\n              }\n\n              if (\n                localElementMap.hasOwnProperty(element.id) &&\n                localElementMap[element.id].version > element.version\n              ) {\n                elements.push(localElementMap[element.id]);\n                delete localElementMap[element.id];\n              } else if (\n                localElementMap.hasOwnProperty(element.id) &&\n                localElementMap[element.id].version === element.version &&\n                localElementMap[element.id].versionNonce !==\n                  element.versionNonce\n              ) {\n                // resolve conflicting edits deterministically by taking the one with the lowest versionNonce\n                if (\n                  localElementMap[element.id].versionNonce <\n                  element.versionNonce\n                ) {\n                  elements.push(localElementMap[element.id]);\n                } else {\n                  // it should be highly unlikely that the two versionNonces are the same. if we are\n                  // really worried about this, we can replace the versionNonce with the socket id.\n                  elements.push(element);\n                }\n                delete localElementMap[element.id];\n              } else {\n                elements.push(element);\n                delete localElementMap[element.id];\n              }\n\n              return elements;\n            }, [] as Mutable<typeof remoteElements>)\n            // add local elements that weren't deleted or on remote\n            .concat(...Object.values(localElementMap));\n\n          // Avoid broadcasting to the rest of the collaborators the scene\n          // we just received!\n          // Note: this needs to be set before replaceAllElements as it\n          // syncronously calls render.\n          this.lastBroadcastedOrReceivedSceneVersion = getDrawingVersion(\n            newElements,\n          );\n\n          globalSceneState.replaceAllElements(newElements);\n        }\n\n        // We haven't yet implemented multiplayer undo functionality, so we clear the undo stack\n        // when we receive any messages from another peer. This UX can be pretty rough -- if you\n        // undo, a user makes a change, and then try to redo, your element(s) will be lost. However,\n        // right now we think this is the right tradeoff.\n        history.clear();\n        if (!this.portal.socketInitialized) {\n          initialize();\n        }\n      };\n\n      const { default: socketIOClient }: any = await import(\n        /* webpackChunkName: \"socketIoClient\" */ \"socket.io-client\"\n      );\n\n      this.portal.open(\n        socketIOClient(SOCKET_SERVER),\n        roomMatch[1],\n        roomMatch[2],\n      );\n\n      // All socket listeners are moving to Portal\n      this.portal.socket!.on(\n        \"client-broadcast\",\n        async (encryptedData: ArrayBuffer, iv: Uint8Array) => {\n          if (!this.portal.roomKey) {\n            return;\n          }\n          const decryptedData = await decryptAESGEM(\n            encryptedData,\n            this.portal.roomKey,\n            iv,\n          );\n\n          switch (decryptedData.type) {\n            case \"INVALID_RESPONSE\":\n              return;\n            case SCENE.INIT: {\n              if (!this.portal.socketInitialized) {\n                updateScene(decryptedData, { scrollToContent: true });\n              }\n              break;\n            }\n            case SCENE.UPDATE:\n              updateScene(decryptedData);\n              break;\n            case \"MOUSE_LOCATION\": {\n              const {\n                socketID,\n                pointerCoords,\n                button,\n                username,\n                selectedElementIds,\n              } = decryptedData.payload;\n              this.setState((state) => {\n                if (!state.collaborators.has(socketID)) {\n                  state.collaborators.set(socketID, {});\n                }\n                const user = state.collaborators.get(socketID)!;\n                user.pointer = pointerCoords;\n                user.button = button;\n                user.selectedElementIds = selectedElementIds;\n                user.username = username;\n                state.collaborators.set(socketID, user);\n                return state;\n              });\n              break;\n            }\n          }\n        },\n      );\n      this.portal.socket!.on(\"first-in-room\", () => {\n        if (this.portal.socket) {\n          this.portal.socket.off(\"first-in-room\");\n        }\n        initialize();\n      });\n\n      this.setState({\n        isCollaborating: true,\n        isLoading: opts.showLoadingState ? true : this.state.isLoading,\n      });\n    }\n  };\n\n  // Portal-only\n  setCollaborators(sockets: string[]) {\n    this.setState((state) => {\n      const collaborators: typeof state.collaborators = new Map();\n      for (const socketID of sockets) {\n        if (state.collaborators.has(socketID)) {\n          collaborators.set(socketID, state.collaborators.get(socketID)!);\n        } else {\n          collaborators.set(socketID, {});\n        }\n      }\n      return {\n        ...state,\n        collaborators,\n      };\n    });\n  }\n\n  private broadcastMouseLocation = (payload: {\n    pointerCoords: SocketUpdateDataSource[\"MOUSE_LOCATION\"][\"payload\"][\"pointerCoords\"];\n    button: SocketUpdateDataSource[\"MOUSE_LOCATION\"][\"payload\"][\"button\"];\n  }) => {\n    if (this.portal.socket?.id) {\n      const data: SocketUpdateDataSource[\"MOUSE_LOCATION\"] = {\n        type: \"MOUSE_LOCATION\",\n        payload: {\n          socketID: this.portal.socket.id,\n          pointerCoords: payload.pointerCoords,\n          button: payload.button || \"up\",\n          selectedElementIds: this.state.selectedElementIds,\n          username: this.state.username,\n        },\n      };\n      return this.portal._broadcastSocketData(\n        data as SocketUpdateData,\n        true, // volatile\n      );\n    }\n  };\n\n  // maybe should move to Portal\n  broadcastScene = (sceneType: SCENE.INIT | SCENE.UPDATE, syncAll: boolean) => {\n    if (sceneType === SCENE.INIT && !syncAll) {\n      throw new Error(\"syncAll must be true when sending SCENE.INIT\");\n    }\n\n    let syncableElements = getSyncableElements(\n      globalSceneState.getElementsIncludingDeleted(),\n    );\n\n    if (!syncAll) {\n      // sync out only the elements we think we need to to save bandwidth.\n      // periodically we'll resync the whole thing to make sure no one diverges\n      // due to a dropped message (server goes down etc).\n      syncableElements = syncableElements.filter(\n        (syncableElement) =>\n          !this.broadcastedElementVersions.has(syncableElement.id) ||\n          syncableElement.version >\n            this.broadcastedElementVersions.get(syncableElement.id)!,\n      );\n    }\n\n    const data: SocketUpdateDataSource[typeof sceneType] = {\n      type: sceneType,\n      payload: {\n        elements: syncableElements,\n      },\n    };\n    this.lastBroadcastedOrReceivedSceneVersion = Math.max(\n      this.lastBroadcastedOrReceivedSceneVersion,\n      getDrawingVersion(globalSceneState.getElementsIncludingDeleted()),\n    );\n    for (const syncableElement of syncableElements) {\n      this.broadcastedElementVersions.set(\n        syncableElement.id,\n        syncableElement.version,\n      );\n    }\n    return this.portal._broadcastSocketData(data as SocketUpdateData);\n  };\n\n  private onSceneUpdated = () => {\n    this.setState({});\n  };\n\n  private updateCurrentCursorPosition = withBatchedUpdates(\n    (event: MouseEvent) => {\n      cursorX = event.x;\n      cursorY = event.y;\n    },\n  );\n\n  restoreUserName() {\n    const username = restoreUsernameFromLocalStorage();\n\n    if (username !== null) {\n      this.setState({\n        username,\n      });\n    }\n  }\n\n  // Input handling\n\n  private onKeyDown = withBatchedUpdates((event: KeyboardEvent) => {\n    // ensures we don't prevent devTools select-element feature\n    if (event[KEYS.CTRL_OR_CMD] && event.shiftKey && event.key === \"C\") {\n      return;\n    }\n\n    if (\n      (isWritableElement(event.target) && event.key !== KEYS.ESCAPE) ||\n      // case: using arrows to move between buttons\n      (isArrowKey(event.key) && isInputLike(event.target))\n    ) {\n      return;\n    }\n\n    if (event.key === KEYS.QUESTION_MARK) {\n      this.setState({\n        showShortcutsDialog: true,\n      });\n    }\n\n    if (\n      !event[KEYS.CTRL_OR_CMD] &&\n      event.altKey &&\n      event.keyCode === KEYS.Z_KEY_CODE\n    ) {\n      this.toggleZenMode();\n    }\n\n    if (event[KEYS.CTRL_OR_CMD] && event.keyCode === KEYS.GRID_KEY_CODE) {\n      this.toggleGridMode();\n    }\n\n    if (event.code === \"KeyC\" && event.altKey && event.shiftKey) {\n      this.copyToClipboardAsPng();\n      event.preventDefault();\n      return;\n    }\n\n    if (this.actionManager.handleKeyDown(event)) {\n      return;\n    }\n\n    if (event.code === \"Digit9\") {\n      this.setState({ isLibraryOpen: !this.state.isLibraryOpen });\n    }\n\n    const shape = findShapeByKey(event.key);\n\n    if (isArrowKey(event.key)) {\n      const step =\n        (this.state.gridSize &&\n          (event.shiftKey ? ELEMENT_TRANSLATE_AMOUNT : this.state.gridSize)) ||\n        (event.shiftKey\n          ? ELEMENT_SHIFT_TRANSLATE_AMOUNT\n          : ELEMENT_TRANSLATE_AMOUNT);\n      globalSceneState.replaceAllElements(\n        globalSceneState.getElementsIncludingDeleted().map((el) => {\n          if (this.state.selectedElementIds[el.id]) {\n            const update: { x?: number; y?: number } = {};\n            if (event.key === KEYS.ARROW_LEFT) {\n              update.x = el.x - step;\n            } else if (event.key === KEYS.ARROW_RIGHT) {\n              update.x = el.x + step;\n            } else if (event.key === KEYS.ARROW_UP) {\n              update.y = el.y - step;\n            } else if (event.key === KEYS.ARROW_DOWN) {\n              update.y = el.y + step;\n            }\n            return newElementWith(el, update);\n          }\n          return el;\n        }),\n      );\n      event.preventDefault();\n    } else if (event.key === KEYS.ENTER) {\n      const selectedElements = getSelectedElements(\n        globalSceneState.getElements(),\n        this.state,\n      );\n\n      if (\n        selectedElements.length === 1 &&\n        isLinearElement(selectedElements[0])\n      ) {\n        if (\n          !this.state.editingLinearElement ||\n          this.state.editingLinearElement.elementId !== selectedElements[0].id\n        ) {\n          history.resumeRecording();\n          this.setState({\n            editingLinearElement: new LinearElementEditor(selectedElements[0]),\n          });\n        }\n      } else if (\n        selectedElements.length === 1 &&\n        !isLinearElement(selectedElements[0])\n      ) {\n        const selectedElement = selectedElements[0];\n        this.startTextEditing({\n          sceneX: selectedElement.x + selectedElement.width / 2,\n          sceneY: selectedElement.y + selectedElement.height / 2,\n        });\n        event.preventDefault();\n        return;\n      }\n    } else if (\n      !event.ctrlKey &&\n      !event.altKey &&\n      !event.metaKey &&\n      this.state.draggingElement === null\n    ) {\n      if (shapesShortcutKeys.includes(event.key.toLowerCase())) {\n        this.selectShapeTool(shape);\n      } else if (event.key === \"q\") {\n        this.toggleLock();\n      }\n    }\n    if (event.key === KEYS.SPACE && gesture.pointers.size === 0) {\n      isHoldingSpace = true;\n      document.documentElement.style.cursor = CURSOR_TYPE.GRABBING;\n    }\n  });\n\n  private onKeyUp = withBatchedUpdates((event: KeyboardEvent) => {\n    if (event.key === KEYS.SPACE) {\n      if (this.state.elementType === \"selection\") {\n        resetCursor();\n      } else {\n        setCursorForShape(this.state.elementType);\n        this.setState({\n          selectedElementIds: {},\n          selectedGroupIds: {},\n          editingGroupId: null,\n        });\n      }\n      isHoldingSpace = false;\n    }\n  });\n\n  private selectShapeTool(elementType: AppState[\"elementType\"]) {\n    if (!isHoldingSpace) {\n      setCursorForShape(elementType);\n    }\n    if (isToolIcon(document.activeElement)) {\n      document.activeElement.blur();\n    }\n    if (elementType !== \"selection\") {\n      this.setState({\n        elementType,\n        selectedElementIds: {},\n        selectedGroupIds: {},\n        editingGroupId: null,\n      });\n    } else {\n      this.setState({ elementType });\n    }\n  }\n\n  private onGestureStart = withBatchedUpdates((event: GestureEvent) => {\n    event.preventDefault();\n    this.setState({\n      selectedElementIds: {},\n    });\n    gesture.initialScale = this.state.zoom;\n  });\n\n  private onGestureChange = withBatchedUpdates((event: GestureEvent) => {\n    event.preventDefault();\n\n    this.setState({\n      zoom: getNormalizedZoom(gesture.initialScale! * event.scale),\n    });\n  });\n\n  private onGestureEnd = withBatchedUpdates((event: GestureEvent) => {\n    event.preventDefault();\n    const { previousSelectedElementIds } = this.state;\n    this.setState({\n      previousSelectedElementIds: {},\n      selectedElementIds: previousSelectedElementIds,\n    });\n    gesture.initialScale = null;\n  });\n\n  private setElements = (elements: readonly ExcalidrawElement[]) => {\n    globalSceneState.replaceAllElements(elements);\n  };\n\n  private handleTextWysiwyg(\n    element: ExcalidrawTextElement,\n    {\n      isExistingElement = false,\n    }: {\n      isExistingElement?: boolean;\n    },\n  ) {\n    const resetSelection = () => {\n      this.setState({\n        draggingElement: null,\n        editingElement: null,\n      });\n    };\n\n    const updateElement = (text: string) => {\n      globalSceneState.replaceAllElements([\n        ...globalSceneState.getElementsIncludingDeleted().map((_element) => {\n          if (_element.id === element.id && isTextElement(_element)) {\n            return updateTextElement(_element, {\n              text,\n              isDeleted: !text.trim(),\n            });\n          }\n          return _element;\n        }),\n      ]);\n    };\n\n    textWysiwyg({\n      id: element.id,\n      zoom: this.state.zoom,\n      getViewportCoords: (x, y) => {\n        const { x: viewportX, y: viewportY } = sceneCoordsToViewportCoords(\n          { sceneX: x, sceneY: y },\n          this.state,\n          this.canvas,\n          window.devicePixelRatio,\n        );\n        return [viewportX, viewportY];\n      },\n      onChange: withBatchedUpdates((text) => {\n        updateElement(text);\n      }),\n      onSubmit: withBatchedUpdates((text) => {\n        updateElement(text);\n        this.setState((prevState) => ({\n          selectedElementIds: {\n            ...prevState.selectedElementIds,\n            [element.id]: true,\n          },\n        }));\n        if (this.state.elementLocked) {\n          setCursorForShape(this.state.elementType);\n        }\n        history.resumeRecording();\n        resetSelection();\n      }),\n      onCancel: withBatchedUpdates(() => {\n        updateElement(\"\");\n        if (isExistingElement) {\n          history.resumeRecording();\n        }\n        resetSelection();\n      }),\n    });\n    // deselect all other elements when inserting text\n    this.setState({\n      selectedElementIds: {},\n      selectedGroupIds: {},\n      editingGroupId: null,\n    });\n\n    // do an initial update to re-initialize element position since we were\n    //  modifying element's x/y for sake of editor (case: syncing to remote)\n    updateElement(element.text);\n  }\n\n  private getTextElementAtPosition(\n    x: number,\n    y: number,\n  ): NonDeleted<ExcalidrawTextElement> | null {\n    const element = getElementAtPosition(\n      globalSceneState.getElements(),\n      this.state,\n      x,\n      y,\n      this.state.zoom,\n    );\n\n    if (element && isTextElement(element) && !element.isDeleted) {\n      return element;\n    }\n    return null;\n  }\n\n  private startTextEditing = ({\n    sceneX,\n    sceneY,\n    insertAtParentCenter = true,\n  }: {\n    /** X position to insert text at */\n    sceneX: number;\n    /** Y position to insert text at */\n    sceneY: number;\n    /** whether to attempt to insert at element center if applicable */\n    insertAtParentCenter?: boolean;\n  }) => {\n    const existingTextElement = this.getTextElementAtPosition(sceneX, sceneY);\n\n    const parentCenterPosition =\n      insertAtParentCenter &&\n      this.getTextWysiwygSnappedToCenterPosition(\n        sceneX,\n        sceneY,\n        this.state,\n        this.canvas,\n        window.devicePixelRatio,\n      );\n\n    const element = existingTextElement\n      ? existingTextElement\n      : newTextElement({\n          x: parentCenterPosition\n            ? parentCenterPosition.elementCenterX\n            : sceneX,\n          y: parentCenterPosition\n            ? parentCenterPosition.elementCenterY\n            : sceneY,\n          strokeColor: this.state.currentItemStrokeColor,\n          backgroundColor: this.state.currentItemBackgroundColor,\n          fillStyle: this.state.currentItemFillStyle,\n          strokeWidth: this.state.currentItemStrokeWidth,\n          strokeStyle: this.state.currentItemStrokeStyle,\n          roughness: this.state.currentItemRoughness,\n          opacity: this.state.currentItemOpacity,\n          text: \"\",\n          fontSize: this.state.currentItemFontSize,\n          fontFamily: this.state.currentItemFontFamily,\n          textAlign: parentCenterPosition\n            ? \"center\"\n            : this.state.currentItemTextAlign,\n          verticalAlign: parentCenterPosition\n            ? \"middle\"\n            : DEFAULT_VERTICAL_ALIGN,\n        });\n\n    this.setState({ editingElement: element });\n\n    if (existingTextElement) {\n      // if text element is no longer centered to a container, reset\n      //  verticalAlign to default because it's currently internal-only\n      if (!parentCenterPosition || element.textAlign !== \"center\") {\n        mutateElement(element, { verticalAlign: DEFAULT_VERTICAL_ALIGN });\n      }\n    } else {\n      globalSceneState.replaceAllElements([\n        ...globalSceneState.getElementsIncludingDeleted(),\n        element,\n      ]);\n\n      // case: creating new text not centered to parent elemenent  offset Y\n      //  so that the text is centered to cursor position\n      if (!parentCenterPosition) {\n        mutateElement(element, {\n          y: element.y - element.baseline / 2,\n        });\n      }\n    }\n\n    this.setState({\n      editingElement: element,\n    });\n\n    this.handleTextWysiwyg(element, {\n      isExistingElement: !!existingTextElement,\n    });\n  };\n\n  private handleCanvasDoubleClick = (\n    event: React.MouseEvent<HTMLCanvasElement>,\n  ) => {\n    // case: double-clicking with arrow/line tool selected would both create\n    //  text and enter multiElement mode\n    if (this.state.multiElement) {\n      return;\n    }\n\n    const selectedElements = getSelectedElements(\n      globalSceneState.getElements(),\n      this.state,\n    );\n\n    if (selectedElements.length === 1 && isLinearElement(selectedElements[0])) {\n      if (\n        !this.state.editingLinearElement ||\n        this.state.editingLinearElement.elementId !== selectedElements[0].id\n      ) {\n        history.resumeRecording();\n        this.setState({\n          editingLinearElement: new LinearElementEditor(selectedElements[0]),\n        });\n      }\n      return;\n    }\n\n    resetCursor();\n\n    const { x: sceneX, y: sceneY } = viewportCoordsToSceneCoords(\n      event,\n      this.state,\n      this.canvas,\n      window.devicePixelRatio,\n    );\n\n    const selectedGroupIds = getSelectedGroupIds(this.state);\n\n    if (selectedGroupIds.length > 0) {\n      const elements = globalSceneState.getElements();\n      const hitElement = getElementAtPosition(\n        elements,\n        this.state,\n        sceneX,\n        sceneY,\n        this.state.zoom,\n      );\n\n      const selectedGroupId =\n        hitElement &&\n        getSelectedGroupIdForElement(hitElement, this.state.selectedGroupIds);\n\n      if (selectedGroupId) {\n        this.setState((prevState) =>\n          selectGroupsForSelectedElements(\n            {\n              ...prevState,\n              editingGroupId: selectedGroupId,\n              selectedElementIds: { [hitElement!.id]: true },\n              selectedGroupIds: {},\n            },\n            globalSceneState.getElements(),\n          ),\n        );\n        return;\n      }\n    }\n\n    resetCursor();\n\n    this.startTextEditing({\n      sceneX,\n      sceneY,\n      insertAtParentCenter: !event.altKey,\n    });\n  };\n\n  private handleCanvasPointerMove = (\n    event: React.PointerEvent<HTMLCanvasElement>,\n  ) => {\n    this.savePointer(event.clientX, event.clientY, this.state.cursorButton);\n\n    if (gesture.pointers.has(event.pointerId)) {\n      gesture.pointers.set(event.pointerId, {\n        x: event.clientX,\n        y: event.clientY,\n      });\n    }\n\n    if (gesture.pointers.size === 2) {\n      const center = getCenter(gesture.pointers);\n      const deltaX = center.x - gesture.lastCenter!.x;\n      const deltaY = center.y - gesture.lastCenter!.y;\n      gesture.lastCenter = center;\n\n      const distance = getDistance(Array.from(gesture.pointers.values()));\n      const scaleFactor = distance / gesture.initialDistance!;\n\n      this.setState({\n        scrollX: normalizeScroll(this.state.scrollX + deltaX / this.state.zoom),\n        scrollY: normalizeScroll(this.state.scrollY + deltaY / this.state.zoom),\n        zoom: getNormalizedZoom(gesture.initialScale! * scaleFactor),\n        shouldCacheIgnoreZoom: true,\n      });\n      this.resetShouldCacheIgnoreZoomDebounced();\n    } else {\n      gesture.lastCenter = gesture.initialDistance = gesture.initialScale = null;\n    }\n\n    if (isHoldingSpace || isPanning || isDraggingScrollBar) {\n      return;\n    }\n    const isPointerOverScrollBars = isOverScrollBars(\n      currentScrollBars,\n      event.clientX,\n      event.clientY,\n    );\n    const isOverScrollBar = isPointerOverScrollBars.isOverEither;\n    if (!this.state.draggingElement && !this.state.multiElement) {\n      if (isOverScrollBar) {\n        resetCursor();\n      } else {\n        setCursorForShape(this.state.elementType);\n      }\n    }\n\n    const { x: scenePointerX, y: scenePointerY } = viewportCoordsToSceneCoords(\n      event,\n      this.state,\n      this.canvas,\n      window.devicePixelRatio,\n    );\n\n    if (\n      this.state.editingLinearElement &&\n      this.state.editingLinearElement.draggingElementPointIndex === null\n    ) {\n      const editingLinearElement = LinearElementEditor.handlePointerMove(\n        event,\n        scenePointerX,\n        scenePointerY,\n        this.state.editingLinearElement,\n      );\n      if (editingLinearElement !== this.state.editingLinearElement) {\n        this.setState({ editingLinearElement });\n      }\n    }\n\n    if (this.state.multiElement) {\n      const { multiElement } = this.state;\n      const { x: rx, y: ry } = multiElement;\n\n      const { points, lastCommittedPoint } = multiElement;\n      const lastPoint = points[points.length - 1];\n\n      setCursorForShape(this.state.elementType);\n\n      if (lastPoint === lastCommittedPoint) {\n        // if we haven't yet created a temp point and we're beyond commit-zone\n        //  threshold, add a point\n        if (\n          distance2d(\n            scenePointerX - rx,\n            scenePointerY - ry,\n            lastPoint[0],\n            lastPoint[1],\n          ) >= LINE_CONFIRM_THRESHOLD\n        ) {\n          mutateElement(multiElement, {\n            points: [...points, [scenePointerX - rx, scenePointerY - ry]],\n          });\n        } else {\n          document.documentElement.style.cursor = CURSOR_TYPE.POINTER;\n          // in this branch, we're inside the commit zone, and no uncommitted\n          //  point exists. Thus do nothing (don't add/remove points).\n        }\n      } else {\n        // cursor moved inside commit zone, and there's uncommitted point,\n        //  thus remove it\n        if (\n          points.length > 2 &&\n          lastCommittedPoint &&\n          distance2d(\n            scenePointerX - rx,\n            scenePointerY - ry,\n            lastCommittedPoint[0],\n            lastCommittedPoint[1],\n          ) < LINE_CONFIRM_THRESHOLD\n        ) {\n          document.documentElement.style.cursor = CURSOR_TYPE.POINTER;\n          mutateElement(multiElement, {\n            points: points.slice(0, -1),\n          });\n        } else {\n          if (isPathALoop(points)) {\n            document.documentElement.style.cursor = CURSOR_TYPE.POINTER;\n          }\n          // update last uncommitted point\n          mutateElement(multiElement, {\n            points: [\n              ...points.slice(0, -1),\n              [scenePointerX - rx, scenePointerY - ry],\n            ],\n          });\n        }\n      }\n      return;\n    }\n\n    const hasDeselectedButton = Boolean(event.buttons);\n    if (\n      hasDeselectedButton ||\n      (this.state.elementType !== \"selection\" &&\n        this.state.elementType !== \"text\")\n    ) {\n      return;\n    }\n\n    const elements = globalSceneState.getElements();\n\n    const selectedElements = getSelectedElements(elements, this.state);\n    if (\n      selectedElements.length === 1 &&\n      !isOverScrollBar &&\n      !this.state.editingLinearElement\n    ) {\n      const elementWithResizeHandler = getElementWithResizeHandler(\n        elements,\n        this.state,\n        scenePointerX,\n        scenePointerY,\n        this.state.zoom,\n        event.pointerType,\n      );\n      if (elementWithResizeHandler && elementWithResizeHandler.resizeHandle) {\n        document.documentElement.style.cursor = getCursorForResizingElement(\n          elementWithResizeHandler,\n        );\n        return;\n      }\n    } else if (selectedElements.length > 1 && !isOverScrollBar) {\n      const resizeHandle = getResizeHandlerFromCoords(\n        getCommonBounds(selectedElements),\n        scenePointerX,\n        scenePointerY,\n        this.state.zoom,\n        event.pointerType,\n      );\n      if (resizeHandle) {\n        document.documentElement.style.cursor = getCursorForResizingElement({\n          resizeHandle,\n        });\n        return;\n      }\n    }\n    const hitElement = getElementAtPosition(\n      elements,\n      this.state,\n      scenePointerX,\n      scenePointerY,\n      this.state.zoom,\n    );\n    if (this.state.elementType === \"text\") {\n      document.documentElement.style.cursor = isTextElement(hitElement)\n        ? CURSOR_TYPE.TEXT\n        : CURSOR_TYPE.CROSSHAIR;\n    } else {\n      document.documentElement.style.cursor =\n        hitElement && !isOverScrollBar ? \"move\" : \"\";\n    }\n  };\n\n  // set touch moving for mobile context menu\n  private handleTouchMove = (event: React.TouchEvent<HTMLCanvasElement>) => {\n    touchMoving = true;\n  };\n\n  private handleCanvasPointerDown = (\n    event: React.PointerEvent<HTMLCanvasElement>,\n  ) => {\n    event.persist();\n\n    this.maybeOpenContextMenuAfterPointerDownOnTouchDevices(event);\n    this.maybeCleanupAfterMissingPointerUp(event);\n\n    if (isPanning) {\n      return;\n    }\n\n    this.setState({\n      lastPointerDownWith: event.pointerType,\n      cursorButton: \"down\",\n    });\n    this.savePointer(event.clientX, event.clientY, \"down\");\n\n    if (this.handleCanvasPanUsingWheelOrSpaceDrag(event)) {\n      return;\n    }\n\n    // only handle left mouse button or touch\n    if (\n      event.button !== POINTER_BUTTON.MAIN &&\n      event.button !== POINTER_BUTTON.TOUCH\n    ) {\n      return;\n    }\n\n    this.updateGestureOnPointerDown(event);\n\n    // fixes pointermove causing selection of UI texts #32\n    event.preventDefault();\n    // Preventing the event above disables default behavior\n    //  of defocusing potentially focused element, which is what we\n    //  want when clicking inside the canvas.\n    if (document.activeElement instanceof HTMLElement) {\n      document.activeElement.blur();\n    }\n\n    // don't select while panning\n    if (gesture.pointers.size > 1) {\n      return;\n    }\n\n    // State for the duration of a pointer interaction, which starts with a\n    // pointerDown event, ends with a pointerUp event (or another pointerDown)\n    const pointerDownState = this.initialPointerDownState(event);\n\n    if (this.handleDraggingScrollBar(event, pointerDownState)) {\n      return;\n    }\n\n    this.clearSelectionIfNotUsingSelection();\n\n    if (this.handleSelectionOnPointerDown(event, pointerDownState)) {\n      return;\n    }\n\n    if (this.state.elementType === \"text\") {\n      this.handleTextOnPointerDown(event, pointerDownState);\n      return;\n    } else if (\n      this.state.elementType === \"arrow\" ||\n      this.state.elementType === \"draw\" ||\n      this.state.elementType === \"line\"\n    ) {\n      this.handleLinearElementOnPointerDown(\n        event,\n        this.state.elementType,\n        pointerDownState,\n      );\n    } else {\n      this.createGenericElementOnPointerDown(\n        this.state.elementType,\n        pointerDownState,\n      );\n    }\n\n    const onPointerMove = this.onPointerMoveFromPointerDownHandler(\n      pointerDownState,\n    );\n\n    const onPointerUp = this.onPointerUpFromPointerDownHandler(\n      pointerDownState,\n    );\n\n    lastPointerUp = onPointerUp;\n\n    window.addEventListener(EVENT.POINTER_MOVE, onPointerMove);\n    window.addEventListener(EVENT.POINTER_UP, onPointerUp);\n    pointerDownState.eventListeners.onMove = onPointerMove;\n    pointerDownState.eventListeners.onUp = onPointerUp;\n  };\n\n  private maybeOpenContextMenuAfterPointerDownOnTouchDevices = (\n    event: React.PointerEvent<HTMLCanvasElement>,\n  ): void => {\n    // deal with opening context menu on touch devices\n    if (event.pointerType === \"touch\") {\n      touchMoving = false;\n\n      // open the context menu with the first touch's clientX and clientY\n      // if the touch is not moving\n      touchTimeout = window.setTimeout(() => {\n        if (!touchMoving) {\n          this.openContextMenu({\n            clientX: event.clientX,\n            clientY: event.clientY,\n          });\n        }\n      }, TOUCH_CTX_MENU_TIMEOUT);\n    }\n  };\n\n  private maybeCleanupAfterMissingPointerUp(\n    event: React.PointerEvent<HTMLCanvasElement>,\n  ): void {\n    if (lastPointerUp !== null) {\n      // Unfortunately, sometimes we don't get a pointerup after a pointerdown,\n      // this can happen when a contextual menu or alert is triggered. In order to avoid\n      // being in a weird state, we clean up on the next pointerdown\n      lastPointerUp(event);\n    }\n  }\n\n  // Returns whether the event is a panning\n  private handleCanvasPanUsingWheelOrSpaceDrag = (\n    event: React.PointerEvent<HTMLCanvasElement>,\n  ): boolean => {\n    if (\n      !(\n        gesture.pointers.size === 0 &&\n        (event.button === POINTER_BUTTON.WHEEL ||\n          (event.button === POINTER_BUTTON.MAIN && isHoldingSpace))\n      )\n    ) {\n      return false;\n    }\n    isPanning = true;\n\n    let nextPastePrevented = false;\n    const isLinux = /Linux/.test(window.navigator.platform);\n\n    document.documentElement.style.cursor = CURSOR_TYPE.GRABBING;\n    let { clientX: lastX, clientY: lastY } = event;\n    const onPointerMove = withBatchedUpdates((event: PointerEvent) => {\n      const deltaX = lastX - event.clientX;\n      const deltaY = lastY - event.clientY;\n      lastX = event.clientX;\n      lastY = event.clientY;\n\n      /*\n       * Prevent paste event if we move while middle clicking on Linux.\n       * See issue #1383.\n       */\n      if (\n        isLinux &&\n        !nextPastePrevented &&\n        (Math.abs(deltaX) > 1 || Math.abs(deltaY) > 1)\n      ) {\n        nextPastePrevented = true;\n\n        /* Prevent the next paste event */\n        const preventNextPaste = (event: ClipboardEvent) => {\n          document.body.removeEventListener(EVENT.PASTE, preventNextPaste);\n          event.stopPropagation();\n        };\n\n        /*\n         * Reenable next paste in case of disabled middle click paste for\n         * any reason:\n         * - rigth click paste\n         * - empty clipboard\n         */\n        const enableNextPaste = () => {\n          setTimeout(() => {\n            document.body.removeEventListener(EVENT.PASTE, preventNextPaste);\n            window.removeEventListener(EVENT.POINTER_UP, enableNextPaste);\n          }, 100);\n        };\n\n        document.body.addEventListener(EVENT.PASTE, preventNextPaste);\n        window.addEventListener(EVENT.POINTER_UP, enableNextPaste);\n      }\n\n      this.setState({\n        scrollX: normalizeScroll(this.state.scrollX - deltaX / this.state.zoom),\n        scrollY: normalizeScroll(this.state.scrollY - deltaY / this.state.zoom),\n      });\n    });\n    const teardown = withBatchedUpdates(\n      (lastPointerUp = () => {\n        lastPointerUp = null;\n        isPanning = false;\n        if (!isHoldingSpace) {\n          setCursorForShape(this.state.elementType);\n        }\n        this.setState({\n          cursorButton: \"up\",\n        });\n        this.savePointer(event.clientX, event.clientY, \"up\");\n        window.removeEventListener(EVENT.POINTER_MOVE, onPointerMove);\n        window.removeEventListener(EVENT.POINTER_UP, teardown);\n        window.removeEventListener(EVENT.BLUR, teardown);\n      }),\n    );\n    window.addEventListener(EVENT.BLUR, teardown);\n    window.addEventListener(EVENT.POINTER_MOVE, onPointerMove, {\n      passive: true,\n    });\n    window.addEventListener(EVENT.POINTER_UP, teardown);\n    return true;\n  };\n\n  private updateGestureOnPointerDown(\n    event: React.PointerEvent<HTMLCanvasElement>,\n  ): void {\n    gesture.pointers.set(event.pointerId, {\n      x: event.clientX,\n      y: event.clientY,\n    });\n\n    if (gesture.pointers.size === 2) {\n      gesture.lastCenter = getCenter(gesture.pointers);\n      gesture.initialScale = this.state.zoom;\n      gesture.initialDistance = getDistance(\n        Array.from(gesture.pointers.values()),\n      );\n    }\n  }\n\n  private initialPointerDownState(\n    event: React.PointerEvent<HTMLCanvasElement>,\n  ): PointerDownState {\n    const origin = viewportCoordsToSceneCoords(\n      event,\n      this.state,\n      this.canvas,\n      window.devicePixelRatio,\n    );\n\n    return {\n      origin,\n      originInGrid: tupleToCoors(\n        getGridPoint(origin.x, origin.y, this.state.gridSize),\n      ),\n      scrollbars: isOverScrollBars(\n        currentScrollBars,\n        event.clientX,\n        event.clientY,\n      ),\n      // we need to duplicate because we'll be updating this state\n      lastCoords: { ...origin },\n      resize: {\n        handle: false as ReturnType<typeof resizeTest>,\n        isResizing: false,\n        offset: { x: 0, y: 0 },\n        arrowDirection: \"origin\",\n      },\n      hit: {\n        element: null,\n        wasAddedToSelection: false,\n        hasBeenDuplicated: false,\n      },\n      drag: {\n        hasOccurred: false,\n        offset: null,\n      },\n      eventListeners: {\n        onMove: null,\n        onUp: null,\n      },\n    };\n  }\n\n  // Returns whether the event is a dragging a scrollbar\n  private handleDraggingScrollBar(\n    event: React.PointerEvent<HTMLCanvasElement>,\n    pointerDownState: PointerDownState,\n  ): boolean {\n    if (\n      !(pointerDownState.scrollbars.isOverEither && !this.state.multiElement)\n    ) {\n      return false;\n    }\n    isDraggingScrollBar = true;\n    pointerDownState.lastCoords.x = event.clientX;\n    pointerDownState.lastCoords.y = event.clientY;\n    const onPointerMove = withBatchedUpdates((event: PointerEvent) => {\n      const target = event.target;\n      if (!(target instanceof HTMLElement)) {\n        return;\n      }\n\n      if (pointerDownState.scrollbars.isOverHorizontal) {\n        const x = event.clientX;\n        const dx = x - pointerDownState.lastCoords.x;\n        this.setState({\n          scrollX: normalizeScroll(this.state.scrollX - dx / this.state.zoom),\n        });\n        pointerDownState.lastCoords.x = x;\n        return;\n      }\n\n      if (pointerDownState.scrollbars.isOverVertical) {\n        const y = event.clientY;\n        const dy = y - pointerDownState.lastCoords.y;\n        this.setState({\n          scrollY: normalizeScroll(this.state.scrollY - dy / this.state.zoom),\n        });\n        pointerDownState.lastCoords.y = y;\n      }\n    });\n\n    const onPointerUp = withBatchedUpdates(() => {\n      isDraggingScrollBar = false;\n      setCursorForShape(this.state.elementType);\n      lastPointerUp = null;\n      this.setState({\n        cursorButton: \"up\",\n      });\n      this.savePointer(event.clientX, event.clientY, \"up\");\n      window.removeEventListener(EVENT.POINTER_MOVE, onPointerMove);\n      window.removeEventListener(EVENT.POINTER_UP, onPointerUp);\n    });\n\n    lastPointerUp = onPointerUp;\n\n    window.addEventListener(EVENT.POINTER_MOVE, onPointerMove);\n    window.addEventListener(EVENT.POINTER_UP, onPointerUp);\n    return true;\n  }\n\n  private clearSelectionIfNotUsingSelection = (): void => {\n    if (this.state.elementType !== \"selection\") {\n      this.setState({\n        selectedElementIds: {},\n        selectedGroupIds: {},\n        editingGroupId: null,\n      });\n    }\n  };\n\n  // Returns whether the pointer event has been completely handled\n  private handleSelectionOnPointerDown = (\n    event: React.PointerEvent<HTMLCanvasElement>,\n    pointerDownState: PointerDownState,\n  ): boolean => {\n    if (this.state.elementType === \"selection\") {\n      const elements = globalSceneState.getElements();\n      const selectedElements = getSelectedElements(elements, this.state);\n      if (selectedElements.length === 1 && !this.state.editingLinearElement) {\n        const elementWithResizeHandler = getElementWithResizeHandler(\n          elements,\n          this.state,\n          pointerDownState.origin.x,\n          pointerDownState.origin.y,\n          this.state.zoom,\n          event.pointerType,\n        );\n        if (elementWithResizeHandler != null) {\n          this.setState({\n            resizingElement: elementWithResizeHandler.element,\n          });\n          pointerDownState.resize.handle =\n            elementWithResizeHandler.resizeHandle;\n        }\n      } else if (selectedElements.length > 1) {\n        pointerDownState.resize.handle = getResizeHandlerFromCoords(\n          getCommonBounds(selectedElements),\n          pointerDownState.origin.x,\n          pointerDownState.origin.y,\n          this.state.zoom,\n          event.pointerType,\n        );\n      }\n      if (pointerDownState.resize.handle) {\n        document.documentElement.style.cursor = getCursorForResizingElement({\n          resizeHandle: pointerDownState.resize.handle,\n        });\n        pointerDownState.resize.isResizing = true;\n        pointerDownState.resize.offset = tupleToCoors(\n          getResizeOffsetXY(\n            pointerDownState.resize.handle,\n            selectedElements,\n            pointerDownState.origin.x,\n            pointerDownState.origin.y,\n          ),\n        );\n        if (\n          selectedElements.length === 1 &&\n          isLinearElement(selectedElements[0]) &&\n          selectedElements[0].points.length === 2\n        ) {\n          pointerDownState.resize.arrowDirection = getResizeArrowDirection(\n            pointerDownState.resize.handle,\n            selectedElements[0],\n          );\n        }\n      } else {\n        if (this.state.editingLinearElement) {\n          const ret = LinearElementEditor.handlePointerDown(\n            event,\n            this.state,\n            (appState) => this.setState(appState),\n            history,\n            pointerDownState.origin.x,\n            pointerDownState.origin.y,\n          );\n          if (ret.hitElement) {\n            pointerDownState.hit.element = ret.hitElement;\n          }\n          if (ret.didAddPoint) {\n            return true;\n          }\n        }\n\n        // hitElement may already be set above, so check first\n        pointerDownState.hit.element =\n          pointerDownState.hit.element ??\n          getElementAtPosition(\n            elements,\n            this.state,\n            pointerDownState.origin.x,\n            pointerDownState.origin.y,\n            this.state.zoom,\n          );\n\n        this.maybeClearSelectionWhenHittingElement(\n          event,\n          pointerDownState.hit.element,\n        );\n\n        // If we click on something\n        const hitElement = pointerDownState.hit.element;\n        if (hitElement != null) {\n          // deselect if item is selected\n          // if shift is not clicked, this will always return true\n          // otherwise, it will trigger selection based on current\n          // state of the box\n          if (!this.state.selectedElementIds[hitElement.id]) {\n            // if we are currently editing a group, treat all selections outside of the group\n            // as exiting editing mode.\n            if (\n              this.state.editingGroupId &&\n              !isElementInGroup(hitElement, this.state.editingGroupId)\n            ) {\n              this.setState({\n                selectedElementIds: {},\n                selectedGroupIds: {},\n                editingGroupId: null,\n              });\n              return true;\n            }\n            this.setState((prevState) => {\n              return selectGroupsForSelectedElements(\n                {\n                  ...prevState,\n                  selectedElementIds: {\n                    ...prevState.selectedElementIds,\n                    [hitElement!.id]: true,\n                  },\n                },\n                globalSceneState.getElements(),\n              );\n            });\n            // TODO: this is strange...\n            globalSceneState.replaceAllElements(\n              globalSceneState.getElementsIncludingDeleted(),\n            );\n            pointerDownState.hit.wasAddedToSelection = true;\n          }\n        }\n\n        const { selectedElementIds } = this.state;\n        this.setState({\n          previousSelectedElementIds: selectedElementIds,\n        });\n      }\n    }\n    return false;\n  };\n\n  private handleTextOnPointerDown = (\n    event: React.PointerEvent<HTMLCanvasElement>,\n    pointerDownState: PointerDownState,\n  ): void => {\n    // if we're currently still editing text, clicking outside\n    //  should only finalize it, not create another (irrespective\n    //  of state.elementLocked)\n    if (this.state.editingElement?.type === \"text\") {\n      return;\n    }\n\n    this.startTextEditing({\n      sceneX: pointerDownState.origin.x,\n      sceneY: pointerDownState.origin.y,\n      insertAtParentCenter: !event.altKey,\n    });\n\n    resetCursor();\n    if (!this.state.elementLocked) {\n      this.setState({\n        elementType: \"selection\",\n      });\n    }\n  };\n\n  private handleLinearElementOnPointerDown = (\n    event: React.PointerEvent<HTMLCanvasElement>,\n    elementType: \"draw\" | \"line\" | \"arrow\",\n    pointerDownState: PointerDownState,\n  ): void => {\n    if (this.state.multiElement) {\n      const { multiElement } = this.state;\n\n      // finalize if completing a loop\n      if (multiElement.type === \"line\" && isPathALoop(multiElement.points)) {\n        mutateElement(multiElement, {\n          lastCommittedPoint:\n            multiElement.points[multiElement.points.length - 1],\n        });\n        this.actionManager.executeAction(actionFinalize);\n        return;\n      }\n\n      const { x: rx, y: ry, lastCommittedPoint } = multiElement;\n\n      // clicking inside commit zone  finalize arrow\n      if (\n        multiElement.points.length > 1 &&\n        lastCommittedPoint &&\n        distance2d(\n          pointerDownState.origin.x - rx,\n          pointerDownState.origin.y - ry,\n          lastCommittedPoint[0],\n          lastCommittedPoint[1],\n        ) < LINE_CONFIRM_THRESHOLD\n      ) {\n        this.actionManager.executeAction(actionFinalize);\n        return;\n      }\n\n      this.setState((prevState) => ({\n        selectedElementIds: {\n          ...prevState.selectedElementIds,\n          [multiElement.id]: true,\n        },\n      }));\n      // clicking outside commit zone  update reference for last committed\n      //  point\n      mutateElement(multiElement, {\n        lastCommittedPoint: multiElement.points[multiElement.points.length - 1],\n      });\n      document.documentElement.style.cursor = CURSOR_TYPE.POINTER;\n    } else {\n      const [gridX, gridY] = getGridPoint(\n        pointerDownState.origin.x,\n        pointerDownState.origin.y,\n        elementType === \"draw\" ? null : this.state.gridSize,\n      );\n      const element = newLinearElement({\n        type: elementType,\n        x: gridX,\n        y: gridY,\n        strokeColor: this.state.currentItemStrokeColor,\n        backgroundColor: this.state.currentItemBackgroundColor,\n        fillStyle: this.state.currentItemFillStyle,\n        strokeWidth: this.state.currentItemStrokeWidth,\n        strokeStyle: this.state.currentItemStrokeStyle,\n        roughness: this.state.currentItemRoughness,\n        opacity: this.state.currentItemOpacity,\n      });\n      this.setState((prevState) => ({\n        selectedElementIds: {\n          ...prevState.selectedElementIds,\n          [element.id]: false,\n        },\n      }));\n      mutateElement(element, {\n        points: [...element.points, [0, 0]],\n      });\n      globalSceneState.replaceAllElements([\n        ...globalSceneState.getElementsIncludingDeleted(),\n        element,\n      ]);\n      this.setState({\n        draggingElement: element,\n        editingElement: element,\n      });\n    }\n  };\n\n  private createGenericElementOnPointerDown = (\n    elementType: ExcalidrawGenericElement[\"type\"],\n    pointerDownState: PointerDownState,\n  ): void => {\n    const [gridX, gridY] = getGridPoint(\n      pointerDownState.origin.x,\n      pointerDownState.origin.y,\n      this.state.gridSize,\n    );\n    const element = newElement({\n      type: elementType,\n      x: gridX,\n      y: gridY,\n      strokeColor: this.state.currentItemStrokeColor,\n      backgroundColor: this.state.currentItemBackgroundColor,\n      fillStyle: this.state.currentItemFillStyle,\n      strokeWidth: this.state.currentItemStrokeWidth,\n      strokeStyle: this.state.currentItemStrokeStyle,\n      roughness: this.state.currentItemRoughness,\n      opacity: this.state.currentItemOpacity,\n    });\n\n    if (element.type === \"selection\") {\n      this.setState({\n        selectionElement: element,\n        draggingElement: element,\n      });\n    } else {\n      globalSceneState.replaceAllElements([\n        ...globalSceneState.getElementsIncludingDeleted(),\n        element,\n      ]);\n      this.setState({\n        multiElement: null,\n        draggingElement: element,\n        editingElement: element,\n      });\n    }\n  };\n\n  private onPointerMoveFromPointerDownHandler(\n    pointerDownState: PointerDownState,\n  ): (event: PointerEvent) => void {\n    return withBatchedUpdates((event: PointerEvent) => {\n      // We need to initialize dragOffsetXY only after we've updated\n      // `state.selectedElementIds` on pointerDown. Doing it here in pointerMove\n      // event handler should hopefully ensure we're already working with\n      // the updated state.\n      if (pointerDownState.drag.offset === null) {\n        pointerDownState.drag.offset = tupleToCoors(\n          getDragOffsetXY(\n            getSelectedElements(globalSceneState.getElements(), this.state),\n            pointerDownState.origin.x,\n            pointerDownState.origin.y,\n          ),\n        );\n      }\n\n      const target = event.target;\n      if (!(target instanceof HTMLElement)) {\n        return;\n      }\n\n      if (pointerDownState.scrollbars.isOverHorizontal) {\n        const x = event.clientX;\n        const dx = x - pointerDownState.lastCoords.x;\n        this.setState({\n          scrollX: normalizeScroll(this.state.scrollX - dx / this.state.zoom),\n        });\n        pointerDownState.lastCoords.x = x;\n        return;\n      }\n\n      if (pointerDownState.scrollbars.isOverVertical) {\n        const y = event.clientY;\n        const dy = y - pointerDownState.lastCoords.y;\n        this.setState({\n          scrollY: normalizeScroll(this.state.scrollY - dy / this.state.zoom),\n        });\n        pointerDownState.lastCoords.y = y;\n        return;\n      }\n\n      const { x, y } = viewportCoordsToSceneCoords(\n        event,\n        this.state,\n        this.canvas,\n        window.devicePixelRatio,\n      );\n      const [gridX, gridY] = getGridPoint(x, y, this.state.gridSize);\n\n      // for arrows/lines, don't start dragging until a given threshold\n      //  to ensure we don't create a 2-point arrow by mistake when\n      //  user clicks mouse in a way that it moves a tiny bit (thus\n      //  triggering pointermove)\n      if (\n        !pointerDownState.drag.hasOccurred &&\n        (this.state.elementType === \"arrow\" ||\n          this.state.elementType === \"line\")\n      ) {\n        if (\n          distance2d(\n            x,\n            y,\n            pointerDownState.origin.x,\n            pointerDownState.origin.y,\n          ) < DRAGGING_THRESHOLD\n        ) {\n          return;\n        }\n      }\n\n      if (pointerDownState.resize.isResizing) {\n        const selectedElements = getSelectedElements(\n          globalSceneState.getElements(),\n          this.state,\n        );\n        const resizeHandle = pointerDownState.resize.handle;\n        this.setState({\n          // TODO: rename this state field to \"isScaling\" to distinguish\n          // it from the generic \"isResizing\" which includes scaling and\n          // rotating\n          isResizing: resizeHandle && resizeHandle !== \"rotation\",\n          isRotating: resizeHandle === \"rotation\",\n        });\n        const [resizeX, resizeY] = getGridPoint(\n          x - pointerDownState.resize.offset.x,\n          y - pointerDownState.resize.offset.y,\n          this.state.gridSize,\n        );\n        if (\n          resizeElements(\n            resizeHandle,\n            (newResizeHandle) => {\n              pointerDownState.resize.handle = newResizeHandle;\n            },\n            selectedElements,\n            pointerDownState.resize.arrowDirection,\n            getRotateWithDiscreteAngleKey(event),\n            getResizeWithSidesSameLengthKey(event),\n            getResizeCenterPointKey(event),\n            resizeX,\n            resizeY,\n          )\n        ) {\n          return;\n        }\n      }\n\n      if (this.state.editingLinearElement) {\n        const didDrag = LinearElementEditor.handlePointDragging(\n          this.state,\n          (appState) => this.setState(appState),\n          x,\n          y,\n          pointerDownState.lastCoords.x,\n          pointerDownState.lastCoords.y,\n        );\n\n        if (didDrag) {\n          pointerDownState.lastCoords.x = x;\n          pointerDownState.lastCoords.y = y;\n          return;\n        }\n      }\n\n      const hitElement = pointerDownState.hit.element;\n      if (hitElement && this.state.selectedElementIds[hitElement.id]) {\n        // Marking that click was used for dragging to check\n        // if elements should be deselected on pointerup\n        pointerDownState.drag.hasOccurred = true;\n        const selectedElements = getSelectedElements(\n          globalSceneState.getElements(),\n          this.state,\n        );\n        if (selectedElements.length > 0) {\n          const [dragX, dragY] = getGridPoint(\n            x - pointerDownState.drag.offset.x,\n            y - pointerDownState.drag.offset.y,\n            this.state.gridSize,\n          );\n          dragSelectedElements(selectedElements, dragX, dragY);\n\n          // We duplicate the selected element if alt is pressed on pointer move\n          if (event.altKey && !pointerDownState.hit.hasBeenDuplicated) {\n            // Move the currently selected elements to the top of the z index stack, and\n            // put the duplicates where the selected elements used to be.\n            // (the origin point where the dragging started)\n\n            pointerDownState.hit.hasBeenDuplicated = true;\n\n            const nextElements = [];\n            const elementsToAppend = [];\n            const groupIdMap = new Map();\n            for (const element of globalSceneState.getElementsIncludingDeleted()) {\n              if (\n                this.state.selectedElementIds[element.id] ||\n                // case: the state.selectedElementIds might not have been\n                //  updated yet by the time this mousemove event is fired\n                (element.id === hitElement.id &&\n                  pointerDownState.hit.wasAddedToSelection)\n              ) {\n                const duplicatedElement = duplicateElement(\n                  this.state.editingGroupId,\n                  groupIdMap,\n                  element,\n                );\n                const [originDragX, originDragY] = getGridPoint(\n                  pointerDownState.origin.x - pointerDownState.drag.offset.x,\n                  pointerDownState.origin.y - pointerDownState.drag.offset.y,\n                  this.state.gridSize,\n                );\n                mutateElement(duplicatedElement, {\n                  x: duplicatedElement.x + (originDragX - dragX),\n                  y: duplicatedElement.y + (originDragY - dragY),\n                });\n                nextElements.push(duplicatedElement);\n                elementsToAppend.push(element);\n              } else {\n                nextElements.push(element);\n              }\n            }\n            globalSceneState.replaceAllElements([\n              ...nextElements,\n              ...elementsToAppend,\n            ]);\n          }\n          return;\n        }\n      }\n\n      // It is very important to read this.state within each move event,\n      // otherwise we would read a stale one!\n      const draggingElement = this.state.draggingElement;\n      if (!draggingElement) {\n        return;\n      }\n\n      if (isLinearElement(draggingElement)) {\n        pointerDownState.drag.hasOccurred = true;\n        const points = draggingElement.points;\n        let dx: number;\n        let dy: number;\n        if (draggingElement.type === \"draw\") {\n          dx = x - draggingElement.x;\n          dy = y - draggingElement.y;\n        } else {\n          dx = gridX - draggingElement.x;\n          dy = gridY - draggingElement.y;\n        }\n\n        if (getRotateWithDiscreteAngleKey(event) && points.length === 2) {\n          ({ width: dx, height: dy } = getPerfectElementSize(\n            this.state.elementType,\n            dx,\n            dy,\n          ));\n        }\n\n        if (points.length === 1) {\n          mutateElement(draggingElement, { points: [...points, [dx, dy]] });\n        } else if (points.length > 1) {\n          if (draggingElement.type === \"draw\") {\n            mutateElement(draggingElement, {\n              points: simplify([...(points as Point[]), [dx, dy]], 0.7),\n            });\n          } else {\n            mutateElement(draggingElement, {\n              points: [...points.slice(0, -1), [dx, dy]],\n            });\n          }\n        }\n      } else if (draggingElement.type === \"selection\") {\n        dragNewElement(\n          draggingElement,\n          this.state.elementType,\n          pointerDownState.origin.x,\n          pointerDownState.origin.y,\n          x,\n          y,\n          distance(pointerDownState.origin.x, x),\n          distance(pointerDownState.origin.y, y),\n          getResizeWithSidesSameLengthKey(event),\n          getResizeCenterPointKey(event),\n        );\n      } else {\n        dragNewElement(\n          draggingElement,\n          this.state.elementType,\n          pointerDownState.originInGrid.x,\n          pointerDownState.originInGrid.y,\n          gridX,\n          gridY,\n          distance(pointerDownState.originInGrid.x, gridX),\n          distance(pointerDownState.originInGrid.y, gridY),\n          getResizeWithSidesSameLengthKey(event),\n          getResizeCenterPointKey(event),\n        );\n      }\n\n      if (this.state.elementType === \"selection\") {\n        const elements = globalSceneState.getElements();\n        if (!event.shiftKey && isSomeElementSelected(elements, this.state)) {\n          this.setState({\n            selectedElementIds: {},\n            selectedGroupIds: {},\n            editingGroupId: null,\n          });\n        }\n        const elementsWithinSelection = getElementsWithinSelection(\n          elements,\n          draggingElement,\n        );\n        this.setState((prevState) =>\n          selectGroupsForSelectedElements(\n            {\n              ...prevState,\n              selectedElementIds: {\n                ...prevState.selectedElementIds,\n                ...elementsWithinSelection.reduce((map, element) => {\n                  map[element.id] = true;\n                  return map;\n                }, {} as any),\n              },\n            },\n            globalSceneState.getElements(),\n          ),\n        );\n      }\n    });\n  }\n\n  private onPointerUpFromPointerDownHandler(\n    pointerDownState: PointerDownState,\n  ): (event: PointerEvent) => void {\n    return withBatchedUpdates((childEvent: PointerEvent) => {\n      const {\n        draggingElement,\n        resizingElement,\n        multiElement,\n        elementType,\n        elementLocked,\n      } = this.state;\n\n      this.setState({\n        isResizing: false,\n        isRotating: false,\n        resizingElement: null,\n        selectionElement: null,\n        cursorButton: \"up\",\n        // text elements are reset on finalize, and resetting on pointerup\n        //  may cause issues with double taps\n        editingElement:\n          multiElement || isTextElement(this.state.editingElement)\n            ? this.state.editingElement\n            : null,\n      });\n\n      this.savePointer(childEvent.clientX, childEvent.clientY, \"up\");\n\n      // if moving start/end point towards start/end point within threshold,\n      //  close the loop\n      if (this.state.editingLinearElement) {\n        const editingLinearElement = LinearElementEditor.handlePointerUp(\n          this.state.editingLinearElement,\n        );\n        if (editingLinearElement !== this.state.editingLinearElement) {\n          this.setState({ editingLinearElement });\n        }\n      }\n\n      lastPointerUp = null;\n\n      window.removeEventListener(\n        EVENT.POINTER_MOVE,\n        pointerDownState.eventListeners.onMove!,\n      );\n      window.removeEventListener(\n        EVENT.POINTER_UP,\n        pointerDownState.eventListeners.onUp!,\n      );\n\n      if (draggingElement?.type === \"draw\") {\n        this.actionManager.executeAction(actionFinalize);\n        return;\n      }\n      if (isLinearElement(draggingElement)) {\n        if (draggingElement!.points.length > 1) {\n          history.resumeRecording();\n        }\n        if (\n          !pointerDownState.drag.hasOccurred &&\n          draggingElement &&\n          !multiElement\n        ) {\n          const { x, y } = viewportCoordsToSceneCoords(\n            childEvent,\n            this.state,\n            this.canvas,\n            window.devicePixelRatio,\n          );\n          mutateElement(draggingElement, {\n            points: [\n              ...draggingElement.points,\n              [x - draggingElement.x, y - draggingElement.y],\n            ],\n          });\n          this.setState({\n            multiElement: draggingElement,\n            editingElement: this.state.draggingElement,\n          });\n        } else if (pointerDownState.drag.hasOccurred && !multiElement) {\n          if (!elementLocked) {\n            resetCursor();\n            this.setState((prevState) => ({\n              draggingElement: null,\n              elementType: \"selection\",\n              selectedElementIds: {\n                ...prevState.selectedElementIds,\n                [this.state.draggingElement!.id]: true,\n              },\n            }));\n          } else {\n            this.setState((prevState) => ({\n              draggingElement: null,\n              selectedElementIds: {\n                ...prevState.selectedElementIds,\n                [this.state.draggingElement!.id]: true,\n              },\n            }));\n          }\n        }\n        return;\n      }\n\n      if (\n        elementType !== \"selection\" &&\n        draggingElement &&\n        isInvisiblySmallElement(draggingElement)\n      ) {\n        // remove invisible element which was added in onPointerDown\n        globalSceneState.replaceAllElements(\n          globalSceneState.getElementsIncludingDeleted().slice(0, -1),\n        );\n        this.setState({\n          draggingElement: null,\n        });\n        return;\n      }\n\n      if (draggingElement) {\n        mutateElement(\n          draggingElement,\n          getNormalizedDimensions(draggingElement),\n        );\n      }\n\n      if (resizingElement) {\n        history.resumeRecording();\n      }\n\n      if (resizingElement && isInvisiblySmallElement(resizingElement)) {\n        globalSceneState.replaceAllElements(\n          globalSceneState\n            .getElementsIncludingDeleted()\n            .filter((el) => el.id !== resizingElement.id),\n        );\n      }\n\n      // If click occurred on already selected element\n      // it is needed to remove selection from other elements\n      // or if SHIFT or META key pressed remove selection\n      // from hitted element\n      //\n      // If click occurred and elements were dragged or some element\n      // was added to selection (on pointerdown phase) we need to keep\n      // selection unchanged\n      const hitElement = pointerDownState.hit.element;\n      if (\n        getSelectedGroupIds(this.state).length === 0 &&\n        hitElement &&\n        !pointerDownState.drag.hasOccurred &&\n        !pointerDownState.hit.wasAddedToSelection\n      ) {\n        if (childEvent.shiftKey) {\n          this.setState((prevState) => ({\n            selectedElementIds: {\n              ...prevState.selectedElementIds,\n              [hitElement!.id]: false,\n            },\n          }));\n        } else {\n          this.setState((_prevState) => ({\n            selectedElementIds: { [hitElement!.id]: true },\n          }));\n        }\n      }\n\n      if (draggingElement === null) {\n        // if no element is clicked, clear the selection and redraw\n        this.setState({\n          selectedElementIds: {},\n          selectedGroupIds: {},\n          editingGroupId: null,\n        });\n        return;\n      }\n\n      if (!elementLocked) {\n        this.setState((prevState) => ({\n          selectedElementIds: {\n            ...prevState.selectedElementIds,\n            [draggingElement.id]: true,\n          },\n        }));\n      }\n\n      if (\n        elementType !== \"selection\" ||\n        isSomeElementSelected(globalSceneState.getElements(), this.state)\n      ) {\n        history.resumeRecording();\n      }\n\n      if (!elementLocked) {\n        resetCursor();\n        this.setState({\n          draggingElement: null,\n          elementType: \"selection\",\n        });\n      } else {\n        this.setState({\n          draggingElement: null,\n        });\n      }\n    });\n  }\n\n  private maybeClearSelectionWhenHittingElement(\n    event: React.PointerEvent<HTMLCanvasElement>,\n    hitElement: ExcalidrawElement | null,\n  ): void {\n    const isHittingASelectedElement =\n      hitElement != null && this.state.selectedElementIds[hitElement.id];\n\n    // clear selection if shift is not clicked\n    if (isHittingASelectedElement || event.shiftKey) {\n      return;\n    }\n    this.setState((prevState) => ({\n      selectedElementIds: {},\n      selectedGroupIds: {},\n      // Continue editing the same group if the user selected a different\n      // element from it\n      editingGroupId:\n        prevState.editingGroupId &&\n        hitElement != null &&\n        isElementInGroup(hitElement, prevState.editingGroupId)\n          ? prevState.editingGroupId\n          : null,\n    }));\n    const { selectedElementIds } = this.state;\n    this.setState({\n      selectedElementIds: {},\n      previousSelectedElementIds: selectedElementIds,\n    });\n  }\n\n  private handleCanvasRef = (canvas: HTMLCanvasElement) => {\n    // canvas is null when unmounting\n    if (canvas !== null) {\n      this.canvas = canvas;\n      this.rc = rough.canvas(this.canvas);\n\n      this.canvas.addEventListener(EVENT.WHEEL, this.handleWheel, {\n        passive: false,\n      });\n      this.canvas.addEventListener(EVENT.TOUCH_START, this.onTapStart);\n      this.canvas.addEventListener(EVENT.TOUCH_END, this.onTapEnd);\n    } else {\n      this.canvas?.removeEventListener(EVENT.WHEEL, this.handleWheel);\n      this.canvas?.removeEventListener(EVENT.TOUCH_START, this.onTapStart);\n      this.canvas?.removeEventListener(EVENT.TOUCH_END, this.onTapEnd);\n    }\n  };\n\n  private handleCanvasOnDrop = (event: React.DragEvent<HTMLCanvasElement>) => {\n    const libraryShapes = event.dataTransfer.getData(\n      \"application/vnd.excalidraw.json\",\n    );\n    if (libraryShapes !== \"\") {\n      this.addElementsFromPasteOrLibrary(\n        JSON.parse(libraryShapes),\n        event.clientX,\n        event.clientY,\n      );\n      return;\n    }\n\n    const file = event.dataTransfer?.files[0];\n    if (\n      file?.type === \"application/json\" ||\n      file?.name.endsWith(\".excalidraw\")\n    ) {\n      this.setState({ isLoading: true });\n      loadFromBlob(file)\n        .then(({ elements, appState }) =>\n          this.syncActionResult({\n            elements,\n            appState: {\n              ...(appState || this.state),\n              isLoading: false,\n            },\n            commitToHistory: false,\n          }),\n        )\n        .catch((error) => {\n          this.setState({ isLoading: false, errorMessage: error.message });\n        });\n    } else {\n      this.setState({\n        isLoading: false,\n        errorMessage: t(\"alerts.couldNotLoadInvalidFile\"),\n      });\n    }\n  };\n\n  private handleCanvasContextMenu = (\n    event: React.PointerEvent<HTMLCanvasElement>,\n  ) => {\n    event.preventDefault();\n    this.openContextMenu(event);\n  };\n\n  private openContextMenu = ({\n    clientX,\n    clientY,\n  }: {\n    clientX: number;\n    clientY: number;\n  }) => {\n    const { x, y } = viewportCoordsToSceneCoords(\n      { clientX, clientY },\n      this.state,\n      this.canvas,\n      window.devicePixelRatio,\n    );\n\n    const elements = globalSceneState.getElements();\n    const element = getElementAtPosition(\n      elements,\n      this.state,\n      x,\n      y,\n      this.state.zoom,\n    );\n    if (!element) {\n      ContextMenu.push({\n        options: [\n          navigator.clipboard && {\n            label: t(\"labels.paste\"),\n            action: () => this.pasteFromClipboard(null),\n          },\n          probablySupportsClipboardBlob &&\n            elements.length > 0 && {\n              label: t(\"labels.copyAsPng\"),\n              action: this.copyToClipboardAsPng,\n            },\n          probablySupportsClipboardWriteText &&\n            elements.length > 0 && {\n              label: t(\"labels.copyAsSvg\"),\n              action: this.copyToClipboardAsSvg,\n            },\n          ...this.actionManager.getContextMenuItems((action) =>\n            CANVAS_ONLY_ACTIONS.includes(action.name),\n          ),\n          {\n            label: t(\"labels.toggleGridMode\"),\n            action: this.toggleGridMode,\n          },\n        ],\n        top: clientY,\n        left: clientX,\n      });\n      return;\n    }\n\n    if (!this.state.selectedElementIds[element.id]) {\n      this.setState({ selectedElementIds: { [element.id]: true } });\n    }\n\n    ContextMenu.push({\n      options: [\n        navigator.clipboard && {\n          label: t(\"labels.copy\"),\n          action: this.copyAll,\n        },\n        navigator.clipboard && {\n          label: t(\"labels.paste\"),\n          action: () => this.pasteFromClipboard(null),\n        },\n        probablySupportsClipboardBlob && {\n          label: t(\"labels.copyAsPng\"),\n          action: this.copyToClipboardAsPng,\n        },\n        probablySupportsClipboardWriteText && {\n          label: t(\"labels.copyAsSvg\"),\n          action: this.copyToClipboardAsSvg,\n        },\n        ...this.actionManager.getContextMenuItems(\n          (action) => !CANVAS_ONLY_ACTIONS.includes(action.name),\n        ),\n      ],\n      top: clientY,\n      left: clientX,\n    });\n  };\n\n  private handleWheel = withBatchedUpdates((event: WheelEvent) => {\n    event.preventDefault();\n    const { deltaX, deltaY } = event;\n    const { selectedElementIds, previousSelectedElementIds } = this.state;\n\n    // note that event.ctrlKey is necessary to handle pinch zooming\n    if (event.metaKey || event.ctrlKey) {\n      const sign = Math.sign(deltaY);\n      const MAX_STEP = 10;\n      let delta = Math.abs(deltaY);\n      if (delta > MAX_STEP) {\n        delta = MAX_STEP;\n      }\n      delta *= sign;\n      if (Object.keys(previousSelectedElementIds).length !== 0) {\n        setTimeout(() => {\n          this.setState({\n            selectedElementIds: previousSelectedElementIds,\n            previousSelectedElementIds: {},\n          });\n        }, 1000);\n      }\n      this.setState(({ zoom }) => ({\n        zoom: getNormalizedZoom(zoom - delta / 100),\n        selectedElementIds: {},\n        previousSelectedElementIds:\n          Object.keys(selectedElementIds).length !== 0\n            ? selectedElementIds\n            : previousSelectedElementIds,\n      }));\n      return;\n    }\n\n    // scroll horizontally when shift pressed\n    if (event.shiftKey) {\n      this.setState(({ zoom, scrollX }) => ({\n        // on Mac, shift+wheel tends to result in deltaX\n        scrollX: normalizeScroll(scrollX - (deltaY || deltaX) / zoom),\n      }));\n      return;\n    }\n\n    this.setState(({ zoom, scrollX, scrollY }) => ({\n      scrollX: normalizeScroll(scrollX - deltaX / zoom),\n      scrollY: normalizeScroll(scrollY - deltaY / zoom),\n    }));\n  });\n\n  private getTextWysiwygSnappedToCenterPosition(\n    x: number,\n    y: number,\n    state: {\n      scrollX: FlooredNumber;\n      scrollY: FlooredNumber;\n      zoom: number;\n    },\n    canvas: HTMLCanvasElement | null,\n    scale: number,\n  ) {\n    const elementClickedInside = getElementContainingPosition(\n      globalSceneState\n        .getElementsIncludingDeleted()\n        .filter((element) => !isTextElement(element)),\n      x,\n      y,\n    );\n    if (elementClickedInside) {\n      const elementCenterX =\n        elementClickedInside.x + elementClickedInside.width / 2;\n      const elementCenterY =\n        elementClickedInside.y + elementClickedInside.height / 2;\n      const distanceToCenter = Math.hypot(\n        x - elementCenterX,\n        y - elementCenterY,\n      );\n      const isSnappedToCenter =\n        distanceToCenter < TEXT_TO_CENTER_SNAP_THRESHOLD;\n      if (isSnappedToCenter) {\n        const { x: viewportX, y: viewportY } = sceneCoordsToViewportCoords(\n          { sceneX: elementCenterX, sceneY: elementCenterY },\n          state,\n          canvas,\n          scale,\n        );\n        return { viewportX, viewportY, elementCenterX, elementCenterY };\n      }\n    }\n  }\n\n  private savePointer = (x: number, y: number, button: \"up\" | \"down\") => {\n    if (!x || !y) {\n      return;\n    }\n    const pointerCoords = viewportCoordsToSceneCoords(\n      { clientX: x, clientY: y },\n      this.state,\n      this.canvas,\n      window.devicePixelRatio,\n    );\n\n    if (isNaN(pointerCoords.x) || isNaN(pointerCoords.y)) {\n      // sometimes the pointer goes off screen\n      return;\n    }\n    this.portal.socket &&\n      // do not broadcast when more than 1 pointer since that shows flickering on the other side\n      gesture.pointers.size < 2 &&\n      this.broadcastMouseLocation({\n        pointerCoords,\n        button,\n      });\n  };\n\n  private resetShouldCacheIgnoreZoomDebounced = debounce(() => {\n    this.setState({ shouldCacheIgnoreZoom: false });\n  }, 300);\n\n  private saveDebounced = debounce(() => {\n    saveToLocalStorage(\n      globalSceneState.getElementsIncludingDeleted(),\n      this.state,\n    );\n      if(window.isCloudConnected && window.activeDocIndex>0){\n         window.saveActiveDoc();\n      }\n \n  }, 300);\n}\n\n// -----------------------------------------------------------------------------\n// TEST HOOKS\n// -----------------------------------------------------------------------------\n\ndeclare global {\n  interface Window {\n    h: {\n      elements: readonly ExcalidrawElement[];\n      state: AppState;\n      setState: React.Component<any, AppState>[\"setState\"];\n      history: SceneHistory;\n      app: InstanceType<typeof App>;\n    };\n  }\n}\n\nif (\n  process.env.NODE_ENV === ENV.TEST ||\n  process.env.NODE_ENV === ENV.DEVELOPMENT\n) {\n  window.h = {} as Window[\"h\"];\n\n  Object.defineProperties(window.h, {\n    elements: {\n      get() {\n        return globalSceneState.getElementsIncludingDeleted();\n      },\n      set(elements: ExcalidrawElement[]) {\n        return globalSceneState.replaceAllElements(elements);\n      },\n    },\n    history: {\n      get: () => history,\n    },\n  });\n}\n\nexport default App;\n","// time in milliseconds\nexport const TAP_TWICE_TIMEOUT = 300;\nexport const INITAL_SCENE_UPDATE_TIMEOUT = 5000;\nexport const SYNC_FULL_SCENE_INTERVAL_MS = 20000;\nexport const TOUCH_CTX_MENU_TIMEOUT = 500;\n","// This optional code is used to register a service worker.\n// register() is not called by default.\n\n// This lets the app load faster on subsequent visits in production, and gives\n// it offline capabilities. However, it also means that developers (and users)\n// will only see deployed updates on subsequent visits to a page, after all the\n// existing tabs open on the page have been closed, since previously cached\n// resources are updated in the background.\n\n// To learn more about the benefits of this model and instructions on how to\n// opt-in, read https://bit.ly/CRA-PWA\n\nconst isLocalhost = Boolean(\n  window.location.hostname === \"localhost\" ||\n    // [::1] is the IPv6 localhost address.\n    window.location.hostname === \"[::1]\" ||\n    // 127.0.0.0/8 are considered localhost for IPv4.\n    window.location.hostname.match(\n      /^127(?:\\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/,\n    ),\n);\n\ntype Config = {\n  onSuccess?: (registration: ServiceWorkerRegistration) => void;\n  onUpdate?: (registration: ServiceWorkerRegistration) => void;\n};\n\nexport const register = (config?: Config) => {\n  if (process.env.NODE_ENV === \"production\" && \"serviceWorker\" in navigator) {\n    // The URL constructor is available in all browsers that support SW.\n    const publicUrl = new URL(process.env.PUBLIC_URL, window.location.href);\n    if (publicUrl.origin !== window.location.origin) {\n      // Our service worker won't work if PUBLIC_URL is on a different origin\n      // from what our page is served on. This might happen if a CDN is used to\n      // serve assets; see https://github.com/facebook/create-react-app/issues/2374\n      return;\n    }\n\n    window.addEventListener(\"load\", () => {\n      const swUrl = `${process.env.PUBLIC_URL}/service-worker.js`;\n\n      if (isLocalhost) {\n        // This is running on localhost. Let's check if a service worker still exists or not.\n        checkValidServiceWorker(swUrl, config);\n\n        // Add some additional logging to localhost, pointing developers to the\n        // service worker/PWA documentation.\n        navigator.serviceWorker.ready.then(() => {\n          console.info(\n            \"This web app is being served cache-first by a service \" +\n              \"worker. To learn more, visit https://bit.ly/CRA-PWA\",\n          );\n        });\n      } else {\n        // Is not localhost. Just register service worker\n        registerValidSW(swUrl, config);\n      }\n    });\n  }\n};\n\nconst registerValidSW = (swUrl: string, config?: Config) => {\n  navigator.serviceWorker\n    .register(swUrl)\n    .then((registration) => {\n      registration.onupdatefound = () => {\n        const installingWorker = registration.installing;\n        if (installingWorker == null) {\n          return;\n        }\n        installingWorker.onstatechange = () => {\n          if (installingWorker.state === \"installed\") {\n            if (navigator.serviceWorker.controller) {\n              // At this point, the updated precached content has been fetched,\n              // but the previous service worker will still serve the older\n              // content until all client tabs are closed.\n\n              // console.log(\n              //   \"New content is available and will be used when all \" +\n              //     \"tabs for this page are closed.\",\n              // );\n\n              // Execute callback\n              if (config && config.onUpdate) {\n                config.onUpdate(registration);\n              }\n            } else {\n              // At this point, everything has been precached.\n              // It's the perfect time to display a\n              // \"Content is cached for offline use.\" message.\n\n              // console.log(\"Content is cached for offline use.\");\n\n              // Execute callback\n              if (config && config.onSuccess) {\n                config.onSuccess(registration);\n              }\n            }\n          }\n        };\n      };\n    })\n    .catch((error) => {\n      console.error(\"Error during service worker registration:\", error);\n    });\n};\n\nconst checkValidServiceWorker = (swUrl: string, config?: Config) => {\n  // Check if the service worker can be found. If it can't reload the page.\n  fetch(swUrl, {\n    headers: { \"Service-Worker\": \"script\" },\n  })\n    .then((response) => {\n      // Ensure service worker exists, and that we really are getting a JS file.\n      const contentType = response.headers.get(\"content-type\");\n      if (\n        response.status === 404 ||\n        (contentType != null && contentType.indexOf(\"javascript\") === -1)\n      ) {\n        // No service worker found. Probably a different app. Reload the page.\n        navigator.serviceWorker.ready.then((registration) => {\n          registration.unregister().then(() => {\n            window.location.reload();\n          });\n        });\n      } else {\n        // Service worker found. Proceed as normal.\n        registerValidSW(swUrl, config);\n      }\n    })\n    .catch(() => {\n      // console.log(\n      //   \"No internet connection found. App is running in offline mode.\",\n      // );\n    });\n};\n\nexport const unregister = () => {\n  if (\"serviceWorker\" in navigator) {\n    navigator.serviceWorker.ready\n      .then((registration) => {\n        registration.unregister();\n      })\n      .catch((error) => {\n        console.error(error.message);\n      });\n  }\n};\n","import React, { useState, useLayoutEffect } from \"react\";\nimport ReactDOM from \"react-dom\";\nimport * as Sentry from \"@sentry/browser\";\nimport * as SentryIntegrations from \"@sentry/integrations\";\n\nimport { EVENT } from \"./constants\";\nimport { TopErrorBoundary } from \"./components/TopErrorBoundary\";\nimport { InitializeApp } from \"./components/InitializeApp\";\nimport { IsMobileProvider } from \"./is-mobile\";\nimport App from \"./components/App\";\nimport { register as registerServiceWorker } from \"./serviceWorker\";\n\nimport \"./css/styles.scss\";\nimport { loadFromBlob } from \"./data\";\n\n// On Apple mobile devices add the proprietary app icon and splashscreen markup.\n// No one should have to do this manually, and eventually this annoyance will\n// go away once https://bugs.webkit.org/show_bug.cgi?id=183937 is fixed.\nif (\n  /\\b(iPad|iPhone|iPod)\\b/.test(navigator.userAgent) &&\n  !matchMedia(\"(display-mode: standalone)\").matches\n) {\n  import(/* webpackChunkName: \"pwacompat\" */ \"pwacompat\");\n}\n\nconst SentryEnvHostnameMap: { [key: string]: string } = {\n  \"excalidraw.com\": \"production\",\n  \"vercel.app\": \"staging\",\n};\n\nconst REACT_APP_DISABLE_SENTRY =\n  process.env.REACT_APP_DISABLE_SENTRY === \"true\";\nconst REACT_APP_GIT_SHA = process.env.REACT_APP_GIT_SHA as string;\n\n// Disable Sentry locally or inside the Docker to avoid noise/respect privacy\nconst onlineEnv =\n  !REACT_APP_DISABLE_SENTRY &&\n  Object.keys(SentryEnvHostnameMap).find(\n    (item) => window.location.hostname.indexOf(item) >= 0,\n  );\n\nSentry.init({\n  dsn: onlineEnv\n    ? \"https://7bfc596a5bf945eda6b660d3015a5460@sentry.io/5179260\"\n    : undefined,\n  environment: onlineEnv ? SentryEnvHostnameMap[onlineEnv] : undefined,\n  release: REACT_APP_GIT_SHA,\n  ignoreErrors: [\n    \"undefined is not an object (evaluating 'window.__pad.performLoop')\", // Only happens on Safari, but spams our servers. Doesn't break anything\n  ],\n  integrations: [\n    new SentryIntegrations.CaptureConsole({\n      levels: [\"error\"],\n    }),\n  ],\n  beforeSend(event) {\n    if (event.request?.url) {\n      event.request.url = event.request.url.replace(/#.*$/, \"\");\n    }\n    return event;\n  },\n});\n\nwindow.__EXCALIDRAW_SHA__ = REACT_APP_GIT_SHA;\n\n// Block pinch-zooming on iOS outside of the content area\ndocument.addEventListener(\n  \"touchmove\",\n  (event) => {\n    // @ts-ignore\n    if (event.scale !== 1) {\n      event.preventDefault();\n    }\n  },\n  { passive: false },\n);\n\nfunction ExcalidrawApp() {\n  const [dimensions, setDimensions] = useState({\n    width: window.innerWidth,\n    height: window.innerHeight,\n  });\n\n  const onResize = () => {\n    setDimensions({\n      width: window.innerWidth,\n      height: window.innerHeight,\n    });\n  };\n\n  useLayoutEffect(() => {\n    window.addEventListener(\"resize\", onResize);\n\n    return () => window.removeEventListener(\"resize\", onResize);\n  }, []);\n\n  const { width, height } = dimensions;\n  return (\n    <TopErrorBoundary>\n      <IsMobileProvider>\n        <InitializeApp>\n          <App width={width} height={height} />\n        </InitializeApp>\n      </IsMobileProvider>\n    </TopErrorBoundary>\n  );\n}\n\nconst rootElement = document.getElementById(\"root\");\n\nReactDOM.render(<ExcalidrawApp />, rootElement);\n\nregisterServiceWorker({\n  onUpdate: (registration) => {\n    const waitingServiceWorker = registration.waiting;\n    if (waitingServiceWorker) {\n      waitingServiceWorker.addEventListener(\n        EVENT.STATE_CHANGE,\n        (event: Event) => {\n          const target = event.target as ServiceWorker;\n          const state = target.state as ServiceWorkerState;\n          if (state === \"activated\") {\n            window.location.reload();\n          }\n        },\n      );\n      waitingServiceWorker.postMessage({ type: \"SKIP_WAITING\" });\n    }\n  },\n});\n\nif (\"launchQueue\" in window && \"LaunchParams\" in window) {\n  (window as any).launchQueue.setConsumer(\n    async (launchParams: { files: any[] }) => {\n      if (!launchParams.files.length) {\n        return;\n      }\n      const fileHandle = launchParams.files[0];\n      const blob = await fileHandle.getFile();\n      loadFromBlob(blob);\n    },\n  );\n}\n","var map = {\n\t\"./README.md\": [\n\t\t112,\n\t\t7,\n\t\t40\n\t],\n\t\"./ar-SA\": [\n\t\t40,\n\t\t3,\n\t\t0\n\t],\n\t\"./ar-SA.json\": [\n\t\t40,\n\t\t3,\n\t\t0\n\t],\n\t\"./bg-BG\": [\n\t\t41,\n\t\t3,\n\t\t1\n\t],\n\t\"./bg-BG.json\": [\n\t\t41,\n\t\t3,\n\t\t1\n\t],\n\t\"./ca-ES\": [\n\t\t42,\n\t\t3,\n\t\t2\n\t],\n\t\"./ca-ES.json\": [\n\t\t42,\n\t\t3,\n\t\t2\n\t],\n\t\"./de-DE\": [\n\t\t43,\n\t\t3,\n\t\t3\n\t],\n\t\"./de-DE.json\": [\n\t\t43,\n\t\t3,\n\t\t3\n\t],\n\t\"./el-GR\": [\n\t\t44,\n\t\t3,\n\t\t4\n\t],\n\t\"./el-GR.json\": [\n\t\t44,\n\t\t3,\n\t\t4\n\t],\n\t\"./en\": [\n\t\t19,\n\t\t3\n\t],\n\t\"./en.json\": [\n\t\t19,\n\t\t3\n\t],\n\t\"./es-ES\": [\n\t\t45,\n\t\t3,\n\t\t5\n\t],\n\t\"./es-ES.json\": [\n\t\t45,\n\t\t3,\n\t\t5\n\t],\n\t\"./fa-IR\": [\n\t\t46,\n\t\t3,\n\t\t6\n\t],\n\t\"./fa-IR.json\": [\n\t\t46,\n\t\t3,\n\t\t6\n\t],\n\t\"./fi-FI\": [\n\t\t47,\n\t\t3,\n\t\t7\n\t],\n\t\"./fi-FI.json\": [\n\t\t47,\n\t\t3,\n\t\t7\n\t],\n\t\"./fr-FR\": [\n\t\t48,\n\t\t3,\n\t\t8\n\t],\n\t\"./fr-FR.json\": [\n\t\t48,\n\t\t3,\n\t\t8\n\t],\n\t\"./he-IL\": [\n\t\t49,\n\t\t3,\n\t\t9\n\t],\n\t\"./he-IL.json\": [\n\t\t49,\n\t\t3,\n\t\t9\n\t],\n\t\"./hi-IN\": [\n\t\t50,\n\t\t3,\n\t\t10\n\t],\n\t\"./hi-IN.json\": [\n\t\t50,\n\t\t3,\n\t\t10\n\t],\n\t\"./hu-HU\": [\n\t\t51,\n\t\t3,\n\t\t11\n\t],\n\t\"./hu-HU.json\": [\n\t\t51,\n\t\t3,\n\t\t11\n\t],\n\t\"./id-ID\": [\n\t\t52,\n\t\t3,\n\t\t12\n\t],\n\t\"./id-ID.json\": [\n\t\t52,\n\t\t3,\n\t\t12\n\t],\n\t\"./it-IT\": [\n\t\t53,\n\t\t3,\n\t\t13\n\t],\n\t\"./it-IT.json\": [\n\t\t53,\n\t\t3,\n\t\t13\n\t],\n\t\"./ja-JP\": [\n\t\t54,\n\t\t3,\n\t\t14\n\t],\n\t\"./ja-JP.json\": [\n\t\t54,\n\t\t3,\n\t\t14\n\t],\n\t\"./ko-KR\": [\n\t\t55,\n\t\t3,\n\t\t15\n\t],\n\t\"./ko-KR.json\": [\n\t\t55,\n\t\t3,\n\t\t15\n\t],\n\t\"./nb-NO\": [\n\t\t56,\n\t\t3,\n\t\t16\n\t],\n\t\"./nb-NO.json\": [\n\t\t56,\n\t\t3,\n\t\t16\n\t],\n\t\"./nl-NL\": [\n\t\t57,\n\t\t3,\n\t\t17\n\t],\n\t\"./nl-NL.json\": [\n\t\t57,\n\t\t3,\n\t\t17\n\t],\n\t\"./nn-NO\": [\n\t\t58,\n\t\t3,\n\t\t18\n\t],\n\t\"./nn-NO.json\": [\n\t\t58,\n\t\t3,\n\t\t18\n\t],\n\t\"./percentages\": [\n\t\t20,\n\t\t3\n\t],\n\t\"./percentages.json\": [\n\t\t20,\n\t\t3\n\t],\n\t\"./pl-PL\": [\n\t\t59,\n\t\t3,\n\t\t19\n\t],\n\t\"./pl-PL.json\": [\n\t\t59,\n\t\t3,\n\t\t19\n\t],\n\t\"./pt-PT\": [\n\t\t60,\n\t\t3,\n\t\t20\n\t],\n\t\"./pt-PT.json\": [\n\t\t60,\n\t\t3,\n\t\t20\n\t],\n\t\"./ru-RU\": [\n\t\t61,\n\t\t3,\n\t\t21\n\t],\n\t\"./ru-RU.json\": [\n\t\t61,\n\t\t3,\n\t\t21\n\t],\n\t\"./sq-AL\": [\n\t\t62,\n\t\t3,\n\t\t22\n\t],\n\t\"./sq-AL.json\": [\n\t\t62,\n\t\t3,\n\t\t22\n\t],\n\t\"./tr-TR\": [\n\t\t63,\n\t\t3,\n\t\t23\n\t],\n\t\"./tr-TR.json\": [\n\t\t63,\n\t\t3,\n\t\t23\n\t],\n\t\"./uk-UA\": [\n\t\t64,\n\t\t3,\n\t\t24\n\t],\n\t\"./uk-UA.json\": [\n\t\t64,\n\t\t3,\n\t\t24\n\t],\n\t\"./zh-CN\": [\n\t\t65,\n\t\t3,\n\t\t25\n\t],\n\t\"./zh-CN.json\": [\n\t\t65,\n\t\t3,\n\t\t25\n\t],\n\t\"./zh-TW\": [\n\t\t66,\n\t\t3,\n\t\t26\n\t],\n\t\"./zh-TW.json\": [\n\t\t66,\n\t\t3,\n\t\t26\n\t]\n};\nfunction webpackAsyncContext(req) {\n\tif(!__webpack_require__.o(map, req)) {\n\t\treturn Promise.resolve().then(function() {\n\t\t\tvar e = new Error(\"Cannot find module '\" + req + \"'\");\n\t\t\te.code = 'MODULE_NOT_FOUND';\n\t\t\tthrow e;\n\t\t});\n\t}\n\n\tvar ids = map[req], id = ids[0];\n\treturn Promise.all(ids.slice(2).map(__webpack_require__.e)).then(function() {\n\t\treturn __webpack_require__.t(id, ids[1])\n\t});\n}\nwebpackAsyncContext.keys = function webpackAsyncContextKeys() {\n\treturn Object.keys(map);\n};\nwebpackAsyncContext.id = 26;\nmodule.exports = webpackAsyncContext;"],"sourceRoot":""}